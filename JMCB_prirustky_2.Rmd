---
title: "JMCB_prirustky_2"
author: "Kateřina Křížová"
date: "2024-03-01"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=FALSE, fig.dim = c(8, 4))

# PACKAGES

# install.packages("tidyverse", dependencies = T)
# install.packages("readxl")
# install.packages("stringr")
# install.packages("stringi")
# install.packages("mdbr")
# install.packages("RODBC")
# install.packages("odbc")
# install.packages("xlsx")
# install.packages("data.table")
# install.packages("Matrix")
require(tidyverse)
require(readxl)
require(xlsx) # write excel in sheets
require(stringr) # ::str_split_fixed
require(stringi) # ::stri_detect_fixed - detect empty string
require(mdbr) # ::read_mdb
require(RODBC) # ::read_mdb
require(odbc) # ::read_mdb
library(Matrix) 
library(data.table) # ::rbindlist 

```

# PATHS ; PROJ INFO ; FCE

```{r}

proj <- "JMCB"

path_proj <- "M:/03 klienti/kraj jihocesky/jihoceske muzeum v ceskych budejovicich - JMCB/03 migrace/jmcb migrace 2023/"
path_kk <- paste0(path_proj, "KK_workspace/")

# path_data <- "M:/03 klienti/kraj jihocesky/jihoceske muzeum v ceskych budejovicich - JMCB/2023_PK/zdrojdat/orig/"


# _______________________________________ FUNKCE_________________________________________

# Read and merge excel sheets (## READ)

read_excel_allsheets <- function(filename, tibble = FALSE) {
    # I prefer straight data.frames
    # but if you like tidyverse tibbles (the default with read_excel)
    # then just pass tibble = TRUE
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X, col_types = "text", col_names = F,))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheets
    x
}

# _____________________________________ SIGN INVC ________________________________________

val_sign <- c("MDRH-Ff","MDRH-Kpl","A-P","MDRH-F","MDRH-P-Čul","MDRH-St","MDRH-Sz","PNŠ","PVS","PVU",
              "MDRH-K","MDRH-Kf","MDRH-S","MDRH-Sf","PFi","PND","PPT","PST","PUPR","A","D",
              "F","Fd","Fi","Fo","Fs","G","GK","H","HB","IT","K","LA","M","ME","Mi","MP","N","O",
              "P","PAK","PM","PN","PP","PT","PUPC","R","S","ST","UP","V","VS","ZV","B","ZE") # podsbirky, ktere maji v MUS definovanou masku


mask2 <- c("MDRH-Ff", "MDRH-Kpl")
mask3 <- c("A-P","MDRH-F","MDRH-P-Čul","MDRH-St","MDRH-Sz","PNŠ","PVS","PVU")
mask4 <- c("MDRH-K","MDRH-Kf","MDRH-S","MDRH-Sf","PFi","PND","PPT","PST","PUPR")
mask5 <- c("A","D","F","Fd","Fi","Fo","Fs","G","GK","H","HB","IT","K","LA","M","ME","Mi","MP","N","O",
           "P","PAK","PM","PN","PP","PT","PUPC","R","S","ST","UP","V","VS","ZV")
mask6 <- c("B","ZE")

```

# --------------------------------------- sign A

A-1984.xlsx
A-1985.xlsx
A-1986.xlsx
A-1987.xlsx
A-1988 pokrač..xlsx
A-1984.xlsx
A-1988.xlsx
A-1989.xlsx
A-1990.xlsx
A-1991.xlsx  -------------------------> KK_red.xlsx/A

## READ

```{r, warning = F}
CORE_a <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "A") # warning asi ok
```

## EDA

```{r}

n_a <- nrow(CORE_a)
eda <- CORE_a

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r ZKONTROLOVANO, warning=FALSE}

UPDT_a <- CORE_a

# eda
sample_n(UPDT_a, 10)

aa <- UPDT_a %>% 
  mutate(Mpref = "A",
         sbirka1 = "JCM",
         cisrada3 = "Z", 
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            # podsbirka == "25" ~ "166", # KONFLIKT !!!
                            # podsbirka == "25" ~ "168",
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>%  # Mprirc jen pracovni, bez vednul, jen pro group a nastaveni subcisel
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% # Mpref definovano v POVINNE
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() %>% 
  # -------------------------------------------------- prirc4 - part 2
  mutate(Mp0 = str_pad(porc104, maxp, pad = 0),
         Ms0 = str_pad(subc105, maxs, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
 mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks, pozn20) # ok
```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
nabpozn29

puvmaj28 

```{r ZKONTROLOVANO}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       # popis muze mit 2000 charakterů
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
          is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J"),
         cennab27 = ifelse(str_detect(zpusobNabyti, ",-"), str_extract(zpusobNabyti, "\\d+,-"), NA), # 
         # POZN29_zpusobNabyti = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA),
         POZN29_zpusobNabyti = ifelse(zpnab23 == "J", paste0("Způsob nabytí: ", zpusobNabyti), NA),                                        
         POZN29_odkazDoklad = ifelse(!is.na(odkazDoklad), paste0("Odkaz na doklad: ", odkazDoklad), NA)) %>% 
  # -------------------------------------------------- nabpozn29
  unite(nabpozn29, c("POZN29_zpusobNabyti", "POZN29_odkazDoklad"), sep = "\n", na.rm = T, remove = FALSE) %>% 
  # -------------------------------------------------- puvmaj28 
  mutate(puvmaj28 = puvodMajitel) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, cennab27, nabpozn29, puvmaj28, .before = zdroj)


# check duplicity pricr4
check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

# check lengthPopis
any(bb$lengthPopis > 2000) # chceme FALSE

# check zpusob nabyti
check <- bb %>% select(zpusobNabyti, zpnab23, POZN29_zpusobNabyti, cennab27) %>% distinct()

# CLEAR

bb <- bb %>%  select(-lengthPopis, -is_valid_date, -is_valid_date2)
rm(check)

```

## VYRAZENI 

datvyr64 
dokvyr67 (nebudu extrahovat, nevim, co je a co neni soucasti nazvu dokumentu -> do poznamky)
poznvyr73

```{r ZKONTROLOVANO}

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; dokvyr67 ; poznvyr73
  mutate(vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         poznvyr73 = ifelse(is.na(odpisVyrazeni), NA, paste("Odpis / převod / vyřazení atd.: ", odpisVyrazeni))) %>% 
  relocate(vyrdat64, poznvyr73,  .before = zdroj)

check <- cc %>% select(odpisVyrazeni, vyrdat64, poznvyr73) %>% distinct()
rm(check)

```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ) # z prvni varky
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r ZKONTROLOVANO}

dd <- cc %>% 
  mutate(text3_90 = jineCislo) %>% relocate(text3_90, .after = jineCislo) %>%
  mutate(text4_91 = revize) %>% relocate(text4_91, .after = revize) %>% 
  mutate(text5_92 = sign) %>% relocate(text5_92, .after = sign) %>% 
  mutate(text6_99 = invc) %>% relocate(text5_92, .after = invc) %>% 
  relocate(text3_90, text4_91, text5_92, text6_99, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(type_invc = case_when(str_detect(invc, "^[A-Za-z]*\\s*\\d+$") ~ "single",
                               str_detect(invc, "\\d+,\\s\\d+")&!str_detect(invc, "-") ~ "seznam",
                               str_detect(invc, "^\\d+\\s*-\\s*\\d+$") ~ "interval",
                               str_detect(invc, ",")&str_detect(invc, "\\d+\\s*-\\s*\\d+") ~ "sez+int",
                               is.na(invc) ~ NA,
                               TRUE ~ "tbd"),
         isDoable = ifelse(type_invc %in% c("single", "seznam", "interval")&sign %in% val_sign, T, 
                           ifelse(is.na(invc), NA, F))) %>%                                 # !!!! dulezity priznak !!!!
  relocate(type_invc, isDoable, .after = invc)

prehled <- ee %>% select(prirc4, sign, invc, type_invc, isDoable) %>% filter(!is.na(invc))
summary(as.factor(prehled$type_invc))

# ------------------------------------------------------ single 2084

single <- ee %>% filter(type_invc == "single"&isDoable == T) %>% 
  mutate(Minvc = str_extract(invc, "\\d+"),
         Msub = str_extract(invc, "[A-Za-z]+$"),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc)) %>% 
  unite(invc5, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-Minvc, -Msub, -Minvc0)

prehled_sin <- single %>% select(prirc4, invc, type_invc, invc5)

# ------------------------------------------------------ seznam 531 -------- FUNKCNI -> oprav i u dalsich

seznam <- ee %>% filter(type_invc == "seznam"&isDoable == T) %>% 
  mutate(numbers = invc) %>% 
  separate_rows(numbers, sep = ",") %>% 
  # rename("numbers" = invc) %>% 
  mutate(numbers = str_trim(numbers),
         Minvc = ifelse(str_detect(numbers, "^[A-Za-z]+"), str_extract(numbers, "\\d+"), numbers),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc),
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>% 
  unite(Minvc_single, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(Minvc_single, .after = numbers) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc_single, collapse = ",")) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-numbers, -Minvc, -Minvc0, -Msub, -Minvc_single) %>% 
  distinct() %>% 
  ungroup()

prehled_sez <- seznam %>% select(prirc4, sign, invc, type_invc, invc5)

# ------------------------------------------------------ interval 142

interval0 <- ee %>% filter(type_invc == "interval"&isDoable == T) %>% 
  separate(invc, into = c("start", "end"), sep = "-", remove = F) %>% 
  mutate(start = as.numeric(start), end = as.numeric(end)) %>% 
  mutate(is_valid_int = ifelse(start < end, TRUE, FALSE),
         is_wrong_order = ifelse(is_valid_int == FALSE&nchar(start)==nchar(end), TRUE, FALSE)) # nebudu resit spatny poradi, at si vyresi sami..

int_y <- interval0 %>% 
  filter(is_valid_int==T) %>% 
  mutate(Linvc = as.character(purrr::map2(start, end, ~toString(seq(.x, .y, by = 1))))) %>% 
  separate_rows(Linvc, sep = ",") %>% 
  mutate(Linvc = str_trim(Linvc),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Linvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Linvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Linvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Linvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Linvc, 6, pad = "0")),
                            TRUE ~ Linvc),
         Msub = str_extract(Linvc, "[A-Za-z]+$")) %>% 
  unite(Minvc, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc, collapse = ",")) %>% 
  select(-Linvc, -Minvc0, -Minvc, -Msub) %>% 
  distinct() %>%
  ungroup() 
 
int_n <- interval0 %>% 
  filter(is_valid_int==F) %>% 
  mutate(Minvc = paste("chybne zadany interval invc"))
 
interval <- bind_rows(int_y, int_n) %>% 
  mutate(invc5 = Minvc) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-start, -end, -is_valid_int, -is_wrong_order, -Minvc)

nrow(interval0) == nrow(interval) # neztratili jsme nejake radky cestou?
rm(interval0)

# ------------------------------------------------------ zbytek 883

# 827* NA
# 56* FALSE

nrow(ee %>% filter(is.na(isDoable))) #827

zbytek <- ee %>% filter(isDoable == F|is.na(isDoable))

nrow(single)+nrow(seznam)+nrow(interval)+nrow(zbytek)==nrow(ee) # chceme TRUE

# ------------------------------------------------------ JOIN 

ff <- bind_rows(single, seznam, interval, zbytek) %>% 
  relocate(invc5, .after = prirc4)

nrow(ff) == nrow(ee) # musi byt stejne!

# rm(aa)
# rm(bb)
# rm(cc)
# rm(dd)
# rm(ee)

fin <- ff

```

# --------------------------------------- sign S

2003 Archeologie S.xlsx
2004 Archeologie S.xlsx
2005 Archeologie S.xlsx  -------------------------> KK_red.xlsx/S

## READ

```{r}
CORE_s <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "S") # warning asi ok
```

## EDA

```{r}

n_s <- nrow(CORE_s)
eda <- CORE_s

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

UPDT_s <- CORE_s

# eda
sample_n(UPDT_s, 10)

aa <- UPDT_s %>% 
  mutate(Mpref = "S",
         sbirka1 = "JCM",
         cisrada3 = "Z", 
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
   mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            # podsbirka == "25" ~ "166", # KONFLIKT !!!
                            # podsbirka == "25" ~ "168",
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() %>% 
  # -------------------------------------------------- prirc4 - part 2
  mutate(Mp0 = str_pad(porc104, maxp, pad = 0),
         Ms0 = str_pad(subc105, maxs, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
 mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>%  
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
nabpozn29

puvmaj28 
(prisp87)

```{r}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       # popis muze mit ____ charakterů
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
          is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  select(-is_valid_date) %>%  # , -is_valid_date2
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J"),
         cennab27 = ifelse(str_detect(zpusobNabyti, ",-"), str_extract(zpusobNabyti, "\\d+,-"), NA), # 
         # POZN29_zpusobNabyti = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA),
         POZN29_zpusobNabyti = ifelse(zpnab23 == "J", paste0("Způsob nabytí: ", zpusobNabyti), NA),                                        
         POZN29_odkazDoklad = ifelse(!is.na(odkazDoklad), paste0("Odkaz na doklad: ", odkazDoklad), NA)) %>% 
  # -------------------------------------------------- nabpozn29
  unite(nabpozn29, c("POZN29_zpusobNabyti", "POZN29_odkazDoklad"), sep = "\n", na.rm = T, remove = FALSE) %>% 
  # -------------------------------------------------- puvmaj28 ; prisp87
  mutate(puvmaj28 = puvodMajitel) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, cennab27, nabpozn29, puvmaj28, .before = zdroj)


# check duplicity pricr4

check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

```


## VYRAZENI 

datvyr64 
dokvyr67 (nebudu extrahovat, nevim, co je a co neni soucasti nazvu dokumentu -> do poznamky)
poznvyr73

```{r}

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; dokvyr67 ; poznvyr73
  mutate(vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         poznvyr73 = ifelse(is.na(odpisVyrazeni), NA, paste("Odpis / převod / vyřazení atd.: ", odpisVyrazeni))) %>% 
  relocate(vyrdat64, poznvyr73,  .before = zdroj)
```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r}

dd <- cc %>% 
  mutate(text3_90 = jineCislo) %>% relocate(text3_90, .after = jineCislo) %>%
  mutate(text4_91 = revize) %>% relocate(text4_91, .after = revize) %>% 
  mutate(text5_92 = sign) %>% relocate(text5_92, .after = sign) %>% 
  mutate(text6_99 = invc) %>% relocate(text5_92, .after = invc) %>% 
  relocate(text3_90, text4_91, text5_92, text6_99, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(type_invc = case_when(str_detect(invc, "^[A-Za-z]*\\s*\\d+$") ~ "single",
                               str_detect(invc, "\\d+,\\s\\d+")&!str_detect(invc, "-") ~ "seznam",
                               str_detect(invc, "^\\d+\\s*-\\s*\\d+$") ~ "interval",
                               str_detect(invc, ",")&str_detect(invc, "\\d+\\s*-\\s*\\d+") ~ "sez+int",
                               is.na(invc) ~ NA,
                               TRUE ~ "tbd"),
         isDoable = ifelse(type_invc %in% c("single", "seznam", "interval")&sign %in% val_sign, T, 
                           ifelse(is.na(invc), NA, F))) %>%                                 # !!!! dulezity priznak !!!!
  relocate(type_invc, isDoable, .after = invc)

prehled <- ee %>% select(prirc4, sign, invc, type_invc, isDoable) %>% filter(!is.na(invc))
summary(as.factor(prehled$type_invc))

# ------------------------------------------------------ single 143

single <- ee %>% filter(type_invc == "single"&isDoable == T) %>% 
  mutate(Minvc = str_extract(invc, "\\d+"),
         Msub = str_extract(invc, "[A-Za-z]+$"),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc)) %>% 
  unite(invc5, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-Minvc, -Msub, -Minvc0)

prehled_sin <- single %>% select(prirc4, invc, type_invc, invc5)

# ------------------------------------------------------ seznam 20

seznam <- ee %>% filter(type_invc == "seznam"&isDoable == T) %>% 
  mutate(numbers = invc) %>% 
  separate_rows(numbers, sep = ",") %>% 
  # rename("numbers" = invc) %>% 
  mutate(numbers = str_trim(numbers),
         Minvc = ifelse(str_detect(numbers, "^[A-Za-z]+"), str_extract(numbers, "\\d+"), numbers),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc), 
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>% 
  unite(Minvc_single, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(Minvc_single, .after = numbers) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc_single, collapse = ",")) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-numbers, -Minvc, -Minvc0, -Msub, -Minvc_single) %>% 
  distinct() %>% 
  ungroup()

# ------------------------------------------------------ interval 20

interval0 <- ee %>% filter(type_invc == "interval"&isDoable == T) %>% 
  separate(invc, into = c("start", "end"), sep = "-", remove = F) %>% 
  mutate(start = as.numeric(start), end = as.numeric(end)) %>% 
  mutate(is_valid_int = ifelse(start < end, TRUE, FALSE),
         is_wrong_order = ifelse(is_valid_int == FALSE&nchar(start)==nchar(end), TRUE, FALSE)) # nebudu resit spatny poradi, at si vyresi sami..

int_y <- interval0 %>% 
  filter(is_valid_int==T) %>% 
  mutate(Linvc = as.character(purrr::map2(start, end, ~toString(seq(.x, .y, by = 1))))) %>% 
  separate_rows(Linvc, sep = ",") %>% 
  mutate(Linvc = str_trim(Linvc),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Linvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Linvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Linvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Linvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Linvc, 6, pad = "0")),
                            TRUE ~ Linvc),
         Msub = str_extract(Linvc, "[A-Za-z]+$")) %>% 
  unite(Minvc, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc, collapse = ",")) %>% 
  select(-Linvc, -Minvc0, -Minvc, -Msub) %>% 
  distinct() %>%
  ungroup() 
 
int_n <- interval0 %>% 
  filter(is_valid_int==F) %>% 
  mutate(Minvc = paste("chybne zadany interval invc"))
 
interval <- bind_rows(int_y, int_n) %>% 
  mutate(invc5 = Minvc) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-start, -end, -is_valid_int, -is_wrong_order, -Minvc)

nrow(interval0) == nrow(interval) # neztratili jsme nejake radky cestou?
rm(interval0)

# ------------------------------------------------------ zbytek 6

# 4* NA
# 2* FALSE

nrow(ee %>% filter(is.na(isDoable))) #827

zbytek <- ee %>% filter(isDoable == F|is.na(isDoable))

nrow(single)+nrow(seznam)+nrow(interval)+nrow(zbytek)==nrow(ee) # chceme TRUE

# ------------------------------------------------------ JOIN 

ff <- bind_rows(single, seznam, interval, zbytek) %>% 
  relocate(invc5, .after = prirc4)

nrow(ff) == nrow(ee) # musi byt stejne!

# rm(aa)
# rm(bb)
# rm(cc)
# rm(dd)
# rm(ee)

fin <- ff

```

# --------------------------------------- sign DCM / DC

Diecézní muzeum.xlsx  -------------------------> KK_red.xlsx/S

## READ

```{r}
CORE_dcm <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "DCM") # warning asi ok
```

## EDA

```{r}

n_dcm <- nrow(CORE_dcm)
eda <- CORE_dcm

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

UPDT_dcm <- CORE_dcm

# eda
sample_n(UPDT_dcm, 10)

aa <- UPDT_dcm %>% 
  mutate(Mpref = "DCM",
         sbirka1 = "JCM",
         cisrada3 = "Z", 
         rok12 = "neni zadan",
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
   mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            # podsbirka == "25" ~ "166", # KONFLIKT !!!
                            # podsbirka == "25" ~ "168",
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() %>% 
  # -------------------------------------------------- prirc4 - part 2
  mutate(Mp0 = str_pad(porc104, maxp, pad = 0),
         Ms0 = str_pad(subc105, maxs, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```


# --------------------------------------- sign FI

Př. kniha -Filmotéka.xlsx  -------------------------> KK_red.xlsx/FI

## READ

```{r}
CORE_fi <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "FI") # warning asi ok
```

## EDA

```{r}

n_fi <- nrow(CORE_fi)
eda <- CORE_fi

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

```
## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

UPDT_fi <- CORE_fi

# eda
sample_n(UPDT_fi, 10)

aa <- UPDT_fi %>% 
  mutate(Mpref = "FI",
         sbirka1 = "JCM",
         cisrada3 = "Z", 
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            # podsbirka == "25" ~ "166", # KONFLIKT !!!
                            # podsbirka == "25" ~ "168",
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() %>% 
  # -------------------------------------------------- prirc4 - part 2
  mutate(Mp0 = str_pad(porc104, maxp, pad = 0),
         Ms0 = str_pad(subc105, maxs, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(sign_prirc, Mp0, Mslash, rok12), 
                         paste0(sign_prirc, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
nabpozn29

puvmaj28 
(prisp87)

```{r}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       # popis muze mit ____ charakterů
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
          is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  select(-is_valid_date) %>%  # , -is_valid_date2
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J"),
         cennab27 = ifelse(str_detect(zpusobNabyti, ",-"), str_extract(zpusobNabyti, "\\d+,-"), NA), # 
         # POZN29_zpusobNabyti = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA),
         POZN29_zpusobNabyti = ifelse(zpnab23 == "J", paste0("Způsob nabytí: ", zpusobNabyti), NA),                                        
         POZN29_odkazDoklad = ifelse(!is.na(odkazDoklad), paste0("Odkaz na doklad: ", odkazDoklad), NA)) %>% 
  # -------------------------------------------------- nabpozn29
  unite(nabpozn29, c("POZN29_zpusobNabyti", "POZN29_odkazDoklad"), sep = "\n", na.rm = T, remove = FALSE) %>% 
  # -------------------------------------------------- puvmaj28 ; prisp87
  mutate(puvmaj28 = puvodMajitel) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, cennab27, nabpozn29, puvmaj28, .before = zdroj)


# check duplicity pricr4

check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

```

## VYRAZENI 

datvyr64 
dokvyr67 (nebudu extrahovat, nevim, co je a co neni soucasti nazvu dokumentu -> do poznamky)
poznvyr73

```{r}

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; dokvyr67 ; poznvyr73
  mutate(vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         poznvyr73 = ifelse(is.na(odpisVyrazeni), NA, paste("Odpis / převod / vyřazení atd.: ", odpisVyrazeni))) %>% 
  relocate(vyrdat64, poznvyr73, .before = zdroj)
```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r}

dd <- cc %>% 
  mutate(text3_90 = jineCislo) %>% relocate(text3_90, .after = jineCislo) %>%
  mutate(text4_91 = revize) %>% relocate(text4_91, .after = revize) %>% 
  mutate(text5_92 = sign) %>% relocate(text5_92, .after = sign) %>% 
  mutate(text6_99 = invc) %>% relocate(text5_92, .after = invc) %>% 
  relocate(text3_90, text4_91, text5_92, text6_99, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(invc5 = ifelse(!is.na(invc),  paste0(sign, str_pad(invc, 5, pad = "0")), NA)) %>% 
  relocate(invc5, .after = prirc4)
fin <- ee
```

# --------------------------------------- sign F ***in progress***

Fototéka_1985.xlsx
Fototéka_1986.xlsx
Fototéka_1987.xlsx
Fototéka_1988.xlsx
Fototéka_1989.xlsx
Fototéka_1990.xlsx
Fototéka_1991.xlsx
Fototéka_1994.xlsx
Fototéka_1995.xlsx
Fototéka_2000.xlsx
Fototéka_2001.xlsx
Fototéka_2003.xlsx  -------------------------> KK_red.xlsx/FI

## READ

```{r}
CORE_f <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "F") # warning asi ok
```

## EDA

```{r}

n_f <- nrow(CORE_f)
eda <- CORE_f

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

UPDT_f <- CORE_f

# eda
sample_n(UPDT_f, 10)

aa <- UPDT_f %>% 
  mutate(Mpref = "F",
         sbirka1 = "JCM",
         cisrada3 = "Z", 
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            # podsbirka == "25" ~ "166", # KONFLIKT !!!
                            # podsbirka == "25" ~ "168",
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() %>% 
  # -------------------------------------------------- prirc4 - part 2
  mutate(Mp0 = str_pad(porc104, maxp, pad = 0),
         Ms0 = str_pad(subc105, maxs, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(sign_prirc, Mp0, Mslash, rok12), 
                         paste0(sign_prirc, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```

# --------------------------------------- sign H ***in progress***

H 1884-2003 část1.xlsx
H 1884-2003 část2.xlsx  -------------------------> KK_red.xlsx/FI

## READ

```{r}
CORE_h <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "H") # warning asi ok
```

## EDA

```{r}

n_h <- nrow(CORE_h)
eda <- CORE_h

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

UPDT_h <- CORE_h

# eda
sample_n(UPDT_h, 10)

aa <- UPDT_h %>% 
  mutate(Mpref = "H", # sigantura urcena pani Simkovou
         sbirka1 = "JCM",
         cisrada3 = "Z", 
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  relocate(Mpref, .after = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            # podsbirka == "25" ~ "166", # KONFLIKT !!!
                            # podsbirka == "25" ~ "168",
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() %>% 
  # -------------------------------------------------- prirc4 - part 2
  mutate(Mp0 = str_pad(porc104, maxp, pad = 0),
         Ms0 = str_pad(subc105, maxs, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks, pozn20) # ok

```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
cennab27
nabpozn29

puvmaj28 

```{r ZKONTROLOVANO}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       # popis muze mit 2000 charakterů
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
          is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J"),
         cennab27 = cenaKc, 
         # POZN29_zpusobNabyti = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA),
         POZN29_zpusobNabyti = ifelse(zpnab23 == "J", paste0("Způsob nabytí: ", zpusobNabyti), NA),                                        
         POZN29_odkazDoklad = ifelse(!is.na(odkazDoklad), paste0("Odkaz na doklad: ", odkazDoklad), NA)) %>% 
  # -------------------------------------------------- nabpozn29
  unite(nabpozn29, c("POZN29_zpusobNabyti", "POZN29_odkazDoklad"), sep = "\n", na.rm = T, remove = FALSE) %>% 
  # -------------------------------------------------- puvmaj28 
  mutate(puvmaj28 = puvodMajitel) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, cennab27, nabpozn29, puvmaj28, .before = zdroj)


# check duplicity pricr4
check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

# check lengthPopis
any(bb$lengthPopis > 2000) # chceme FALSE

# check zpusob nabyti
check <- bb %>% select(zpusobNabyti, zpnab23, POZN29_zpusobNabyti, cennab27) %>% distinct()

# CLEAR

bb <- bb %>%  select(-lengthPopis, -is_valid_date, -is_valid_date2)
rm(check)

```

## VYRAZENI 

datvyr64 
dokvyr67 (nebudu extrahovat, nevim, co je a co neni soucasti nazvu dokumentu -> do poznamky)
poznvyr73

```{r}

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; dokvyr67 ; poznvyr73
  mutate(vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         poznvyr73 = ifelse(is.na(odpisVyrazeni), NA, paste("Odpis / převod / vyřazení atd.: ", odpisVyrazeni))) %>% 
  relocate(vyrdat64, poznvyr73,  .before = zdroj)
```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r}

dd <- cc %>% 
  mutate(text3_90 = jineCislo) %>% relocate(text3_90, .after = jineCislo) %>%
  mutate(text4_91 = revize) %>% relocate(text4_91, .after = revize) %>% 
  mutate(text5_92 = sign) %>% relocate(text5_92, .after = sign) %>% 
  mutate(text6_99 = invc) %>% relocate(text5_92, .after = invc) %>% 
  mutate(text7_100 = chyb_invc) %>% 
  relocate(text3_90, text4_91, text5_92, text6_99, text7_100, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(type_invc = case_when(str_detect(invc, "^[A-Za-z]*\\s*\\d+$") ~ "single",
                               str_detect(invc, "\\d+,\\s\\d+")&!str_detect(invc, "-") ~ "seznam",
                               str_detect(invc, "^\\d+\\s*-\\s*\\d+$") ~ "interval",
                               str_detect(invc, ",")&str_detect(invc, "\\d+\\s*-\\s*\\d+") ~ "sez+int",
                               is.na(invc) ~ NA,
                               TRUE ~ "tbd"),
         isDoable = ifelse(type_invc %in% c("single", "seznam", "interval")&sign %in% val_sign, T, 
                           ifelse(is.na(invc), NA, F))) %>%                                 # !!!! dulezity priznak !!!!
  relocate(type_invc, isDoable, .after = invc)

prehled <- ee %>% select(prirc4, sign, invc, type_invc, isDoable) %>% filter(!is.na(invc))
summary(as.factor(prehled$type_invc))

# ------------------------------------------------------ single 2084

single <- ee %>% filter(type_invc == "single"&isDoable == T) %>% 
  mutate(Minvc = str_extract(invc, "\\d+"),
         Msub = str_extract(invc, "[A-Za-z]+$"),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc)) %>% 
  unite(invc5, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-Minvc, -Msub, -Minvc0)

prehled_sin <- single %>% select(prirc4, invc, type_invc, invc5)

# ------------------------------------------------------ seznam 531

seznam <- ee %>% filter(type_invc == "seznam"&isDoable == T) %>% 
  mutate(numbers = invc) %>% 
  separate_rows(numbers, sep = ",") 
  # rename("numbers" = invc) %>% 
  mutate(numbers = str_trim(numbers),
         Minvc = ifelse(str_detect(numbers, "^[A-Za-z]+"), str_extract(numbers, "\\d+"), numbers),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc), 
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>%
  unite(Minvc_single, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(Minvc_single, .after = numbers) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc_single, collapse = ",")) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-numbers, Minvc, -Minvc0, -Msub, -Minvc_single) %>% 
  distinct() %>% 
  ungroup()

# ------------------------------------------------------ interval 142

interval0 <- ee %>% filter(type_invc == "interval"&isDoable == T) %>% 
  separate(invc, into = c("start", "end"), sep = "-", remove = F) %>% 
  mutate(start = as.numeric(start), end = as.numeric(end)) %>% 
  mutate(is_valid_int = ifelse(start < end, TRUE, FALSE),
         is_wrong_order = ifelse(is_valid_int == FALSE&nchar(start)==nchar(end), TRUE, FALSE)) # nebudu resit spatny poradi, at si vyresi sami..

int_y <- interval0 %>% 
  filter(is_valid_int==T) %>% 
  mutate(Linvc = as.character(purrr::map2(start, end, ~toString(seq(.x, .y, by = 1))))) %>% 
  separate_rows(Linvc, sep = ",") %>% 
  mutate(Linvc = str_trim(Linvc),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Linvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Linvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Linvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Linvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Linvc, 6, pad = "0")),
                            TRUE ~ Linvc), 
         Msub = str_extract(Linvc, "[A-Za-z]+$")) %>% 
  unite(Minvc, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc, collapse = ",")) %>% 
  select(-Linvc, -Minvc0, -Minvc, -Msub) %>% 
  distinct() %>%
  ungroup() 
 
int_n <- interval0 %>% 
  filter(is_valid_int==F) %>% 
  mutate(Minvc = paste("chybne zadany interval invc"))
 
interval <- bind_rows(int_y, int_n) %>% 
  mutate(invc5 = Minvc) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-start, -end, -is_valid_int, -is_wrong_order, -Minvc)

nrow(interval0) == nrow(interval) # neztratili jsme nejake radky cestou?
rm(interval0)

# ------------------------------------------------------ zbytek 883

# 827* NA
# 56* FALSE

nrow(ee %>% filter(is.na(isDoable))) #827

zbytek <- ee %>% filter(isDoable == F|is.na(isDoable))

nrow(single)+nrow(seznam)+nrow(interval)+nrow(zbytek)==nrow(ee) # chceme TRUE

# ------------------------------------------------------ JOIN 

ff <- bind_rows(single, seznam, interval, zbytek) %>% 
  relocate(invc5, .after = prirc4)

nrow(ff) == nrow(ee) # musi byt stejne!

# rm(aa)
# rm(bb)
# rm(cc)
# rm(dd)
# rm(ee)

fin <- ff

```

# ------------------ S A V E ------------------ 

```{r}

# ------------------------------------------------------ switch
# uprav dle excelu, ktery zpracovavas

# n <- 3640
# imp <- "signatura_A"
# df_save <- fin

# n <- 189
# # imp <- "signatura_S"
# df_save <- fin

n <- 14
# imp <- "signatura_FI"
df_save <- fin

# ------------------------------------------------------ priprava tabulky

Lpk <- c("sbirka1", "podsb2", "cisrada3", "prirc4", "invc5", "lok6","prirpla7", "prirpla8", "prirpla9", "ozn10",
         "popis11", "rok12", "pocetks13", "obal14", "evid15", "mater16", "datace17", "stav18", "popstav19", "pozn20",
         "liter21", "datnab22", "zpnab23", "typ24","doklnab25", "mena26", "cennab27", "puvmaj28", "nabpozn29", "typ30",
         "armisto31", "arkontext32", "arakce33", "arvyzk34", "arlok35", "arku36", "arparc37", "arpoz38", "nalpozn39", "naladr40",
         "nalokr41", "nalobec42", "nalcast43", "nalmc44", "nalcis45", "nalul46", "nalorc47", "nalpsc48", "stat49", "artext50",
         "polpop51", "polCES52", "polks53", "poldopl1_54", " poldopl1_55", "poldopl2_56", "poldopl2_57", "poldopl3_58", "poldopl3_59", "archiv60",
         "acvsign61", "acvmark62", "acvpozn63", "vyrdat64", "vyrduv65", "vyrtyp66", "vyrdok67", "vyrmena68", "vyrcena69", "zpub70",
         "vyrCES71", "novaj72", "poznvyr73", "predchmaj74", "userins75", "datins76", "arkontext2_77", "arkontext3_78", "arkomp79", "arSJTSK80",
         "arcizivyz81", "arnazevvyz82", "arrokvyz83", "arfirmavyz84", "arvedoucivyz85", "rokakvi86", "prisp87", 
         "text1_88", "text2_89", "text3_90", "text4_91", "text5_92", 
         "priz1_93", "priz2_94", "priz3_95", "priz4_96", "priz5_97",
         "datzap98", "text6_99", "text7_100", "text8_101", "text9_102", "text10_103", "porc104", "subc105", "puv_invc106") # 105 ; 106 jen pro pozdejsi (invc)

mus_tab <- data.frame(smazme = 1:n)

for(i in Lpk){
  if(i %in% colnames(df_save)){
    ano <- df_save %>% select(all_of(i))
    mus_tab <- cbind(mus_tab, ano)
    print("jo")
  } else{
    ne <- data.frame(rep(NA, n))
    colnames(ne) <- i
    mus_tab <- cbind(mus_tab, ne)
    print("houby")}
}

mus_tab <- mus_tab %>% select(-smazme) 

```

## full csv

```{r}

f2s <- paste0(path_kk, "import/", proj, "_import_", imp, ".csv")

if(file.exists(f2s)){
  print("You've been here before!")
  rm(f2s)
} else {
  write.table(mus_tab, file = f2s,
            quote = T, row.names = F,
            sep = ";", dec = ",",
            # na = "", fileEncoding="cp1250")
            na = "", fileEncoding = "UTF-8")
  print("Import csv  W R I T T E N  !")
  rm(f2s)
}
```
## sample

```{r}

sam <- mus_tab %>% slice(1:10) # TOP 10
sam <- sample_n(mus_tab, 10) # RNDM SMPL

f2s <- paste0(path_kk, "import/sample_", proj, "_import_", imp, ".csv")

if(file.exists(f2s)){
  print("You've been here before!")
  rm(f2s)
} else {
  write.table(sam, file = f2s,
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="UTF-8")
            # na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  rm(f2s)
}
```

## acc factor

```{r}

mus_tab$rok12 <- as.factor(mus_tab$rok12)

df_list <- split(mus_tab, mus_tab$rok12)

for (i in seq_along(df_list)) {
  subset_df <- df_list[[i]]
  group_name <- unique(subset_df$rok12)
  # write.csv(subset_df, paste0(path_kk, "import/", proj, "_import_", group_name, ".csv"), row.names = FALSE)
  write.table(subset_df, file = paste0(path_kk, "import/roky/", proj, "_import_", group_name, ".csv"),
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="UTF-8")
}
```

