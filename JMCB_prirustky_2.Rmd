---
title: "JMCB_prirustky_2"
author: "Kateřina Křížová"
date: "2024-03-01"
output: pdf_document
---

druha varka prirustku JMCB k migraci

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=FALSE, fig.dim = c(8, 4))

# PACKAGES

# install.packages("tidyverse", dependencies = T)
# install.packages("readxl")
# install.packages("stringr")
# install.packages("stringi")
# install.packages("mdbr")
# install.packages("RODBC")
# install.packages("odbc")
# install.packages("xlsx")
# install.packages("data.table")
# install.packages("Matrix")
require(tidyverse)
require(readxl)
require(xlsx) # write excel in sheets
require(stringr) # ::str_split_fixed
require(stringi) # ::stri_detect_fixed - detect empty string
require(mdbr) # ::read_mdb
require(RODBC) # ::read_mdb
require(odbc) # ::read_mdb
library(Matrix) 
library(data.table) # ::rbindlist 

```

# PATHS ; PROJ INFO ; FCE

```{r}

proj <- "JMCB"

path_proj <- "M:/03 klienti/kraj jihocesky/jihoceske muzeum v ceskych budejovicich - JMCB/03 migrace/jmcb migrace 2023/"
path_kk <- paste0(path_proj, "KK_workspace/")

# path_data <- "M:/03 klienti/kraj jihocesky/jihoceske muzeum v ceskych budejovicich - JMCB/2023_PK/zdrojdat/orig/"


# _______________________________________ FUNKCE_________________________________________

# Read and merge excel sheets (## READ)

# read_excel_allsheets <- function(filename, tibble = FALSE) {
#     # I prefer straight data.frames
#     # but if you like tidyverse tibbles (the default with read_excel)
#     # then just pass tibble = TRUE
#     sheets <- readxl::excel_sheets(filename)
#     x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X, col_types = "text", col_names = F,))
#     if(!tibble) x <- lapply(x, as.data.frame)
#     names(x) <- sheets
#     x
# }

# _____________________________________ SIGN INVC ________________________________________

val_sign <- c("MDRH-Ff","MDRH-Kpl","A-P","MDRH-F","MDRH-P-Čul","MDRH-St","MDRH-Sz","PNŠ","PVS","PVU",
              "MDRH-K","MDRH-Kf","MDRH-S","MDRH-Sf","PFi","PND","PPT","PST","PUPR","A","D",
              "F","Fd","Fi","Fo","Fs","G","GK","H","HB","IT","K","LA","M","ME","Mi","MP","N","O",
              "P","PAK","PM","PN","PP","PT","PUPC","R","S","ST","UP","V","VS","ZV","B","ZE") # podsbirky, ktere maji v MUS definovanou masku


mask2 <- c("MDRH-Ff", "MDRH-Kpl")
mask3 <- c("A-P","MDRH-F","MDRH-P-Čul","MDRH-St","MDRH-Sz","PNŠ","PVS","PVU")
mask4 <- c("MDRH-K","MDRH-Kf","MDRH-S","MDRH-Sf","PFi","PND","PPT","PST","PUPR")
mask5 <- c("A","D","F","Fd","Fi","Fo","Fs","G","GK","H","HB","IT","K","LA","M","ME","Mi","MP","N","O",
           "P","PAK","PM","PN","PP","PT","PUPC","R","S","ST","UP","V","VS","ZV")
mask6 <- c("B","ZE")

```

# ------------------------------ IMPORTOVANO sign A

A-1984.xlsx
A-1985.xlsx
A-1986.xlsx
A-1987.xlsx
A-1988 pokrač..xlsx
A-1984.xlsx
(A-1988.xlsx) -> jiz soucasti A-1988 pokrač..xlsx
A-1989.xlsx
A-1990.xlsx
A-1991.xlsx  -------------------------> KK_red.xlsx/A

## READ

```{r, warning = F}
CORE_a <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "A") # warning asi ok
```

## EDA

```{r}

n_a <- nrow(CORE_a)
eda <- CORE_a

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>% 
  unite(check, c("prirc", "rok"), sep = "/", remove = F) %>% 
  select(check, prirc, rok) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(check==1) # chceme 0

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r ZKONTROLOVANO, warning=FALSE}

UPDT_a <- CORE_a

# eda
sample_n(UPDT_a, 10)

a <- UPDT_a %>% 
  mutate(Mpref = "A",
         sbirka1 = "JCM",
         cisrada3 = "A",
         prirvyraz9 = ifelse(isRed==T, 1, 0), 
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, prirvyraz9, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            podsbirka == "25"&sign %in% c("D", "H") ~ "166", # KONFLIKT !!!
                            podsbirka == "25"&str_detect(sign, "MDRH") ~ "167",
                            podsbirka == "25"&sign %in% c("O", "PVS", "VS") ~ "168", 
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>%  # Mprirc jen pracovni, bez vednul, jen pro group a nastaveni subcisel
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% # Mpref definovano v POVINNE
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() 
  # -------------------------------------------------- ¨vedouci nuly -> kontrola a doplneni v Mp0 a Ms0
vednul <- a %>% select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()

  # -------------------------------------------------- prirc4 - part 2
aa <- a %>% 
  mutate(Mp0 = ifelse(rok12 == "1988", str_pad(porc104, 4, pad = 0), str_pad(porc104, 3, pad = 0)),
         Ms0 = str_pad(subc105, 2, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>%
  # -------------------------------------------------- pocetks13
 mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks, pozn20) # ok

check <- aa %>% select(podsbirka, podsb2, sign) %>% distinct()
# check <- aa %>% select(prirc, rok12, Mpref, Mp0, Ms0, prirc4) %>% distinct()
```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
nabpozn29

puvmaj28 

```{r ZKONTROLOVANO}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       # popis muze mit 2000 charakterů
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
          is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  # -------------------------------------------------- zpnab23 ; doklnab25 ; cennab27
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J"),
         doklnab25 = odkazDoklad,
         cennab27 = ifelse(str_detect(zpusobNabyti, ",-"), str_extract(zpusobNabyti, "\\d+,-"), NA),
         cennab27 = gsub(",-", "", cennab27)) %>% 
  # -------------------------------------------------- nabpozn29
  mutate(nabpozn29 = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA)) %>% 
  # -------------------------------------------------- puvmaj28 
  mutate(puvmaj28 = puvodMajitel) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, doklnab25, cennab27, nabpozn29, puvmaj28, .before = zdroj)


# check duplicity pricr4
check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

# check lengthPopis
any(bb$lengthPopis > 2000) # chceme FALSE

# check zpusob nabyti
# check <- bb %>% select(zpusobNabyti, zpnab23, POZN29_zpusobNabyti, cennab27) %>% distinct()

# CLEAR

bb <- bb %>%  select(-lengthPopis, -is_valid_date, -is_valid_date2)
rm(check)

```

## VYRAZENI 

datvyr64 
dokvyr67 (nebudu extrahovat, nevim, co je a co neni soucasti nazvu dokumentu -> do poznamky)
poznvyr73

```{r ZKONTROLOVANO}

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; dokvyr67 ; poznvyr73
  mutate(vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         poznvyr73 = ifelse(is.na(odpisVyrazeni), NA, paste("Odpis / převod / vyřazení atd.: ", odpisVyrazeni))) %>% 
  relocate(vyrdat64, poznvyr73,  .before = zdroj)

check <- cc %>% select(prirvyraz9, odpisVyrazeni, vyrdat64, poznvyr73) %>% distinct()
rm(check)

```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ) # z prvni varky
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r ZKONTROLOVANO}

dd <- cc %>% 
  mutate(text3_90 = jineCislo) %>% relocate(text3_90, .after = jineCislo) %>%
  mutate(text4_91 = revize) %>% relocate(text4_91, .after = revize) %>% 
  mutate(text5_92 = sign) %>% relocate(text5_92, .after = sign) %>% 
  mutate(text6_99 = invc) %>% relocate(text5_92, .after = invc) %>% 
  relocate(text3_90, text4_91, text5_92, text6_99, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(type_invc = case_when(str_detect(invc, "^[A-Za-z]*\\s*\\d+$") ~ "single",
                               str_detect(invc, "\\d+,\\s\\d+")&!str_detect(invc, "-") ~ "seznam",
                               str_detect(invc, "^\\d+\\s*-\\s*\\d+$") ~ "interval",
                               str_detect(invc, ",")&str_detect(invc, "\\d+\\s*-\\s*\\d+") ~ "sez+int",
                               is.na(invc) ~ NA,
                               TRUE ~ "tbd"),
         isDoable = ifelse(type_invc %in% c("single", "seznam", "interval")&sign %in% val_sign, T, 
                           ifelse(is.na(invc), NA, F))) %>%                                 # !!!! dulezity priznak !!!!
  relocate(type_invc, isDoable, .after = invc)

prehled <- ee %>% select(prirc4, sign, invc, type_invc, isDoable) %>% filter(!is.na(invc))
summary(as.factor(prehled$type_invc))

# ------------------------------------------------------ single 2084

single <- ee %>% filter(type_invc == "single"&isDoable == T) %>% 
  mutate(Minvc = str_extract(invc, "\\d+"),
         Msub = str_extract(invc, "[A-Za-z]+$"),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc)) %>% 
  unite(invc5, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-Minvc, -Msub, -Minvc0)

prehled_sin <- single %>% select(prirc4, invc, type_invc, invc5)

# ------------------------------------------------------ seznam 531 -------- FUNKCNI -> oprav i u dalsich

seznam <- ee %>% filter(type_invc == "seznam"&isDoable == T) %>% 
  mutate(numbers = invc) %>% 
  separate_rows(numbers, sep = ",") %>% 
  # rename("numbers" = invc) %>% 
  mutate(numbers = str_trim(numbers),
         Minvc = ifelse(str_detect(numbers, "^[A-Za-z]+"), str_extract(numbers, "\\d+"), numbers),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc),
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>% 
  unite(Minvc_single, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(Minvc_single, .after = numbers) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc_single, collapse = ",")) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-numbers, -Minvc, -Minvc0, -Msub, -Minvc_single) %>% 
  distinct() %>% 
  ungroup()

prehled_sez <- seznam %>% select(prirc4, sign, invc, type_invc, invc5)

# ------------------------------------------------------ interval 142

interval0 <- ee %>% filter(type_invc == "interval"&isDoable == T) %>% 
  separate(invc, into = c("start", "end"), sep = "-", remove = F) %>% 
  mutate(start = as.numeric(start), end = as.numeric(end)) %>% 
  mutate(is_valid_int = ifelse(start < end, TRUE, FALSE),
         is_wrong_order = ifelse(is_valid_int == FALSE&nchar(start)==nchar(end), TRUE, FALSE)) # nebudu resit spatny poradi, at si vyresi sami..

int_y <- interval0 %>% 
  filter(is_valid_int==T) %>% 
  mutate(Linvc = as.character(purrr::map2(start, end, ~toString(seq(.x, .y, by = 1))))) %>% 
  separate_rows(Linvc, sep = ",") %>% 
  mutate(Linvc = str_trim(Linvc),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Linvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Linvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Linvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Linvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Linvc, 6, pad = "0")),
                            TRUE ~ Linvc),
         Msub = str_extract(Linvc, "[A-Za-z]+$")) %>% 
  unite(Minvc, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc, collapse = ",")) %>% 
  select(-Linvc, -Minvc0, -Minvc, -Msub) %>% 
  distinct() %>%
  ungroup() 
 
int_n <- interval0 %>% 
  filter(is_valid_int==F) %>% 
  mutate(Minvc = paste("chybne zadany interval invc"),
         invc5 = NA)
 
interval <- bind_rows(int_y, int_n) %>% 
  # mutate(invc5 = Minvc) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-start, -end, -is_valid_int, -is_wrong_order, -Minvc)

nrow(interval0) == nrow(interval) # neztratili jsme nejake radky cestou?
rm(interval0)

# ------------------------------------------------------ zbytek 883

# 827* NA
# 56* FALSE

nrow(ee %>% filter(is.na(isDoable))) #827

zbytek <- ee %>% filter(isDoable == F|is.na(isDoable))
not_doable <- zbytek %>% filter(isDoable == F) %>% select(prirc4, sign, invc)
write.table(not_doable, file = paste0(path_kk, "vystupy/", proj, "_problematickaINVC_signA.csv"),
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="UTF-8")

nrow(single)+nrow(seznam)+nrow(interval)+nrow(zbytek)==nrow(ee) # chceme TRUE

# ------------------------------------------------------ JOIN 

ff <- bind_rows(single, seznam, interval, zbytek) %>% 
  relocate(invc5, .after = prirc4)

nrow(ff) == nrow(ee) # musi byt stejne!

# rm(aa)
# rm(bb)
# rm(cc)
# rm(dd)
# rm(ee)

fin <- ff

check <- ff %>% select(prirc4, invc5, sign, invc, type_invc) %>% distinct()

```

# ------------------------------ IMPORTOVANO sign S

2003 Archeologie S.xlsx
2004 Archeologie S.xlsx
2005 Archeologie S.xlsx  -------------------------> KK_red.xlsx/S

## READ

```{r}
CORE_s <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "S") # warning asi ok
```

## EDA

```{r}

n_s <- nrow(CORE_s)
eda <- CORE_s

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>% 
  unite(check, c("prirc", "rok"), sep = "/", remove = F) %>% 
  select(check, prirc, rok) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(check==1) # chceme 0

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

UPDT_s <- CORE_s

# eda
sample_n(UPDT_s, 10)

a <- UPDT_s %>% 
  mutate(Mpref = "S",
         sbirka1 = "JCM",
         cisrada3 = "S", 
         prirvyraz9 = ifelse(isRed==T, 1, 0), 
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, prirvyraz9, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
   mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            podsbirka == "25"&sign %in% c("D", "H") ~ "166", # KONFLIKT !!!
                            podsbirka == "25"&str_detect(sign, "MDRH") ~ "167",
                            podsbirka == "25"&sign %in% c("O", "PVS", "VS") ~ "168", 
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup()

# -------------------------------------------------- vedouci nuly -> kontrola a doplneni v Mp0 a Ms0

vednul <- a %>% select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()

  # -------------------------------------------------- prirc4 - part 2
aa <- a %>%  
  mutate(Mp0 = str_pad(porc104, 3, pad = 0),
         Ms0 = str_pad(subc105, 1, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
 mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>%  
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

check <- aa %>% select(podsbirka, podsb2, sign) %>% distinct()

```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
nabpozn29

puvmaj28 
(prisp87)

```{r}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       #
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
          is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  select(-is_valid_date) %>%  # , -is_valid_date2
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J")) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, .before = zdroj)


# check duplicity pricr4

check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

```


## VYRAZENI 

datvyr64 
dokvyr67 (nebudu extrahovat, nevim, co je a co neni soucasti nazvu dokumentu -> do poznamky)
poznvyr73

```{r}

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; dokvyr67 ; poznvyr73
  mutate(vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         poznvyr73 = ifelse(is.na(odpisVyrazeni), NA, paste("Odpis / převod / vyřazení atd.: ", odpisVyrazeni))) %>% 
  relocate(vyrdat64, poznvyr73,  .before = zdroj)
```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r}

dd <- cc %>% 
  mutate(text3_90 = jineCislo) %>% relocate(text3_90, .after = jineCislo) %>%
  mutate(text4_91 = revize) %>% relocate(text4_91, .after = revize) %>% 
  mutate(text5_92 = sign) %>% relocate(text5_92, .after = sign) %>% 
  mutate(text6_99 = invc) %>% relocate(text5_92, .after = invc) %>% 
  relocate(text3_90, text4_91, text5_92, text6_99, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(type_invc = case_when(str_detect(invc, "^[A-Za-z]*\\s*\\d+$") ~ "single",
                               str_detect(invc, "\\d+,\\s\\d+")&!str_detect(invc, "-") ~ "seznam",
                               str_detect(invc, "^\\d+\\s*-\\s*\\d+$") ~ "interval",
                               str_detect(invc, ",")&str_detect(invc, "\\d+\\s*-\\s*\\d+") ~ "sez+int",
                               is.na(invc) ~ NA,
                               TRUE ~ "tbd"),
         isDoable = ifelse(type_invc %in% c("single", "seznam", "interval")&sign %in% val_sign, T, 
                           ifelse(is.na(invc), NA, F))) %>%                                 # !!!! dulezity priznak !!!!
  relocate(type_invc, isDoable, .after = invc)

prehled <- ee %>% select(prirc4, sign, invc, type_invc, isDoable) %>% filter(!is.na(invc))
summary(as.factor(prehled$type_invc))

# ------------------------------------------------------ single 143

single <- ee %>% filter(type_invc == "single"&isDoable == T) %>% 
  mutate(Minvc = str_extract(invc, "\\d+"),
         Msub = str_extract(invc, "[A-Za-z]+$"),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc)) %>% 
  unite(invc5, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-Minvc, -Msub, -Minvc0)

prehled_sin <- single %>% select(prirc4, invc, type_invc, invc5)

# ------------------------------------------------------ seznam 20

seznam <- ee %>% filter(type_invc == "seznam"&isDoable == T) %>% 
  mutate(numbers = invc) %>% 
  separate_rows(numbers, sep = ",") %>% 
  # rename("numbers" = invc) %>% 
  mutate(numbers = str_trim(numbers),
         Minvc = ifelse(str_detect(numbers, "^[A-Za-z]+"), str_extract(numbers, "\\d+"), numbers),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc), 
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>% 
  unite(Minvc_single, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(Minvc_single, .after = numbers) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc_single, collapse = ",")) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-numbers, -Minvc, -Minvc0, -Msub, -Minvc_single) %>% 
  distinct() %>% 
  ungroup()

# ------------------------------------------------------ interval 20

interval0 <- ee %>% filter(type_invc == "interval"&isDoable == T) %>% 
  separate(invc, into = c("start", "end"), sep = "-", remove = F) %>% 
  mutate(start = as.numeric(start), end = as.numeric(end)) %>% 
  mutate(is_valid_int = ifelse(start < end, TRUE, FALSE),
         is_wrong_order = ifelse(is_valid_int == FALSE&nchar(start)==nchar(end), TRUE, FALSE)) # nebudu resit spatny poradi, at si vyresi sami..

int_y <- interval0 %>% 
  filter(is_valid_int==T) %>% 
  mutate(Linvc = as.character(purrr::map2(start, end, ~toString(seq(.x, .y, by = 1))))) %>% 
  separate_rows(Linvc, sep = ",") %>% 
  mutate(Linvc = str_trim(Linvc),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Linvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Linvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Linvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Linvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Linvc, 6, pad = "0")),
                            TRUE ~ Linvc),
         Msub = str_extract(Linvc, "[A-Za-z]+$")) %>% 
  unite(Minvc, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc, collapse = ",")) %>% 
  select(-Linvc, -Minvc0, -Minvc, -Msub) %>% 
  distinct() %>%
  ungroup() 
#  
# int_n <- interval0 %>% 
#   filter(is_valid_int==F) %>% 
#   mutate(Minvc = paste("chybne zadany interval invc"),
#          invc5 = NA)
 
interval <- int_y %>% 
# interval <- bind_rows(int_y, int_n) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-start, -end, -is_valid_int, -is_wrong_order)

nrow(interval0) == nrow(interval) # neztratili jsme nejake radky cestou?
rm(interval0)

# ------------------------------------------------------ zbytek 6

# 4* NA
# 2* FALSE

nrow(ee %>% filter(is.na(isDoable))) #827

zbytek <- ee %>% filter(isDoable == F|is.na(isDoable))
not_doable <- zbytek %>% filter(isDoable == F) %>% select(prirc4, sign, invc)
write.table(not_doable, file = paste0(path_kk, "vystupy/", proj, "_problematickaINVC_signS.csv"),
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="UTF-8")

nrow(single)+nrow(seznam)+nrow(interval)+nrow(zbytek)==nrow(ee) # chceme TRUE

# ------------------------------------------------------ JOIN 

ff <- bind_rows(single, seznam, interval, zbytek) %>% 
  relocate(invc5, .after = prirc4)

nrow(ff) == nrow(ee) # musi byt stejne!

# rm(aa)
# rm(bb)
# rm(cc)
# rm(dd)
# rm(ee)

fin <- ff

check <- ff %>% select(prirc4, invc5, sign, invc, type_invc) %>% distinct()
```

# ------------------------------ IMPORTOVANO sign DCM / DC

Diecézní muzeum.xlsx  -------------------------> KK_red.xlsx/DCM

## READ

```{r}
CORE_dcm <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "DCM") # warning asi ok
```

## EDA

```{r}

n_dcm <- nrow(CORE_dcm)
eda <- CORE_dcm

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>%
  group_by(invc) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(isDupl==1) # chceme 0

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

sort(unique(CORE_dcm$podsbirka))

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

# eda
sample_n(CORE_dcm, 10)

aa <- CORE_dcm %>% 
  mutate(Mpref = "DCM",
         sbirka1 = "JCM",
         cisrada3 = "DCM", 
         prirvyraz9 = ifelse(isRed==T, 1, 0),
         popis11 = popis,
         rok12 = "1900",
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, prirvyraz9, popis11, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
   mutate(Mpodsb = ifelse(str_detect(podsbirka, "^\\d+"), str_extract(podsbirka, "^\\d+"), NA), 
          podsb2 = case_when(Mpodsb == "1" ~ "151",
                            Mpodsb == "10" ~ "158",
                            Mpodsb == "11" ~ "160",
                            Mpodsb == "13" ~ "154",
                            Mpodsb == "15" ~ "161",
                            # Mpodsb == "16 - VU" ~ "", # není v MUS definovana
                            Mpodsb == "17" ~ "155",
                            Mpodsb == "18" ~ "159",
                            Mpodsb == "19" ~ "162",
                            Mpodsb == "20 - VU" ~ "164",
                            Mpodsb == "21 - VU" ~ "156",
                            # Mpodsb == "22 - VU" ~ "156", # není v MUS definovana
                            # Mpodsb == "23 - VU" ~ "156", # není v MUS definovana
                            # Mpodsb == "24 - VU" ~ "156", # není v MUS definovana
                            Mpodsb == "25"&sign %in% c("D", "H") ~ "166", # KONFLIKT !!!
                            Mpodsb == "25"&str_detect(sign, "MDRH") ~ "167",
                            Mpodsb == "25"&sign %in% c("O", "PVS", "VS") ~ "168", 
                            Mpodsb == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("podsb.: neuvedena"),
                                  podsb2 == "99" ~ paste0("podsb: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4
  mutate(prirc = invc, 
         Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc)),
         Mp0 = str_pad(Mporc, 4, pad = 0),
         Ms0 = str_pad(Msub, 1, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(Msub), paste0(Mpref, Mp0), 
                         paste0(Mpref, Mp0, Mdash, Ms0))) %>% 
  ungroup() %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("ks: neuveden"),
                                    TRUE ~ NA),
         POZN20_podsb = ifelse(!is.na(podsbirka), paste0("podsbirka: ", podsbirka), NA),
         POZN20_vypuj = ifelse(!is.na(vypujcka), paste0("(pole bez hlavicky): ", vypujcka), NA),
         # POZN20_loka = ifelse(!is.na(lokace), paste0("lokace: ", lokace), NA),
         POZN20_pozn = ifelse(!is.na(poznamka), paste0("poznámka: ", poznamka), NA)) %>% 
  # -------------------------------------------------- pozn20 a texty
  unite(pozn20, c("POZN20_podsb", "POZN20_pocetks", "POZN20_pozn", "POZN20_vypuj"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  mutate(text4_91 = revize, 
         text5_92 = sign,
         text9_102 = lokace) %>% 
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj) 

fin <- aa

  # parkrat zkontroluj
# sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
# sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```


# ------------------------------ IMPORTOVANO sign FI

Př. kniha -Filmotéka.xlsx  -------------------------> KK_red.xlsx/FI

## READ

```{r}
CORE_fi <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "FI") # warning asi ok
```

## EDA

```{r}

n_fi <- nrow(CORE_fi)
eda <- CORE_fi

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>% 
  unite(check, c("prirc", "rok"), sep = "/", remove = F) %>% 
  select(check, prirc, rok) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(check==1) # chceme 0

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

```
## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

UPDT_fi <- CORE_fi

# eda
sample_n(UPDT_fi, 10)

a <- UPDT_fi %>% 
  mutate(Mpref = "FI",
         sbirka1 = "JCM",
         cisrada3 = "FI", 
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            podsbirka == "25"&sign %in% c("D", "H") ~ "166", # KONFLIKT !!!
                            podsbirka == "25"&str_detect(sign, "MDRH") ~ "167",
                            podsbirka == "25"&sign %in% c("O", "PVS", "VS") ~ "168", 
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() 
  # -------------------------------------------------- ¨vedouci nuly -> kontrola a doplneni v Mp0 a Ms0

vednul <- a %>% select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()

  # -------------------------------------------------- prirc4 - part 2
aa <- a %>%
  mutate(Mp0 = str_pad(porc104, 1, pad = 0),
         Ms0 = str_pad(subc105, 1, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(sign_prirc, Mp0, Mslash, rok12), 
                         paste0(sign_prirc, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
nabpozn29

puvmaj28 
(prisp87)

```{r}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       # popis muze mit ____ charakterů
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
          is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  select(-is_valid_date) %>%  # , -is_valid_date2
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J")) %>% 
  # -------------------------------------------------- puvmaj28 ; prisp87
  mutate(puvmaj28 = puvodMajitel) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, puvmaj28, .before = zdroj)


# check duplicity pricr4

check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

```


## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r}

dd <- bb %>% 
  mutate(text3_90 = jineCislo) %>% relocate(text3_90, .after = jineCislo) %>%
  mutate(text4_91 = revize) %>% relocate(text4_91, .after = revize) %>% 
  mutate(text5_92 = sign) %>% relocate(text5_92, .after = sign) %>% 
  mutate(text6_99 = invc) %>% relocate(text5_92, .after = invc) %>% 
  relocate(text3_90, text4_91, text5_92, text6_99, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(invc5 = ifelse(!is.na(invc),  paste0(sign, str_pad(invc, 5, pad = "0")), NA)) %>% 
  relocate(invc5, .after = prirc4)
fin <- ee
```

# ------------------------------ IMPORTOVANO sign F 

Fototéka_1985.xlsx
Fototéka_1986.xlsx
Fototéka_1987.xlsx
Fototéka_1988.xlsx
Fototéka_1989.xlsx
Fototéka_1990.xlsx
Fototéka_1991.xlsx
Fototéka_1994.xlsx
Fototéka_1995.xlsx
Fototéka_2000.xlsx
Fototéka_2001.xlsx
Fototéka_2003.xlsx  -------------------------> KK_red.xlsx/F

## READ

```{r}
# CORE_f <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "F")
CORE_f <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "F", col_types="text") # hooodne warnings a chybejici data, vyreseno col:types 
```

## EDA

```{r}

n_f <- nrow(CORE_f)
eda <- CORE_f

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>% 
  unite(check, c("prirc", "rok"), sep = "/", remove = F) %>% 
  select(check, prirc, rok) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(check==1) # chceme 0

# rm(eda)

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

UPDT_f <- CORE_f

# eda
sample_n(UPDT_f, 10)

a <- UPDT_f %>% 
  mutate(Mpref = "F",
         sbirka1 = "JCM",
         cisrada3 = "F", 
         # prirvyraz9 = ifelse(isRed==T, 1, 0), 
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            podsbirka == "25"&sign %in% c("D", "H") ~ "166", # KONFLIKT !!!
                            podsbirka == "25"&str_detect(sign, "MDRH") ~ "167",
                            podsbirka == "25"&sign %in% c("O", "PVS", "VS") ~ "168", 
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() 

# -------------------------------------------------- vedouci nuly -> kontrola a doplneni v Mp0 a Ms0
vednul <- a %>% select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()

# -------------------------------------------------- prirc4 - part 2
aa <- a %>% 
  mutate(Mp0 = str_pad(porc104, 3, pad = 0),
         Ms0 = str_pad(subc105, 1, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
cennab27
nabpozn29

puvmaj28 

```{r ZKONTROLOVANO}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       # popis muze mit 2000 charakterů
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   # mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
   #        is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
   #        is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
   # mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
   mutate(Mdat_ser = as.numeric(datumNabyti),
          Mdat = format(as.Date(Mdat_ser, origin = "1899-12-30"), "%d.%m.%Y")) %>% 
          # Mdat = case_when(str_detect(datumNabyti, "^.....$") ~ Mdat_trans,
          #                 str_detect(datumNabyti, ",") ~ sub(",", ".", datumNabyti),
          #                 str_detect(datumNabyti, "^r\\.") ~ paste0("01.01.", str_extract(datumNabyti, "\\d+")), 
          #                 str_detect(datumNabyti, "^K") ~ sub("K", "", datumNabyti), 
          #                 str_detect(datumNabyti, "\\.$") ~ sub("\\.$", "", datumNabyti), 
          #                 str_detect(datumNabyti, "^19..$") ~ paste0("01.01.", datumNabyti),
          #                 str_detect(datumNabyti, ".*X.*") ~ str_replace(datumNabyti, "X", "10"),
          #                 TRUE ~ datumNabyti)) %>%
   mutate(is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% relocate(Mdat, is_valid_date2, .after = datumNabyti) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  relocate(datnab22, .after = datumNabyti) %>% 
  # select(-Mdat_ser, -Mdat, -is_valid_date) %>% 
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J"),
         doklnab25 = odkazDoklad,
         cennab27 = ifelse(str_detect(zpusobNabyti, ",-|Kčs"), str_extract(zpusobNabyti, "\\d+,-|\\d+ Kčs"), NA),
         cennab27 = str_trim(gsub(",-|Kčs", "", cennab27)),
         cennab27 = case_when(zpusobNabyti == "koupě 130,50,-" ~ "130.50",
                              zpusobNabyti == "koupě 67,50,-" ~ "67.50",
                              TRUE ~ cennab27)) %>% 
  # -------------------------------------------------- nabpozn29
  mutate(nabpozn29 = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA)) %>% 
  # -------------------------------------------------- puvmaj28 ; prisp87 
  mutate(puvmaj28 = puvodMajitel,
         prisp87 = ifelse(str_detect(zpusobNabyti, "Foto:"), str_remove(zpusobNabyti, "Foto: "), NA)) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, cennab27, nabpozn29, puvmaj28, prisp87, .before = zdroj)


# check duplicity pricr4
check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

# check lengthPopis
any(bb$lengthPopis > 2000) # chceme FALSE

# check zpusob nabyti
check <- bb %>% select(zpusobNabyti, zpnab23,cennab27) %>% distinct()

# CLEAR

bb <- bb %>%  select(-lengthPopis, -is_valid_date, -is_valid_date2)
rm(check)

```

## VYRAZENI 

pole odpis/převod/pozn je všude prázdné

```{r}

cc <- bb  # zadne zaznamy ve sloupci odpisVyrazeni
  # # -------------------------------------------------- datvyr64 ; dokvyr67 ; poznvyr73
  # mutate(vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
  #        poznvyr73 = ifelse(is.na(odpisVyrazeni), NA, paste("Odpis / převod / vyřazení atd.: ", odpisVyrazeni))) %>% 
  # relocate(vyrdat64, poznvyr73,  .before = zdroj)
```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r}

dd <- cc %>% 
  # mutate(text3_90 = jineCislo) %>% relocate(text3_90, .after = jineCislo) %>%
  # mutate(text4_91 = revize) %>% relocate(text4_91, .after = revize) %>% 
  mutate(text5_92 = sign) %>% relocate(text5_92, .after = sign) %>% 
  mutate(text6_99 = invc) %>% relocate(text5_92, .after = invc) %>% 
  # mutate(text7_100 = chyb_invc) %>%
  relocate(text5_92, text6_99, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(sign = "F", # kde chybi, doplnit, rikala pani Simkova
        type_invc = case_when(str_detect(invc, "^[A-Za-z]*\\s*\\d+$") ~ "single",
                               str_detect(invc, "\\d+,\\s\\d+")&!str_detect(invc, "-") ~ "seznam",
                               str_detect(invc, "^\\d+\\s*-\\s*\\d+$") ~ "interval",
                               str_detect(invc, ",")&str_detect(invc, "\\d+\\s*-\\s*\\d+") ~ "sez+int",
                               is.na(invc) ~ NA,
                               TRUE ~ "tbd"),
         isDoable = ifelse(type_invc %in% c("single", "seznam", "interval")&sign %in% val_sign, T, 
                           ifelse(is.na(invc), NA, F))) %>%                                 # !!!! dulezity priznak !!!!
  relocate(type_invc, isDoable, .after = invc)

prehled <- ee %>% select(prirc4, sign, invc, type_invc, isDoable) %>% filter(!is.na(invc))
summary(as.factor(prehled$type_invc))

# ------------------------------------------------------ single 1784

single <- ee %>% filter(type_invc == "single"&isDoable == T) %>% 
  mutate(Minvc = str_extract(invc, "\\d+"),
         Msub = str_extract(invc, "[A-Za-z]+$"),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc)) %>% 
  unite(invc5, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-Minvc, -Msub, -Minvc0)

prehled_sin <- single %>% select(prirc4, invc, type_invc, invc5)

# ------------------------------------------------------ seznam 12

seznam <- ee %>% filter(type_invc == "seznam"&isDoable == T) %>% 
  mutate(numbers = invc) %>% 
  separate_rows(numbers, sep = ",") %>% 
  # rename("numbers" = invc) %>% 
  mutate(numbers = str_trim(numbers),
         Minvc = ifelse(str_detect(numbers, "^[A-Za-z]+"), str_extract(numbers, "\\d+"), numbers),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc), 
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>%
  unite(Minvc_single, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(Minvc_single, .after = numbers) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc_single, collapse = ",")) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-numbers, -Minvc, -Minvc0, -Msub, -Minvc_single) %>% 
  distinct() %>% 
  ungroup()


# ------------------------------------------------------ zbytek 96

# 96* NA
# 0* FALSE

nrow(ee %>% filter(is.na(isDoable))) # 96

zbytek <- ee %>% filter(isDoable == F|is.na(isDoable))
not_doable <- zbytek %>% filter(isDoable == F) %>% select(prirc4, sign, invc)                         # vse doable
# write.table(not_doable, file = paste0(path_kk, "vystupy/", proj, "_problematickaINVC_signF.csv"),
#             quote = T, row.names = F, 
#             sep = ";", dec = ",", 
#             na = "", fileEncoding="UTF-8") 

nrow(single)+nrow(seznam)+nrow(zbytek)==nrow(ee) # chceme TRUE

# ------------------------------------------------------ JOIN 

ff <- bind_rows(single, seznam, zbytek) %>% 
  relocate(invc5, .after = prirc4)

nrow(ff) == nrow(ee) # musi byt stejne!

# rm(aa)
# rm(bb)
# rm(cc)
# rm(dd)
# rm(ee)

fin <- ff

```

# ------------------------------ IMPORTOVANO sign H

H 1884-2003 část1.xlsx
H 1884-2003 část2.xlsx  -------------------------> KK_red.xlsx/H

## READ

```{r}
CORE_h <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "H") # warning asi ok
```

## EDA

```{r}

n_h <- nrow(CORE_h)
eda <- CORE_h

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>% 
  unite(check, c("prirc", "rok"), sep = "/", remove = F) %>% 
  select(check, prirc, rok) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(check==1) # chceme 0

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

UPDT_h <- CORE_h

# eda
sample_n(UPDT_h, 10)

a <- UPDT_h %>% 
  mutate(Mpref = "H", # sigantura urcena pani Simkovou
         sbirka1 = "JCM",
         cisrada3 = "H", 
         prirvyraz9 = ifelse(isRed==T, 1, 0), 
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, prirvyraz9, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  relocate(Mpref, .after = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            podsbirka == "25"&sign %in% c("D", "H") ~ "166", # KONFLIKT !!!
                            podsbirka == "25"&str_detect(sign, "MDRH") ~ "167",
                            podsbirka == "25"&sign %in% c("O", "PVS", "VS") ~ "168", 
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
   ungroup() 
 # -------------------------------------------------- vedouci nuly -> kontrola a doplneni v Mp0 a Ms0

vednul <- a %>% select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()

 # -------------------------------------------------- prirc4 - part 2
 aa <- a %>%
   mutate(Mp0 = str_pad(porc104, 3, pad = 0),
         Ms0 = str_pad(subc105, 2, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj) 

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks, pozn20) # ok

```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
cennab27
nabpozn29

puvmaj28 

```{r ZKONTROLOVANO}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       # popis muze mit 2000 charakterů
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
          is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J"),
         doklnab25 = odkazDoklad, 
         cennab27 = str_trim(str_replace_all(cenaKc, ",-|Kčs|Kč", "")), 
         cennab27 = (str_replace_all(cennab27, ",", ".")), 
         cennab27 = case_when(cenaKc == "19,-, 20,-" ~ NA,
                              cenaKc == "80,-, 50,-"  ~ NA, 
                              TRUE ~ cennab27),
         # POZN29_zpusobNabyti = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA),
         POZN29_zpusobNabyti = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA),                                       
         POZN29_cenaNabyti = ifelse(!is.na(cenaKc), paste0("Kč: ", cenaKc), NA)) %>% 
  # -------------------------------------------------- nabpozn29
  unite(nabpozn29, c("POZN29_zpusobNabyti", "POZN29_cenaNabyti"), sep = "\n", na.rm = T, remove = FALSE) %>% 
  # -------------------------------------------------- puvmaj28 
  mutate(puvmaj28 = puvodMajitel) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, doklnab25, cennab27, nabpozn29, puvmaj28, .before = zdroj)


# check duplicity pricr4
check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

# check lengthPopis
any(bb$lengthPopis > 2000) # chceme FALSE

# check zpusob nabyti
check <- bb %>% select(zpusobNabyti, zpnab23, nabpozn29, POZN29_zpusobNabyti, POZN29_cenaNabyti, cenaKc, cennab27) %>% distinct()

# CLEAR

bb <- bb %>%  select(-lengthPopis, -is_valid_date, -is_valid_date2)
rm(check)

```

## VYRAZENI 

datvyr64 
dokvyr67 (nebudu extrahovat, nevim, co je a co neni soucasti nazvu dokumentu -> do poznamky)
poznvyr73

```{r}

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; vyrdok67 
  mutate(vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         poznvyr73 = ifelse(!is.na(odpisVyrazeni), paste0("Odpis / převod / vyřazení atd.): ", odpisVyrazeni), NA)) %>% 
  relocate(vyrdat64, poznvyr73, .before = zdroj)
```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc
text7 = chybne invc


```{r}

dd <- cc %>% 
  mutate(text3_90 = jineCislo) %>% relocate(text3_90, .after = jineCislo) %>%
  mutate(text4_91 = revize) %>% relocate(text4_91, .after = revize) %>% 
  mutate(text5_92 = sign) %>% relocate(text5_92, .after = sign) %>% 
  mutate(text6_99 = invc) %>% relocate(text5_92, .after = invc) %>% 
  mutate(text7_100 = chyb_invc) %>% 
  relocate(text3_90, text4_91, text5_92, text6_99, text7_100, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(sign = "H", 
         type_invc = case_when(str_detect(invc, "^[A-Za-z]*\\s*\\d+$") ~ "single",
                               str_detect(invc, "\\d+,\\s\\d+")&!str_detect(invc, "-") ~ "seznam",
                               str_detect(invc, "^\\d+\\s*-\\s*\\d+$") ~ "interval",
                               str_detect(invc, ",")&str_detect(invc, "\\d+\\s*-\\s*\\d+") ~ "sez+int",
                               is.na(invc) ~ NA,
                               TRUE ~ "tbd"),
         isDoable = ifelse(type_invc %in% c("single", "seznam", "interval")&sign %in% val_sign, T, 
                           ifelse(is.na(invc), NA, F))) %>%                                 # !!!! dulezity priznak !!!!
  relocate(type_invc, isDoable, .after = invc)

prehled <- ee %>% select(prirc4, sign, invc, type_invc, isDoable) %>% filter(!is.na(invc))
summary(as.factor(prehled$type_invc))

# ------------------------------------------------------ single 177

single <- ee %>% filter(type_invc == "single"&isDoable == T) %>% 
  mutate(Minvc = str_extract(invc, "\\d+"),
         Msub = str_extract(invc, "[A-Za-z]+$"),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc)) %>% 
  unite(invc5, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-Minvc, -Msub, -Minvc0)

prehled_sin <- single %>% select(prirc4, invc, type_invc, invc5)

# ------------------------------------------------------ seznam 3

seznam <- ee %>% filter(type_invc == "seznam"&isDoable == T) %>% 
  mutate(numbers = invc) %>% 
  separate_rows(numbers, sep = ",") %>% 
  # rename("numbers" = invc) %>% 
  mutate(numbers = str_trim(numbers),
         Minvc = ifelse(str_detect(numbers, "^[A-Za-z]+"), str_extract(numbers, "\\d+"), numbers),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc), 
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>%
  unite(Minvc_single, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(Minvc_single, .after = numbers) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc_single, collapse = ",")) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-numbers, -Minvc, -Minvc0, -Msub, -Minvc_single) %>% 
  distinct() %>% 
  ungroup()

# ------------------------------------------------------ interval 4

interval0 <- ee %>% filter(type_invc == "interval"&isDoable == T) %>% 
  separate(invc, into = c("start", "end"), sep = "-", remove = F) %>% 
  mutate(start = as.numeric(start), end = as.numeric(end)) %>% 
  mutate(is_valid_int = ifelse(start < end, TRUE, FALSE),
         is_wrong_order = ifelse(is_valid_int == FALSE&nchar(start)==nchar(end), TRUE, FALSE)) # nebudu resit spatny poradi, at si vyresi sami..

int_y <- interval0 %>% 
  filter(is_valid_int==T) %>% 
  mutate(Linvc = as.character(purrr::map2(start, end, ~toString(seq(.x, .y, by = 1))))) %>% 
  separate_rows(Linvc, sep = ",") %>% 
  mutate(Linvc = str_trim(Linvc),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Linvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Linvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Linvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Linvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Linvc, 6, pad = "0")),
                            TRUE ~ Linvc), 
         Msub = str_extract(Linvc, "[A-Za-z]+$")) %>% 
  unite(Minvc, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc, collapse = ",")) %>% 
  select(-Linvc, -Minvc0, -Minvc, -Msub) %>% 
  distinct() %>%
  ungroup() 
 
# int_n <- interval0 %>% 
#   filter(is_valid_int==F) %>% 
#    mutate(Minvc = paste("chybne zadany interval invc"),
#          invc5 = NA)
#  
# interval <- bind_rows(int_y, int_n) %>% 
#   # mutate(invc5 = Minvc) %>% 
#   relocate(invc5, .after = invc) %>% 
#   select(-start, -end, -is_valid_int, -is_wrong_order, -Minvc)

interval <- int_y

nrow(interval0) == nrow(interval) # neztratili jsme nejake radky cestou?
rm(interval0)

# ------------------------------------------------------ zbytek 276

# 259* NA
# 17* FALSE

nrow(ee %>% filter(is.na(isDoable))) #827

zbytek <- ee %>% filter(isDoable == F|is.na(isDoable))
not_doable <- zbytek %>% filter(isDoable == F) %>% select(prirc4, sign, invc)
write.table(not_doable, file = paste0(path_kk, "vystupy/", proj, "_problematickaINVC_signH.csv"),
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="UTF-8")

nrow(single)+nrow(seznam)+nrow(interval)+nrow(zbytek)==nrow(ee) # chceme TRUE

# ------------------------------------------------------ JOIN 

ff <- bind_rows(single, seznam, interval, zbytek) %>% 
  relocate(invc5, .after = prirc4)

nrow(ff) == nrow(ee) # musi byt stejne!

# rm(aa)
# rm(bb)
# rm(cc)
# rm(dd)
# rm(ee)

fin <- ff

```

# ------------------------------ IMPORTOVANO sign II - (a)

X excelu -------------------------> KK_red.xlsx/kniha II - (a)
ve slozce kniha II 40 excelu, z toho dva druhy zapisu, dba druhy hlavicek
zde starsi zaznamy, mene popsane

## READ

```{r}
CORE_ia <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "kniha II - (a)") # warning asi ok
```

## EDA

```{r}

n_ia <- nrow(CORE_ia)
eda <- CORE_ia

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>% 
  unite(check, c("prirc", "rok"), sep = "/", remove = F) %>% 
  select(check, prirc, rok) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(check==1) # chceme 0

# vedouci nuly a masky -> tady jeste ne, musime upravit format pric

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

UPDT_ia <- CORE_ia

# eda
sample_n(UPDT_ia, 10)

a <- UPDT_ia %>% 
  mutate(Mpref = "II", # sigantura urcena pani Simkovou
         sbirka1 = "JCM",
         cisrada3 = "II", 
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  relocate(Mpref, .after = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = "99",
         POZN20_podsb = "Podsbírka č.: neuvedena") %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = gsub("\\.$", "", prirc)) %>% 
  group_by(rok12) %>% 
  fill(Mporc, .direction = "down") %>% 
  ungroup() %>% 
  group_by(rok12, Mporc) %>% 
  mutate(porc104 = as.numeric(Mporc),
         Msub = case_when(n()!=1 ~ seq_along(Mporc), TRUE ~ NA), # seq_along(poradi)-1
         subc105 = as.numeric(Msub)) %>% 
  relocate(Mpref, Mporc, Msub, porc104, subc105, .before = zdroj) %>%
  ungroup() %>% 
  unite(Mprirc, c("Mpref", "Mporc", "Msub", "rok12"), sep = "-", na.rm = T, remove = F) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T)) %>% 
  ungroup()

# -------------------------------------------------- kontrola duplicit a vedouci nuly -> kontrola a doplneni v Mp0 a Ms0
any(is.na(a$isDupl_prirc)) # chceme FALSE

vednul <- a %>% 
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() %>% 
  select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()
 
  # -------------------------------------------------- prirc4 - part 2
aa <- a %>% 
  mutate(Mp0 = str_pad(porc104, 3, pad = 0),
         Ms0 = str_pad(subc105, 2, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, .before = zdroj) 

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
# sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks, pozn20) # ok

```

## NABYTI, PUVOD, POPIS

popis 11 (cz+nj)

datnab22 (mesic slovne, nekde jen mesic, nekde chybi rok)
cennab27  (slozit z Kc a Ha)
rokakvi86 (puvodni obsah pole datumNabyti)

```{r ZKONTROLOVANO}

bb <- aa %>% 
  # -------------------------------------------------- popis11
  mutate(popis11 = paste(ifelse(!is.na(popisCJ), paste("zápis česky: ", popisCJ), ""),
                         ifelse(!is.na(popisNJ), paste("zápis německy: ", popisNJ), ""), sep = "\n\n"),
         lengthPopis = nchar(popis11)) %>% 
  # -------------------------------------------------- datnab22
   mutate(Mden = str_extract(datumNabyti, "^\\d+"),
          Mmesic = case_when(str_detect(datumNabyti, "led") ~ 1,
                             str_detect(datumNabyti, "nor") ~ 2,
                             str_detect(datumNabyti, "řezn") ~ 3,
                             str_detect(datumNabyti, "dub") ~ 4,
                             str_detect(datumNabyti, "květ") ~ 5,
                             str_detect(datumNabyti, "červn") ~ 6,
                             str_detect(datumNabyti, "červenc") ~ 7,
                             str_detect(datumNabyti, "srp") ~ 8,
                             str_detect(datumNabyti, "září") ~ 9,
                             str_detect(datumNabyti, "říj") ~ 10,
                             str_detect(datumNabyti, "list") ~ 11,
                             str_detect(datumNabyti, "pros") ~ 12,
                             TRUE ~ NA),
          Mrok = str_extract(datumNabyti, "\\d{4}"),
          Mrok_comb = ifelse(!is.na(Mrok), Mrok, rok12)) %>% 
  
  unite(datnab22, c("Mden", "Mmesic", "Mrok_comb"), sep = ".", na.rm = T) %>% 
  mutate(rokakvi86 = ifelse(!str_detect(datnab22, "^\\d+\\.\\d+\\.\\d{4}$")&!is.na(datumNabyti), datumNabyti, NA),
         datnab22 = ifelse(str_detect(datnab22, "^\\d+\\.\\d+\\.\\d{4}$"), datnab22, NA)) %>% 
  # -------------------------------------------------- cennab27
  unite(cennab27, c("cenaKc", "cenaHa"), sep = ".", na.rm = T) %>%  
# -------------------------------------------------- RELOCATE
  relocate(popis11, datnab22,  rokakvi86, cennab27, .before = zdroj)


# check duplicity pricr4
check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

# check lengthPopis
any(bb$lengthPopis > 2000) # chceme FALSE

# check zpusob nabyti
check <- bb %>% select(zpusobNabyti, zpnab23, POZN29_zpusobNabyti, cenaKc, cennab27) %>% distinct()

# CLEAR

bb <- bb %>%  select(-lengthPopis, -is_valid_date, -is_valid_date2)
rm(check)

```

## VYRAZENI 

datvyr64 
dokvyr67 (nebudu extrahovat, nevim, co je a co neni soucasti nazvu dokumentu -> do poznamky)
poznvyr73

```{r}

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; vyrdok67 
  mutate(Mvyr1 = ifelse(str_detect(pozn, "(?i)odpis|(?i)odeps|(?i)vylouč"), pozn, NA),
         Mvyr2 = ifelse(str_detect(pozn2, "(?i)odpis|(?i)odeps|(?i)vylouč"), pozn2, NA)) %>% 
  unite(poznvyr73, c("Mvyr1", "Mvyr2"), sep = "\n\n", na.rm = T, remove = FALSE) %>% 
  mutate(vyrdat64 = str_extract(poznvyr73, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         vyrdok67 = ifelse(str_detect(poznvyr73, "č.*j.*\\d+"), str_extract(poznvyr73, "č\\..*j\\.\\s.*?(?:\\s|$)"), NA),
         POZN20_pozn1 = ifelse(!is.na(pozn), paste("poznámka: ", pozn), NA),
         POZN20_pozn2 = ifelse(!is.na(pozn2), paste("(sloupec bez nadpisu): ", pozn2), NA)) %>% 
  relocate(vyrdat64, vyrdok67, poznvyr73, .before = zdroj)

check <- cc %>% select(pozn, Mvyr1, pozn2, Mvyr2, vyrdat64, vyrdok67, poznvyr73, POZN20_pozn1, POZN20_pozn2) %>% distinct() 

```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc
text7 = chybne invc



```{r}

dd <- cc %>% 
 # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb", "POZN20_pocetks", "POZN20_pozn1", "POZN20_pozn2"), sep = "\n\n", na.rm = T, remove = FALSE) %>%  
 # -------------------------------------------------- texty
  mutate(text8_101 = inventar) %>% 
  relocate(pozn20, text8_101, .before = zdroj)
```

## INVENTARNI CISLA

nejsou

```{r}

fin <- dd 
```

# --------------------------------------- IMPORTOVANO sign II - (b)

X excelu -------------------------> KK_red.xlsx/kniha II - (b)
ve slozce kniha II 40 excelu, z toho dva druhy zapisu, dba druhy hlavicek
zde starsi zaznamy, mene popsane

## READ

```{r}
CORE_ib <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "kniha II - (b)") # warning asi ok
```

## EDA

```{r}

n_ib <- nrow(CORE_ib)
eda <- CORE_ib

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>% 
  unite(check, c("prirc", "rok"), sep = "/", remove = F) %>% 
  select(check, prirc, rok) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(check==1) # chceme 0

# kontrola prirc, zda jsou jen ciselna

check <- CORE_ib %>% select(prirc) %>% 
  mutate(isNum = str_extract(prirc, "[A-Za-z]")) # -> zadna subcisla

```


## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

UPDT_ib <- CORE_ib

# eda
sample_n(UPDT_ib, 10)

a <- UPDT_ib %>% 
  mutate(Mpref = "II",
         sbirka1 = "JCM",
         cisrada3 = "II", 
         prirvyraz9 = ifelse(isRed==T, 1, 0),
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, prirvyraz9, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            podsbirka == "25"&sign %in% c("D", "H") ~ "166", # KONFLIKT !!!
                            podsbirka == "25"&str_detect(sign, "MDRH") ~ "167",
                            podsbirka == "25"&sign %in% c("O", "PVS", "VS") ~ "168", 
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() 

# -------------------------------------------------- vedouci nuly -> kontrola a doplneni v Mp0 a Ms0
vednul <- a %>% select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()
view(vednul)
# -------------------------------------------------- prirc4 - part 2
aa <- a %>% 
  mutate(Mp0 = str_pad(porc104, 3, pad = 0),
         Ms0 = str_pad(subc105, 2, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
cennab27
nabpozn29

puvmaj28 

```{r ZKONTROLOVANO}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       # popis muze mit 2000 charakterů
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   # mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
   #        is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
   #        is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
   # mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
   mutate(Mdat_ser = as.numeric(datumNabyti),
          Mdat = format(as.Date(Mdat_ser, origin = "1899-12-30"), "%d.%m.%Y")) %>% 
          # Mdat = case_when(str_detect(datumNabyti, "^.....$") ~ Mdat_trans,
          #                 str_detect(datumNabyti, ",") ~ sub(",", ".", datumNabyti),
          #                 str_detect(datumNabyti, "^r\\.") ~ paste0("01.01.", str_extract(datumNabyti, "\\d+")), 
          #                 str_detect(datumNabyti, "^K") ~ sub("K", "", datumNabyti), 
          #                 str_detect(datumNabyti, "\\.$") ~ sub("\\.$", "", datumNabyti), 
          #                 str_detect(datumNabyti, "^19..$") ~ paste0("01.01.", datumNabyti),
          #                 str_detect(datumNabyti, ".*X.*") ~ str_replace(datumNabyti, "X", "10"),
          #                 TRUE ~ datumNabyti)) %>%
   mutate(is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% relocate(Mdat, is_valid_date2, .after = datumNabyti) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  relocate(datnab22, .after = datumNabyti) %>% 
  # select(-Mdat_ser, -Mdat, -is_valid_date) %>% 
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J"),
         doklnab25 = odkazDoklad,
         cennab27 = ifelse(str_detect(zpusobNabyti, ",-"), str_extract(zpusobNabyti, "\\d+,-"), ifelse(str_detect(zpusobNabyti, "\\d+,\\d+"), str_extract(zpusobNabyti, "\\d+,\\d+"), NA)),
         cennab27 = str_trim(gsub(",-", "", cennab27)),  
         cennab27 = str_trim(gsub(",", ".", cennab27))) %>% 
  # -------------------------------------------------- nabpozn29
  mutate(nabpozn29 = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA)) %>% 
  # -------------------------------------------------- puvmaj28 ; prisp87 
  mutate(puvmaj28 = puvodMajitel) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, cennab27, nabpozn29, puvmaj28, .before = zdroj)


# check duplicity pricr4
check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

# check lengthPopis
any(bb$lengthPopis > 2000) # chceme FALSE

# check zpusob nabyti
check <- bb %>% select(zpusobNabyti, zpnab23, cennab27, nabpozn29) %>% distinct()

# CLEAR

bb <- bb %>%  select(-lengthPopis, -is_valid_date, -is_valid_date2)
rm(check)

```

## VYRAZENI 

pole odpis/převod/pozn je všude prázdné

```{r}

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; dokvyr67 ; poznvyr73
  mutate(vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         # vyrdok67 = ifelse(str_detect(odpisVyrazeni, "č.*j.*\\d+"), str_extract(odpisVyrazeni, "č\\..*j\\.\\s.*?(?:\\s|$)"), NA),
         vyrdok67 = ifelse(str_detect(odpisVyrazeni, "č.*j.*\\d+|Kniha úbytků"), str_extract(odpisVyrazeni, "č\\..*j\\.\\s.*?(?:\\s|$)|Kniha úbytků č. \\d+"), NA),
         poznvyr73 = ifelse(is.na(odpisVyrazeni), NA, paste0("Odpis / převod / vyřazení atd.: ", odpisVyrazeni))) %>%
  relocate(vyrdat64, vyrdok67, poznvyr73, .before = zdroj)
  
check <- cc %>% select(odpisVyrazeni, vyrdat64, vyrdok67, poznvyr73) %>% distinct()
```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r}

dd <- cc %>% 
  mutate(text3_90 = jineCislo) %>% relocate(text3_90, .after = jineCislo) %>%
  mutate(text4_91 = revize) %>% relocate(text4_91, .after = revize) %>%
  mutate(text5_92 = sign) %>% relocate(text5_92, .after = sign) %>% 
  mutate(text6_99 = invc) %>% relocate(text5_92, .after = invc) %>% 
  # mutate(text7_100 = chyb_invc) %>%
  relocate(text3_90, text4_91, text5_92, text6_99, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(
    # sign = "II", # nekde divny format invc -> podle sigantury se odlisi, ty divne nemaji siganturu
        type_invc = case_when(str_detect(invc, "^[A-Za-z]*\\s*\\d+$") ~ "single",
                               str_detect(invc, "\\d+,\\s*\\d+")&!str_detect(invc, "-") ~ "seznam",
                               str_detect(invc, "^\\d+\\s*-\\s*\\d+$") ~ "interval",
                               str_detect(invc, ",")&str_detect(invc, "\\d+\\s*-\\s*\\d+") ~ "sez+int",
                               is.na(invc) ~ NA,
                               TRUE ~ "tbd"),
         isDoable = ifelse(type_invc %in% c("single", "seznam", "interval")&sign %in% val_sign, T, 
                           ifelse(is.na(invc), NA, F))) %>%                                 # !!!! dulezity priznak !!!!
  relocate(type_invc, isDoable, .after = invc)

prehled <- ee %>% filter(isDoable == T) %>% select(prirc4, sign, invc, type_invc, isDoable) %>% filter(!is.na(invc))
summary(as.factor(prehled$type_invc))

# ------------------------------------------------------ single 531

single <- ee %>% filter(type_invc == "single"&isDoable == T) %>% 
  mutate(Minvc = str_extract(invc, "\\d+"),
         Msub = str_extract(invc, "[A-Za-z]+$"),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc)) %>% 
  unite(invc5, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-Minvc, -Msub, -Minvc0)

prehled_sin <- single %>% select(prirc4, invc, type_invc, invc5)

# ------------------------------------------------------ seznam 33

seznam <- ee %>% filter(type_invc == "seznam"&isDoable == T) %>% 
  mutate(numbers = invc) %>% 
  separate_rows(numbers, sep = ",") %>% 
  # rename("numbers" = invc) %>% 
  mutate(numbers = str_trim(numbers),
         Minvc = ifelse(str_detect(numbers, "^[A-Za-z]+"), str_extract(numbers, "\\d+"), numbers),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc), 
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>%
  unite(Minvc_single, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(Minvc_single, .after = numbers) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc_single, collapse = ",")) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-numbers, -Minvc, -Minvc0, -Msub, -Minvc_single) %>% 
  distinct() %>% 
  ungroup()

# ------------------------------------------------------ interval 1

interval0 <- ee %>% filter(type_invc == "interval"&isDoable == T) %>% 
  separate(invc, into = c("start", "end"), sep = "-", remove = F) %>% 
  mutate(start = as.numeric(start), end = as.numeric(end)) %>% 
  mutate(is_valid_int = ifelse(start < end, TRUE, FALSE),
         is_wrong_order = ifelse(is_valid_int == FALSE&nchar(start)==nchar(end), TRUE, FALSE)) # nebudu resit spatny poradi, at si vyresi sami..

int_y <- interval0 %>% 
  filter(is_valid_int==T) %>% 
  mutate(Linvc = as.character(purrr::map2(start, end, ~toString(seq(.x, .y, by = 1))))) %>% 
  separate_rows(Linvc, sep = ",") %>% 
  mutate(Linvc = str_trim(Linvc),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Linvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Linvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Linvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Linvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Linvc, 6, pad = "0")),
                            TRUE ~ Linvc), 
         Msub = str_extract(Linvc, "[A-Za-z]+$")) %>% 
  unite(Minvc, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc, collapse = ",")) %>% 
  select(-Linvc, -Minvc0, -Minvc, -Msub) %>% 
  distinct() %>%
  ungroup() 
 
# int_n <- interval0 %>% 
#   filter(is_valid_int==F) %>% 
#    mutate(Minvc = paste("chybne zadany interval invc"),
#          invc5 = NA)
#  
# interval <- bind_rows(int_y, int_n) %>% 
#   # mutate(invc5 = Minvc) %>% 
#   relocate(invc5, .after = invc) %>% 
#   select(-start, -end, -is_valid_int, -is_wrong_order, -Minvc)

interval <- int_y

nrow(interval0) == nrow(interval) # neztratili jsme nejake radky cestou?
rm(interval0)


# ------------------------------------------------------ zbytek 628

# 275* NA
# 353* FALSE

nrow(ee %>% filter(is.na(isDoable))) 
nrow(ee %>% filter(isDoable == F)) 

zbytek <- ee %>% filter(isDoable == F|is.na(isDoable))
not_doable <- zbytek %>% filter(isDoable == F) %>% select(prirc4, sign, invc)                         
# write.table(not_doable, file = paste0(path_kk, "vystupy/", proj, "_problematickaINVC_signIIb.csv"),
#             quote = T, row.names = F,
#             sep = ";", dec = ",",
#             na = "", fileEncoding="UTF-8")

nrow(single)+nrow(seznam)+nrow(interval)+nrow(zbytek)==nrow(ee) # chceme TRUE

# ------------------------------------------------------ JOIN 

ff <- bind_rows(single, seznam, interval, zbytek) %>% 
  relocate(invc5, .after = prirc4)

nrow(ff) == nrow(ee) # musi byt stejne!

# rm(aa)
# rm(bb)
# rm(cc)
# rm(dd)
# rm(ee)

fin <- ff

```

# --------------------------------------- IMPORTOVANO sign P

3 excely -------------------------> KK_red.xlsx/P


## READ

```{r}
CORE_p <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "P", col_types = "text") # warning asi ok
```

## EDA

```{r}

n_p <- nrow(CORE_p)
eda <- CORE_p

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>% 
  unite(check, c("prirc", "rok"), sep = "/", remove = F) %>% 
  select(check, prirc, rok) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(check==1) # chceme 0

# kontrola prirc, zda jsou jen ciselna

check <- CORE_p %>% select(prirc) %>% 
  mutate(isNum = str_extract(prirc, "[A-Za-z]")) # -> zadna subcisla

```


## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

UPDT_p <- CORE_p

# eda
sample_n(UPDT_p, 10)

a <- UPDT_p %>% 
  mutate(Mpref = "P",
         sbirka1 = "JCM",
         cisrada3 = "P", 
         prirvyraz9 = ifelse(isRed==T, 1, 0),
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, prirvyraz9, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            podsbirka == "25"&sign %in% c("D", "H") ~ "166", # KONFLIKT !!!
                            podsbirka == "25"&str_detect(sign, "MDRH") ~ "167",
                            podsbirka == "25"&sign %in% c("O", "PVS", "VS") ~ "168", 
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() 

# -------------------------------------------------- vedouci nuly -> kontrola a doplneni v Mp0 a Ms0
vednul <- a %>% select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()
view(vednul)
# -------------------------------------------------- prirc4 - part 2
aa <- a %>% 
  mutate(Mp0 = str_pad(porc104, 4, pad = 0),
         Ms0 = str_pad(subc105, 2, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
cennab27
nabpozn29

puvmaj28 

```{r ZKONTROLOVANO}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       # popis muze mit 2000 charakterů
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   # mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
   #        is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
   #        is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
   # mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
   mutate(Mdat_ser = as.numeric(datumNabyti),
          Mdat = format(as.Date(Mdat_ser, origin = "1899-12-30"), "%d.%m.%Y")) %>% 
          # Mdat = case_when(str_detect(datumNabyti, "^.....$") ~ Mdat_trans,
          #                 str_detect(datumNabyti, ",") ~ sub(",", ".", datumNabyti),
          #                 str_detect(datumNabyti, "^r\\.") ~ paste0("01.01.", str_extract(datumNabyti, "\\d+")), 
          #                 str_detect(datumNabyti, "^K") ~ sub("K", "", datumNabyti), 
          #                 str_detect(datumNabyti, "\\.$") ~ sub("\\.$", "", datumNabyti), 
          #                 str_detect(datumNabyti, "^19..$") ~ paste0("01.01.", datumNabyti),
          #                 str_detect(datumNabyti, ".*X.*") ~ str_replace(datumNabyti, "X", "10"),
          #                 TRUE ~ datumNabyti)) %>%
   mutate(is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% relocate(Mdat, is_valid_date2, .after = datumNabyti) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  relocate(datnab22, .after = datumNabyti) %>% 
  # select(-Mdat_ser, -Mdat, -is_valid_date) %>% 
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J"),
         doklnab25 = odkazDoklad,
         cennab27 = ifelse(str_detect(zpusobNabyti, ",-|Kčs"), str_extract(zpusobNabyti, "\\d+"), ifelse(str_detect(zpusobNabyti, "\\d+,\\d+"), str_extract(zpusobNabyti, "\\d+,\\d+"), NA)),
         cennab27 = str_trim(gsub(",-", "", cennab27)),  
         cennab27 = str_trim(gsub(",", ".", cennab27))) %>% 
  # -------------------------------------------------- nabpozn29
  mutate(nabpozn29 = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA)) %>% 
  # -------------------------------------------------- puvmaj28 ; prisp87 
  mutate(puvmaj28 = puvodMajitel) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, cennab27, nabpozn29, puvmaj28, .before = zdroj)


# check duplicity pricr4
check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

# check lengthPopis
any(bb$lengthPopis > 2000) # chceme FALSE

# check zpusob nabyti
check <- bb %>% select(zpusobNabyti, zpnab23, cennab27, nabpozn29) %>% distinct()

# CLEAR

bb <- bb %>%  select(-lengthPopis, -is_valid_date, -is_valid_date2)
rm(check)

```

## VYRAZENI 

pole odpis/převod/pozn je všude prázdné

```{r}

over <- bb %>% select(odpisVyrazeni) %>% distinct()

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; dokvyr67 ; poznvyr73
  mutate(
    vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
    vyrdok67 = ifelse(str_detect(odpisVyrazeni, "č.*j.*\\d+"), str_extract(odpisVyrazeni, "č\\..*j\\.\\s.*OMG|č\\..*j\\..*MK\\s\\d+\\/\\d+"), NA),
    poznvyr73 = ifelse(is.na(odpisVyrazeni), NA, paste0("Odpis / převod / vyřazení atd.: ", odpisVyrazeni))) %>%
  relocate(vyrdat64, vyrdok67, poznvyr73, .before = zdroj)
  
check <- cc %>% select(odpisVyrazeni, vyrdat64, vyrdok67, poznvyr73) %>% distinct()
view(check)
```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r}

dd <- cc %>% 
  mutate(text3_90 = jineCislo) %>% relocate(text3_90, .after = jineCislo) %>%
  mutate(text4_91 = revize) %>% relocate(text4_91, .after = revize) %>%
  mutate(text5_92 = sign) %>% relocate(text5_92, .after = sign) %>% 
  mutate(text6_99 = invc) %>% relocate(text5_92, .after = invc) %>% 
  # mutate(text7_100 = chyb_invc) %>%
  relocate(text3_90, text4_91, text5_92, text6_99, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(
    # sign = "II"
        type_invc = case_when(str_detect(invc, "^[A-Za-z]*\\s*\\d+$") ~ "single",
                               str_detect(invc, "\\d+,\\s*\\d+")&!str_detect(invc, "-|[A-Za-z]") ~ "seznam",
                               str_detect(invc, "^\\d+\\s*-\\s*\\d+$") ~ "interval",
                               str_detect(invc, ",")&str_detect(invc, "\\d+\\s*-\\s*\\d+") ~ "sez+int",
                               is.na(invc) ~ NA,
                               TRUE ~ "tbd"),
         isDoable = ifelse(type_invc %in% c("single", "seznam", "interval")&sign %in% val_sign, T, 
                           ifelse(is.na(invc), NA, F))) %>%                                 # !!!! dulezity priznak !!!!
  relocate(type_invc, isDoable, .after = invc)

prehled <- ee %>% filter(isDoable == T) %>% select(prirc4, sign, invc, type_invc, isDoable) %>% filter(!is.na(invc))
summary(as.factor(prehled$type_invc))

# ------------------------------------------------------ single 942

single <- ee %>% filter(type_invc == "single"&isDoable == T) %>% 
  mutate(Minvc = str_extract(invc, "\\d+"),
         Msub = str_extract(invc, "[A-Za-z]+$"),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc)) %>% 
  unite(invc5, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-Minvc, -Msub, -Minvc0)

prehled_sin <- single %>% select(prirc4, invc, type_invc, invc5)

# ------------------------------------------------------ seznam 103

seznam <- ee %>% filter(type_invc == "seznam"&isDoable == T) %>% 
  mutate(numbers = invc) %>% 
  separate_rows(numbers, sep = ",") %>% 
  # rename("numbers" = invc) %>% 
  mutate(numbers = str_trim(numbers),
         Minvc = ifelse(str_detect(numbers, "^[A-Za-z]+"), str_extract(numbers, "\\d+"), numbers),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc), 
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>%
  unite(Minvc_single, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(Minvc_single, .after = numbers) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc_single, collapse = ",")) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-numbers, -Minvc, -Minvc0, -Msub, -Minvc_single) %>% 
  distinct() %>% 
  ungroup()

# ------------------------------------------------------ interval 4

interval0 <- ee %>% filter(type_invc == "interval"&isDoable == T) %>% 
  separate(invc, into = c("start", "end"), sep = "-", remove = F) %>% 
  mutate(start = as.numeric(start), end = as.numeric(end)) %>% 
  mutate(is_valid_int = ifelse(start < end, TRUE, FALSE),
         is_wrong_order = ifelse(is_valid_int == FALSE&nchar(start)==nchar(end), TRUE, FALSE)) # nebudu resit spatny poradi, at si vyresi sami..

int_y <- interval0 %>% 
  filter(is_valid_int==T) %>% 
  mutate(Linvc = as.character(purrr::map2(start, end, ~toString(seq(.x, .y, by = 1))))) %>% 
  separate_rows(Linvc, sep = ",") %>% 
  mutate(Linvc = str_trim(Linvc),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Linvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Linvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Linvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Linvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Linvc, 6, pad = "0")),
                            TRUE ~ Linvc), 
         Msub = str_extract(Linvc, "[A-Za-z]+$")) %>% 
  unite(Minvc, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc, collapse = ",")) %>% 
  select(-Linvc, -Minvc0, -Minvc, -Msub) %>% 
  distinct() %>%
  ungroup() 
 
# int_n <- interval0 %>% 
#   filter(is_valid_int==F) %>% 
#    mutate(Minvc = paste("chybne zadany interval invc"),
#          invc5 = NA)
#  
# interval <- bind_rows(int_y, int_n) %>% 
#   # mutate(invc5 = Minvc) %>% 
#   relocate(invc5, .after = invc) %>% 
#   select(-start, -end, -is_valid_int, -is_wrong_order, -Minvc)

interval <- int_y

nrow(interval0) == nrow(interval) # neztratili jsme nejake radky cestou?
rm(interval0)


# ------------------------------------------------------ zbytek 628

# 275* NA
# 353* FALSE

nrow(ee %>% filter(is.na(isDoable))) 
nrow(ee %>% filter(isDoable == F)) 

zbytek <- ee %>% filter(isDoable == F|is.na(isDoable))
not_doable <- zbytek %>% filter(isDoable == F) %>% select(prirc4, sign, invc)                         
# write.table(not_doable, file = paste0(path_kk, "vystupy/", proj, "_problematickaINVC_signP.csv"),
#             quote = T, row.names = F,
#             sep = ";", dec = ",",
#             na = "", fileEncoding="UTF-8")

nrow(single)+nrow(seznam)+nrow(interval)+nrow(zbytek)==nrow(ee) # chceme TRUE

# ------------------------------------------------------ JOIN 

ff <- bind_rows(single, seznam, interval, zbytek) %>% 
  relocate(invc5, .after = prirc4)

nrow(ff) == nrow(ee) # musi byt stejne!

# rm(aa)
# rm(bb)
# rm(cc)
# rm(dd)
# rm(ee)

fin <- ff

```

# --------------------------------------- IMPORTOVANO sign St

1 excel -------------------------> KK_red.xlsx/St


## READ

```{r}
CORE_st <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "St", col_types = "text") %>% 
  mutate(rok = paste0("19", str_extract(prirc, "(?<=/).*$")))

sort(unique(CORE_st$rok))
sort(unique(CORE_st$podsbirka))
sort(unique(CORE_st$pocetKs))
```

## EDA

```{r}

eda <- CORE_st

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>% 
  unite(check, c("prirc", "rok"), sep = "/", remove = F) %>% 
  select(check, prirc, rok) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(check==1) # chceme 0

# kontrola prirc, zda jsou jen ciselna

check <- CORE_st %>% select(prirc) %>% 
  mutate(isNum = str_extract(prirc, "[A-Za-z]")) # -> zadna subcisla

```


## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

# eda
sample_n(CORE_st, 10)

a <- CORE_st %>% 
  mutate(Mpref = "St",
         sbirka1 = "JCM",
         cisrada3 = "St",
         rok12 = rok, 
         evid15 = "1",
         typ30 = "P",
         datzap98 = paste0("31.12.", rok12)) %>%
  relocate(sbirka1, cisrada3, evid15, typ30, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(Mpodsb = ifelse(podsbirka == "19 - M", "19", podsbirka),
         podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            Mpodsb == "18" ~ "159",
                            # Mpodsb == "19" ~ "162",
                            Mpodsb == "19 – PM" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            podsbirka == "25"&sign %in% c("D", "H") ~ "166", # KONFLIKT !!!
                            podsbirka == "25"&str_detect(sign, "MDRH") ~ "167",
                            podsbirka == "25"&sign %in% c("O", "PVS", "VS") ~ "168", 
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  separate(prirc, into=c("Mporc", "Mrok") , sep="/", remove = F) %>% 
  mutate(Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() 

# -------------------------------------------------- vedouci nuly -> kontrola a doplneni v Mp0 a Ms0
vednul <- a %>% select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()
view(vednul)
# -------------------------------------------------- prirc4 - part 2
aa <- a %>% 
  mutate(Mp0 = str_pad(porc104, 4, pad = 0),
         Ms0 = str_pad(subc105, 2, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```

## NABYTI, PUVOD, POPIS

ozn10
popis11

```{r ZKONTROLOVANO}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(predmet),                                                       # popis muze mit 2000 charakterů
         popis11 = predmet) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, .before = zdroj)


# check duplicity pricr4
check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

# check lengthPopis
any(bb$lengthPopis > 2000) # chceme FALSE

# CLEAR

rm(check)

```

## VYRAZENI 

pole odpis/převod/pozn je všude prázdné

```{r}

cc <- bb 
```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r}

dd <- cc %>% 
  mutate(text3_90 = jineCislo,
         text5_92 = sign,
         POZN20_pozn = ifelse(!is.na(poznamka), paste0("Poznámka: ", poznamka), NA)) %>% 
   # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks", "POZN20_pozn"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  relocate(text3_90, text5_92, pozn20, .before = zdroj)
```

## INVENTARNI CISLA

nejsou

```{r}
fin <- dd
```

# --------------------------------------- IMPORTOVANO sign IIIa

26 excelů -------------------------> KK_red.xlsx/IIIa


## READ

```{r}
CORE_IIIa <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "kniha IIIa", col_types = "text") 

sort(unique(CORE_IIIa$rok)) # 26 roku - spravne, sedi s poctem excelu ve verzi IIIa
sort(unique(CORE_IIIa$podsbirka))
sort(unique(CORE_IIIa$sign))
```

## EDA

```{r}

eda <- CORE_IIIa

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>% 
  unite(check, c("prirc", "rok"), sep = "/", remove = F) %>% 
  select(check, prirc, rok) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(check==1) # chceme 0

# kontrola prirc, zda jsou jen ciselna

check <- CORE_IIIa %>% select(prirc) %>% 
  mutate(isNum = str_extract(prirc, "[A-Za-z]")) # -> zadna subcisla

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

# eda
sample_n(CORE_IIIa, 10)

a <- CORE_IIIa %>% 
  mutate(Mpref = "III",
         sbirka1 = "JCM",
         cisrada3 = "III", 
         prirvyraz9 = ifelse(isRed==T, 1, 0),
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, prirvyraz9, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            podsbirka == "25"&sign %in% c("D", "H") ~ "166", # KONFLIKT !!!
                            podsbirka == "25"&str_detect(sign, "MDRH") ~ "167",
                            podsbirka == "25"&sign %in% c("O", "PVS", "VS") ~ "168", 
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() 

# -------------------------------------------------- vedouci nuly -> kontrola a doplneni v Mp0 a Ms0
vednul <- a %>% select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()
view(vednul)
# -------------------------------------------------- prirc4 - part 2
aa <- a %>% 
  mutate(Mp0 = str_pad(porc104, 3, pad = 0),
         Ms0 = str_pad(subc105, 2, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
cennab27
nabpozn29

puvmaj28 

```{r ZKONTROLOVANO}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       # popis muze mit 2000 charakterů
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   # mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
   #        is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
   #        is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
   # mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
   mutate(Mdat_ser = as.numeric(datumNabyti),
          Mdat = format(as.Date(Mdat_ser, origin = "1899-12-30"), "%d.%m.%Y")) %>% 
          # Mdat = case_when(str_detect(datumNabyti, "^.....$") ~ Mdat_trans,
          #                 str_detect(datumNabyti, ",") ~ sub(",", ".", datumNabyti),
          #                 str_detect(datumNabyti, "^r\\.") ~ paste0("01.01.", str_extract(datumNabyti, "\\d+")), 
          #                 str_detect(datumNabyti, "^K") ~ sub("K", "", datumNabyti), 
          #                 str_detect(datumNabyti, "\\.$") ~ sub("\\.$", "", datumNabyti), 
          #                 str_detect(datumNabyti, "^19..$") ~ paste0("01.01.", datumNabyti),
          #                 str_detect(datumNabyti, ".*X.*") ~ str_replace(datumNabyti, "X", "10"),
          #                 TRUE ~ datumNabyti)) %>%
   mutate(is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% relocate(Mdat, is_valid_date2, .after = datumNabyti) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  relocate(datnab22, .after = datumNabyti) %>% 
  # select(-Mdat_ser, -Mdat, -is_valid_date) %>% 
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J"),
         doklnab25 = odkazDoklad,
         # cennab27 = ifelse(str_detect(zpusobNabyti, ",-|Kčs"), str_extract(zpusobNabyti, "\\d+"), ifelse(str_detect(zpusobNabyti, "\\d+,\\d+"), str_extract(zpusobNabyti, "\\d+,\\d+"), NA)),
         cennab27 = ifelse(str_detect(zpusobNabyti, ",-")&str_detect(zpusobNabyti, "\\d+,\\d+"), str_extract(zpusobNabyti, "\\d+,\\d+"), ifelse(str_detect(zpusobNabyti, "\\d+,-"), str_extract(zpusobNabyti, "\\d+"), NA)),
         cennab27 = str_trim(gsub(",-", "", cennab27)),  
         cennab27 = str_trim(gsub(",", ".", cennab27))) %>% 
  # -------------------------------------------------- nabpozn29
  mutate(POZN29_datum = ifelse(is.na(datnab22)&!is.na(datumNabyti), paste0("Datum nabytí: ", datumNabyti), NA),
         POZN29_zpusob = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA)) %>% 
  unite(nabpozn29, c("POZN29_datum","POZN29_zpusob"), sep = "\n", na.rm = T, remove = FALSE) %>% 
  # -------------------------------------------------- RELOCATE
  # -------------------------------------------------- puvmaj28 ; prisp87 
  mutate(puvmaj28 = puvodMajitel) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, cennab27, nabpozn29, puvmaj28, .before = zdroj)


# check duplicity pricr4
check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

# check lengthPopis
any(bb$lengthPopis > 2000) # chceme FALSE

# check zpusob nabyti
check <- bb %>% select(zpusobNabyti, zpnab23, cennab27, nabpozn29) %>% distinct()

# CLEAR

bb <- bb %>%  select(-lengthPopis, -is_valid_date, -is_valid_date2)
rm(check)

```

## VYRAZENI 

```{r}

over <- bb %>% select(odpisVyrazeni) %>% distinct()

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; dokvyr67 ; poznvyr73
  mutate(
    vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
    vyrdok67 = ifelse(str_detect(odpisVyrazeni, "č.*j.*\\d+"), 
                      str_extract(odpisVyrazeni, "č\\..*j\\.\\s.*OMG|č\\..*j\\..*MK\\s\\d+\\/\\d+|čj\\.\\s.*OMG|č\\.j\\.: \\d+\\/\\d+-\\d+|č\\.j\\.: \\d+\\/\\d+"), NA),
    poznvyr73 = ifelse(is.na(odpisVyrazeni), NA, paste0("Odpis / převod / vyřazení atd.: ", odpisVyrazeni))) %>%
  relocate(vyrdat64, vyrdok67, poznvyr73, .before = zdroj)
  
check <- cc %>% select(odpisVyrazeni, vyrdat64, vyrdok67, poznvyr73) %>% distinct()
view(check)
```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r}

dd <- cc %>% 
  mutate(text3_90 = jineCislo) %>% 
  mutate(text4_91 = revize) %>% 
  mutate(text5_92 = sign) %>% 
  mutate(text6_99 = invc) %>% 
  # mutate(text7_100 = chyb_invc) %>%
  relocate(text3_90, text4_91, text5_92, text6_99, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(
        type_invc = case_when(str_detect(invc, "^[A-Za-z]*\\s*\\d+$") ~ "single",
                               str_detect(invc, "\\d+,\\s*\\d+")&!str_detect(invc, "-|[A-Za-z]") ~ "seznam",
                               str_detect(invc, "^\\d+\\s*-\\s*\\d+$") ~ "interval",
                               str_detect(invc, ",")&str_detect(invc, "\\d+\\s*-\\s*\\d+") ~ "sez+int",
                               is.na(invc) ~ NA,
                               TRUE ~ "tbd"),
         isDoable = ifelse(type_invc %in% c("single", "seznam", "interval")&sign %in% val_sign, T, 
                           ifelse(is.na(invc), NA, F))) %>%                                 # !!!! dulezity priznak !!!!
  relocate(type_invc, isDoable, .after = invc)

prehled <- ee %>% filter(isDoable == T) %>% select(prirc4, sign, invc, type_invc, isDoable) %>% filter(!is.na(invc))
summary(as.factor(prehled$type_invc))

# ------------------------------------------------------ single 1932

single <- ee %>% filter(type_invc == "single"&isDoable == T) %>% 
  mutate(Minvc = str_extract(invc, "\\d+"),
         Msub = str_extract(invc, "[A-Za-z]+$"),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc)) %>% 
  unite(invc5, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-Minvc, -Msub, -Minvc0)

prehled_sin <- single %>% select(prirc4, invc, type_invc, invc5)

# ------------------------------------------------------ seznam 78

seznam <- ee %>% filter(type_invc == "seznam"&isDoable == T) %>% 
  mutate(numbers = invc) %>% 
  separate_rows(numbers, sep = ",") %>% 
  # rename("numbers" = invc) %>% 
  mutate(numbers = str_trim(numbers),
         Minvc = ifelse(str_detect(numbers, "^[A-Za-z]+"), str_extract(numbers, "\\d+"), numbers),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc), 
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>%
  unite(Minvc_single, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(Minvc_single, .after = numbers) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc_single, collapse = ",")) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-numbers, -Minvc, -Minvc0, -Msub, -Minvc_single) %>% 
  distinct() %>% 
  ungroup()

# ------------------------------------------------------ interval 20

interval0 <- ee %>% filter(type_invc == "interval"&isDoable == T) %>% 
  separate(invc, into = c("start", "end"), sep = "-", remove = F) %>% 
  mutate(start = as.numeric(start), end = as.numeric(end)) %>% 
  mutate(is_valid_int = ifelse(start < end, TRUE, FALSE),
         is_wrong_order = ifelse(is_valid_int == FALSE&nchar(start)==nchar(end), TRUE, FALSE)) # nebudu resit spatny poradi, at si vyresi sami..

int_y <- interval0 %>% 
  filter(is_valid_int==T) %>% 
  mutate(Linvc = as.character(purrr::map2(start, end, ~toString(seq(.x, .y, by = 1))))) %>% 
  separate_rows(Linvc, sep = ",") %>% 
  mutate(Linvc = str_trim(Linvc),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Linvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Linvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Linvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Linvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Linvc, 6, pad = "0")),
                            TRUE ~ Linvc), 
         Msub = str_extract(Linvc, "[A-Za-z]+$")) %>% 
  unite(Minvc, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc, collapse = ",")) %>% 
  select(-Linvc, -Minvc0, -Minvc, -Msub) %>% 
  distinct() %>%
  ungroup() 
 
# int_n <- interval0 %>% 
#   filter(is_valid_int==F) %>% 
#    mutate(Minvc = paste("chybne zadany interval invc"),
#          invc5 = NA)
#  
# interval <- bind_rows(int_y, int_n) %>% 
#   # mutate(invc5 = Minvc) %>% 
#   relocate(invc5, .after = invc) %>% 
#   select(-start, -end, -is_valid_int, -is_wrong_order, -Minvc)

interval <- int_y

nrow(interval0) == nrow(interval) # neztratili jsme nejake radky cestou?
rm(interval0)


# ------------------------------------------------------ zbytek 3728

# 2557* NA
# 1171* FALSE

nrow(ee %>% filter(is.na(isDoable))) 
nrow(ee %>% filter(isDoable == F)) 

zbytek <- ee %>% filter(isDoable == F|is.na(isDoable))
not_doable <- zbytek %>% filter(isDoable == F) %>% select(prirc4, sign, invc)                         
# write.table(not_doable, file = paste0(path_kk, "vystupy/", proj, "_problematickaINVC_signIIIa.csv"),
#             quote = T, row.names = F,
#             sep = ";", dec = ",",
#             na = "", fileEncoding="UTF-8")

nrow(single)+nrow(seznam)+nrow(interval)+nrow(zbytek)==nrow(ee) # chceme TRUE

# ------------------------------------------------------ JOIN 

ff <- bind_rows(single, seznam, interval, zbytek) %>% 
  relocate(invc5, .after = prirc4)

nrow(ff) == nrow(ee) # musi byt stejne!

# rm(aa)
# rm(bb)
# rm(cc)
# rm(dd)
# rm(ee)

fin <- ff

```

# --------------------------------------- IMPORTOVANO sign IIIb

3 excely -------------------------> KK_red.xlsx/IIIb


## READ

```{r}
CORE_IIIb <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "kniha IIIb", col_types = "text") 

sort(unique(CORE_IIIb$rok)) # 3 roky - spravne, sedi s poctem excelu ve verzi IIIb
sort(unique(CORE_IIIb$podsbirka))
sort(unique(CORE_IIIb$sign))
```

## EDA

```{r}

eda <- CORE_IIIb

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>% 
  unite(check, c("prirc", "rok"), sep = "/", remove = F) %>% 
  select(check, prirc, rok) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(check==1) # chceme 0

# kontrola prirc, zda jsou jen ciselna

check <- CORE_IIIb %>% select(prirc) %>% 
  mutate(isNum = str_extract(prirc, "[A-Za-z]")) # -> zadna subcisla

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

# eda
sample_n(CORE_IIIb, 10)

a <- CORE_IIIb %>% 
  # jedno sporne prorc --> vynechat:
  filter(prirc != "87-137") %>% 
  mutate(Mpref = "III",
         sbirka1 = "JCM",
         cisrada3 = "III", 
         prirvyraz9 = ifelse(isRed==T, 1, 0),
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, prirvyraz9, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            podsbirka == "25"&sign %in% c("D", "H") ~ "166", # KONFLIKT !!!
                            podsbirka == "25"&str_detect(sign, "MDRH") ~ "167",
                            podsbirka == "25"&sign %in% c("O", "PVS", "VS") ~ "168", 
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() 

# -------------------------------------------------- vedouci nuly -> kontrola a doplneni v Mp0 a Ms0
vednul <- a %>% select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()
view(vednul)
# -------------------------------------------------- prirc4 - part 2
aa <- a %>% 
  mutate(Mp0 = str_pad(porc104, 3, pad = 0),
         Ms0 = str_pad(subc105, 2, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
cennab27
nabpozn29

puvmaj28 

```{r ZKONTROLOVANO}

bb <- aa %>% 
  # -------------------------------------------------- ozn10
  mutate(ozn10 = predmet) %>% 
    # -------------------------------------------------- popis11
  mutate(popis11 = paste(ifelse(!is.na(popisCJ), paste("Překlad čeština: ", popisCJ), ""),
                         ifelse(!is.na(popisNJ), paste("Přepis němčina: ", popisNJ), ""), sep = "\n\n"),
         lengthPopis = nchar(popis11)) %>% 
  # -------------------------------------------------- datnab22
   mutate(
         # Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
          is_valid_date = !is.na(as.Date(datumNabyti, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(datumNabyti), is_valid_date, NA)) %>%
   mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", datumNabyti, NA)) %>% 
  #  mutate(Mdat_ser = as.numeric(datumNabyti),
  #         Mdat = format(as.Date(Mdat_ser, origin = "1899-12-30"), "%d.%m.%Y")) %>% 
  #         # Mdat = case_when(str_detect(datumNabyti, "^.....$") ~ Mdat_trans,
  #         #                 str_detect(datumNabyti, ",") ~ sub(",", ".", datumNabyti),
  #         #                 str_detect(datumNabyti, "^r\\.") ~ paste0("01.01.", str_extract(datumNabyti, "\\d+")), 
  #         #                 str_detect(datumNabyti, "^K") ~ sub("K", "", datumNabyti), 
  #         #                 str_detect(datumNabyti, "\\.$") ~ sub("\\.$", "", datumNabyti), 
  #         #                 str_detect(datumNabyti, "^19..$") ~ paste0("01.01.", datumNabyti),
  #         #                 str_detect(datumNabyti, ".*X.*") ~ str_replace(datumNabyti, "X", "10"),
  #         #                 TRUE ~ datumNabyti)) %>%
  #  mutate(is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
  #         is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% relocate(Mdat, is_valid_date2, .after = datumNabyti) %>% 
  # mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  # relocate(datnab22, .after = datumNabyti) %>% 
  # # select(-Mdat_ser, -Mdat, -is_valid_date) %>% 
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J"),
         doklnab25 = odkazDoklad,
         # cennab27 = ifelse(str_detect(zpusobNabyti, ",-|Kčs"), str_extract(zpusobNabyti, "\\d+"), ifelse(str_detect(zpusobNabyti, "\\d+,\\d+"), str_extract(zpusobNabyti, "\\d+,\\d+"), NA)),
         # cennab27 = ifelse(str_detect(zpusobNabyti, ",-"), str_extract(zpusobNabyti, "\\d+(?=,-)"), NA),
         cennab27 = ifelse(str_detect(zpusobNabyti, ",-")&str_detect(zpusobNabyti, "\\d+,\\d+"), str_extract(zpusobNabyti, "\\d+,\\d+"), ifelse(str_detect(zpusobNabyti, "\\d+,-"), str_extract(zpusobNabyti, "\\d+"), NA)),
         cennab27 = str_trim(gsub(",-", "", cennab27)),  
         cennab27 = str_trim(gsub(",", ".", cennab27))) %>% 
  # -------------------------------------------------- nabpozn29
  mutate(POZN29_datum = ifelse(is.na(datnab22)&!is.na(datumNabyti), paste0("Datum nabytí: ", datumNabyti), NA),
         POZN29_zpusob = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA)) %>% 
  unite(nabpozn29, c("POZN29_datum","POZN29_zpusob"), sep = "\n", na.rm = T, remove = FALSE) %>% 
  # -------------------------------------------------- puvmaj28 
  mutate(puvmaj28 = puvodMajitel) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, cennab27, nabpozn29, puvmaj28, .before = zdroj)


# check duplicity pricr4
check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

# check lengthPopis
any(bb$lengthPopis > 2000) # chceme FALSE

# check zpusob nabyti
check <- bb %>% select(zpusobNabyti, zpnab23, cennab27, nabpozn29) %>% distinct()

# CLEAR

bb <- bb %>%  select(-lengthPopis, -is_valid_date, -is_valid_date2)
rm(check)

```

## VYRAZENI 

```{r}

over <- bb %>% select(odpisVyrazeni) %>% distinct()

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; dokvyr67 ; poznvyr73
  mutate(
    vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
    vyrdok67 = ifelse(str_detect(odpisVyrazeni, "č.*j.*\\d+"), 
                      str_extract(odpisVyrazeni, "č\\.*j.*\\d+\\/\\d+-\\d+|č\\.*j.*\\d+\\/\\d+"), NA),
    poznvyr73 = ifelse(is.na(odpisVyrazeni), NA, paste0("Odpis / převod / vyřazení atd.: ", odpisVyrazeni))) %>%
  relocate(vyrdat64, vyrdok67, poznvyr73, .before = zdroj)
  
check <- cc %>% select(odpisVyrazeni, vyrdat64, vyrdok67, poznvyr73) %>% distinct()
view(check)
```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r}

dd <- cc %>% 
  mutate(text3_90 = jineCislo) %>% 
  mutate(text4_91 = revize) %>% 
  mutate(text5_92 = sign) %>% 
  mutate(text6_99 = invc) %>% 
  # mutate(text7_100 = chyb_invc) %>%
  relocate(text3_90, text4_91, text5_92, text6_99, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(
        type_invc = case_when(str_detect(invc, "^[A-Za-z]*\\s*\\d+$") ~ "single",
                               str_detect(invc, "\\d+,\\s*\\d+")&!str_detect(invc, "-|[A-Za-z]") ~ "seznam",
                               str_detect(invc, "^\\d+\\s*-\\s*\\d+$") ~ "interval",
                               str_detect(invc, ",")&str_detect(invc, "\\d+\\s*-\\s*\\d+") ~ "sez+int",
                               is.na(invc) ~ NA,
                               TRUE ~ "tbd"),
         isDoable = ifelse(type_invc %in% c("single", "seznam", "interval")&sign %in% val_sign, T, 
                           ifelse(is.na(invc), NA, F))) %>%                                 # !!!! dulezity priznak !!!!
  relocate(type_invc, isDoable, .after = invc)

prehled <- ee %>% filter(isDoable == T) %>% select(prirc4, sign, invc, type_invc, isDoable) %>% filter(!is.na(invc))
summary(as.factor(prehled$type_invc))

# ------------------------------------------------------ single 32

single <- ee %>% filter(type_invc == "single"&isDoable == T) %>% 
  mutate(Minvc = str_extract(invc, "\\d+"),
         Msub = str_extract(invc, "[A-Za-z]+$"),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc)) %>% 
  unite(invc5, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-Minvc, -Msub, -Minvc0)

prehled_sin <- single %>% select(prirc4, invc, type_invc, invc5)

# ------------------------------------------------------ seznam 1

seznam <- ee %>% filter(type_invc == "seznam"&isDoable == T) %>% 
  mutate(numbers = invc) %>% 
  separate_rows(numbers, sep = ",") %>% 
  # rename("numbers" = invc) %>% 
  mutate(numbers = str_trim(numbers),
         Minvc = ifelse(str_detect(numbers, "^[A-Za-z]+"), str_extract(numbers, "\\d+"), numbers),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc), 
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>%
  unite(Minvc_single, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(Minvc_single, .after = numbers) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc_single, collapse = ",")) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-numbers, -Minvc, -Minvc0, -Msub, -Minvc_single) %>% 
  distinct() %>% 
  ungroup()

# ------------------------------------------------------ interval 3

interval0 <- ee %>% filter(type_invc == "interval"&isDoable == T) %>% 
  separate(invc, into = c("start", "end"), sep = "-", remove = F) %>% 
  mutate(start = as.numeric(start), end = as.numeric(end)) %>% 
  mutate(is_valid_int = ifelse(start < end, TRUE, FALSE),
         is_wrong_order = ifelse(is_valid_int == FALSE&nchar(start)==nchar(end), TRUE, FALSE)) # nebudu resit spatny poradi, at si vyresi sami..

int_y <- interval0 %>% 
  filter(is_valid_int==T) %>% 
  mutate(Linvc = as.character(purrr::map2(start, end, ~toString(seq(.x, .y, by = 1))))) %>% 
  separate_rows(Linvc, sep = ",") %>% 
  mutate(Linvc = str_trim(Linvc),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Linvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Linvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Linvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Linvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Linvc, 6, pad = "0")),
                            TRUE ~ Linvc), 
         Msub = str_extract(Linvc, "[A-Za-z]+$")) %>% 
  unite(Minvc, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc, collapse = ",")) %>% 
  select(-Linvc, -Minvc0, -Minvc, -Msub) %>% 
  distinct() %>%
  ungroup() 
 
# int_n <- interval0 %>% 
#   filter(is_valid_int==F) %>% 
#    mutate(Minvc = paste("chybne zadany interval invc"),
#          invc5 = NA)
#  
# interval <- bind_rows(int_y, int_n) %>% 
#   # mutate(invc5 = Minvc) %>% 
#   relocate(invc5, .after = invc) %>% 
#   select(-start, -end, -is_valid_int, -is_wrong_order, -Minvc)

interval <- int_y

nrow(interval0) == nrow(interval) # neztratili jsme nejake radky cestou?
rm(interval0)


# ------------------------------------------------------ zbytek 143

# 134* NA
# 9* FALSE

nrow(ee %>% filter(is.na(isDoable))) 
nrow(ee %>% filter(isDoable == F)) 

zbytek <- ee %>% filter(isDoable == F|is.na(isDoable))
not_doable <- zbytek %>% filter(isDoable == F) %>% select(prirc4, sign, invc)                         
# write.table(not_doable, file = paste0(path_kk, "vystupy/", proj, "_problematickaINVC_signIIIb.csv"),
#             quote = T, row.names = F,
#             sep = ";", dec = ",",
#             na = "", fileEncoding="UTF-8")

nrow(single)+nrow(seznam)+nrow(interval)+nrow(zbytek)==nrow(ee) # chceme TRUE

# ------------------------------------------------------ JOIN 

ff <- bind_rows(single, seznam, interval, zbytek) %>% 
  relocate(invc5, .after = prirc4)

nrow(ff) == nrow(ee) # musi byt stejne!

# rm(aa)
# rm(bb)
# rm(cc)
# rm(dd)
# rm(ee)

fin <- ff

```


# --------------------------------------- IMPORTOVANO sign IIIc

2 excely -------------------------> KK_red.xlsx/IIIc
1942 a 1943

## READ

```{r}
CORE_IIIc <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "kniha IIIc", col_types = "text") %>% 
  mutate(rok12 = str_extract(zdroj, "^...."))

sort(unique(CORE_IIIc$zdroj)) 
sort(unique(CORE_IIIc$prirc)) 
sort(unique(CORE_IIIc$datumNabyti))
sort(unique(CORE_IIIc$pocetKs))
sort(unique(CORE_IIIc$cenaKc))

## EDA

eda <- CORE_IIIc

any(is.na(eda$prirc)) # TRUE !! -> dva zaznamy bez cisla, radky 300 a 305 v 1943 excelu
any(is.na(eda$rok12)) # FALSE

eda <- eda %>% 
  drop_na(prirc) %>%  # NA muzeme vypustit, protoze vime, jake to jsou !!
  unite(check, c("prirc", "rok12"), sep = "/", remove = F) %>% 
  select(check, prirc, rok12) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  ungroup() %>% 
  filter(isDupl==1) # chceme 0

# kontrola prirc, zda jsou jen ciselna

check <- CORE_IIIc %>% select(prirc) %>% 
  mutate(isNum = str_extract(prirc, "[A-Za-z]")) # -> subcisla !!

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

# eda
sample_n(CORE_IIIc, 10)

aa <- CORE_IIIc %>%
  # filter(rok12 == "1943") %>% 
  mutate(Mpref = "III",
         sbirka1 = "JCM",
         podsb2 = "99", 
         cisrada3 = "III", 
         prirvyraz9 = ifelse(isRed==T, 1, 0),
         pocetks13 = ifelse(is.na(pocetKs), "1", pocetKs),# sort(unique(CORE_IIIc$pocetKs)) -> vsechno ciselne udaje OK
         evid15 = "1",
         typ30 = "P",
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(Mpref, sbirka1, podsb2, cisrada3, prirvyraz9, rok12, pocetks13, evid15, typ30, datzap98, .before = zdroj)

```

## POZNAMKA, DATUM NABYTI, VYRAZENI

```{r}
bb <- aa %>% 
  # -------------------------------------------------- pozn20
  mutate(MnadpisPozn = ifelse(nadpis == T, poznamka, NA)) %>% 
  group_by(rok12, dolni) %>% 
  fill(MnadpisPozn, .direction = "down") %>% 
  unite(Mpozn, c("MnadpisPozn", "poznamka"), sep = "; ", na.rm = T) %>% 
  mutate(pozn20 = paste(ifelse(Mpozn!= "", paste0(Mpozn), ""),
                        ifelse(!is.na(cenaHa), paste0("halířů: ", cenaHa), ""), sep = "\n\n")) %>%
  ungroup() %>% 
# -------------------------------------------------- datnab22
group_by(rok12, dolni) %>% 
  mutate(Mdat = case_when(str_detect(datumNabyti, "III") ~ gsub("III", "3", datumNabyti),
                          str_detect(datumNabyti, "II") ~ gsub("II", "2", datumNabyti),
                          str_detect(datumNabyti, "I") ~ gsub("I", "1", datumNabyti),
                          str_detect(datumNabyti, "/") ~ gsub("/", ".", datumNabyti),
                          TRUE ~ datumNabyti),
         Mdat = ifelse(str_detect(Mdat, "\\.$"), Mdat, paste0(Mdat, ".")),
         datnab22 = ifelse(!is.na(Mdat), paste0(Mdat, rok12), NA)) %>% 
  group_by(prirc, rok12) %>% 
  fill(datnab22, .direction = "down") %>%
  ungroup() %>% 
  # -------------------------------------------------- vyrdat64, vyrdok67, poznvyr73
  mutate(MnadpisOdpis = ifelse(nadpis == T, odpisVyrazeni, NA)) %>% 
  group_by(rok12, dolni) %>% 
  fill(MnadpisOdpis, .direction = "down") %>% 
  unite(Modpis, c("MnadpisOdpis", "odpisVyrazeni"), sep = "; ", na.rm = T) %>% 
  ungroup() %>% 
  mutate(
    vyrdat64 = str_extract(Modpis, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
    vyrdok67 = ifelse(str_detect(Modpis, "č.*j.*\\d+"), 
                      str_extract(Modpis,"č\\.*j.*\\d+\\/\\d+-\\d+|č\\.*j.*\\d+\\/\\d+"), NA),
    poznvyr73 = ifelse(Modpis == "", NA, paste0("Odpis: ", Modpis))) %>%
  relocate(pozn20, datnab22, vyrdat64, vyrdok67, poznvyr73, .before = zdroj)
```

```{r CVICNA POZN}

cvic <- aa %>% 
  select(rok12, prirc, dolni, nadpis, odpisVyrazeni) %>% 
  mutate(MnadpisOdpis = ifelse(nadpis == T, odpisVyrazeni, NA)) %>% 
  group_by(rok12, dolni) %>% 
  fill(MnadpisOdpis, .direction = "down") %>% 
  unite(Modpis, c("MnadpisOdpis", "odpisVyrazeni"), sep = "; ", na.rm = T) %>% 
  ungroup() 


check <- aa %>% select(nadpis, prirc, dolni, poznamka)

```

## POPIS

```{r}
cc <- bb %>% 
 # -------------------------------------------------- popis11
  mutate(MnadpisNJ = ifelse(nadpis == T, popisNJ, NA),
         MnadpisCJ = ifelse(nadpis == T, popisCJ, NA)) %>% 
  group_by(rok12, dolni) %>% 
  fill(MnadpisNJ, .direction = "down") %>% 
  fill(MnadpisCJ, .direction = "down") %>% 
  unite(NJ, c("MnadpisNJ", "popisNJ"), sep = " ", na.rm = T) %>% 
  unite(CJ, c("MnadpisCJ", "popisCJ"), sep = " ", na.rm = T) %>% 
  mutate(NJ = paste0("popisNJ: ", NJ),
         CJ = paste0("popisCJ: ", CJ)) %>% 
  unite(popis11, c("NJ", "CJ"), sep = "\n\n", na.rm = T)  
  
```

## PRIRC

dropneme nadpis == TRUE, protoze vsechny informace z nadpisu jsou v podrazenych zaznamech
66 nadpisu -> sedi s excelem

```{r}
dd <- cc %>% 
  # -------------------------------------------------- prirc4 
  filter(is.na(nadpis)) %>% # 617-66=551 OK
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  ungroup() %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = ifelse(prirc == "110 a,b", 1, as.numeric(Msub))) %>%  # aby jediny zaznam se subcislem mel subcislo 1
  # -------------------------------------------------- prirc4 
  mutate(Mp0 = str_pad(porc104, 3, pad = 0),
         Ms0 = str_pad(subc105, 2, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0)),
         prirc4 = ifelse(prirc4 == "III110/1942-01", "III110/1942-a,b", prirc4)) %>% 
  select(-Mpref, -Mporc, -Msub, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  relocate(prirc, prirc4, porc104, subc105, .after = cisrada3)

fin <- dd
```

```{r CVICNE PRIRC}

cvic <- cc %>% 
  filter(is.na(nadpis)) %>%
  select(Mpref, prirc, rok12, prirc) %>% 
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  ungroup() %>% 
  select(Mporc, Mpref, prirc, rok12, Msub) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = ifelse(prirc == "110 a,b", 1, as.numeric(Msub))) %>%  # aby jediny zaznam se subcislem mel subcislo 1
  # -------------------------------------------------- prirc4 
  mutate(Mp0 = str_pad(porc104, 3, pad = 0),
         Ms0 = str_pad(subc105, 2, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0)),
         prirc4 = ifelse(prirc4 == "III110/1942-01", "III110/1942-a,b", prirc4)) %>% 
  select(-Mpref, -Mporc, -Msub, -Mp0, -Ms0, -Mslash, -Mdash) 




  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() 
# -------------------------------------------------- vedouci nuly -> kontrola a doplneni v Mp0 a Ms0
vednul <- cvic %>% select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()
view(vednul)
# -------------------------------------------------- prirc4 - part 2
aa <- a %>% 
  mutate(Mp0 = str_pad(porc104, 3, pad = 0),
         Ms0 = str_pad(subc105, 2, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) 

```

# --------------------------------------- IMPORTOVANO sign IIId

## READ

```{r}
CORE_IIId <- readxl::read_excel(paste0(path_kk, "data/KK_red.xlsx"), sheet = "kniha IIId", col_types = "text") 

sort(unique(CORE_IIId$rok)) 
sort(unique(CORE_IIId$podsbirka))
sort(unique(CORE_IIId$sign))
```

## EDA

```{r}

eda <- CORE_IIId

any(is.na(eda$prirc)) # FALSE
any(is.na(eda$rok)) # FALSE

eda <- eda %>% 
  unite(check, c("prirc", "rok"), sep = "/", remove = F) %>% 
  select(check, prirc, rok) %>% 
  group_by(check) %>% 
  mutate(isDupl = ifelse(n()!=1, 1, 0)) %>% 
  filter(check==1) # chceme 0

# kontrola prirc, zda jsou jen ciselna

check <- CORE_IIId %>% select(prirc) %>% 
  mutate(isNum = str_extract(prirc, "[A-Za-z]")) # -> zadna subcisla

```

## POVINNE

\sbirka1        -> sbirka dle MUSEIONu
\podsb2         -> podsbirka KOD dle MUSEIONu
\cisrada3       -> kod prirustkove knihy
\prirc4         -> 
\rok12          -> 
\pocetks13      -> pokud neni definovano, je treba zadat [1] ; zkontrolovat, jestli nejsou 6+3 apod (do pozn20)
\evid15         -> pro moznost propojeni s invc nutne zadat [1]
\typ30          -> hodnota "P"(obecný) nebo "PA"(archeologický)
? ("polks53")
\datzap98       -> pokud neni definovano, zadavame 31.12.[rok12]
\porc104        -> poradove cislo prirustku

```{r, warning=F}

# eda
sample_n(CORE_IIId, 10)

a <- CORE_IIId %>% 
  mutate(Mpref = "III",
         sbirka1 = "JCM",
         cisrada3 = "III", 
         prirvyraz9 = ifelse(isRed==T, 1, 0),
         rok12 = rok,
         evid15 = "1",
         typ30 = "P", 
         datzap98 = paste0("31.12.", rok12)) %>% 
  relocate(sbirka1, cisrada3, prirvyraz9, rok12, evid15, typ30, datzap98, .before = zdroj) %>% 
  # -------------------------------------------------- podsb2
  mutate(podsb2 = case_when(podsbirka == "1" ~ "151",
                            podsbirka == "10" ~ "158",
                            podsbirka == "11" ~ "160",
                            podsbirka == "13" ~ "154",
                            podsbirka == "15" ~ "161",
                            podsbirka == "17" ~ "155",
                            podsbirka == "18" ~ "159",
                            podsbirka == "19" ~ "162",
                            podsbirka == "20" ~ "164",
                            podsbirka == "21" ~ "156",
                            podsbirka == "25"&sign %in% c("D", "H") ~ "166", # KONFLIKT !!!
                            podsbirka == "25"&str_detect(sign, "MDRH") ~ "167",
                            podsbirka == "25"&sign %in% c("O", "PVS", "VS") ~ "168", 
                            podsbirka == "5" ~ "165",
                            podsbirka == "6" ~ "157",
                            podsbirka == "7" ~ "152",
                            podsbirka == "8" ~ "163",
                            podsbirka == "9" ~ "153",
                            TRUE ~ "99"),
         POZN20_podsb = case_when(is.na(podsbirka) ~ paste0("Podsbírka č.: neuvedena"),
                                  podsb2 == "99" ~ paste0("Podsbírka č.: ", podsbirka),
                                  TRUE ~ NA)) %>% 
  # -------------------------------------------------- prirc4 - part 1
  mutate(Mporc = str_extract(prirc, "\\d+"),
         Mprirc = paste0(Mpref, Mporc, "/", rok12)) %>% 
  group_by(Mprirc) %>% 
  mutate(isDupl_prirc = ifelse(n() == 1, F, T),
         Msub = ifelse(isDupl_prirc == F, NA, seq_along(Mprirc))) %>% 
  relocate(Mpref, Mporc, Msub, Mprirc, .before = zdroj) %>% 
  # -------------------------------------------------- porc104, subc105
  mutate(porc104 = as.numeric(Mporc),
         subc105 = as.numeric(Msub)) %>% 
  # -------------------------------------------------- vedouci nuly
  group_by(rok12) %>% 
  mutate(maxcp = max(porc104, na.rm = TRUE),
         maxp = nchar(maxcp)) %>% 
  relocate(maxcp, maxp, .after = subc105) %>% 
  mutate(maxcs = max(subc105, na.rm = TRUE),
         maxcs = ifelse(maxcs == "-Inf", NA, maxcs), # warning je ok, timhle radkem ho napravujeme 
         maxs = nchar(maxcs),
         maxs = ifelse(is.na(maxs), 0, maxs)) %>% 
  relocate(maxcs, maxs, .after = maxp) %>% 
  ungroup() 

# -------------------------------------------------- vedouci nuly -> kontrola a doplneni v Mp0 a Ms0
vednul <- a %>% select(rok12, Mpref, maxcp, maxp, maxcs, maxs) %>% distinct()
view(vednul)
# -------------------------------------------------- prirc4 - part 2
aa <- a %>% 
  mutate(Mp0 = str_pad(porc104, 3, pad = 0),
         Ms0 = str_pad(subc105, 2, pad = 0),
         Mslash = "/",
         Mdash = "-",
         prirc4 = ifelse(is.na(subc105), paste0(Mpref, Mp0, Mslash, rok12), 
                         paste0(Mpref, Mp0, Mslash, rok12, Mdash, Ms0))) %>% 
  select(-Mpref, -Mporc, -Msub, -Mprirc, -maxcp, -maxp, -maxcs, -maxs, -Mp0, -Ms0, -Mslash, -Mdash) %>% 
  # -------------------------------------------------- pocetks13
  mutate(isCislo = ifelse(!is.na(as.numeric(pocetKs)) & !is.na(pocetKs),
                          ifelse(as.numeric(pocetKs) > 0, T, F),F), 
         isCislo = ifelse(is.na(isCislo), F, isCislo),
         pocetks13 = ifelse(isCislo == F, "1", pocetKs),
         # POZN20_pocetks = ifelse(isCislo == F&!is.na(pocetKs), paste0("Počet ks: ", pocetKs), NA)) %>% 
         POZN20_pocetks = case_when(isCislo == F&!is.na(pocetKs) ~ paste0("Počet ks: ", pocetKs),
                                    isCislo == F&is.na(pocetKs) ~ paste0("Počet ks: neuveden"),
                                    TRUE ~ NA)) %>% 
  # -------------------------------------------------- pozn20
  unite(pozn20, c("POZN20_podsb","POZN20_pocetks"), sep = "\n", na.rm = T, remove = FALSE) %>%  
  # -------------------------------------------------- RELOCATE
  relocate(prirc4, porc104, subc105, podsb2, pocetks13, pozn20, .before = zdroj)

  # parkrat zkontroluj
sample_n(aa, 10) %>% select(rok, prirc, porc104, subc105, prirc4) # ok
sample_n(aa, 10) %>% select(pocetKs, pocetks13, POZN20_pocetks) # ok

```

## NABYTI, PUVOD, POPIS

ozn10
popis 11

datnab22
zpnab23
cennab27
nabpozn29

puvmaj28 

```{r ZKONTROLOVANO}

bb <- aa %>% 
  # -------------------------------------------------- ozn10;  popis11
  mutate(ozn10 = predmet,
         lengthPopis = nchar(popis),                                                       # popis muze mit 2000 charakterů
         popis11 = popis) %>% 
  # -------------------------------------------------- datnab22
   # mutate(Mdat = format(as.Date(datumNabyti, origin = "1899-12-30"), "%d.%m.%Y"),
   #        is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
   #        is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% 
   # mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
   mutate(Mdat_ser = as.numeric(datumNabyti),
          Mdat = format(as.Date(Mdat_ser, origin = "1899-12-30"), "%d.%m.%Y")) %>% 
          # Mdat = case_when(str_detect(datumNabyti, "^.....$") ~ Mdat_trans,
          #                 str_detect(datumNabyti, ",") ~ sub(",", ".", datumNabyti),
          #                 str_detect(datumNabyti, "^r\\.") ~ paste0("01.01.", str_extract(datumNabyti, "\\d+")), 
          #                 str_detect(datumNabyti, "^K") ~ sub("K", "", datumNabyti), 
          #                 str_detect(datumNabyti, "\\.$") ~ sub("\\.$", "", datumNabyti), 
          #                 str_detect(datumNabyti, "^19..$") ~ paste0("01.01.", datumNabyti),
          #                 str_detect(datumNabyti, ".*X.*") ~ str_replace(datumNabyti, "X", "10"),
          #                 TRUE ~ datumNabyti)) %>%
   mutate(is_valid_date = !is.na(as.Date(Mdat, format = "%d.%m.%Y")),
          is_valid_date2 = ifelse(!is.na(Mdat), is_valid_date, NA)) %>% relocate(Mdat, is_valid_date2, .after = datumNabyti) %>% 
  mutate(datnab22 = ifelse(is_valid_date2 == "TRUE", Mdat, NA)) %>% 
  relocate(datnab22, .after = datumNabyti) %>% 
  # select(-Mdat_ser, -Mdat, -is_valid_date) %>% 
  # -------------------------------------------------- zpnab23
  # sort(unique(bb$zpusobNabyti))
  mutate(zpnab23 = case_when(str_detect(zpusobNabyti, "(?i)koupě.*autor") ~ "A",
                             str_detect(zpusobNabyti, "(?i)koupě.*dědic") ~ "B",
                             str_detect(zpusobNabyti, "(?i)dědictví") ~ "C",
                             str_detect(zpusobNabyti, "(?i)dar") ~ "D",
                             str_detect(zpusobNabyti, "(?i)deposit") ~ "E",
                             str_detect(zpusobNabyti, "(?i)konf") ~ "F",
                             str_detect(zpusobNabyti, "(?i)jiný") ~ "J",
                             str_detect(zpusobNabyti, "(?i)koup") ~ "K",
                             str_detect(zpusobNabyti, "(?i)nález|nalez") ~ "N",
                             str_detect(zpusobNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpusobNabyti, "(?i)převod") ~ "P",
                             str_detect(zpusobNabyti, "(?i)replika") ~ "R",
                             str_detect(zpusobNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpusobNabyti, "(?i)pozůstalost") ~ "T",
                             str_detect(zpusobNabyti, "(?i)výzkum|vyzkum") ~ "V",
                             str_detect(zpusobNabyti, "(?i)směna") ~ "X",
                             str_detect(zpusobNabyti, "(?i)výkup|vykoup") ~ "Y",
                             str_detect(zpusobNabyti, "(?i)výroba") ~ "Z",
                             str_detect(zpusobNabyti, "(?i)sběr") ~ "1",
                             str_detect(zpusobNabyti, "(?i)činnost") ~ "2",
                             str_detect(zpusobNabyti, "(?i)nákup") ~ "3",
                             str_detect(zpusobNabyti, "(?i)terén.*akce") ~ "4",
                             is.na(zpusobNabyti) ~ "U", # neuvedeno 
                             TRUE ~ "J"),
         doklnab25 = odkazDoklad,
         # cennab27 = ifelse(str_detect(zpusobNabyti, ",-|Kčs"), str_extract(zpusobNabyti, "\\d+"), ifelse(str_detect(zpusobNabyti, "\\d+,\\d+"), str_extract(zpusobNabyti, "\\d+,\\d+"), NA)),
         cennab27 = ifelse(str_detect(zpusobNabyti, ",-")&str_detect(zpusobNabyti, "\\d+,\\d+"), str_extract(zpusobNabyti, "\\d+,\\d+"), ifelse(str_detect(zpusobNabyti, "\\d+,-"), str_extract(zpusobNabyti, "\\d+"), NA)),
         cennab27 = str_trim(gsub(",-", "", cennab27)),  
         cennab27 = str_trim(gsub(",", ".", cennab27))) %>% 
  # -------------------------------------------------- nabpozn29
  mutate(POZN29_datum = ifelse(is.na(datnab22)&!is.na(datumNabyti), paste0("Datum nabytí: ", datumNabyti), NA),
         POZN29_zpusob = ifelse(!is.na(zpusobNabyti), paste0("Způsob nabytí: ", zpusobNabyti), NA)) %>% 
  unite(nabpozn29, c("POZN29_datum","POZN29_zpusob"), sep = "\n", na.rm = T, remove = FALSE) %>% 
  # -------------------------------------------------- RELOCATE
  # -------------------------------------------------- puvmaj28 ; prisp87 
  mutate(puvmaj28 = puvodMajitel) %>% 
# -------------------------------------------------- RELOCATE
  relocate(ozn10, popis11, datnab22, zpnab23, cennab27, nabpozn29, puvmaj28, .before = zdroj)


# check duplicity pricr4
check <- bb %>% 
  group_by(prirc4) %>% 
  filter(n() != 1) # zadne duplicity v prirc ! ;-)

# check lengthPopis
any(bb$lengthPopis > 2000) # chceme FALSE

# check zpusob nabyti
check <- bb %>% select(zpusobNabyti, zpnab23, cennab27, nabpozn29) %>% distinct()

# CLEAR

bb <- bb %>%  select(-lengthPopis, -is_valid_date, -is_valid_date2)
rm(check)

```

## VYRAZENI 

```{r}

over <- bb %>% select(odpisVyrazeni) %>% distinct()

cc <- bb %>% 
  # -------------------------------------------------- datvyr64 ; dokvyr67 ; poznvyr73
  mutate(
    vyrdat64 = str_extract(odpisVyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
    vyrdok67 = ifelse(str_detect(odpisVyrazeni, "č.*j.*\\d+"), 
                      str_extract(odpisVyrazeni, "č\\..*j\\.\\s.*OMG|č\\..*j\\..*MK\\s\\d+\\/\\d+|čj\\.\\s.*OMG|č\\.j\\.: \\d+\\/\\d+-\\d+|č\\.j\\.: \\d+\\/\\d+"), NA),
    poznvyr73 = ifelse(is.na(odpisVyrazeni), NA, paste0("Odpis / převod / vyřazení atd.: ", odpisVyrazeni))) %>%
  relocate(vyrdat64, vyrdok67, poznvyr73, .before = zdroj)
  
check <- cc %>% select(odpisVyrazeni, vyrdat64, vyrdok67, poznvyr73) %>% distinct()
view(check)
```

## TEXTY, PRIZNAKY, POZNAMKA

(text1 - umisteni
text2 - umisteniCZ)
text3 - jinecislo
text4 = revize
text5 = signatura
text6 = puvodni invc


```{r}

dd <- cc %>% 
  mutate(text3_90 = jineCislo) %>% 
  mutate(text4_91 = revize) %>% 
  mutate(text5_92 = sign) %>% 
  mutate(text6_99 = invc) %>% 
  # mutate(text7_100 = chyb_invc) %>%
  relocate(text3_90, text4_91, text5_92, text6_99, .before = zdroj)
```

## INVENTARNI CISLA

```{r}

# proces

ee <- dd %>% 
  mutate(
        type_invc = case_when(str_detect(invc, "^[A-Za-z]*\\s*\\d+$") ~ "single",
                               str_detect(invc, "\\d+,\\s*\\d+")&!str_detect(invc, "-|[A-Za-z]") ~ "seznam",
                               str_detect(invc, "^\\d+\\s*-\\s*\\d+$") ~ "interval",
                               str_detect(invc, ",")&str_detect(invc, "\\d+\\s*-\\s*\\d+") ~ "sez+int",
                               is.na(invc) ~ NA,
                               TRUE ~ "tbd"),
         isDoable = ifelse(type_invc %in% c("single", "seznam", "interval")&sign %in% val_sign, T, 
                           ifelse(is.na(invc), NA, F))) %>%                                 # !!!! dulezity priznak !!!!
  relocate(type_invc, isDoable, .after = invc)

prehled <- ee %>% filter(isDoable == T) %>% select(prirc4, sign, invc, type_invc, isDoable) %>% filter(!is.na(invc))
summary(as.factor(prehled$type_invc))

# ------------------------------------------------------ single 89

single <- ee %>% filter(type_invc == "single"&isDoable == T) %>% 
  mutate(Minvc = str_extract(invc, "\\d+"),
         Msub = str_extract(invc, "[A-Za-z]+$"),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc)) %>% 
  unite(invc5, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-Minvc, -Msub, -Minvc0)

prehled_sin <- single %>% select(prirc4, invc, type_invc, invc5)

# ------------------------------------------------------ seznam 13

seznam <- ee %>% filter(type_invc == "seznam"&isDoable == T) %>% 
  mutate(numbers = invc) %>% 
  separate_rows(numbers, sep = ",") %>% 
  # rename("numbers" = invc) %>% 
  mutate(numbers = str_trim(numbers),
         Minvc = ifelse(str_detect(numbers, "^[A-Za-z]+"), str_extract(numbers, "\\d+"), numbers),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Minvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Minvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Minvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Minvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Minvc, 6, pad = "0")),
                            TRUE ~ Minvc), 
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>%
  unite(Minvc_single, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  relocate(Minvc_single, .after = numbers) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc_single, collapse = ",")) %>% 
  relocate(invc5, .after = invc) %>% 
  select(-numbers, -Minvc, -Minvc0, -Msub, -Minvc_single) %>% 
  distinct() %>% 
  ungroup()

# ------------------------------------------------------ interval 2

interval0 <- ee %>% filter(type_invc == "interval"&isDoable == T) %>% 
  separate(invc, into = c("start", "end"), sep = "-", remove = F) %>% 
  mutate(start = as.numeric(start), end = as.numeric(end)) %>% 
  mutate(is_valid_int = ifelse(start < end, TRUE, FALSE),
         is_wrong_order = ifelse(is_valid_int == FALSE&nchar(start)==nchar(end), TRUE, FALSE)) # nebudu resit spatny poradi, at si vyresi sami..

int_y <- interval0 %>% 
  filter(is_valid_int==T) %>% 
  mutate(Linvc = as.character(purrr::map2(start, end, ~toString(seq(.x, .y, by = 1))))) %>% 
  separate_rows(Linvc, sep = ",") %>% 
  mutate(Linvc = str_trim(Linvc),
         Minvc0 = case_when(sign %in% mask2 ~ paste0(sign, str_pad(Linvc, 2, pad = "0")),
                            sign %in% mask3 ~ paste0(sign, str_pad(Linvc, 3, pad = "0")),
                            sign %in% mask4 ~ paste0(sign, str_pad(Linvc, 4, pad = "0")),
                            sign %in% mask5 ~ paste0(sign, str_pad(Linvc, 5, pad = "0")),
                            sign %in% mask6 ~ paste0(sign, str_pad(Linvc, 6, pad = "0")),
                            TRUE ~ Linvc), 
         Msub = str_extract(Linvc, "[A-Za-z]+$")) %>% 
  unite(Minvc, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  group_by(prirc4) %>% 
  mutate(invc5 = paste0(Minvc, collapse = ",")) %>% 
  select(-Linvc, -Minvc0, -Minvc, -Msub) %>% 
  distinct() %>%
  ungroup() 
 
# int_n <- interval0 %>% 
#   filter(is_valid_int==F) %>% 
#    mutate(Minvc = paste("chybne zadany interval invc"),
#          invc5 = NA)
#  
# interval <- bind_rows(int_y, int_n) %>% 
#   # mutate(invc5 = Minvc) %>% 
#   relocate(invc5, .after = invc) %>% 
#   select(-start, -end, -is_valid_int, -is_wrong_order, -Minvc)

interval <- int_y

nrow(interval0) == nrow(interval) # neztratili jsme nejake radky cestou?
rm(interval0)


# ------------------------------------------------------ zbytek 138

# 100* NA
# 38* FALSE

nrow(ee %>% filter(is.na(isDoable))) 
nrow(ee %>% filter(isDoable == F)) 

zbytek <- ee %>% filter(isDoable == F|is.na(isDoable))
not_doable <- zbytek %>% filter(isDoable == F) %>% select(prirc4, sign, invc)                         
# write.table(not_doable, file = paste0(path_kk, "vystupy/", proj, "_problematickaINVC_signIIIa.csv"),
#             quote = T, row.names = F,
#             sep = ";", dec = ",",
#             na = "", fileEncoding="UTF-8")

nrow(single)+nrow(seznam)+nrow(interval)+nrow(zbytek)==nrow(ee) # chceme TRUE

# ------------------------------------------------------ JOIN 

ff <- bind_rows(single, seznam, interval, zbytek) %>% 
  relocate(invc5, .after = prirc4)

nrow(ff) == nrow(ee) # musi byt stejne!

# rm(aa)
# rm(bb)
# rm(cc)
# rm(dd)
# rm(ee)

fin <- ff

```


# ------------------ S A V E ------------------ 

```{r}

df_save <- fin

# ------------------------------------------------------ switch
# uprav dle excelu, ktery zpracovavas

# n <- 3640
# # imp <- "signatura_A"

# n <- 189
# # imp <- "signatura_S"

# n <- 14
# # imp <- "signatura_FI"

# n <- 1892
# # imp <- "signatura_F"

# n <- 460
# # imp <- "signatura_H"

# n <- 928
# # imp <- "signatura_IIa"

# n <- 1193
# # imp <- "signatura_IIb"

# n <- 1844
# # imp <- "signatura_P"

# n <- 2498
# imp <- "signatura_St"

# n <- 5758
# # imp <- "signatura_IIIa"

# n <- 179
# imp <- "signatura_IIIb"

# n <- 551
# imp <- "signatura_IIIc_19421943"

n <- 242
imp <- "signatura_IIId_1946"

# n <- 2582
# imp <- "signatura_DCM"


# ------------------------------------------------------ priprava tabulky

Lpk <- c("sbirka1", "podsb2", "cisrada3", "prirc4", "invc5", "lok6","prirpla7", "duvnepla8", "prirvyraz9", "ozn10",
         "popis11", "rok12", "pocetks13", "obal14", "evid15", "mater16", "datace17", "stav18", "popstav19", "pozn20",
         "liter21", "datnab22", "zpnab23", "typ24","doklnab25", "mena26", "cennab27", "puvmaj28", "nabpozn29", "typ30",
         "armisto31", "arkontext32", "arakce33", "arvyzk34", "arlok35", "arku36", "arparc37", "arpoz38", "nalpozn39", "naladr40",
         "nalokr41", "nalobec42", "nalcast43", "nalmc44", "nalcis45", "nalul46", "nalorc47", "nalpsc48", "stat49", "artext50",
         "polpop51", "polCES52", "polks53", "poldopl1_54", " poldopl1_55", "poldopl2_56", "poldopl2_57", "poldopl3_58", "poldopl3_59", "archiv60",
         "acvsign61", "acvmark62", "acvpozn63", "vyrdat64", "vyrduv65", "vyrtyp66", "vyrdok67", "vyrmena68", "vyrcena69", "zpub70",
         "vyrCES71", "novaj72", "poznvyr73", "predchmaj74", "userins75", "datins76", "arkontext2_77", "arkontext3_78", "arkomp79", "arSJTSK80",
         "arcizivyz81", "arnazevvyz82", "arrokvyz83", "arfirmavyz84", "arvedoucivyz85", "rokakvi86", "prisp87", 
         "text1_88", "text2_89", "text3_90", "text4_91", "text5_92", 
         "priz1_93", "priz2_94", "priz3_95", "priz4_96", "priz5_97",
         "datzap98", "text6_99", "text7_100", "text8_101", "text9_102", "text10_103", "porc104", "subc105", "puv_invc106") # 105 ; 106 jen pro pozdejsi (invc)

mus_tab <- data.frame(smazme = 1:n)

for(i in Lpk){
  if(i %in% colnames(df_save)){
    ano <- df_save %>% select(all_of(i))
    mus_tab <- cbind(mus_tab, ano)
    # print("jo")
  } else{
    ne <- data.frame(rep(NA, n))
    colnames(ne) <- i
    mus_tab <- cbind(mus_tab, ne)
    # print("houby")
    }
}

mus_tab <- mus_tab %>% select(-smazme) %>% arrange(rok12, porc104, subc105)

check <- mus_tab %>% select(prirc4, rok12, porc104, subc105)

```

## full csv

```{r}

f2s <- paste0(path_kk, "import/", proj, "_import_", imp, ".csv")

if(file.exists(f2s)){
  print("You've been here before!")
  rm(f2s)
} else {
  write.table(mus_tab, file = f2s,
            quote = T, row.names = F,
            sep = ";", dec = ",",
            # na = "", fileEncoding="cp1250")
            na = "", fileEncoding = "UTF-8")
  print("Import csv  W R I T T E N  !")
  rm(f2s)
}
```

## sample

```{r}

sam <- mus_tab %>% slice(1:10) # TOP 10
# sam <- sample_n(mus_tab, 10) # RNDM SMPL

f2s <- paste0(path_kk, "import/sample_", proj, "_import_", imp, ".csv")

if(file.exists(f2s)){
  print("You've been here before!")
  rm(f2s)
} else {
  write.table(sam, file = f2s,
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="UTF-8")
            # na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  rm(f2s)
}
```

## acc factor

```{r}

mus_tab$rok12 <- as.factor(mus_tab$rok12)

df_list <- split(mus_tab, mus_tab$rok12)

for (i in seq_along(df_list)) {
  subset_df <- df_list[[i]]
  group_name <- unique(subset_df$rok12)
  # write.csv(subset_df, paste0(path_kk, "import/", proj, "_import_", group_name, ".csv"), row.names = FALSE)
  write.table(subset_df, file = paste0(path_kk, "import/roky/", proj, "_import_", group_name, ".csv"),
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="UTF-8")
}
```

# ------- OBDOBI CISELNE RADY -------

Kód řady	$kodRady 	povinny
Typ řady	$typRady 	povinny
Rok	$rok 	povinny,int
Maska	$maska 	povinny
Počet číslic	$pocetCislic 	int >0
Počitadlo	$pocitadlo 	int>0
Poslední použité číslo	$posledniPouziteCislo	

SELECT "" As 1kodRady , "" As 2typRady , "" As 3rok , "" As 4maska , "" As 5pocetCislic , "" As 6pocitadlo , "" As 7posledniPouziteCisl FROM TABULKA;								

```{r}

kodrady1 <- rep("III", 26)
typrady2 <- rep("PK", 26)
# rok3 <- seq(1900, 1942)
rok3 <- sort(unique(mus_tab$rok12))
maska4 <- rep("{S}{###}/{YYYY}-{##}", 26)
pocetCis5 <- rep("3", 26)
pocitadlo6 <- rep("0", 26)
poslPouz7 <- rep("", 26)

ocr <- data.frame(kodrady1, typrady2, rok3, maska4, pocetCis5, pocitadlo6, poslPouz7)

write.table(ocr, file = paste0(path_kk, "import/", proj, "_obdobiCiselneRady_IIIa.csv"),
            quote = T, row.names = F,
            sep = ";", dec = ",",
            na = "", fileEncoding="UTF-8")
```

