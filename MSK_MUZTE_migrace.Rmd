---
title: "MUZTE"
subtitle: "Migrace dat"
author: "Katerina Krizova"
date: "2023-02-08"
output:
  pdf_document
    toc: true
    toc_depth: 2
    number_sections: false
    fig_caption: true
  fontsize: 11pt
  geometry: margin=1in

---

\newpage 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=FALSE, fig.dim = c(8, 4))

# PACKAGES

# install.packages("tidyverse", dependencies = T)
# install.packages("readxl")
# install.packages("stringr")
# install.packages("stringi")
# install.packages("mdbr")
# install.packages("RODBC")
# install.packages("odbc")
# install.packages("xlsx")
require(tidyverse)
require(readxl)
require(stringr) # ::str_split_fixed
require(stringi) # ::stri_detect_fixed - detect empty string
require(mdbr) # ::read_mdb
require(RODBC) # ::read_mdb
require(odbc) # ::read_mdb
require(xlsx) # write excel in sheets
```

\newpage 

# P O Z N A M K Y 

! sepis si podrobnou migracni matici
! pis poznamky do notes

! str_trim pro celou bach tabulku !!  
! zkontroluj duplicity puvodnich inventarnich cisel !!  

! taxon ve formatu: r o d   d r u h   *s u b s p.*  p o d d r u h !!
! vse, co se nesparuje nechat pouze v 'originalni jmeno'

! slovniky - karta - doprovodne
! kontrola: policko po policku, zda zadna informace nechybi
 
\newpage 

# PROJEKT A CESTY

```{r PROJECT SPECIFICATIONS AND PATHS}

projekt <- "MUZTE"

path <-  "C:/Users/krizova/Documents/R/"
path_proj <-  paste0("C:/Users/krizova/Documents/R/MIG/", projekt, "/") 

path_data <-  paste0(path_proj, "data/")
path_csv <-  paste0(path_proj, "csv/")
path_kd <- paste0(path_proj, "kd/")
```

## nacist bach tabulku

```{r LOAD AND INIT MODIF}

# L O A D

dbname <- paste0(path_data, "muzTE_bio.accdb") 
con <- RODBC::odbcConnectAccess2007(dbname)      
bach0 <- RODBC::sqlFetch(con, "lcl_botanika")   


# M U S E I O N   E V I D E N C E

bach <- bach0 %>% 
  mutate(MSBIRKA = "MUZTE",
         MPODSB = "5",
         MPODSBnaz = "Botanická",
         MFOND = "Botanika",
         MFONDnaz = "Botanika",
         X = NA) %>% 
  select(-contains("_sort"), -nvg_id, -id) %>%  # vyrad nadbytecne bach sloupce
  mutate(across(where(is.character), str_trim)) # zbav se nadbytecnych mezer


# M I G R A C N I   M A T I C E

mm <- as.data.frame(colnames(bach)) # zkopiruj do excelu a vytvor si migr. matici
# write.xlsx(x = mm, file = paste0(path_proj, "MUZTE_migracni_matice.xlsx"))

# rm(bach0)
rm(mm)
```

## sort unique

vymenuj nazev sloupce dle potreby

```{r}

sort(unique(bach$publikace))

```


## biolib + ciselniky

```{r BIOSLOVNIKY}

# B I O L I B   S L O V N I K

biolib <- read.csv(paste0(path, "bioslov/BioLib_KKsummary_plantae.csv"), sep = ";") 
# bl_mech <- read.csv(paste0(path, "bioslov/BioLib_KKsummary_plantae.csv"), sep = ";") 

bl_subsp <- biolib %>% filter(!is.na(poddruh_Nomen))
bl_sp <- biolib %>% filter(is.na(poddruh_Nomen)) %>% filter(!is.na(druh_Nomen)) %>% purrr::discard(~all(is.na(.)))
bl_rod <- biolib %>% filter(!is.na(rod_Nomen)) %>% select(1:24) %>% distinct()
bl_cel <- biolib %>% filter(!is.na(rod_Nomen)) %>% select(1:19) %>% distinct()
bl_rad <- biolib %>% filter(!is.na(rad_Nomen)) %>% select(1:14) %>% distinct()
bl_tri <- biolib %>% filter(!is.na(trida_Nomen)) %>% select(1:9) %>% distinct()
bl_kme <- biolib %>% filter(!is.na(kmen_Nomen)) %>% select(1:4) %>% distinct()

# dbname <- paste0(path_data, "botanicke_lokality.mdb") 
# dbname <- paste0(path_data, "botanicke_lokality.mdb") 
# con <- RODBC::odbcConnectAccess2007(dbname)      
# botlok <- RODBC::sqlFetch(con, "data")  
#  
# dbname <- paste0(path_data, "ciselnik_botanickych_rodu.mdb") 
# con <- RODBC::odbcConnectAccess2007(dbname)      
# botrod <- RODBC::sqlFetch(con, "data") 
# 
# dbname <- paste0(path_data, "ciselnik_botanickych_druhu.mdb") 
# con <- RODBC::odbcConnectAccess2007(dbname)      
# botdru <- RODBC::sqlFetch(con, "data") 
```

# NASTAVENI

## fondy 

rucne, pouze jeden Botanika Botanika (kod, nazev)


## skupiny

rucne, P a PB 


## podskupiny

rucne, PB 1) Bezcévnaté 2) Tracheophyta


# SLOVNIKY

## A D R E S A R *-*-*-*-*-*

*IMPORTNÍ ROZHRANÍ*: CSV Adresář osob  
**MUSEION**: import_adresar.csv
    
POZN:

pole:  
    + create_uid
    + lastwrite_uid -> *mozna nepotrebujeme ?! *
    + sberatel  (vice zaznamu)  
    + urcil  (vice zaznamu)  

### analyza

```{r ADRESAR}

# install.packages("randomNames")
require(randomNames)

sort(unique(bach$create_uid))
sort(unique(bach$lastwrite_uid))
sort(unique(bach$sberatel))
sort(unique(bach$urcil))
```

### priprava bach_adr

```{r ADRESAR}

bach_adr <- bach %>% 
  # create_uid  
  mutate(M1 = case_when(create_uid == "dpodstawkova" ~ "D.",
                        create_uid == "jana.glombova" ~ "Jana",
                        create_uid == "nela.kotaskova" ~ "Nela",
                        TRUE ~ NA),
         M2 = case_when(create_uid == "dpodstawkova" ~ "Podstawková",
                        create_uid == "jana.glombova" ~ "Glombová",
                        create_uid == "nela.kotaskova" ~ "Kotásková",
                        create_uid %in% c("skarka", "Skarka") ~ "Skarka",
                        create_uid %in% c("svendova", "Svendova") ~ "Svendova",
                        TRUE ~ NA)) %>% 
  unite(MCREATE, c(M2, M1), sep = " ", na.rm = T, remove = FALSE) %>% 
  # lastwrite_uid  
  mutate(M1 = case_when(lastwrite_uid == "dpodstawkova" ~ "D.",
                        lastwrite_uid == "jana.glombova" ~ "Jana",
                        lastwrite_uid == "nela.kotaskova" ~ "Nela",
                        lastwrite_uid == "Skarka" ~ NA,
                        TRUE ~ NA),
         M2 = case_when(lastwrite_uid == "dpodstawkova" ~ "Podstawková",
                        lastwrite_uid == "jana.glombova" ~ "Glombová",
                        lastwrite_uid == "nela.kotaskova" ~ "Kotásková",
                        lastwrite_uid %in% c("skarka", "Skarka") ~ "Skarka",
                        TRUE ~ NA)) %>% 
  unite(MLSTWR, c(M2, M1), sep = " ", na.rm = T, remove = FALSE) %>% 
  # sberatel
  mutate(
    Msberatel = case_when(sberatel == "Buša E." ~ "Burša E.",
                          sberatel == "Kousalová Š:" ~ "Kousalová Š.",
                          sberatel %in% c("J. a P. Pavlíkovi", "Pavlíkovi P. A J.") 
                          ~ "Pavlíkovi P. a J.",
                          sberatel == "D. Podstawková" ~ "Podstawková D.", TRUE ~ sberatel), 
    M1 = ifelse(str_detect(Msberatel, "^\\w+\\s\\w\\.$"), str_extract(Msberatel, "\\w\\.$"), 
                ifelse(str_detect(Msberatel, "^\\w\\.\\s\\w+$"), str_extract(Msberatel, "^\\w\\."), NA)),
    M2 = ifelse(str_detect(Msberatel, "^\\w+\\s\\w\\.$"), str_extract(Msberatel, "^\\w+"),
                ifelse(str_detect(Msberatel, "^\\w\\.\\s\\w+$"), str_extract(Msberatel, "\\w+$"), NA))
    ) %>% 
  unite(MSBERAT, c(M2, M1), sep = " ", na.rm = T, remove = FALSE) %>%
  mutate(MSBERAT = ifelse(is.na(M1), Msberatel, MSBERAT)) %>% 
   # urcil         
   mutate(
    Murcil = case_when(urcil %in% c("Buša E.", "BUrša E.") ~ "Burša E.",
                       urcil %in% c("Pavlíkovi P.a J.", "Pavlíkovi P. A J.") ~ "Pavlíkovi P. a J.",
                       urcil %in% c("Duda m.", "Duda M.,") ~ "Duda M.",
                       urcil == "Kilián Z" ~ "Kilián Z.",
                       urcil == "koupě" ~ NA,
                       TRUE ~ urcil), 
    M1 = ifelse(str_detect(Murcil, "^\\w+\\s\\w\\.$"), str_extract(Murcil, "\\w\\.$"), 
                ifelse(str_detect(Murcil, "^\\w\\.\\s\\w+$"), str_extract(Murcil, "^\\w\\."), NA)),
    M2 = ifelse(str_detect(Murcil, "^\\w+\\s\\w\\.$"), str_extract(Murcil, "^\\w+"),
                ifelse(str_detect(Murcil, "^\\w\\.\\s\\w+$"), str_extract(Murcil, "\\w+$"), NA))
    ) %>% 
  unite(MURCIL, c(M2, M1), sep = " ", na.rm = T, remove = FALSE) %>%
  mutate(MURCIL = ifelse(is.na(M1), Murcil, MURCIL)) %>% 
  select(-M1, -M2, -Msberatel, -Murcil) 

```

### commit adresar

```{r}

bach <- bach_adr %>%                      # UNCOMMENT TO COMMIT
  mutate(status_adresar = "OK") %>%
   select(-contains("status_"), contains("status_")) # status at the end

# utils::View(bach)
```


### vazby

```{r ADRESAR}

c <- bach_adr %>% select("bach" = create_uid, "mus" = MCREATE) 
l <- bach_adr %>% select("bach" = lastwrite_uid, "mus" = MLSTWR)
s <- bach_adr %>% select("bach" = sberatel, "mus" = MSBERAT)
u <- bach_adr %>% select("bach" = urcil,"mus" =  MURCIL)

pracovni_adresar <- bind_rows(c,l,s,u) %>% distinct() %>% arrange(mus) %>% filter(mus != "")

# pokracuj k ulozeni do sekce: # ! ! !   E X P O R T Y  C S V   ! ! !

```

### modified table

```{r ADRESAR}

mod_tab <- pracovni_adresar %>%  
  select(mus) %>% 
  distinct() %>%  
  mutate(typsubj1 = "OO",
         subjkod2 = case_when(mus %in% c("", NA) ~ "neznámý", TRUE ~ mus),
         osjm4 = case_when(str_detect(mus, "^\\w+\\s\\w+$") ~ str_extract(mus, "\\w+$"),
                           str_detect(mus, "^\\w+\\s\\w\\.$") ~ str_extract(mus, "\\w\\.$"),
                           TRUE ~ NA),
         osprijm6 = case_when(str_detect(mus, "^\\w+\\s\\w+$|^\\w+\\s\\w\\.$") ~ str_extract(mus, "^\\w+"),
                           is.na(osjm4) ~ subjkod2,
                           TRUE ~ NA),
         ospohl10 = "neznámé",
         MSBIRKA = "MUZTE",
         MPODSB = "5",
         MPODSBnaz = "Botanická",
         X = NA)

rm(c)
rm(l)
rm(s)
rm(u)

```

### csv table

```{r CSV ADRESAR}

# C R E A T E    C S V

mus_tab <- mod_tab %>% 
  select('1typSubjektuKod' = typsubj1, # !! povinne !!
         '2subjektKod' = subjkod2,         # !! povinne !!
         '3subjektAlterKod' = X, 
         '4osobaJmenoPrvni'= osjm4, 
         '5osobaJmenoDruhe' = X, 
         '6osobaPrijmeni' = osprijm6,         # !! povinne !!
         '7osobaTitulPredJmenem' = X, '8osobaTitulZaJmenem' = X, 
         '9osobaRodnePrijmeni' = X, 
         '10osobaPohlavi' = ospohl10,   # !! povinne !! "muž", "žena", "neznámé"
         
         '11osobaDatumNarozeni' = X, '12osobaMistoNarozeni' = X,
         '13okresNarozeniNazev' = X, '14obecNarozeniNazev' = X,
         '15statNarozeniKod' = X, '16osobaDatumUmrti' = X,
         '17osobaMistoUmrti' = X, 
    
         '18subjektStatKod' = X,
         '19kontaktEmail' = X, '20kontaktMobil' = X,
         '21kontaktMobil2' = X, '22kontaktTelefon' = X,
         '23kontaktInternet' = X, '24kontaktInternetoveVolani' = X,
         '25adresaText' = X, '26kontaktniAdresaText' = X,
         '27fyzickaOsobaRodneCislo' = X, '28subjektPoznamka' = X, 
         
         '29AdresaTextoveOkres' = X, '30AdresaTextoveObec' = X,
         '31AdresaTextoveCastObce' = X, '32AdresaTextoveMestskaCast' = X,
         '33AdresaTextoveUlice' = X, '34AdresaTextoveCisloOrientacni' = X,
         '35AdresaTextoveCislo' = X, '36AdresaTextovePSC' = X,
         
         '37zamestnanecCislo' = X, '38oddeleniKod' = X,
         '39osobnostMedailon' = X, '40osobnostPseudonym' = X,
         '41okruhSubjektuNazev' = X, '42subjektSbirka' = MSBIRKA,           
         '43subjektPodsbirka' = MPODSB, 
         '44osobaStudia' = X,
         '45osobaSpolky' = X, '46osobaOsobnost' = X,
         '47subjektDatumOd' = X, '48subjektDatumDo' = X,
         '49kontaktEmail2' = X, 
         '50text1' = X, '51text2' = X, '52text3' = X, 
         '53role1' = X, '54role2' = X, 
         '55role3' = X, '56role4' = X, '57$role5' = X
         # , rel_ZkrJm = puv
         )

csv_adresar <- mus_tab # ulozit na pozdeji
imp <- "BOTadresar"

# pokracuj k ulozeni do sekce: # ! ! !   E X P O R T Y  C S V   ! ! !

```

## L O K A L I T Y *-*-*-*-*-*

*IMPORTNÍ ROZHRANÍ*: CSV Lokalita  
**MUSEION**: import_lokalita.csv

    
POZN:
oblast, katastr, (lokalita_geo, lokalita_ekol)

PRED IMPORTEM !!!

a) stát - rucne, vetsina uz tam je
b) okres - rucne
c) (kraj) - ?
d) oblast - insertnim dotazem primo do databaze, neni importni brana

### analyza

```{r LOKALITY, warning=FALSE}

# kontrola katastru

mus_KU <- read_excel(paste0(path_data, "MUZTE_mus_KU.xlsx")) %>% rename("MKU" = Název)
# bachkat <- bach %>% select(katastr) %>% distinct()
# kat_check <- left_join(bachkat, muskat, by = c("katastr" = "Název"), keep = T)

# plyr::count(bach[,c('oblast','katastr', "lokalita_geo")]) # i s poctem
# lll <- plyr::count(bach_lok[,c("MSTAT", "MKRAJ", "MOKRES", "MOBLAST", "MKATASTR", "lokalita_geo")]) %>% arrange(MOBLAST)
```

Diskuse nad oblastmi a katastry s pani Ilonou Pavelkovou vvvvvvvv

```{r LOKALITY}

# diskuse nad rozdelenim poli atd

disklok <- bach %>% 
  select(oblast, katastr) %>%  # , lokalita_geo, lokalita_ekol
  distinct()

# write.xlsx(x = disklok,                       
#            file = paste0(path_proj, "diskuse/MUZTE_lokality_k_diskusi.xlsx"), row.names = F)

sort(unique(disklok$oblast))

```

### priprava bach_lok

```{r LOKALITY, warning=FALSE}

# utils::View(bach_lok)
# sort(unique(bach_lok$statkod3))
# summary(factor(bach_lok$statkod3))

bach_lok <- bach %>% 
  
  # oblast
  
  mutate(oblast0 = case_when(str_detect(oblast, "JIhomoravský kraj|Jihomorav.kraj") ~
                               gsub("JIhomoravský kraj|Jihomorav.kraj", "Jihomoravský kraj", oblast),
                           
                             str_detect(oblast, "NItranský kraj") ~
                               gsub("NItranský kraj", "Nitranský kraj", oblast),
                             
                             str_detect(oblast, "Olomouc. Kraj|Olomouc. kraj") ~
                               gsub("Olomouc. Kraj|Olomouc. kraj", "Olomoucký kraj", oblast),
                             
                             str_detect(oblast, "Plzeńský kraj|Plzeňský krak") ~
                               gsub("Plzeńský kraj|Plzeňský krak", "Plzeňský kraj", oblast),
                             
                             str_detect(oblast, "Prešovský  kraj") ~
                               gsub("Prešovský  kraj", "Prešovský kraj", oblast),
                             
                             str_detect(oblast, "Severní Morava. Jeseník") ~
                               gsub("Severní Morava. Jeseník", "Severní Morava, Jeseník", oblast),
                             
                             str_detect(oblast, "Třebíč.") ~
                               gsub("Třebíč.", "Třebíč", oblast),
                             
                          TRUE ~ oblast)) %>% 
                          
  separate(oblast0, into=c("Mstat0", "Mokres0", "Moblast0"), 
           sep = ",", extra = "merge", remove = F) %>% 
  mutate(across(where(is.character), str_trim)) %>%
  mutate(Mstat = ifelse(str_detect(oblast, "u Černého"), NA, Mstat0), 
         Mokres = case_when(str_detect(Mokres0, "^[:upper:][:upper:]$") ~ Mokres0,
                            str_detect(Moblast0, "Žilinský kraj, okres Čadca") ~ "Čadca",
                            katastr == "Háj u Opavy" ~ "OP",
                            TRUE ~ NA),
         Moblast = case_when(is.na(Moblast0)&str_detect(Mokres0,"kraj|krak|Kraj") ~ Mokres0, 
                             !str_detect(Mokres0, "^[:upper:][:upper:]$") ~ Mokres0,
                             str_detect(oblast0, "u Černého") ~ "U Černého moře",
                             str_detect(oblast0, "Severní Morava, Jeseník") ~ 
                               "Severní Morava",
                             katastr == "Háj u Opavy" ~ "MS kraj", 
                            TRUE ~ Moblast0)) %>% 
  mutate(MSTAT = case_when(Mstat == "SR" ~ "SK",
                           Mstat %in% c("ČR", "ČR. KI") ~ "CZ", 
                           Mstat == "" ~ NA, 
                           TRUE ~ Mstat),
         MOKRES = Mokres,
         MOBLAST = case_when(Moblast == "Beskydské podhůří, Beskydské podhůří" 
                             ~ "Beskydské podhůří",
                           Moblast %in% c("Jablunkovské brázda", "Jablunkvoská brázda")
                           ~ "Jablunkovská brázda",
                           Moblast == "Lysohorksá hornatina" ~ "Lysohorská hornatina",
                           Moblast %in% c("Podbeskdská pahorkatina", 
                                          "Podbeskydksá pahorkatina", 
                                          "Podbeskydská phorkatina", 
                                          "Podsbeskydská pahorkatina", 
                                          "Posbeskydská pahorkatina") 
                           ~ "Podbeskydská pahorkatina",
                           Moblast == "Slezské Beskdy" ~ "Slezské Beskydy",
                           TRUE ~ Moblast)) %>% 
  select(-oblast0, -Mstat0, -Mstat, -Mokres0, -Mokres, -Moblast0, -Moblast) %>% 
  
  # katastr

  mutate(MKATASTR = case_when(katastr == "Albrechitce" ~ "Albrechtice",
                              katastr %in% c("Belanské tatry", "Belanské Tatry", 
                                             "Belianské tatry") ~ "Belianské Tatry",
                              katastr == "Bílý kříž" ~ "Bílý Kříž",
                              katastr == "Bystřcie" ~ "Bystřice",
                              katastr == "Bystřice nad olší" ~ "Bystřice nad Olší",
                              katastr == "Český těšín" ~ "Český Těšín",
                              katastr == "Františkovy lázně" ~ "Františkovy Lázně",
                              katastr == "Frýdek - Místek" ~ "Frýdek-Místek",
                              katastr %in% c("Havířov-Bludovice,", "Havířov - Bludovice") 
                              ~ "Havířov-Bludovice",
                              katastr == "Hraadec u Opavy" ~ "Hradec u Opavy",
                              katastr == "Hranice na  Moravě" ~ "Hranice na Moravě",
                              katastr == "Chtoěbuz" ~ "Chotěbuz",
                              katastr == "Karivná" ~ "Karviná",
                              katastr == "Kunčice pod Onřejníkem" ~ 
                                "Kunčice pod Ondřejníkem",
                              katastr == "Liptovské hole - Roháče" ~ 
                                "Liptovské hole (Roháče)",
                              katastr == "Loučná nad desnou" ~ "Loučná nad Desnou",
                              katastr == "MIlíkov" ~ "Milíkov",
                              katastr == "Mosty u jablunkova" ~ "Mosty u Jablunkova",
                              katastr == "NItra" ~ "Nitra",
                              katastr %in% c("Nový dvůr u Opavy", "Nový Dvůr u Opavy,")
                              ~ "Nový Dvůr u Opavy",
                              katastr %in% c("Olrlová", "Olrová") ~ "Orlová",
                              katastr == "Oščadnice" ~ "Oščadnica",
                              katastr == "Petrovice u Karviná" ~ "Petrovice u Karviné",
                              katastr == "Rožnov p. Radhoštěm" ~ "Rožnov pod Radhoštěm",
                              katastr == "Rychvlad" ~ "Rychvald",
                              katastr == "Sedlišě" ~ "Sedliště",
                              katastr == "Stará ves nad Ondřejnicí" ~ 
                                "Stará Ves nad Ondřejnicí",
                              katastr == "Staré Město u Uh. Hradiště" ~ 
                                "Staré Město u Uherského Hradiště",
                              katastr == "Střítěž" ~ "Střítež",
                              katastr == "Těrlicko- Kostelec" ~ "Těrlicko-Kostelec",
                              katastr == "Těrlilcko" ~ "Těrlicko",
                              katastr %in% c("Věřňoivce", "Věřnovice", "Věřńovice") 
                              ~ "Věřňovice",
                              katastr %in% c("Vadovce", "Vaďovice") ~ "Vaďovce",
                              katastr %in% c("Věřňoivce", "Věřnovice", "Věřńovice") 
                              ~ "Věřňovice",
                              katastr %in% c("Višnové", "Višnpvé") ~ "Višňové",
                              katastr %in% c("Vyské Tatry", "Vysoké tatry") 
                              ~ "Vysoké Tatry", 
                              TRUE ~ katastr)) %>% 
  mutate(across(where(is.character), str_trim)) %>% 
  
   # katastr ze slovniku
  
  left_join(mus_KU %>% select(MKU), by = c("MKATASTR" = "MKU"), keep = T) 


# bach_lok[bach_lok == ""] <- NA

bach_lok <- bach_lok %>% unite(MLOKALITA, c("MOBLAST", "MKATASTR"), sep = ", ", na.rm = T, remove = F) %>% 
  mutate(MLOKALITA = sub("^, "", ", MLOKALITA),
         MLOKALITA = sub(",\\s$", "", MLOKALITA),
         MLOKALITA = sub("Beskydy, Beskydy", "Beskydy", MLOKALITA))

# bach_lok[bach_lok == ""] <- NA
```

### commit lokality

```{r}

bach <- bach_lok %>%                        # UNCOMMENT TO COMMIT
  mutate(status_lokality = "OK") %>%
  select(-contains("status_"), contains("status_")) # status at the end

# utils::View(bach)
```

### vazby

```{r LOKALITY}

pracovni_lokality <- bach_lok %>% select(MLOKALITA, MSTAT, MOKRES, MOBLAST) %>% distinct()

# pokracuj k ulozeni do sekce: # ! ! !   E X P O R T Y  C S V   ! ! !




# MS SQL insert query

ins_obl <- pracovni_lokality %>% 
  select(MOBLAST) %>%
  distinct() %>% 
  mutate(ins = "insert into OBLAST (id, nazev, spravcesbirky_id, uins, dins) values (NEXT VALUE FOR SEQ_W4SN",
         lok = paste0("'", MOBLAST,"'"), 
         spr = 21470130,
         uin = "'krizova_ins'",
         tim = "CURRENT_TIMESTAMP);") %>% 
  unite(MINSQ, c("ins", "lok", "spr", "uin", "tim"), sep = ",", na.rm = T, remove = FALSE) %>% 
  select(insert_query = MINSQ)

write.table(ins_obl, paste0(path_csv, projekt, "_insert_oblasti", ".txt"), append = FALSE, 
            row.names = FALSE, col.names = FALSE, quote = FALSE)

```

### modified table

```{r LOKLITY}

mod_tab <- pracovni_lokality %>% 
  # mutate(MZEME = case_when(MSTAT %in% c("ČR", "ČR. KI") ~ "Česko",
  mutate(MZEME = case_when(MSTAT == "CZ" ~ "Česko",
                           MSTAT == "PL" ~ "Polsko",
                           MSTAT == "SK" ~ "Slovensko", TRUE ~ NA),
         MSBIRKA = "MUZTE",
         MPODSB = "5",
         MPODSBnaz = "Botanická",
         MFOND = "Botanika",
         MFONDnaz = "Botanika",
         X = NA)

```

### csv table

```{r LOKALITY}

mus_tab <- mod_tab %>% 
  select(
    '1lokalitaNazev' = MLOKALITA,  # !! povinne !!
    '2okresNazev'= MOKRES,
    '3statKod' = MSTAT, 
    '4oblastNazev'= MOBLAST,
    '5lokalitaZeme' = MZEME, 
    '6lokalitaCtverec'= X,
    '7lokalitaMapa' = X, 
    '8lokalitaZemepisnaSirka'= X,
    '9lokalitaZemepisnaDelka'= X, 
    '10lokalitaNadmorskaVyska'= X,
    '11lokalitaPoznamka'= X, 
    '12lokalitaSbirka'= MSBIRKA,
    '13lokalitaPodsbirka'= MPODSB,
    '14fytochorion1'= X,
    '15lokalitaPublicNadNazev'= X, '16lokalitaPublicNazev'= X,
    '17fytochorion2'= X, '18fytochorion3'= X,
    '19fytochorion4'= X) %>% 
  drop_na('1lokalitaNazev') %>% 
  distinct()

mus_tab[mus_tab == ""] <- NA

# oper_lokalita <- mus_tab
imp <- "lokalita"


# rm(fy)
# rm(fy0)
# rm(ku)

```

## T A X O N

### analyza

uprava BACH dat pro parovani s BIOLIBEM

```{r}

ana_tax <- bach %>% 
  mutate(druh = ifelse(druh == "Achyrophorus uniflorus(Vill.)Bluff et Fingerh.", 
                       "Achyrophorus uniflorus (Vill.)Bluff et Fingerh.", druh), # jen oprava mezery
         Mdruh = case_when(str_detect(druh, "×") ~ paste(word(druh, 1), word(druh, 2), word(druh, 3)), 
                            TRUE ~ paste(word(druh, 1), word(druh, 2))),
         Msubsp = case_when(str_detect(druh, "subsp.") ~ 
                              paste(word(druh, 1), word(druh, 2), word(druh, 3), word(druh, 4)), 
                            TRUE ~ NA),
         Mautor = ifelse(str_detect(druh, "^\\w+\\s\\w+$"), NA, 
           case_when(str_detect(druh, "×") ~ sub('^\\w+\\s\\W\\s\\w+\\s', '', druh), 
                     str_detect(druh, "subsp.") ~ sub('^\\w+\\s\\w+\\s\\w+\\.\\s\\w+\\s', '', druh), 
                     str_detect(druh, "^\\w+\\s\\w+-\\w+") ~ sub('^\\w+\\s\\w+-\\w+\\s', '', druh),  # Dryopteris filix-mas
                     str_detect(druh, "agg.") ~ NA, 
                            TRUE ~ sub('^\\w+\\s\\w+\\s', '', druh)))) %>% 
  mutate(across(where(is.character), str_trim))

```

### parovani s BL

sparovano s BL v krocich
  a - poddruhy (sparovane i nesparovane)
  b - druhy -> rozfiltorvano na bb (= sparovane druhy i s autorem) a tax_spWOaut (= nesparovane druhy)
  c - df, obsahujici konecne deleni na SPAROVANO bez autora a NESPAROVANO
  
spojujeme
  a SPAROVANO ; NESPAROVANO
  bb SPAROVANO
  c SPAROVANO bez autora ; NESPAROVANO

```{r}

# tax[tax == ""] <- NA

# parovani P O D D R U H

tax_subsp <- ana_tax %>% 
  filter(!is.na(Msubsp))

a <- left_join(tax_subsp, bl_subsp,
                by = c("rod" = "rod_Nomen", "Mdruh" = "druh_Nomen", # "celed" = "celed_Nomen", 
                       "Msubsp" = "poddruh_Nomen", "Mautor" = "poddruh_Autor"), keep = T) %>% 
  mutate(biolib_status = ifelse(is.na(poddruh_Nomen), "NESPAROVANO", "SPAROVANO"))

# parovani D R U H

tax_sp <- ana_tax %>% 
  filter(is.na(Msubsp))

b <- left_join(tax_sp, bl_sp,
                by = c("celed" = "celed_Nomen", "rod" = "rod_Nomen", 
                       "Mdruh" = "druh_Nomen", "Mautor" = "druh_Autor"), keep = T) %>% 
  mutate(biolib_status = ifelse(is.na(druh_Nomen), "NESPAROVANO", "SPAROVANO"))

# parovani D R U H   B E Z   A U T O R A

tax_spWOaut <- b %>% filter(biolib_status == "NESPAROVANO") %>% 
  select(-kmen_ID,-kmen_Nomen,-kmen_Autor,-kmen_Nazev,-trida_ID,-trida_Nomen,-trida_Autor,-trida_Nazev,-trida_NadNomen,
         -rad_ID,-rad_Nomen,-rad_Autor,-rad_Nazev,-rad_NadNomen,-celed_ID,-celed_Nomen,-celed_Autor,-celed_Nazev,-celed_NadNomen,
         -rod_ID,-rod_Nomen,-rod_Autor,-rod_Nazev,-rod_NadNomen,-druh_ID,-druh_Nomen,-druh_Autor,-druh_Nazev,-druh_NadNomen) # zbavit se vsech BL colnames

bb <- b %>% filter(biolib_status == "SPAROVANO")
rm(b)

c <- left_join(tax_spWOaut, bl_sp,
              by = c("celed" = "celed_Nomen", "rod" = "rod_Nomen", "Mdruh" = "druh_Nomen"),
               keep = T) %>% 
  mutate(biolib_status = ifelse(is.na(druh_Nomen), "NESPAROVANO", "SPAROVANO bez autora"))

# kombinace vysledku parovani

bach_blb <- bind_rows(a, bb, c)
bach_blb$biolib_status <- factor(bach_blb$biolib_status)

summary(bach_blb$biolib_status) # statistika
count(a)
count(bb)
count(c)
count(a)+count(bb)+count(c) == count(bach) # chceme TRUE

# rm(a)
# rm(bb)
# rm(c)
# rm(ana_tax)
# rm(tax_sp)
# rm(tax_subsp)
# rm(tax_spWOaut)
# rm(tax0)

# diskuse ke sparovanym zaznamum bez autora -> poslano pani Pavelkove 23.8.; n = 300

bezaut <- bach_blb %>% 
  filter(biolib_status == "SPAROVANO bez autora") %>% 
  select(druh, Mdruh, Mautor, BIOLIB_autor = druh_Autor) # jen druh, poddruhy v teto kategorii nejsou

# write.xlsx(bezaut, paste0(path_proj, "diskuse/MUZTE_taxony_k_diskusi.xlsx"), row.names = F)

```

### priprava bach_tax

potrebujeme:

  '20taxon' na BIO karte

```{r}

bach_tax <- bach_blb %>%
  mutate(MKATTAX = ifelse(is.na(Msubsp), "druh", "poddruh"), 
         MNOMEN = ifelse(is.na(Msubsp), Mdruh, Msubsp),
         MNAZEVTAX = ifelse(is.na(Msubsp), druh_Nazev, poddruh_Nazev),
         MAUTOR = ifelse(is.na(Msubsp), druh_Autor, poddruh_Autor),
         MAUTOR = ifelse(biolib_status == "NESPAROVANO", Mautor, MAUTOR),
         MNADTAX = ifelse(is.na(Msubsp), druh_NadNomen, poddruh_NadNomen),
         MKATNADTAX = ifelse(is.na(Msubsp), "rod", "druh"),
         MKATNADTAX = ifelse(biolib_status == "NESPAROVANO", NA, MKATNADTAX))

# pripadne vysypat BL sloupce !! ?? !!

```


### commit taxon

```{r}
# 
bach <- bach_tax %>%                      # UNCOMMENT TO COMMIT
  mutate(status_taxon = "OK") %>%
   select(-contains("status_"), contains("status_")) # status at the end

```


### vazby

```{r TAXON}

pracovni_taxony <- bach_tax %>% select(druh, Mdruh, Msubsp, MAUTOR, MNOMEN, biolib_status) %>% distinct()

# pokracuj k ulozeni do sekce: # ! ! !   E X P O R T Y  C S V   ! ! !

```

### nadtaxony

```{r}

#  kmen_Nomen, trida_Nomen, rad_Nomen, celed_Nomen, rod_Nomen, druh_Nomen

# K M E N

mus_kmen <- bach_tax %>% 
  select(kmen_Nomen) %>% distinct() %>% 
  left_join(bl_kme, by = c("kmen_Nomen" = "kmen_Nomen")) %>% drop_na() %>% 
  mutate(X = NA, 
    '1sbirkaCisloEvidInt' = "MUZTE", 
    '2podsbirkaCislo'= "5",          
    '3kodOboru' = "5", 
    '4nazevKategorie'= "kmen",          # !! povinne !!
    nomen5= kmen_Nomen,               # !! povinne !!
    nazev6= kmen_Nazev,                   
    autor7= kmen_Autor,                  
    '8nadrizenyTaxon'= "Plantae",                   
    '9preferovanyTaxon'= X,                   
    '10Poznamka'= X,                   
    '11nazevKategorieNadrizenehoTaxonu' = "říše") %>% 
   select('1sbirkaCisloEvidInt', '2podsbirkaCislo', '3kodOboru', '4nazevKategorie',          
    nomen5, nazev6, autor7, '8nadrizenyTaxon',  '9preferovanyTaxon',                   
    '10Poznamka', '11nazevKategorieNadrizenehoTaxonu')


# T R I D A

mus_trida <- bach_tax %>% 
  select(trida_Nomen) %>% distinct() %>% 
  left_join(bl_tri, by = c("trida_Nomen" = "trida_Nomen")) %>% drop_na() %>% 
  mutate(X = NA, 
    '1sbirkaCisloEvidInt' = "MUZTE", 
    '2podsbirkaCislo'= "5",          
    '3kodOboru' = "5", 
    '4nazevKategorie'= "třída",          # !! povinne !!
    nomen5= trida_Nomen,               # !! povinne !!
    nazev6= trida_Nazev,                   
    autor7= trida_Autor,                  
    '8nadrizenyTaxon'= trida_NadNomen,                   
    '9preferovanyTaxon'= X,                   
    '10Poznamka'= X,                   
    '11nazevKategorieNadrizenehoTaxonu' = "kmen") %>% 
  select('1sbirkaCisloEvidInt', '2podsbirkaCislo', '3kodOboru', '4nazevKategorie',          
    nomen5, nazev6, autor7, '8nadrizenyTaxon',  '9preferovanyTaxon',                   
    '10Poznamka', '11nazevKategorieNadrizenehoTaxonu')


# R A D

mus_rad <- bach_tax %>% 
  select(rad_Nomen) %>% distinct() %>% 
  left_join(bl_rad, by = c("rad_Nomen" = "rad_Nomen")) %>% drop_na() %>% 
  mutate(X = NA, 
    '1sbirkaCisloEvidInt' = "MUZTE", 
    '2podsbirkaCislo'= "5",          
    '3kodOboru' = "5", 
    '4nazevKategorie'= "řád",          # !! povinne !!
    nomen5= rad_Nomen,               # !! povinne !!
    nazev6= rad_Nazev,                   
    autor7= rad_Autor,                  
    '8nadrizenyTaxon'= rad_NadNomen,                   
    '9preferovanyTaxon'= X,                   
    '10Poznamka'= X,                   
    '11nazevKategorieNadrizenehoTaxonu' = "třída") %>% 
   select('1sbirkaCisloEvidInt', '2podsbirkaCislo', '3kodOboru', '4nazevKategorie',          
    nomen5, nazev6, autor7, '8nadrizenyTaxon',  '9preferovanyTaxon',                   
    '10Poznamka', '11nazevKategorieNadrizenehoTaxonu')


# C E L E D

mus_celed <- bach_tax %>% 
  select(celed, celed_Nomen) %>% 
  distinct(celed, celed_Nomen, .keep_all = TRUE) %>% 
  group_by(celed) %>% filter(!duplicated(celed)|n()==1) %>% 
  mutate(status = celed==celed_Nomen) %>%  # vsude true, pouzijeme pole 'celed'
  ungroup() %>%
  left_join(bl_cel, by = c("celed" = "celed_Nomen")) %>% 
  mutate(X = NA, 
    '1sbirkaCisloEvidInt' = "MUZTE", 
    '2podsbirkaCislo'= "5",          
    '3kodOboru' = "5", 
    '4nazevKategorie'= "čeleď",          # !! povinne !!
    nomen5= celed,               # !! povinne !!
    nazev6= ifelse(is.na(celed_Nomen), NA, celed_Nazev),                   
    autor7= ifelse(is.na(celed_Nomen), NA, celed_Autor),                  
    '8nadrizenyTaxon'= ifelse(is.na(celed_Nomen), NA, celed_NadNomen),         
    '9preferovanyTaxon'= X,                   
    '10Poznamka'= X,                   
    '11nazevKategorieNadrizenehoTaxonu' = ifelse(is.na(celed_Nomen), NA, "řád")) %>% 
   select('1sbirkaCisloEvidInt', '2podsbirkaCislo', '3kodOboru', '4nazevKategorie',          
    nomen5, nazev6, autor7, '8nadrizenyTaxon',  '9preferovanyTaxon',                   
    '10Poznamka', '11nazevKategorieNadrizenehoTaxonu')


# R O D

mus_rod <- bach_tax %>% 
  select(rod, rod_Nomen) %>% 
  distinct(rod, rod_Nomen, .keep_all = TRUE) %>% 
  group_by(rod) %>% filter(!duplicated(rod)|n()==1) %>% 
  mutate(status = rod==rod_Nomen) %>%  # vsude true, pouzijeme pole 'celed'
  ungroup() %>% 
  left_join(bl_rod, by = c("rod" = "rod_Nomen")) %>%  
  mutate(X = NA, 
    '1sbirkaCisloEvidInt' = "MUZTE", 
    '2podsbirkaCislo'= "5",          
    '3kodOboru' = "5", 
    '4nazevKategorie'= "rod",          # !! povinne !!
    nomen5= rod,               # !! povinne !!
    nazev6= ifelse(is.na(rod_Nomen), NA, rod_Nazev),                   
    autor7= ifelse(is.na(rod_Nomen), NA, rod_Autor),                  
    '8nadrizenyTaxon'= ifelse(is.na(rod_Nomen), NA, rod_NadNomen),                   
    '9preferovanyTaxon'= X,                   
    '10Poznamka'= X,                   
    '11nazevKategorieNadrizenehoTaxonu' = ifelse(is.na(rod_Nomen), NA, "čeleď")) %>% 
  select('1sbirkaCisloEvidInt', '2podsbirkaCislo', '3kodOboru', '4nazevKategorie',          
    nomen5, nazev6, autor7, '8nadrizenyTaxon',  '9preferovanyTaxon',                   
    '10Poznamka', '11nazevKategorieNadrizenehoTaxonu')

# # D R U H  (pro poddruhy)
# 
# bach_druh <- bach_tax %>% 
#   filter(!is.na(Msubsp)) %>% 
#   select(Mdruh, druh_Nomen)  %>% 
#   distinct(Mdruh, druh_Nomen, .keep_all = TRUE) %>% 
#   mutate(status = Mdruh==druh_Nomen) %>%  # vsude true, pouzijeme pole 'celed'
#   left_join(bl_sp, by = c("druh_Nomen" = "druh_Nomen")) 
#   mutate(X = NA, 
#     '1sbirkaCisloEvidInt' = "MUZTE", 
#     '2podsbirkaCislo'= "5",          
#     '3kodOboru' = X, 
#     '4nazevKategorie'= "druh",          # !! povinne !!
#     nomen5= Mdruh,               # !! povinne !!
#     nazev6= ifelse(is.na(druh_Nomen), NA, druh_Nazev),                   
#     autor7= ifelse(is.na(druh_Nomen), NA, druh_Autor),                  
#     '8nadrizenyTaxon'= ifelse(is.na(druh_Nomen), NA, druh_NadNomen),                   
#     '9preferovanyTaxon'= X,                   
#     '10Poznamka'= X,                   
#     '11nazevKategorieNadrizenehoTaxonu' = ifelse(is.na(druh_Nomen), NA, "čeleď")) %>% 
#   select('1sbirkaCisloEvidInt', '2podsbirkaCislo', '3kodOboru', '4nazevKategorie',          
#     nomen5, nazev6, autor7, '8nadrizenyTaxon',  '9preferovanyTaxon',                   
#     '10Poznamka', '11nazevKategorieNadrizenehoTaxonu')

# D R U H    A    P O D D R U H 

mus_druh <- bach_tax %>%
  mutate(MSBIRKA = "MUZTE", MPODSB = "5", X = NA) %>% 
  select(
    '1sbirkaCisloEvidInt' = MSBIRKA, 
    '2podsbirkaCislo'= MPODSB,          
    '3kodOboru' = MPODSB, # je stejny, jako podsbirka, pouzivam jen hodnotu
    '4nazevKategorie'= MKATTAX,          # !! povinne !!
    nomen5= MNOMEN,                   # !! povinne !!
    nazev6= MNAZEVTAX,                   
    autor7= MAUTOR,                  
    '8nadrizenyTaxon'= MNADTAX,                   
    '9preferovanyTaxon'= X,                   
    '10Poznamka'= X,                   
    '11nazevKategorieNadrizenehoTaxonu' = MKATNADTAX) %>% 
  distinct()

```


### modified table

V tomto pripade jde spis o prime vytvoreni importniho rozhrani pro druh a poddruh
V dalsim kroku se pripoji slovniky i pro vyssi kategorie
Ze spojene tabulky se tak stane jedno velke slovnikove importni rozhrani

```{r}

mod_tab <- bind_rows(mus_kmen, mus_trida, mus_rad, mus_celed, mus_rod, mus_druh) %>% 
  group_by(nomen5) %>% 
  mutate(alert = ifelse(n() != 1, "DUPL", NA)) %>% 
  ungroup() 

# dupl <- mod_tab %>% filter(!is.na(alert)) %>% 
#   group_by(nomen5) %>% 
#   mutate(rown = seq_along(nomen5),
#          nomen5_dupl = paste0(nomen5, "_", alert, rown)) %>% 
#   relocate(nomen5_dupl, .before = (nazev6)) %>% 
#   select(-nomen5, nomen5) %>% 
#   mutate(nomen5_dupl = ifelse(!is.na(nazev6), nomen5, nomen5_dupl))

eleochar <- mod_tab %>% filter(str_detect(nomen5, "Eleocharis")) %>% filter(is.na(alert)) %>% 
  rename("autor7b" = autor7) %>% select(-alert)

odpo <- read.xlsx(paste0(path_proj, "diskuse/MUZTE_autori_k_diskusi_upraveno.xlsx"), sheetIndex = 1, header = T)

dupl_mod_tab <- mod_tab %>% filter(alert == "DUPL") %>% 
  left_join(odpo, by = c("nomen5" = "X5nomen"), keep = T) %>% 
  mutate(autor7b = ifelse(!is.na(X7autor), X7autor, autor7)) %>% 
  relocate(autor7b, .before = autor7) %>% 
  select(-autor7, -alert, -X5nomen, -X7autor, -'NA.') %>% 
  distinct()
  
mod_tab2 <- bind_rows(dupl_mod_tab, eleochar)

# check1 <- mod_tab %>% group_by(nomen5) %>% 
#   filter(n() != 1)
#    
# write.xlsx(as.data.frame(check1), paste0(path_proj, "diskuse/MUZTE_autori_k_diskusi.xlsx"), row.names = F)

```
### csv table

*IMPORTNÍ ROZHRANÍ*: CSV Taxonu  
*MUSEION*: import_taxon.csv  

```{r TAXON}

mus_tab <- mod_tab %>% filter(is.na(alert))
mus_tab <- mod_tab2


mus_tab[mus_tab == ""] <- NA

oper_taxon <- mus_tab
imp <- "taxon_2kolo"

# pokracuj k ulozeni do sekce: # ! ! !   E X P O R T Y  C S V   ! ! !

# T O P   10   F O R   I M P O R T   C H E C K

# mus_tab10 <- mus_tab %>% slice(1:10)
# imp <- "taxon10"
# 
# save <- paste0(path_csv, projekt, "_import_", imp, ".csv")
# 
# if(file.exists(save)){
#   print("You've been here before!")
# } else {
#   write.table(mus_tab10, file = save, # mus_tab10
#             quote = T, row.names = F,
#             sep = ";", dec = ",",
#             na = "", fileEncoding="cp1250")
#   print("Import csv  W R I T T E N  !")
#   }

```



# **************************************************************************************

# MUS KARTA

*P O S T U P*

**PREMOD:**   
- zkousej zpracovat jednotlive kroky  

**MOD:**  
- uspesne kusy kodu skladej za sebe a upravuj pracovni tabulku  

**CSV:**  
- vytvor importni csv soubor pro finalni mograci


*MINVC*
maska:  \{S\}\{#####\}\/\{a\}  

invc = puvodni -> rozdelit na radu a cislo (Mrada a Minvc)
MPORC = pridani vedoucich nul k Minvc
MINVC = finalni cislo <- kombinace Mrada a MPORCS dle masky inv.cisla

*PRIRC*
maska:  \{S\}\{####\}\/\{YYYY\}  


### modified table

```{r}

# GPS

# ------------------------------------ externi reseni -------------------------------------

# vytvorit souradnice vedle a commitnout je do bach df

gps <- bach %>% 
  # select(MINVC, gps) %>% 
  mutate(Mgps = gsub("N|E", "", gps),
         across(where(is.character), str_trim),
         Mform = case_when(str_detect(Mgps, "\\d+°\\d+'.*") ~ "deg",
                           str_detect(Mgps, "\\d+°.*'$") ~ "degdec",
                           str_detect(Mgps, "^\\d+\\.\\d+\\s*,\\s\\d+\\.\\d+") ~ "dec", 
                           TRUE ~ NA))  %>% 
  separate(Mgps, into = c("N", "E"), sep = ",", extra = "merge", remove = F) %>% 
  mutate(across(where(is.character), str_trim),
         NN = gsub("\\.", ",", N),
         EE = gsub("\\.", ",", E)) %>% 
  unite(coord, c("NN", "EE"), sep = " ", na.rm = T, remove = F) %>% 
  # select(MINVC, Mform,coord) %>%
  mutate(coord = gsub("°|'|\"", " ", coord))

gps[is.na(gps)] <- ""
  
# write.xlsx(gps, paste0(path_proj, "diskuse/MUZTE_gps_pro_prevod.xlsx"), row.names = F)


trans <- read.xlsx(paste0(path_proj, "diskuse/MUZTE_gps_pro_prevod.xlsx"), sheetIndex = 1, header = T)

gps_trans <- full_join(gps, trans %>% select(MINVC, trans_coord), by = "MINVC") %>% 
  select(-Mgps, -coord, -N, -E, -NN, -EE) %>% 
  mutate(Mdegdec = gsub("°|′|″|N|E 0", "", trans_coord),
         Mdegdec = str_trim(Mdegdec), 
         Mdegdec = gsub("  ", " ", Mdegdec),
         
         Mdeg = ifelse(Mform == "deg", gsub("°|'|\"", " ", gps), NA),
         Mdeg = gsub("N|E|,", "", Mdeg),
         Mdeg = gsub("  |   ", " ", Mdeg),
         Mdeg = str_trim(Mdeg)) %>% 
  relocate(gps, .before = trans_coord) %>% 
  arrange(desc(Mform)) %>% 
  mutate(Mcoord = coalesce(Mdegdec, Mdeg)) %>% 
  separate(Mcoord, into = c("Nst", "Nmin", "Nvte", "Est", "Emin", "Evte"), sep = " ", extra = "merge", remove = F) %>% 
  select(-trans_coord, -Mdegdec, -Mdeg, -Mcoord, -Mform) %>% 
  relocate(gps, .before = ctverec) %>% 
  arrange(MINVC)

# c o m m i t   g p s 

bach <- gps_trans %>%                      # UNCOMMENT TO COMMIT
  mutate(status_gps = "OK") %>%
   select(-contains("status_"), contains("status_")) # status at the end

rm(gps)
rm(gps_trans)
rm(deg_subs)
rm(check1)
rm(check2)
rm(check3)

# K A R T A

# sort(unique(bach$gps))
# sort(unique(bach$nabyti))
# sort(unique(base$odpis_duvod))

mod_tab <- bach %>% 
  
  mutate(dostal_rc = as.character(dostal_rc),
         kubat_rc = as.character(kubat_rc),
         typred1 = "BO",
         pocetks22 = ifelse(is.na(pocet_kusu)|pocet_kusu == "", "1", pocet_kusu),
         sirka28 = ifelse(is.na(Nst), NA, "N"),
         delka32 = ifelse(is.na(Est), NA, "E"),
         ctverec39 = sub(" ", "", ctverec),
         nadmvyska42 = sub(" m", "", nvyska),
         nabytikod59 = case_when(nabyti %in% c("sběr", "Sběr", "sbšr") ~ "O",
                                 nabyti == "dar" ~ "D",
                                 nabyti == "koupě" ~ "K",
                                 TRUE ~ NA),
         nabytidat60 = ifelse(nabyti_d %in% c("--", ";"),NA, nabyti_d),
         podskup68 = case_when(pskup == "Tracheopyhta" ~ "Tracheophyta", 
                               pskup == "Bezcévnaté" ~ "Bezcevnate", 
                               TRUE ~ pskup)
         )

#------------------------ workspace-------------------------

gps[6,] # print row 6
gps_trans[11388,] # print row 6

deg_subs <- gps_trans %>% filter(Mform == "deg") %>% select(gps)

check1 <- bach %>% filter(!is.na(gps)) %>% select(gps) %>% filter(gps != "") # puvodni bach ma 397 vyplnenych gps
check2 <- gps_trans %>% filter(!is.na(Mcoord)) %>% select(Mcoord) # 395 (03704: na pasece ; 08703. 15-44-14)
check3 <- gps_trans %>% filter(!is.na(gps)) %>% filter(gps != "") %>% select(MINVC, gps, Mcoord)
```

### csv botanika 

*IMPORTNÍ ROZHRANÍ*: CSV_Katalog... **(dle typu karty)**  
*MUSEION*: import_....csv  **(dle typu karty)**  
  
Zkopiruj prislusnou importni branu z _GEN_axi_importCSV.Rmd  


```{r CSV}

mus_tab <- mod_tab %>% 
  select(
    '1typPredmetuKod' = typred1,        # !! povinne !! (BI, BO, ZO, EN, GE nebo PL)
    '2sbirkaCisloEvidInt'= MSBIRKA, # !! povinne !! ze slovniku
    '3podsbirkaCislo' = MPODSB,        # !! povinne !! ze slovniku
    '4ciselnaRadaKod'= MRADA,                    # !! povinne !! ze slovniku
    
    '5SPCislo' = MINVC,                           # !! povinne !!
    
    '6SPcisloCES'= X, 
    '7SPPoradoveCislo' = MPORCISLO,
    '8SPCisloDo'= MINVChorni, 
    '9SPPoradoveCisloDo'= MPORCISLOhorni,
    '10SPPoradoveCisloSub' = MSUBCISLO,
    '11SPPoradoveCisloSubDo' = MSUBCISLOhorni, 
# evidence    
    '12SPDatumZapisu' = create_date, 
    '13jinaEvidence1Cislo' = jcis, 
    '14jinaEvidence2Cislo' = X,
    '15jinaEvidence3Cislo' = X,
    '16fondKod' = MFOND, 
    '17skupinaKod' = skup,
    '18materialovaSkupinaKod' = X, 
    '19oznaceniNazev' = X, # u botaniky nevyplnovat
    '20taxon' = MNOMEN, # 
    '21snadTaxon' = X, 
    '22SPPocetKusu' = pocetks22, # zkontrolovat, zda je všude vyplněno!
    '23urcilOsobaKod' = MURCIL,
    '24dataceUrceniHodnota' = urcil_d,
    '25odborneUrceniPoznamka' = pozn, 
    '26odborneUrceniPopis' = popis, 
# lokalita, geo    
    '27lokalita' = MLOKALITA,      
    '28sirkaNS' = sirka28, 
    '29sirkaStupne' = Nst, 
    '30sirkaMinuty' = Nmin, 
    '31sirkaVteriny' = Nvte, 
    '32delkaEW' = delka32, 
    '33delkaStupne' = Est, 
    '34delkaMinuty' = Emin, 
    '35delkaVteriny' = Evte, 
    '36vyska' = X, '37specifikaceLokality' = lokalita_geo, 
    '38mapa' = X, '39ctverec' = ctverec39,
    '40charakteristika' = lokalita_ekol, 
    '41puvodniPopisLokality' = X,
    '42nadmorskaVyska' = nadmvyska42, '43nalezPoznamka' = X,
    '44dataceHodnota' = X, '45datacePoznamka' = X, 
# etikety
    '46textEtiketa' = X, '47typ' = X,
    '48cf' = X, '49var' = var, 
    '50herbar' = X, '51preparat' = X, 
    '52pocetSamcu' = X, '53pocetSamic' = X, '54pocetJuv' = X, 
    '55collectio' = X,
# lokace    
    '56stalaLokaceKod' = X, '57aktualniLokaceKod' = X, # samost import
# nabyti a zalozeni zaznamu    
    '58SPPoznamka' = X,
    '59zpusobNabytiKod' = nabytikod59,
    '60nabytiPredmetuDatum' = nabytidat60, 
    '61nabytiPredmetuDoklad' = X, '62nabytiPoznamka' = X, 
    '63nabytiPredchoziMajitelSlovy' = X,'64prirustekCislo' = PCISLO,
    '65ciselnaRadaPrirustkuKod' = PCRADA,   
    '66nabytiPrirustkuDatum' = X, 
    '67zakladniCharakteristika' = X, 
    '68kodPodskupiny1' = podskup68, 
    '69kodPodskupiny2' = X,'70kodPodskupiny3' = X, '71predmetCizi' = X,
    '72SPPapirovaKarta' = X, '73SPKartaJeOpsana' = X,
    '74text1' = prirc, 
    '75text2' = negat, 
    '76text3' = zapis_ces,
    '77text4' = reviz,
    '78text5' = X,
    '79SPUIns' = create_uid, # neni slovnikovane, netreba upravovat
    '80SPDIns' = create_date, 
    '81SPUUpd' = X,'82SPDUpd' = X, # nemusi byt nic, stejne se prepise importem
# ?    
    '83parageneze' = X,'84chronostratigrafie' = X,
    '85litostratigrafie' = X,'86poznamkaChrono' = X,
    '87poznamkaLito' = X,'88kompletnost' = X,
    '89tvar' = X,'90barva' = X,
    '91zrnitost' = X,'92biozona' = X,
    '93fertilita' = X,'94zpusobZachovani' = X,
    '95originalniJmeno' = druh, #                  !!!   puvodni jmeno druhu
    '96zoPohlavi' = X,
    '97zoStari' = X,'98snadChrono' = X,
    '99snadLito' = X, '100klicovaSlova' = syn,
    '101nazevKU' = MKU, '102fytochorion' = X,  
    '103lokalitaDoplneni' = lokalita_geo, '104lokalitaOriginalni' = X,
    '105stanoviste' = X, '106mikroStanoviste' = X,
    '107biotopKod' = X, '108zpusobZiskani' = X,
    '109souradniceZdroj' = X, '110souradnicePresnost' = X,
    '111cisloSberu' = X, '112rokAkvizice' = X,
    '113text6' = X, '114text7' = X,
    '115text8' = dostal_rc, '116text9' = kubat_rc,
    '117text10' = invc, '118rokPrirustku' = PCROK,
    '119kategorieTaxonuNazev' = MKATTAX, # povinne
    '120nadrizenyTaxonNom' = MNADTAX)    

imp <- "KatalogBIO"


# ------------------------------------- P O K R A C U J   Z D E !!! 
# ------------------------------------- D O P L N I T !!!


# T O P   10   F O R   I M P O R T   C H E C K

mus_tab10 <- mus_tab %>% filter(!is.na(29)) %>%
  slice(11525:11534)
imp <- "bio10"

save <- paste0(path_csv, projekt, "_import_", imp, ".csv")

if(file.exists(save)){
  print("You've been here before!")
} else {
  write.table(mus_tab10, file = save, # mus_tab10
            quote = T, row.names = F,
            sep = ";", dec = ",",
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  }
```
### nedodelky

```{r}

pozn <- bach %>% select(MINVC, pozn) %>% filter(pozn!="")
write.xlsx(pozn, paste0(path_proj, "diskuse/MUZTE_botanika_poznamka.xlsx"), row.names = F)

```



# C L E A R   E N V 

```{r}

rm(a)
rm(ana_tax)
rm(bb)
# rm(bach0)
# rm(bach_adr)
# rm(bach_blb)
# rm(bach_lok)
# rm(bach_tax)
rm(bezaut)
rm(biolib)
rm(bl_cel)
rm(bl_kme)
rm(bl_rad)
rm(bl_rod)
rm(bl_sp)
rm(bl_subsp)
rm(bl_tri)
rm(c)
rm(mod_tab)
rm(mus_KU)
rm(mus_tab)
rm(mus_tab10)
rm(tax_sp)
rm(tax_spWOaut)
rm(tax_subsp)
rm(trans)

```


# **************************************************************************************

# IMPORT PRIRUSTKOVYCH CISEL

```{r}

mod_tab <- read.xlsx(paste0(path_proj, "diskuse/MUZTE_migrace_NESP_PRIRC.xlsx"), sheetIndex = 1, header = T) %>% 
  slice(2:12) %>% select(prirc = Údaj.64) %>% 
  mutate(X = NA,
         sbirka1 = "MUZTE",
         podsb2 = "5",
         cisrada3 = "P",
         prirrok12 = gsub(".*/", "19", prirc),
         pocetks13 = "1",
         evid15 = "1",
         typptukod30 = "P",
         # datzapis98 = Sys.Date(),
         datzapis98 = "28.8.2023",
         porc104 = gsub("P|/.*", "", prirc),
         porc104 = gsub("^0", "", porc104)
         )

mus_tab <- mod_tab %>%
  select("1sbirkaCisloEvidInt" = sbirka1, # POV
         "2podsbirkaCislo" = podsb2, # POV
         "3ciselnaRadaKod" = cisrada3, # POV
         "4prirustekCislo" = prirc,  # POV
         "5inventarniCisla" = X, "6lokaceKod" = X, 
         "7prirustekPlatnost" = X, "8prirustekDuvodNeplatnosti" = X,
         "9prirustekVyrazeno" = X, "10prirustekOznaceni" = X,
         "11prirustekPopisPrirustku" = X,  
         "12prirustekRok" = prirrok12, # POV
         "13prirustekPocetKusu" = pocetks13, # POV
         "14prirustekObal" = X, 
         "15prirustekEvidovano" = evid15, 
         "16materialNazev" = X, 
         "17dataceHodnota" = X, "18stavNazev" = X, 
         "19prirustekPopisStavu" = X, "20prirustekPoznamka" = X,
         "21literaturaNazev" = X, "22nabytiPredmetuDatum" = X,
         "23zpusobNabytiKod" = X, "24typDokladuNabytiKod" = X,
         "25nabytiPredmetuDoklad" = X, "26menaKod" = X, 
         "27nabytiPredmetuCena" = X, "28puvodniMajitelKod" = X,
         "29nabytiPredmetuPoznamka" = X, 
         "30typPredmetuKod" = typptukod30, # POV - "P"(obecný) nebo "PA"(archeologický)
         "31nalezArcheologieMisto" = X, "32nalezArcheologieKontext" = X,
         "33nalezArcheologieAkce" = X, "34vyzkumCislo" = X,
         "35lokalitaNazev" = X,  "36katastralniUzemiNazev" = X, 
         "37druhCislovaniParcelKod" = X, "38pozemekKod" = X,
         "39nalezPredmetuPoznamka" = X, "40nalezPredmetuAdresa" = X, 
         "41nalezPredmetuOkres" = X, "42nalezPredmetuObec" = X, 
         "43nalezPredmetuCastObce" = X, "44nalezPredmetuMestskaCast" = X,
         "45nalezPredmetuCislo" = X, "46nalezPredmetuUlice" = X, 
         "47nalezPredmetuCisloOrientacni" = X, "48nalezPredmetuPSC" = X,
         "49statKod" = X, "50prirustekArcheologieText" = X, 
         "51polozkaPrirustku1PopisPredmetu" = X, "52cisloCES" = X, 
         "53polozkaPrirustku1PocetKusu" = X,  # POV , muzeme nechat prazdne, vyplni se aut 1
         "54doplnkoveCislo1Cislo" = X,
         "55doplnkoveCislo1Text" = X, "56doplnkoveCislo2Cislo" = X, 
         "57doplnkoveCislo2Text" = X, "58doplnkoveCislo3Cislo" = X, 
         "59doplnkoveCislo3Text" = X, "60archivalieArchivalie" = X, 
         "61archivalieSignatura" = X, "62archivalieMarkant" = X, 
         "63archivaliePoznamka" = X, "64vyrazeniPredmetuDatum" = X, 
         "65duvodVyrazeniKod" = X, "66typDokladuVyrazeniKod" = X, 
         "67vyrazeniPredmetuDoklad" = X, "68vyrazeniPredmetuMenaKod" = X, 
         "69vyrazeniPredmetuCena" = X, "70zpusobUbytkuKod" = X, 
         "71vyrazeniPredmetuCisloCES" = X, "72novyMajitelKod" = X, 
         "73vyrazeniPredmetuPoznamka" = X, "74predchoziMajitelSlovy" = X, 
         "75prirustekUserInsert" = X, "76prirustekDatumInsert" = X, 
         "77nalezArcheologieKontext2" = X, "78nalezArcheologieKontext3" = X, 
         "79nalezArcheologieKomponenta" = X, "80nalezArcheologieSouradniceSJTSK" = X, 
         "81nalezArcheologieCiziVyzkum" = X, "82nalezArcheologieNazevVyzkumu" = X, 
         "83nalezArcheologieRokVyzkumu" = X, "84nalezArcheologieFirmaVyzkumu" = X, 
         "85nalezArcheologieVedouciVyzkumu" = X, "86nabytiPredmetuRokAkvizice" = X, 
         "87prispevatelKod" = X, "88text1" = X, "89text2" = X, "90text3" = X, "91text4" = X, "92text5" = X, 
         "93priznak1" = X, "94priznak2" = X, "95priznak3" = X, "96priznak4" = X, "97priznak5" = X,
         "98datumZapisu" = datzapis98, 
         "99text6" = X, "100text7" = X, "101text8" = X, "102text9" = X, "103text10" = X, 
         "104poradoveCislo" = porc104, 
         "105poradoveCisloSub" = X)

imp <- "PK"

# bach0[1659,]

```




# **************************************************************************************

# DOPROVODNE

bach

## HISTORIE STAVU

*IMPORTNÍ ROZHRANÍ*: CSV Historie Stavů Předmětu 
*MUSEION*: import_histStavu.csv  

```{r}

# sort(unique(bach$stav))
ch <- bach %>% select(reviz, stav)

dop_hist <- bach %>% 
  select(MINVC, MSBIRKA, MPODSB, X, create_date, stav) %>% 
  mutate(stav4 = "import",
         across(where(is.character), str_trim)) 

mus_tab <- dop_hist %>% 
  select("1SPCislo" = MINVC, # POV
         "2sbirkaCisloEvidInt" = MSBIRKA, # POV
         "3podsbirkaCislo" = MPODSB, # POV
         "4stav" = stav4, # POV, slovnik
         "5datumStavu" = create_date, # POV
         "6popisStavu" = stav,
         "7zapsalKod" = X,
         "8historieStavuPredmetuPoznam" = X)

imp <- "histStavu"
rm(dop_hist)

```


## SBERATELE

*IMPORTNÍ ROZHRANÍ*: CSV Sberatele Predmetu 
*MUSEION*: import_sberPtu.csv  

```{r SBERATELE}

# M O D I F Y

dop_sber <- bach %>% 
  select(MINVC, MSBIRKA, MPODSB, X, MSBERAT, sber_d)%>% 
  mutate(poradi4 = "1", 
         X = NA) 

dop_sber[dop_sber == ""] <- NA

# C S V

mus_tab <- dop_sber %>% 
  select(
    '1SPCislo' = MINVC,                     # !! povinne !!
    '2sbirkaCisloEvidInt' = MSBIRKA,        # !! povinne !!
    '3podsbirkaCislo' = MPODSB,             # !! povinne !!
    '4poradi' = poradi4,                    # !! povinne !!
    '5sberatelPredmetu' = MSBERAT,       # !! povinne !!
    '6poznamka' = sber_d)

imp <- "sberPtu"
rm(dop_sber)

```

## LOKACE

*IMPORTNÍ ROZHRANÍ*: CSV Sberatele Predmetu 
*MUSEION*: import_sberPtu.csv  


```{r}

sort(unique(bach$lokace))

dop_lok

```


# **************************************************************************************

# E X P O R T Y    C S V


```{r FIXED EXPORT CSV}

# kontrola import jmena

imp
# imp <- "taxon_bez_DUPL_2663"

# f i n a l n i   c s v

save <- paste0(path_csv, projekt, "_import_", imp, ".csv")

if(file.exists(save)){
  print("You've been here before!")
} else {
  write.table(mus_tab, file = save, # mus_tab10
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  }

# u p r a v e n a   t a b u l k a 

modif_save <- paste0(path_csv, projekt, "_modif_", imp, ".csv")

if(file.exists(modif_save)){
  print("You've been here before!")
} else {
  write.table(mod_tab, file = modif_save, 
            quote = T, row.names = F, 
            sep = ";", dec = ",",              # desetinny oddelovac musi byt carka
            na = "", fileEncoding="cp1250")
  print("Operational file  S A V E D  !")
  }

# # r e l a c n i   t a b u l k y
# 
# rel_save <- paste0(path_csv, projekt, "_pracovni_", imp, ".csv")
# 
# if(file.exists(rel_save)){
#   print("You've been here before!")
# } else {
#   write.table(pracovni_lokality, file = modif_save, # !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! uprav df !!!!!!!!!!!!
#             quote = T, row.names = F, 
#             sep = ";", dec = ",",              
#             na = "", fileEncoding="cp1250")
#   print("Operational file  S A V E D  !")
#   }
# 

```



# **************************************************************************************

# KONFLIKTY PRI MIGRACI DAT

Report pro klienta.  
Nesrovnalosti v datech, vyjimky, apod.  

## pis zde:

1) v jednom pripade podskupina 'Tracheopyhta' -> opraveno na 'Tracheophyta'
2) ADRESAR$create_uid: ztotozneno: 'Buša E.' -> 'Burša E.' ; 'svendova' a 'Svendova'
3) ADRESAR$sberatel: ztotozneno: "Buša E." -> "Burša E." ; "Kousalová Š:" -> "Kousalová Š." ; Pavlíkovi P. A J. -> Pavlíkovi P. a J. ; D. Podstawková -> Podstawková D.
4) ADRESAR$sberatel: ztotozneno: "Buša E." "BUrša E."-> "Burša E." ; Pavlíkovi P. A J. -> Pavlíkovi P. a J.
5) ADRESAR$urcil: koupě invc: 1142

6) NABYTI: "", "42/92", "dar", "koupě", "sběr", "Sběr", "sbšr", "Tracheophyta"
