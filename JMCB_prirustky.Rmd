---
title: "JMCB PK"
author: "Kateřina Křížová"
date: "`r Sys.Date()`"
author: "Katerina Krizova"
output:
  pdf_document
    toc: true
    toc_depth: 2
    number_sections: F
    fig_caption: true
  fontsize: 11pt
  geometry: margin=1in
---


\newpage 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=FALSE, fig.dim = c(8, 4))

# PACKAGES

# install.packages("tidyverse", dependencies = T)
# install.packages("readxl")
# install.packages("stringr")
# install.packages("stringi")
# install.packages("mdbr")
# install.packages("RODBC")
# install.packages("odbc")
# install.packages("xlsx")
# install.packages("data.table")
# install.packages("Matrix")
require(tidyverse)
require(readxl)
require(xlsx) # write excel in sheets
require(stringr) # ::str_split_fixed
require(stringi) # ::stri_detect_fixed - detect empty string
require(mdbr) # ::read_mdb
require(RODBC) # ::read_mdb
require(odbc) # ::read_mdb
library(Matrix) 
library(data.table) # ::rbindlist 

```

\newpage 

# PATHS AND PROJ INFO

```{r}

proj <- "JMCB"

path_proj <- "M:/03 klienti/kraj jihocesky/jihoceske muzeum v ceskych budejovicich - JMCB/03 migrace/jmcb migrace 2023/"
path_kk <- paste0(path_proj, "KK_workspace/")

# path_data <- "M:/03 klienti/kraj jihocesky/jihoceske muzeum v ceskych budejovicich - JMCB/2023_PK/zdrojdat/orig/"

```

# READ

7 excelu, kazdy obsahuje listy s roky
18xx 20xx 68-79 1900-1921 1953-1979 1980-99 1980-1999

```{r}

# single-sheet

# df68 <- readxl::read_excel(paste0(path_proj, "68-79.xlsx"), sheet = 1, col_types = "text") # prekryv s df53
# df80 <- readxl::read_excel(paste0(path_proj, "80-99.xlsx"), sheet = 1, col_types = "text")

# multi-sheets

read_excel_allsheets <- function(filename, tibble = FALSE) {
    # I prefer straight data.frames
    # but if you like tidyverse tibbles (the default with read_excel)
    # then just pass tibble = TRUE
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X, col_types = "text", col_names = F,))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheets
    x
}

# eda -> predelano, df az po nacteni

# a <- c("df18", colnames(df18))
# b <- c("df19", colnames(df19))
# c <- c("df20", colnames(df20))
# d <- c("df53", colnames(df53))
# e <- c("df80", colnames(df80))
# 
# eda <- rbind(a, b, c, d, e, deparse.level = 0)

```

df18 = 18xx
df19 = 1900-1921
df53 = 1953-1979
df68 = 68-79
df80 = 80-99
df20 = 20xx



# CREATE CSV

## df18 

pro excel 18xx

```{r}

# read

mysheets <- read_excel_allsheets(paste0(path_kk, "18xx.xlsx")) # specifikuj excel file
df18 <- as.data.frame(rbindlist(mysheets, fill = T))
names(df18) <- df18[1,]
df18 <- df18 %>% filter(is.na(rok)|rok!="rok") # vymaze vsechny radky, ktere jsou hlavicky puvodnich listu

rm(mysheets)

# obecne

aa <- df18 %>% 
  mutate(sbirka1 = "JCM",
         podsb2 = "99",
         cisrada3 = "Z", 
         typ30 = "P",
         rok12 = rok,
         pocetks13 = "1",
         popisCZ = gsub("α", "alfa", popisCZ))

# prirc 

aa$porc <- as.numeric(aa$porc)

b <- aa %>% 
  group_by(rok) %>% 
  fill(porc, .direction = "down") %>% 
  group_by(rok, porc) %>%
  mutate(porc104 = porc, 
         Msub = case_when(n()!=1 ~ seq_along(porc), TRUE ~ NA), #seq_along(porc)-1 # Msub = gsub("^0$", NA, Msub),
         subc105 = as.numeric(Msub)) %>%
  relocate(Msub, .after = porc) %>% 
  ungroup() 
  

# -----> vedouci nuly ?

vednul <- b %>% 
  group_by(rok) %>% 
  summarise(maxcislo = max(porc104), maxsub = max(subc105, na.rm = TRUE)) %>% 
  mutate(maxcislo_n = nchar(maxcislo),
         maxsub_n = nchar(maxsub))

write.table(vednul, "clipboard", sep = "\t", row.names = FALSE)

# leading zeros edits

bb <- b %>% 
  mutate(Mp0 = case_when(rok %in% c("1895", "1896", "1898") ~ str_pad(porc, 2, pad = "0"), TRUE ~ str_pad(porc, 3, pad = "0")),
         Ms0 = case_when(rok %in% c("1885", "1887", "1888", "1889", "1892", "1895") ~ str_pad(Msub, 2, pad = "0"), TRUE ~ str_pad(Msub, 1, pad = "0")),
         prirc4 = ifelse(!is.na(Msub), paste0(Mp0, "/", rok, "-", Ms0), paste0(Mp0, "/", rok)),
         popis11 = str_trim(paste(ifelse(!is.na(popisCZ), paste("popisCZ: ", popisCZ), ""),
                         ifelse(!is.na(popis), paste("popis: ", popis), ""), sep = "\n\n"))) %>% relocate(prirc4, .after = porc) %>% relocate (popis11, .after = popisCZ)
  


# datum nabyti a vyrazeni

cc <- bb %>% 
  mutate(datnab22 = case_when(
                            str_detect(datum, "\\d+\\/\\d+\\s....$") ~ gsub("\\/|\\s", ".", datum), # ok
                            str_detect(datum, "^\\d+\\/\\s*\\d+$") ~ paste0(str_extract(datum, "^\\d+"), ".", (str_extract(datum, "\\d+$")), ".", rok),     
                            str_detect(datum, "\\d+\\.\\s*\\d+\\.\\s*$") ~ gsub("\\s", "", paste(datum, rok)),
                            TRUE ~ datum)) %>% 
  group_by(rok, porc) %>%
  fill(datnab22, .direction = "down") %>%
  ungroup() %>% 
  mutate(rokakvi86 = datum,
         zpnab23 = case_when(str_detect(puvodCZ, "darováno|dar") ~ "D",
                             str_detect(puvodCZ, "směna") ~ "X",
                             str_detect(puvodCZ, "koupě|koupeno|zakoupeno") ~ "K",
                             str_detect(puvodCZ, "nalezeno") ~ "N",
                             TRUE ~ "J")) %>% # jiny
  relocate(datnab22, .after = datum) %>% relocate(zpnab23, .after = puvodCZ) %>% 
  mutate(datvyr64 = gsub("^Odpis\\s|,\\sčj..*$", "", vyrazeni),
         dokvyr67 = gsub("^.*,\\s", "", vyrazeni),
         poznvyr73 = vyrazeni)

# puvod

dd <- cc %>% 
  mutate(puvmaj28 = str_trim(paste(ifelse(!is.na(puvodCZ), paste("puvodCZ:", puvodCZ), ""),
                         ifelse(!is.na(puvod), paste("puvod:", puvod), ""), sep = "\n\n"))) %>% relocate(puvmaj28, .after = puvodCZ)

# poznamky

ee <- dd %>%
  mutate(pozn20 = str_trim(paste(ifelse(!is.na(poznamkaCZ), paste("poznamkaCZ:", poznamkaCZ), ""),
                        ifelse(!is.na(poznamka), paste("poznamka:", poznamka), ""), sep = "\n\n")),
         nabpozn29 = str_trim(paste(ifelse(!is.na(cenaHA), paste("cenaHA:", cenaHA), ""),
                           ifelse(!is.na(cenaHA), paste("cenaHA:", cenaHA), ""), sep = "\n\n")),
         text1_88 = ifelse(!is.na(umisteni), umisteni, ""),
         text2_89 = ifelse(!is.na(umisteniCZ), umisteniCZ, ""))

# vzorek

# vzorek <- ee %>% filter(rok == "1885" & porc %in% c(140:159))

```

## df19 

pro excel 1900-1921

```{r}
# read

mysheets <- read_excel_allsheets(paste0(path_kk, "1900-1921.xlsx"))
df19 <- as.data.frame(rbindlist(mysheets, fill = T))
names(df19) <- df19[2666,]
df19 <- df19 %>% filter(is.na(poradi)|poradi!="poradi") # vymaze vsechny radky, ktere jsou hlavicky puvodnich listu

# obecne

aa <- df19 %>% 
  mutate(sbirka1 = "JCM",
         podsb2 = "99",
         cisrada3 = "Z",
         typ30 = "P",
         ozn10 = predmet,
         rok12 = rok,
         pocetks13 = ifelse(is.na(pocetks), "1", pocetks),
         text3_90 = jinecislo)

aa$poradi <- as.numeric(aa$poradi)

b <- aa %>% 
  mutate(Mrok = rok) %>% 
  fill(Mrok, .direction = "down") %>% 
  group_by(Mrok) %>% 
  fill(poradi, .direction = "down") %>% 
  group_by(Mrok, poradi) %>%
  mutate(porc104 = poradi,
         Msub = case_when(n()!=1 ~ seq_along(poradi), TRUE ~ NA), # seq_along(poradi)-1
         subc105 = as.numeric(Msub)) %>% 
  relocate(Msub, .after = poradi) %>% 
  relocate(Mrok, .after = rok) %>% 
  ungroup() 
  
# -----> vedouci nuly ?

vednul <- b %>% 
  group_by(Mrok) %>% 
  summarise(maxcislo = max(porc104, na.rm = TRUE), maxsub = max(subc105, na.rm = TRUE)) %>% 
  mutate(maxcislo_n = nchar(maxcislo),
         maxsub_n = nchar(maxsub))

write.table(vednul, "clipboard", sep = "\t", row.names = FALSE)

# leading zeros edits   

bb <- b %>% 
  mutate(Mp0 = case_when(Mrok %in% c("1920", "1921") ~ str_pad(poradi, 1, pad = "0"), 
                         Mrok %in% c("1911", "1912", "1913", "1914", "1915", "1916", "1917", "1918", "1919") ~ str_pad(poradi, 2, pad = "0"),
                         TRUE ~ str_pad(poradi, 3, pad = "0")),
         Ms0 = case_when(Mrok == "1905" ~ str_pad(Msub, 3, pad = "0"),
                         Mrok %in% c("1900", "1901", "1903", "1904", "1915", "1916", "1918", "1919") ~ str_pad(Msub, 1, pad = "0"), 
                         Mrok == "1920" ~ NA,
                         TRUE ~ str_pad(Msub, 2, pad = "0")),
         prirc4 = ifelse(!is.na(Msub), paste0(Mp0, "/", Mrok, "-", Ms0), paste0(Mp0, "/", rok)),
         popis11 = paste(ifelse(!is.na(popisCZ), paste("popisCZ: ", popisCZ), ""),
                         ifelse(!is.na(popis), paste("popis: ", popis), ""), sep = "\n\n")) %>% relocate(prirc4, .after = poradi) %>% relocate (popis11, .after = popisCZ)
  


# datum nabyti a vyrazeni 

cc <- bb %>% 
  mutate(datnab22 = case_when(
                            str_detect(datumNabyti, "\\d+\\/\\d+\\s....$") ~ gsub("\\/|\\s", ".", datumNabyti), # ok
                            str_detect(datumNabyti, "^\\d+\\/\\s*\\d+$") ~ paste0(str_extract(datumNabyti, "^\\d+"), ".", 
                                                                              (str_extract(datumNabyti, "\\d+$")), ".", rok),                
                            str_detect(datumNabyti, "\\/II") ~ paste0(gsub("\\/II", ".2.", datumNabyti),rok),
                            str_detect(datumNabyti, "\\d+\\.\\d+\\.$") ~ paste0(datumNabyti, rok),
                            str_detect(datumNabyti, "\\?") ~ NA, # jeden radek ma otaznik
                            str_detect(datumNabyti, "laub mundlicher Mittheilung des hl. Professor Huye") ~ NA, # jeden radek obsahuje nejspis poznamku -> rok akvizice
                            TRUE ~ datumNabyti),
         rokakvi86 = datumNabyti) %>% 
  group_by(rok, poradi) %>%
  fill(datnab22, .direction = "down") %>%
  ungroup() %>% 
  relocate(datnab22, .after = datumNabyti) %>% 
  mutate(vyrdat64 = gsub("^Odpis\\s+|,*\\sč.\\s*j..*$|čj.*$|,*\\s*č.*k..*", "", vyrazeni), # -> musi byt datum !!!
         vyrdok67 = str_extract(vyrazeni, "č.*$"),
         poznvyr73 = vyrazeni)


# puvod - DOPRACOVAT

dd <- cc %>% 
  mutate(puvmaj28 = paste(ifelse(!is.na(puvodCZ), paste("puvodCZ:", puvodCZ), ""),
                          ifelse(!is.na(puvod), paste("puvod:", puvod), ""), sep = "\n\n"),
         zpnab23 = case_when(zpNabyti == "dar" ~ "D",
                             zpNabyti == "koupě" ~ "K",
                             TRUE ~ "J"))

# poznamky

ee <- dd %>%
  mutate(pozn20 = str_trim(paste(ifelse(!is.na(poznamkaCZ), paste("poznamkaCZ:", poznamkaCZ), ""),
                        ifelse(!is.na(poznamka), paste("poznamka:", poznamka), ""), sep = "\n\n")),
         nabpozn29 = str_trim(paste(ifelse(!is.na(zpNabyti), paste("zpNabyti:", zpNabyti), ""),
                           ifelse(!is.na(cenaKR), paste("cenaKR:", cenaKR), ""),
                           ifelse(!is.na(cenaHA), paste("cenaHA:", cenaHA), ""), sep = "\n\n")),
         text1_88 = ifelse(!is.na(umisteni), umisteni, ""),
         text2_89 = ifelse(!is.na(umisteniCZ), umisteniCZ, ""))

```


## df OST

df53 df68 df80 df20 -> sloucit

```{r}

# df53
mysheets <- read_excel_allsheets(paste0(path_kk, "1953-1979.xlsx"))
df53 <- as.data.frame(rbindlist(mysheets, fill = T))
names(df53) <- df53[1,]
names(df53)[16] = "xpozn"
df53 <- df53 %>% filter(is.na(rokPK)|rokPK!="rokPK") %>% # n = 27579 
    mutate(osoba = "")
df53$rokPK <- as.numeric(df53$rokPK) 
df53 <- df53 %>% filter(rokPK %in% 1953:1967) %>% # filtr roku
    mutate(osoba = "", poradi = "")
# df68
df68 <- readxl::read_excel(paste0(path_proj, "68-79.xlsx"), sheet = 1, col_types = "text") %>% mutate(osoba = "", poradi = "")

# df80
df80 <- readxl::read_excel(paste0(path_proj, "80-99.xlsx"), sheet = 1, col_types = "text") %>% 
  mutate(osoba = ziskal, datumNabyti = datunNabyti, poradi = "", Sign = Sign.) 
  # filter(prirc != "Číslo přír.")

# df20
mysheets <- read_excel_allsheets(paste0(path_kk, "20xx.xlsx")) # specifikuj excel file
df20 <- as.data.frame(rbindlist(mysheets))
names(df20) <- df20[1,] # nacitame bez hlavicky -> nastaveni prvniho radku jako hlavicky
df20 <- df20 %>% filter(is.na(poradi)|poradi!="poradi") %>% # n = 11689 -> vymaze vsechny radky, ktere jsou hlavicky puvodnich listu
    mutate(Revize = revize,
           rokPK = ifelse(rokPK == "20021", "2001", rokPK))

# rbind

sel53 <- df53 %>% select(poradi, prirc, rokPK, datumNabyti, Sign, invc, predmet, popis, pocetKs, zpNabyti, doklad, puvod, vyrazeni, Revize, podsbirka, jinecislo, osoba)
sel68 <- df68 %>% select(poradi, prirc, rokPK, datumNabyti, Sign, invc, predmet, popis, pocetKs, zpNabyti, doklad, puvod, vyrazeni, Revize, podsbirka, jinecislo, osoba)
sel80 <- df80 %>% select(poradi, prirc, rokPK, datumNabyti, Sign, invc, predmet, popis, pocetKs, zpNabyti, doklad, puvod, vyrazeni, Revize, podsbirka, jinecislo, osoba)
sel20 <- df20 %>% select(poradi, prirc, rokPK, datumNabyti, Sign, invc, predmet, popis, pocetKs, zpNabyti, doklad, puvod, vyrazeni, Revize, podsbirka, jinecislo, osoba)

later <- rbind(sel53, sel68, sel80, sel20)

nrow(later) == nrow(sel53) + nrow(sel68) + nrow(sel80) + nrow(sel20) # TRUE

rm(list = ls()[grepl("df", ls())])
rm(list = ls()[grepl("sel", ls())])
rm(mysheets)
# later <- later %>% mutate_all(~ifelse(. == "Φ", "průměr", .))


```

### eda

```{r}
any(is.na(later$poradi))
any(is.na(later$prirc))
any(is.na(later$rokPK))

later <- later %>% 
  mutate(Mrok = rokPK) %>% 
  fill(Mrok, .direction = "down") %>% 
  mutate(Mprirc = prirc) %>% 
  group_by(Mrok) %>% 
  fill(Mprirc, .direction = "down") %>% 
  ungroup() %>% 
  mutate(Mporadi = str_extract(Mprirc, "\\d+")) %>% 
  relocate(Mrok, Mprirc, Mporadi, .before = poradi) %>% 
  group_by(Mrok, Mporadi) %>% 
  mutate(Msub_a = str_trim(ifelse(str_detect(prirc, "a|b"), str_replace_all(prirc, c("\\d+" = "", "\\/" = "")), NA)),
         Msub = as.character(case_when(n()!=1 ~ seq_along(Mporadi), TRUE ~ NA)),
         # Msub = as.character(case_when(n()!=1 ~ seq_along(Mporadi)-1, TRUE ~ NA)),
         # Msub = gsub("^0$", NA, Msub),
         subc105 = case_when(Msub_a == "a" ~ "1",
                             Msub_a == "b" ~ "2", TRUE ~ Msub)) %>% relocate(Msub_a, Msub, .after = Mporadi) %>% 
  ungroup()
  

later %>% select(rokPK, Mrok, poradi, Mporadi, prirc, Mprirc) %>% sample_n(10)
later %>% select(rokPK, Mrok, poradi, Mporadi, prirc, Mprirc) %>% filter(is.na(prirc)) %>% sample_n(10)

```

### popisy u hromadnych karet

```{r}
hr <- later %>% 
  filter(Mrok == "1994") %>% 
  filter(Msub %in% c("1", "2")) # popisy pro roky 1994-2016

later$Mrok <- as.numeric(later$Mrok)
later$Msub <- as.numeric(later$Msub)

# pop <- later %>% 
#   group_by(Mrok, Mprirc) %>% 
#   mutate(Mpop = case_when(Mrok >= 1994 & Mrok <= 2016 ~ popis[1],
#                           TRUE ~ NA)) %>% relocate(Mpop, .before = popis)

nova <- later %>% 
  filter(Mrok %in% 1994:2016) %>% 
 group_by(Mrok, Mprirc) %>% 
  mutate(Mpop = popis[1], 
         Mpop = ifelse(str_detect(Mpop, "^1\\)"), NA, Mpop),
         Mpop = ifelse(is.na(Msub), NA, Mpop)) %>% relocate(Mpop, .before = popis) %>% 
  mutate(Mind = ifelse((is.na(popis[1]) & is.na(Mpop[1])) | (!is.na(popis[1]) & !is.na(Mpop[1])), TRUE, FALSE)) %>% relocate(Mind, .before = Msub) %>% 
  # mutate(Msub0 = ifelse((is.na(popis[1]) & is.na(Mpop[1])) | (!is.na(popis[1]) & !is.na(Mpop[1])), Msub-1, Msub)) %>% relocate(Msub0, .before = Msub)
  mutate(Msub0 = ifelse(Mind == TRUE, Msub-1, Msub))  %>% relocate(Msub0, .before = Msub) %>% 
  ungroup()
      
stara <- later %>% 
   filter(Mrok %in% 1953:1993) %>% 
  mutate(Msub0 = Msub, 
         Mind = FALSE,
         Mpop = NA)

nrow(stara)+nrow(nova)==nrow(later)

jednot <- bind_rows(nova, stara) %>% 
# jednot$Mpopis <- ifelse(jednot$Mpop == jednot$popis, jednot$popis, unite(jednot, Mpop, popis, sep = ": ")) 
  # mutate(Mpopis = ifelse(is.na(Mpop), popis, paste0(Mpop, ": ", popis))) %>% relocate(Mpopis, .after = popis)
  mutate(Mpopis = ifelse(Mpop != popis & !is.na(Mpop), paste0(Mpop, " ", popis), popis)) %>% relocate(Mpopis, .after = popis)


```


### obdobi a masky

```{r}

jednot$Mporadi <- as.numeric(jednot$Mporadi)
jednot$Msub <- as.numeric(jednot$Msub)

vednul <- jednot %>% 
  group_by(Mrok) %>% 
  summarise(maxcislo = max(Mporadi, na.rm = TRUE), maxsub = max(Msub, na.rm = TRUE)) %>% 
  mutate(maxcislo_n = nchar(maxcislo),
         maxsub_n = nchar(maxsub))

y53 <- jednot %>% filter(Mrok == 2013 & !is.na(Msub))
# view(y53)
rm(y53)

write.table(vednul, "clipboard", sep = "\t", row.names = FALSE)

# PORC 4: 1956,1958,1959,1960,1965,1966,1972,1973,1974,1975,1977,1978,1980,1983 ; zbytek 3

# SUBC  3:1998,2000,2004,2005,2009,2010,2011,2012,2013,2014,2015,2016
#       2: 1970, 1986,1987, 1994,1995,1996,1997,1999,2001,2002,2003,2006,2007,2008
#       0: 1953, 1957, 1972, 1977, 1979, 1982, 1985, 1993 ; zbytek 1
#       a,b: 1953 1955 1956 1958 1959 1960 1961 1963 1964 1965 1968 1969 1971 1973 1974 1981

subs <- jednot %>% 
  filter(!is.na(Msub_a))

sort(unique(subs$Mrok))


rady <- ee %>% select(Mrok, Mrada) %>% 
  filter(!is.na(Mrada)) %>% distinct()

```

### proces

```{r}

# prirc
aa <- jednot %>% 
  
  # assign

  mutate(ozn10 = predmet) %>% relocate(ozn10, .after = predmet) %>% 
  mutate(popis11 = Mpopis) %>% relocate(popis11, .after = popis) %>% 
  mutate(pocetks13 = ifelse(is.na(pocetKs), "1", 
                            ifelse(str_detect(pocetKs, "^\\d+$"), pocetKs, "1"))) %>% relocate(pocetks13, .after = pocetKs) %>% # tri sporne zaznamy, dat do poznamky (12) 6   (17) 9  (27) 25 + dva otazniky
  mutate(doklnab25 = doklad) %>% relocate(doklnab25, .after = doklad) %>% 
  mutate(puvmaj28 = puvod) %>% relocate(puvmaj28, .after = puvod) %>% 
  mutate(porc104 = Mporadi, 
         subc105 = Msub0,
         sbirka1 = "JCM",
         cisrada3 = "Z",
         typ30 = "P") %>% 
  
  # prirc etc
  mutate(Mrada = ifelse(str_detect(prirc, "Z"), "Z", NA),
         Mcislo = Mporadi, 
         Mp0 = case_when(Mrok %in% c("1956", "1958", "1959", "1960", "1965", "1966", 
                                         "1972", "1973", "1974", "1975", "1977", "1978",
                                         "1980", "1983") ~ str_pad(Mcislo, 4, pad = "0"),
                            TRUE ~ str_pad(Mcislo, 3, pad = "0")),
         Ms0 = case_when(Mrok %in% c("1998","2000","2004","2005","2009","2010","2011","2012","2013","2014","2015","2016") ~ str_pad(Msub0, 3, pad = "0"),
                         Mrok %in% c("1970", "1986","1987", "1994","1995","1996","1997","1999","2001","2002","2003","2006","2007","2008") ~ str_pad(Msub0, 2, pad = "0"),
                         Mrok %in% c("1953", "1957", "1972", "1977", "1979", "1982", "1985", "1993") ~ NA,
                         TRUE ~ str_pad(Msub0, 1, pad = "0"))) %>% 
  relocate(Mrada, Mcislo, Mp0, Ms0, Msub_a, .after = rokPK) %>% 
  mutate(Mprirc = ifelse(!is.na(Msub_a), paste0(Mp0, "/", Mrok, "-", Msub_a), 
                         ifelse(!is.na(Ms0), paste0(Mp0, "/", Mrok, "-", Ms0), paste0(Mp0, "/", Mrok))),
         prirc4 = ifelse(!is.na(Mrada), paste0(Mrada, Mprirc), Mprirc)) %>% relocate(prirc4, .after = prirc) %>% 
  mutate(rok12 = Mrok) %>% relocate(rok12, .after = rokPK) 

bb <- aa %>% 

# nabyti
  mutate(Mdat_ser = as.numeric(ifelse(str_detect(datumNabyti, "^.....$"), datumNabyti, NA)),
         Mdat_trans = format(as.Date(Mdat_ser, origin = "1899-12-30"), "%d.%m.%Y"),
         datnab22 = ifelse(str_detect(datumNabyti, "^.....$"), Mdat_trans, 
                           ifelse(str_detect(datumNabyti, "\\."), sub("\\.$", "", datumNabyti), datumNabyti))) %>% 
  relocate(datnab22, .after = datumNabyti) %>% 
  mutate(prisp87 = osoba, 
         zpnab23 = case_when(str_detect(zpNabyti, "(?i)koup|nákup") ~ "K",
                             str_detect(zpNabyti, "Koupí od dědiců") ~ "B",
                             str_detect(zpNabyti, "(?i)dar") ~ "D",
                             str_detect(zpNabyti, "(?i)konf") & !str_detect(zpNabyti, "(?i)koup") ~ "F",
                             str_detect(zpNabyti, "(?i)nalez|nález") ~ "N",
                             str_detect(zpNabyti, "(?i)odkaz") ~ "O",
                             str_detect(zpNabyti, "(?i)převod") ~ "P",
                             str_detect(zpNabyti, "(?i)star.*fond") ~ "S",
                             str_detect(zpNabyti, "(?i)pozůst") ~ "T",
                             str_detect(zpNabyti, "(?i)výzkum") ~ "V",
                             TRUE ~ NA)) %>% relocate(zpnab23, .after = zpNabyti) %>% # zpNabyti take do poznnab29
 
  # vyrazeni 
  mutate(vyrdat64 = str_extract(vyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         vyrdok67 = str_extract(vyrazeni, "MK\\s*\\d+\\/\\d+|č.\\s*j.\\s*\\d+\\/\\d+|č.\\s*j.\\s*\\d+\\/\\d+|D\\s\\d+\\/\\d+|Kult\\.*\\s\\d+\\/\\d+|MK\\s*\\d+\\/\\d+\\sOM|č.\\s*j.\\s*\\d+\\/\\d+\\sOM|č.\\s*j.\\s*\\d+\\/\\d+.*G|D\\s\\d+\\/\\d+|Kult\\.*\\s\\d+\\/\\d+|č\\.*\\s*j\\.\\s*\\w+\\s*\\d+\\/\\d+")) %>% 
  relocate(vyrdat64, vyrdok67, .after = vyrazeni) %>%  # vyrazeni take do pozvyr73
  
  # texty
  mutate(text3_90 = jinecislo) %>% relocate(text3_90, .after = jinecislo) %>%
  mutate(text4_91 = Revize) %>% relocate(text4_91, .after = Revize) %>% 
  mutate(text5_92 = Sign) %>% relocate(text5_92, .after = Sign) %>% 
    
  # podsbirka
  mutate(podsb2 = ifelse(!is.na(podsbirka),
                         case_when(podsbirka == "(20)" ~ "164",
                                   podsbirka == "1" ~ "151",
                                   podsbirka == "10" ~ "158",
                                   podsbirka == "11" ~ "160",
                                   podsbirka == "13" ~ "154",
                                   podsbirka == "15" ~ "161",
                                   podsbirka == "17" ~ "155",
                                   podsbirka == "18" ~ "159",
                                   podsbirka == "19" ~ "162",
                                   podsbirka == "20" ~ "164",
                                   podsbirka == "21" ~ "156",
                                   podsbirka == "5" ~ "165",
                                   podsbirka == "6" ~ "157",
                                   podsbirka == "7" ~ "152",
                                   podsbirka == "8" ~ "163",
                                   podsbirka == "9" ~ "153",
                                   TRUE ~ "99"), "99")) %>% relocate(podsb2, .after = podsbirka)  # ostatni udaje (sporne podsb. atd) do pozn20
cc <- bb %>% 
  # invc -----> nedavam nic! je treba resit masky a signatury a maj v tom bordel
  mutate(invc5_tbd = ifelse(str_detect(invc, "^\\d+$"), invc, NA),
         puv_invc106 = invc) %>% # sloupec navic do importniho rozhrani, aby nam info o invc zustalo v importu
  # relocate(invc5, .after = invc) %>% 
  # poznamky
  mutate(pozn20 = ifelse(is.na(pocetks13), paste("pocetKs:", pocetKs), NA),
         nabpozn29 = ifelse(!is.na(zpNabyti), paste("zpNabyti: ", zpNabyti), NA),
         poznvyr73 = ifelse(!is.na(vyrazeni), paste("vyrazeni: ", vyrazeni), NA))

cc$Mrok <- as.factor(cc$Mrok)

# cc$popis11 <- gsub("Φ", "průměr", cc$popis11)
# cc$popis11 <- gsub("Ω", "alfa", cc$popis11)
cc$popis11 <- gsub(";", ",", cc$popis11)

# vzorek

# sample_n(cc, 10)

```

# SAVE CSV

```{r}




Lpk <- c("sbirka1", "podsb2", "cisrada3", "prirc4", "invc5", "lok6","prirpla7", "prirpla8", "prirpla9", "ozn10",
         "popis11", "rok12", "pocetks13", "obal14", "evid15", "mater16", "datace17", "stav18", "popstav19", "pozn20",
         "liter21", "datnab22", "zpnab23", "typ24","doklnab25", "mena26", "cennab27", "puvmaj28", "nabpozn29", "typ30",
         "armisto31", "arkontext32", "arakce33", "arvyzk34", "arlok35", "arku36", "arparc37", "arpoz38", "nalpozn39", "naladr40",
         "nalokr41", "nalobec42", "nalcast43", "nalmc44", "nalcis45", "nalul46", "nalorc47", "nalpsc48", "stat49", "artext50",
         "polpop51", "polCES52", "polks53", "poldopl1_54", " poldopl1_55", "poldopl2_56", "poldopl2_57", "poldopl3_58", "poldopl3_59", "archiv60",
         "acvsign61", "acvmark62", "acvpozn63", "vyrdat64", "vyrduv65", "vyrtyp66", "vyrdok67", "vyrmena68", "vyrcena69", "zpub70",
         "vyrCES71", "novaj72", "poznvyr73", "predchmaj74", "userins75", "datins76", "arkontext2_77", "arkontext3_78", "arkomp79", "arSJTSK80",
         "arcizivyz81", "arnazevvyz82", "arrokvyz83", "arfirmavyz84", "arvedoucivyz85", "rokakvi86", "prisp87", 
         "text1_88", "text2_89", "text3_90", "text4_91", "text5_92", 
         "priz1_93", "priz2_94", "priz3_95", "priz4_96", "priz5_97", 
         "datzap98", "text6_99", "text7_100", "text8_101", "text9_102", "text10_103", "porc104", "subc105", "puv_invc106") # 105 ; 106 jen pro pozdejsi (invc)
         
# uprav dle excelu, ktery zpracovavas

# n <- 2521
# imp <- "df18"
# 
# n <- 3428
# imp <- "df19"

# n <- 40
# imp <- "vzorek"
# ee <- vzorek

n <- 51669
imp <- "dfOST"
ee <- cc
   
mus_tab <- data.frame(smazme = 1:n)


for(i in Lpk){
  if(i %in% colnames(ee)){
    ano <- ee %>% select(all_of(i))
    mus_tab <- cbind(mus_tab, ano)
    print("jo")
  } else{
    ne <- data.frame(rep(NA, n))
    colnames(ne) <- i
    mus_tab <- cbind(mus_tab, ne)
    print("houby")}
}

mus_tab <- mus_tab %>% select(-smazme) %>% filter(rok12 != "1953")

# SAVE

# f2s <- paste0(path_kk, "import/", proj, "_import_", imp, ".csv")
# 
# if(file.exists(f2s)){
#   print("You've been here before!")
#   rm(f2s)
# } else {
#   write.table(mus_tab, file = f2s,
#             quote = T, row.names = F, 
#             sep = ";", dec = ",", 
#             na = "", fileEncoding="cp1250")
#             # na = "", fileEncoding = "UTF-8")
#   print("Import csv  W R I T T E N  !")
#   rm(f2s)
# }

# SAVE 2

# f2s <- paste0(path_kk, "import/", proj, "_import_", imp, ".csv")
# 
# if(file.exists(f2s)){
#   print("You've been here before!")
#   rm(f2s)
# } else {
#   write.csv2(mus_tab, file = f2s,
#             quote = T, row.names = F, 
#             sep = ";", # dec = ",", 
#             # na = "", fileEncoding="cp1250")
#             na = "", fileEncoding = "UTF-8")
#   print("Import csv  W R I T T E N  !")
#   rm(f2s)
# }

# SAVE ACC FACTOR
mus_tab$rok12 <- as.factor(mus_tab$rok12)

df_list <- split(mus_tab, mus_tab$rok12)

# walk2(df_list, mus_tab$rok12, ~ write.csv(.x, paste0(path_kk, "import/", proj, "_import_", .y, ".csv"), row.names = FALSE))

for (i in seq_along(df_list)) {
  subset_df <- df_list[[i]]
  group_name <- unique(subset_df$rok12)
  # write.csv(subset_df, paste0(path_kk, "import/", proj, "_import_", group_name, ".csv"), row.names = FALSE)
  write.table(subset_df, file = paste0(path_kk, "import/roky/", proj, "_import_", group_name, ".csv"),
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="UTF-8")
}

# ----------------------------------------- vzorek

smpl <- paste0(imp, "_sample")

sam <- sample_n(mus_tab, 10)

f2s <- paste0(path_kk, "import/", proj, "_import_", smpl, ".csv")

if(file.exists(f2s)){
  print("You've been here before!")
  rm(f2s)
} else {
  write.table(sam, file = f2s,
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  rm(f2s)
}

```

# COLUNM CHECK

kontroluj oproti mus_tab

```{r}

view(mus_tab)

colnames(df18) # -------> OK
# rok = rok12
# porc = porc104
# datum = dat_nab22
# popis = popis11
# popisCZ = -//-
# cenaKR = nabpozn29
# cenaHA = -//-
# puvod = puvmaj28
# puvodCZ = -//-
# umisteni = text1_88
# umisteniCZ = text2_89
# vyrazeni = poznvyr73
# poznamka = pozn20
# poznamkaCZ =-//-

colnames(df19) # -------> OK
# rok = rok12
# poradi = porc104
# datumNabyti = dat_nab22
# popis = popis11
# popisCZ = -//-
# cenaKR = nabpozn29
# cenaHA = -//-
# puvod = puvmaj28
# umisteni = text1_88
# umisteniCZ = text2_89
# vyrazeni = poznvyr73
# poznamka = pozn20
# poznamkaCZ = -//-
# puvodCZ = puvmaj28
# jinecislo = text3_90
# zpNabyti = zpnab23 ; nabpozn29
# predmet = ozn10
# pocetks = pocetks13

colnames(later) # -------> 

row_number_to_view <- 6716

# View the specific row
specific_row <- mus_tab[row_number_to_view, , drop = FALSE]

# Print the result
print(specific_row)
print(specific_row$popis11)

summary(mus_tab$rok12)

```


# OPRAVY PRI MIGRACI

```{r}

r1980 <- mus_tab %>% filter(rok12 == "1980") %>% 
  mutate(datnab220 = case_when(datnab22 == "1976" ~ "01.01.1976",
                              datnab22 == "1978" ~ "01.01.1978",
                              datnab22 == "1979" ~ "01.01.1979",
                              datnab22 == "leden 1980" ~ NA,
                              TRUE ~ datnab22),
         nabpozn290 = ifelse(datnab22 == "leden 1980", paste(nabpozn29, "datumNabyti: leden 1980", sep = "\n\n"), nabpozn29)) %>% 
  relocate(datnab220, .after = datnab22) %>% 
  relocate(nabpozn290, .after = nabpozn29)

r1987 <- mus_tab %>% filter(rok12 == "1987") %>% 
  mutate(datnab220 = case_when(datnab22 == "1970" ~ "01.01.1970",
                              datnab22 == "1974" ~ "01.01.1974",
                              datnab22 == "1980" ~ "01.01.1980",
                              datnab22 == "1982" ~ "01.01.1982",
                              datnab22 == "1986" ~ "01.01.1986",
                              TRUE ~ datnab22)) %>% 
  relocate(datnab220, .after = datnab22) 

r <- r1987 %>% select(-datnab22)

r1988 <- mus_tab %>% filter(rok12 == "1988") %>% 
 mutate(datnab220 = ifelse(datnab22 == "31.5.-2.6.1988", NA, datnab22),
         nabpozn290 = ifelse(datnab22 == "31.5.-2.6.1988", paste(nabpozn29, "datumNabyti: 31.5.-2.6.1988", sep = "\n\n"), nabpozn29)) %>% 
  relocate(datnab220, .after = datnab22) %>% 
  relocate(nabpozn290, .after = nabpozn29)

r <- r1988 %>% select(-datnab22, -nabpozn29)

write.table(r, file = paste0(path_kk, "import/roky/", proj, "_import_####_opr.csv"),
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="UTF-8")

sort(unique(r1988$datnab22))

```

# SEZNAM PRIRC A INVC

```{r}

# fce --- fce --- fce --- fce --- fce --- fce --- fce --- fce

generate_numbers <- function(min_val, max_val) {
  seq(min_val, max_val, by = 1)
}

# fce --- fce --- fce --- fce --- fce --- fce --- fce --- fce

type <- ee %>% 
  select(prirc, Mprirc, prirc4, Sign, invc) %>% 
  drop_na(invc) %>% 
  mutate(typ_cisla = ifelse(str_detect(invc, "\\d+\\s-\\s\\d+"), "interval", "jiny"))


# INTERVALY ----------------------------------------------------------------------------------------

inter <- type %>% 
  filter(typ_cisla == "interval") %>% 
   mutate(min = str_trim(ifelse(str_detect(invc, "\\d+\\s*-\\s*\\d+"), str_remove(invc, "-.*$"), NA)),
          max = str_trim(ifelse(str_detect(invc, "\\d+\\s*-\\s*\\d+"), str_remove(invc, "^.*-"), NA)),
          Mmin = as.numeric(ifelse(str_detect(min, "^\\d+$"), min, NA)), 
          Mmax = as.numeric(ifelse(str_detect(max, "^\\d+$"), max, NA))) %>% 
  filter(!is.na(Mmin)&!is.na(Mmax)) %>% 
  filter(Mmin<Mmax) %>% 
  rowwise() %>%
  mutate(numbers = list(generate_numbers(Mmin, Mmax))) %>%
  unnest(numbers) %>% 
  select(-min, -Mmin, -max, -Mmax)

inter$numbers <- as.character(inter$numbers)

# JINY ----------------------------------------------------------------------------------------

jiny <- type %>% 
  filter(typ_cisla == "jiny") %>% 
  mutate(orig_invc = invc) %>% 
  separate_rows(invc, sep = ",") %>% 
  rename("numbers" = invc,
         "invc" = orig_invc)

sort(unique(jiny$Sign))

# MERGE ----------------------------------------------------------------------------------------

mer <- bind_rows(inter, jiny)

nrow(inter)+nrow(jiny)==nrow(mer) # TRUE

res <- mer %>% 
  mutate(Minvc = str_trim(numbers),
         # Minvc = str_remove(Minvc, "^[A-Za-z]+"),
         Minvc = str_extract(Minvc, "\\d+"),
         Msub = str_extract(numbers, "[A-Za-z]+$")) %>% 
  mutate(Minvc0 = case_when(Sign == "A" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "B" ~ paste0(Sign, str_pad(Minvc, 6, pad = "0")),
                              Sign == "D" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "F" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "Fi" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "Fo" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "Fo" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "G" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "GK" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "H" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "K" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "LA" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "M" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "ME" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "Mi" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "MP" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "N" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "O" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "P" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "PM" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "PP" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "R" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "S" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "ST" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "UP" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "V" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "VS" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              Sign == "ZE" ~ paste0(Sign, str_pad(Minvc, 6, pad = "0")),
                              Sign == "ZV" ~ paste0(Sign, str_pad(Minvc, 5, pad = "0")),
                              TRUE ~ Minvc)) %>% 
  unite(fin_invc, c("Minvc0", "Msub"), sep = "/", na.rm = T, remove = FALSE) %>% 
  select(-typ_cisla, -numbers, -Minvc, -Minvc0, -Msub)
         

```


# ------------------- N E A K T U A L N I  

df18

pro excel 18xx

TO DO:

? jaky format prirc
? k datumu nabyti doplněn rok
? jaka podsbirka a ciselna rada
? co s podlomenymi zaznamy - 0 jsou jakoby nadpis tech podlomenych

```{r}

# read

mysheets <- read_excel_allsheets(paste0(path_kk, "18xx.xlsx")) # specifikuj excel file
df18 <- as.data.frame(rbindlist(mysheets, fill = T))
names(df18) <- df18[1,]
df18 <- df18 %>% filter(is.na(rok)|rok!="rok") # vymaze vsechny radky, ktere jsou hlavicky puvodnich listu

rm(mysheets)

# obecne

aa <- df18 %>% 
  mutate(sbirka1 = "JCM",
         podsb2 = "99",
         cisrada3 = "Z", 
         typ30 = "P",
         rok12 = rok,
         pocetks13 = "1")

# prirc - DOPRACOVAT

aa$porc <- as.numeric(aa$porc)

bb <- aa %>% 
  group_by(rok) %>% 
  fill(porc, .direction = "down") %>% 
  group_by(rok, porc) %>%
  mutate(porc104 = porc, 
         Msub = case_when(n()!=1 ~ seq_along(porc)-1, TRUE ~ NA),
         Msub = gsub("^0$", NA, Msub),
         subc105 = Msub) %>%
  relocate(Msub, .after = porc) %>% 
  ungroup() %>% 
  mutate(prirc4 = ifelse(!is.na(Msub), paste0(str_pad(porc, 3, pad = "0"), "/", rok, "-", Msub), paste0(str_pad(porc, 3, pad = "0"), "/", rok)),
         popis11 = paste(ifelse(!is.na(popisCZ), paste("popisCZ: ", popisCZ), ""),
                         ifelse(!is.na(popis), paste("popis: ", popis), ""), sep = "\n")) %>% relocate(prirc4, .after = porc) %>% relocate (popis11, .after = popisCZ)

# datum nabyti a vyrazeni

cc <- bb %>% 
  mutate(datnab22 = case_when(
                            str_detect(datum, "\\d+\\/\\d+\\s....$") ~ gsub("\\/|\\s", ".", datum), # ok
                            str_detect(datum, "^\\d+\\/\\s*\\d+$") ~ paste0(str_extract(datum, "^\\d+"), ".", (str_extract(datum, "\\d+$")), ".", rok),     
                            str_detect(datum, "\\d+\\.\\s*\\d+\\.\\s*$") ~ gsub("\\s", "", paste(datum, rok)),
                            TRUE ~ datum),
         rokakvi86 = datum,
         zpnab23 = case_when(str_detect(puvodCZ, "darováno|dar") ~ "D",
                             str_detect(puvodCZ, "směna") ~ "X",
                             str_detect(puvodCZ, "koupě|koupeno|zakoupeno") ~ "K",
                             str_detect(puvodCZ, "nalezeno") ~ "N",
                             TRUE ~ "J")) %>% # jiny
  relocate(datnab22, .after = datum) %>% relocate(zpnab23, .after = puvodCZ) %>% 
  mutate(datvyr64 = gsub("^Odpis\\s|,\\sčj..*$", "", vyrazeni),
         dokvyr67 = gsub("^.*,\\s", "", vyrazeni),
         poznvyr73 = vyrazeni)

# puvod - DOPRACOVAT

dd <- cc %>% 
  mutate(puvmaj28 = paste(ifelse(!is.na(puvodCZ), paste("puvodCZ:", puvodCZ), ""),
                         ifelse(!is.na(puvod), paste("puvod:", puvod), ""), sep = "\n")) %>% relocate(puvmaj28, .after = puvodCZ)

# poznamky

ee <- dd %>%
  mutate(pozn20 = paste(ifelse(!is.na(poznamkaCZ), paste("poznamkaCZ:", poznamkaCZ), ""),
                        ifelse(!is.na(poznamka), paste("poznamka:", poznamka), ""), sep = "\n"),
         nabpozn29 = paste(ifelse(!is.na(cenaKR), paste("cenaKR:", cenaKR), ""),
                           ifelse(!is.na(cenaHA), paste("cenaHA:", cenaHA), ""),
                                  sep = "\n"),
         text1_88 = ifelse(!is.na(umisteni), umisteni, ""),
         text2_89 = ifelse(!is.na(umisteniCZ), umisteniCZ, ""))

# vzorek

vzorek <- ee %>% filter(rok == "1885" & porc %in% c(140:159))

```

df19 

pro excel 1900-1921

```{r}
# read

mysheets <- read_excel_allsheets(paste0(path_kk, "1900-1921.xlsx"))
df19 <- as.data.frame(rbindlist(mysheets, fill = T))
names(df19) <- df19[2666,]
df19 <- df19 %>% filter(is.na(poradi)|poradi!="poradi") # vymaze vsechny radky, ktere jsou hlavicky puvodnich listu

# obecne

aa <- df19 %>% 
  mutate(sbirka1 = "JCM",
         podsb2 = "99",
         cisrada3 = "Z",
         typ30 = "P",
         ozn10 = predmet,
         rok12 = rok,
         pocetks13 = pocetks,
         text3_90 = jinecislo)

# prirc - DOPRACOVAT

aa$poradi <- as.numeric(aa$poradi)

bb <- aa %>% 
  group_by(rok) %>% 
  fill(poradi, .direction = "down") %>% 
  group_by(rok, poradi) %>%
  mutate(Msub = case_when(n()!=1 ~ seq_along(poradi)-1, TRUE ~ NA),
         Msub = gsub("^0$", NA, Msub),
         porc104 = poradi) %>%
  relocate(Msub, .after = poradi) %>% 
  ungroup() %>% 
  mutate(prirc4 = ifelse(!is.na(Msub), paste0(str_pad(poradi, 3, pad = "0"), "/",rok, "-", Msub), paste0(str_pad(poradi, 3, pad = "0"), "/", rok)),
         subc105 = Msub, 
         popis11 = paste(ifelse(!is.na(popisCZ), paste("popisCZ: ", popisCZ), ""), 
                         ifelse(!is.na(popis), paste("popis: ", popis), ""), sep = "\n"))

# datum nabyti a vyrazeni 

cc <- bb %>% 
  mutate(datnab22 = case_when(
                            str_detect(datumNabyti, "\\d+\\/\\d+\\s....$") ~ gsub("\\/|\\s", ".", datumNabyti), # ok
                            str_detect(datumNabyti, "^\\d+\\/\\s*\\d+$") ~ paste0(str_extract(datumNabyti, "^\\d+"), ".", 
                                                                              (str_extract(datumNabyti, "\\d+$")), ".", rok),                
                            str_detect(datumNabyti, "\\/II") ~ paste0(gsub("\\/II", ".2.", datumNabyti),rok),
                            str_detect(datumNabyti, "\\d+\\.\\d+\\.$") ~ paste0(datumNabyti, rok),
                            TRUE ~ datumNabyti),
         rokakvi86 = datumNabyti) %>% 
  relocate(datnab22, .after = datumNabyti) %>% 
  mutate(vyrdat64 = gsub("^Odpis\\s+|,*\\sč.\\s*j..*$|čj.*$|,*\\s*č.*k..*", "", vyrazeni),
         vyrdok67 = str_extract(vyrazeni, "č.*$"),
         poznvyr73 = vyrazeni)


# puvod - DOPRACOVAT

dd <- cc %>% 
  mutate(puvmaj28 = paste(ifelse(!is.na(puvodCZ), paste("puvodCZ:", puvodCZ), ""),
                          ifelse(!is.na(puvod), paste("puvod:", puvod), ""), sep = "\n"),
         zpnab23 = case_when(zpNabyti == "dar" ~ "D",
                             zpNabyti == "koupě" ~ "K",
                             TRUE ~ "J"))

# poznamky

ee <- dd %>%
  mutate(pozn20 = paste(ifelse(!is.na(poznamkaCZ), paste("poznamkaCZ:", poznamkaCZ), ""),
                        ifelse(!is.na(poznamka), paste("poznamka:", poznamka), ""), sep = "\n"),
         nabpozn29 = paste(ifelse(!is.na(zpNabyti), paste("zpNabyti:", zpNabyti), ""),
                           ifelse(!is.na(cenaKR), paste("cenaKR:", cenaKR), ""),
                           ifelse(!is.na(cenaHA), paste("cenaHA:", cenaHA), ""), sep = "\n"),
         text1_88 = ifelse(!is.na(umisteni), umisteni, ""),
         text2_89 = ifelse(!is.na(umisteniCZ), umisteniCZ, ""))

```

df53

pro excel 1953-1979   A L E !!
odfiltrovat 68-79, ktere jsou sumarizovany v dalsim dataframu

```{r}
mysheets <- read_excel_allsheets(paste0(path_kk, "1953-1979.xlsx"))
df53 <- as.data.frame(rbindlist(mysheets, fill = T))
names(df53) <- df53[1,]
names(df53)[16] = "xpozn"
df53 <- df53 %>% filter(is.na(rokPK)|rokPK!="rokPK") # n = 27579 

# filtr roku

df53$rokPK <- as.numeric(df53$rokPK)

df53 <- df53 %>% filter(rokPK %in% 1953:1967)
        
# obecne

df53$prirc <- as.numeric(df53$prirc)

aa <- df53 %>% 
  mutate(podsb2 = podsbirka,
         ozn10 = predmet,
         popis11 = popis,
         rok12 = rokPK,
         pocetks13 = pocetKs,
         text3_90 = jinecislo)

# prirc - DOPRACOVAT

bb <- aa %>% 
  group_by(rokPK) %>% 
  fill(prirc, .direction = "down") %>% 
  group_by(rokPK, prirc) %>%
  mutate(Msub = case_when(n()!=1 ~ seq_along(prirc), TRUE ~ NA),
          porc104 = prirc) %>%
  relocate(Msub, .after = prirc) %>% 
  ungroup() %>% 
  mutate(prirc4 = ifelse(!is.na(prirc), paste0(rokPK, "/", str_pad(prirc, 4, pad = "0")), paste0("format!")),
         Minvc_sin = ifelse(str_detect(invc, "^\\d+$"), invc, ""),
         MinvcOD = ifelse(str_detect(invc, "^\\d+-\\d+$"), gsub("-.*$", "", invc), ""),
         MinvcDO = ifelse(str_detect(invc, "^\\d+-\\d+$"), gsub(".*-", "", invc), ""),
         Minvc_sez = ifelse(str_detect(invc, "\\d,\\s\\d"), gsub(",", ";", invc), "")) %>% 
  relocate(Minvc_sin, .after = invc) %>% 
  relocate(MinvcDO, .after = invc) %>% 
  relocate(MinvcOD, .after = invc) %>% 
  relocate(Minvc_sez, .after = invc)
         
  #        MinvcOD = ifelse(str_detect(invc, "\\d-\\d)"), gsub("-.*$", "", invc), ""),
  #        MinvcDO = ifelse(str_detect(invc, "\\d-\\d)"), gsub(".*-", "", invc), "")) %>% 
  # relocate(MinvcDO, .after = invc) %>% 
  # relocate(MinvcOD, .after = invc)

maxl <- max(nchar(na.omit(df19$poradi)))
maxl

# datum nabyti a vyrazeni - DOPRACOVAT

cc <- bb %>% 
  mutate(Mdat_ser = as.numeric(ifelse(str_detect(datumNabyti, "^.....$"), datumNabyti, NA)),
         Mdat_trans = format(as.Date(Mdat_ser, origin = "1899-12-30"), "%d.%m.%Y"),
         datnab22 = ifelse(str_detect(datumNabyti, "\\d\\.\\d+\\.\\d+\\."), str_remove(datumNabyti, "\\.$"), Mdat_trans)) %>% 
  relocate(datnab22, .after = datumNabyti) %>% 
  mutate(vyrdat64 = str_extract(vyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         vyrdok67 = str_extract(vyrazeni, "MK\\s+\\d+\\/\\d+\\sOM|č.\\s*j.\\s+\\d+\\/\\d+\\sOM|č.\\s*j.\\s+\\d+\\/\\d+.*G|D\\s\\d+\\/\\d+|Kult\\.*\\s\\d+\\/\\d+"),
         vyrdok67 = doklad) %>%  # ktera volba ? -> doklad nevime k cemu se vztahuje, muze to byt i doklad o nabyti atd...
  relocate(vyrazeni, .before = datvyr64)
  
# az bude potvrzeno, pridat k dd.mm. i rok (z pole 'rok')

# puvod - DOPRACOVAT

dd <- cc %>% 
  mutate(puvmaj28 = ifelse(!is.na(puvod), puvod, ""),
         zpnab23 = case_when(str_detect(zpNabyti,"Dar|dar") ~ "D",
                             str_detect(zpNabyti, "onf") ~ "Konf",
                             str_detect(zpNabyti, "Koup|koup") ~ "K",
                             str_detect(zpNabyti, "nález") ~ "N",
                             str_detect(zpNabyti, "ozůstalost") ~ "Poz",
                             str_detect(zpNabyti, "Sběr|sběr") ~ "Sb",
                             TRUE ~ "")) %>% 
  relocate(zpNabyti, .before = zpnab23)

# poznamky

ee <- dd %>%
  mutate(pozn20 = paste(ifelse(!is.na(poznamka), paste("poznamka:", poznamka), ""),
                           ifelse(!is.na(poznamkaCZ), paste("poznamkaCZ:", poznamkaCZ), ""),
                                  sep = "\n"),
         nabpozn29 = paste(ifelse(!is.na(zpNabyti), paste("zpNabyti:", zpNabyti), ""),
                           ifelse(!is.na(cenaKR), paste("cenaKR:", cenaKR), ""),
                           ifelse(!is.na(cenaHA), paste("cenaHA:", cenaHA), ""),
                                  sep = "\n"),
         text1_88 = ifelse(!is.na(umisteni), umisteni, ""),
         text2_89 = ifelse(!is.na(umisteniCZ), umisteniCZ, ""))
```


df68 

pro excel 68-79

```{r}

df68 <- readxl::read_excel(paste0(path_proj, "68-79.xlsx"), sheet = 1, col_types = "text") 

# obecne

df68$prirc <- as.numeric(df68$prirc)

colnames(df68)

aa <- df53 %>% 
  mutate(podsb2 = podsbirka,
         ozn10 = predmet,
         popis11 = popis,
         rok12 = rokPK,
         pocetks13 = pocetKs,
         text3_90 = jinecislo,
         porc104 = prirc)

# prirc - DOPRACOVAT

bb <- aa %>% 
  mutate(prirc4 = ifelse(!is.na(prirc), paste0(rokPK, "/", str_pad(prirc, 4, pad = "0")), paste0("format!")),
         Minvc_sin = ifelse(str_detect(invc, "^\\d+$"), invc, ""),
         MinvcOD = ifelse(str_detect(invc, "^\\d+-\\d+$"), gsub("-.*$", "", invc), ""),
         MinvcDO = ifelse(str_detect(invc, "^\\d+-\\d+$"), gsub(".*-", "", invc), ""),
         Minvc_sez = ifelse(str_detect(invc, "\\d,\\s\\d"), gsub(",", ";", invc), "")) %>% 
  relocate(Minvc_sin, .after = invc) %>% 
  relocate(MinvcDO, .after = invc) %>% 
  relocate(MinvcOD, .after = invc) %>% 
  relocate(Minvc_sez, .after = invc)
         
  #        MinvcOD = ifelse(str_detect(invc, "\\d-\\d)"), gsub("-.*$", "", invc), ""),
  #        MinvcDO = ifelse(str_detect(invc, "\\d-\\d)"), gsub(".*-", "", invc), "")) %>% 
  # relocate(MinvcDO, .after = invc) %>% 
  # relocate(MinvcOD, .after = invc)

# datum nabyti a vyrazeni - DOPRACOVAT

cc <- bb %>% 
  mutate(Mdat_ser = as.numeric(ifelse(str_detect(datumNabyti, "^.....$"), datumNabyti, NA)),
         Mdat_trans = format(as.Date(Mdat_ser, origin = "1899-12-30"), "%d.%m.%Y"),
         datnab22 = ifelse(str_detect(datumNabyti, "\\d\\.\\d+\\.\\d+\\."), str_remove(datumNabyti, "\\.$"), Mdat_trans)) %>% 
  relocate(datnab22, .after = datumNabyti) %>% 
  mutate(datvyr64 = str_extract(vyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         dokvyr67 = str_extract(vyrazeni, "MK\\s+\\d+\\/\\d+\\sOM|č.\\s*j.\\s+\\d+\\/\\d+\\sOM|č.\\s*j.\\s+\\d+\\/\\d+.*G|D\\s\\d+\\/\\d+|Kult\\.*\\s\\d+\\/\\d+"),
         dokvyr67 = doklad) %>%  # ktera volba ? 
  relocate(vyrazeni, .before = datvyr64)
  
# az bude potvrzeno, pridat k dd.mm. i rok (z pole 'rok')

# puvod - DOPRACOVAT

dd <- cc %>% 
  mutate(puvmaj28 = ifelse(!is.na(puvod), puvod, ""),
         zpnab23 = case_when(str_detect(zpNabyti,"Dar|dar") ~ "D",
                             str_detect(zpNabyti, "onf") ~ "Konf",
                             str_detect(zpNabyti, "Koup|koup") ~ "K",
                             str_detect(zpNabyti, "nález") ~ "N",
                             str_detect(zpNabyti, "ozůstalost") ~ "Poz",
                             str_detect(zpNabyti, "Sběr|sběr") ~ "Sb",
                             TRUE ~ "")) %>% 
  relocate(zpNabyti, .before = zpnab23)

# poznamky

ee <- dd %>%
  mutate(pozn20 = paste(ifelse(!is.na(poznamka), paste("poznamka:", poznamka), ""),
                        ifelse(!is.na(poznamkaCZ), paste("poznamkaCZ:", poznamkaCZ), ""),
                                  sep = "\n"),
         nabpozn29 = paste(ifelse(!is.na(zpNabyti), paste("zpNabyti:", zpNabyti), ""),
                           ifelse(!is.na(cenaKR), paste("cenaKR:", cenaKR), ""),
                           ifelse(!is.na(cenaHA), paste("cenaHA:", cenaHA), ""),
                                  sep = "\n"),
         text1_88 = ifelse(!is.na(umisteni), umisteni, ""),
         text2_89 = ifelse(!is.na(umisteniCZ), umisteniCZ, ""))
```


df80

pro excel 1980-1999

```{r}

df80 <- readxl::read_excel(paste0(path_proj, "68-79.xlsx"), sheet = 1, col_types = "text") 

# obecne

df80$prirc <- as.numeric(df68$prirc)

colnames(df80)

aa <- df80 %>% 
  mutate(podsb2 = podsbirka,
         ozn10 = predmet,
         popis11 = popis,
         rok12 = rokPK,
         pocetks13 = pocetKs,
         text3_90 = jinecislo,
         porc104 = prirc)

# prirc - DOPRACOVAT

bb <- aa %>% 
  mutate(prirc4 = ifelse(!is.na(prirc), paste0(rokPK, "/", str_pad(prirc, 4, pad = "0")), paste0("format!")),
         Minvc_sin = ifelse(str_detect(invc, "^\\d+$"), invc, ""),
         MinvcOD = ifelse(str_detect(invc, "^\\d+-\\d+$"), gsub("-.*$", "", invc), ""),
         MinvcDO = ifelse(str_detect(invc, "^\\d+-\\d+$"), gsub(".*-", "", invc), ""),
         Minvc_sez = ifelse(str_detect(invc, "\\d,\\s\\d"), gsub(",", ";", invc), "")) %>% 
  relocate(Minvc_sin, .after = invc) %>% 
  relocate(MinvcDO, .after = invc) %>% 
  relocate(MinvcOD, .after = invc) %>% 
  relocate(Minvc_sez, .after = invc)
         
  #        MinvcOD = ifelse(str_detect(invc, "\\d-\\d)"), gsub("-.*$", "", invc), ""),
  #        MinvcDO = ifelse(str_detect(invc, "\\d-\\d)"), gsub(".*-", "", invc), "")) %>% 
  # relocate(MinvcDO, .after = invc) %>% 
  # relocate(MinvcOD, .after = invc)

# datum nabyti a vyrazeni - DOPRACOVAT

cc <- bb %>% 
  mutate(Mdat_ser = as.numeric(ifelse(str_detect(datumNabyti, "^.....$"), datumNabyti, NA)),
         Mdat_trans = format(as.Date(Mdat_ser, origin = "1899-12-30"), "%d.%m.%Y"),
         datnab22 = ifelse(str_detect(datumNabyti, "\\d\\.\\d+\\.\\d+\\."), str_remove(datumNabyti, "\\.$"), Mdat_trans)) %>% 
  relocate(datnab22, .after = datumNabyti) %>% 
  mutate(datvyr64 = str_extract(vyrazeni, "\\d+\\.\\s*\\d+\\.\\s*\\d{4}"),
         dokvyr67 = str_extract(vyrazeni, "MK\\s+\\d+\\/\\d+\\sOM|č.\\s*j.\\s+\\d+\\/\\d+\\sOM|č.\\s*j.\\s+\\d+\\/\\d+.*G|D\\s\\d+\\/\\d+|Kult\\.*\\s\\d+\\/\\d+"),
         dokvyr67 = doklad) %>%  # ktera volba ? 
  relocate(vyrazeni, .before = datvyr64)
  
# az bude potvrzeno, pridat k dd.mm. i rok (z pole 'rok')

# puvod - DOPRACOVAT

dd <- cc %>% 
  mutate(puvmaj28 = ifelse(!is.na(puvod), puvod, ""),
         zpnab23 = case_when(str_detect(zpNabyti,"Dar|dar") ~ "D",
                             str_detect(zpNabyti, "onf") ~ "Konf",
                             str_detect(zpNabyti, "Koup|koup") ~ "K",
                             str_detect(zpNabyti, "nález") ~ "N",
                             str_detect(zpNabyti, "ozůstalost") ~ "Poz",
                             str_detect(zpNabyti, "Sběr|sběr") ~ "Sb",
                             TRUE ~ ""),
         cennab27 = ifelse(str_detect(zpNabyti,"Koup|koup"), str_extract(zpNabyti, "\\d+,-"), "")) %>% 
  relocate(zpNabyti, .before = zpnab23)

# poznamky

ee <- dd %>%
  mutate(pozn20 = paste(ifelse(!is.na(poznamka), paste("poznamka:", poznamka), ""),
                        ifelse(!is.na(poznamkaCZ), paste("poznamkaCZ:", poznamkaCZ), ""),
                                  sep = "\n"),
         nabpozn29 = paste(ifelse(!is.na(zpNabyti), paste("zpNabyti:", zpNabyti), ""),
                           ifelse(!is.na(cenaKR), paste("cenaKR:", cenaKR), ""),
                           ifelse(!is.na(cenaHA), paste("cenaHA:", cenaHA), ""),
                                  sep = "\n"),
         text1_88 = ifelse(!is.na(umisteni), umisteni, ""),
         text2_89 = ifelse(!is.na(umisteniCZ), umisteniCZ, ""))
```

df20 ok

pro excel 20xx

```{r}

# read 

mysheets <- read_excel_allsheets(paste0(path_kk, "20xx.xlsx")) # specifikuj excel file
df20 <- as.data.frame(rbindlist(mysheets))
names(df20) <- df20[1,] # nacitame bez hlavicky -> nastaveni prvniho radku jako hlavicky
df20 <- df20 %>% filter(is.na(poradi)|poradi!="poradi") # n = 11689 -> vymaze vsechny radky, ktere jsou hlavicky puvodnich listu

# obecne

aa <- df20 %>% 
  mutate(prirc4 = prirc,
         ozn10 = predmet,
         rok12 = rokPK,
         pocetks13 = pocetKs,
         text3_90 = jinecislo)

# prirc - DOPRACOVAT

aa$poradi <- as.numeric(aa$poradi)

bb <- aa %>% 
  mutate(popis11 = popis,
         porc104 = ifelse(!is.na(poradi), poradi, str_extract(prirc, "\\d+")))

# datum nabyti a vyrazeni - DOPRACOVAT

cc <- bb %>% 
  mutate(Mdat_ser = as.numeric(ifelse(str_detect(datumNabyti, "^.....$"), datumNabyti, NA)),
         Mdat_trans = format(as.Date(Mdat_ser, origin = "1899-12-30"), "%d.%m.%Y"),
         Mdat_right = ifelse(str_detect(datumNabyti, "^\\d+\\.\\d+\\.\\d\\d\\d\\d$"), datumNabyti, NA),
         datnab22 = coalesce(Mdat_right, Mdat_trans)) %>% 
  relocate(datnab22, .after = datumNabyti) %>% 
  mutate(vyrdat64 = str_extract(vyrazeni, "\\d{2}\\.\\d+\\.\\d{4}"),
         vyrdok67 = str_extract(vyrazeni, "MK\\s+\\d+\\/\\d+\\sOM|č.j.\\s+\\d+\\/\\d+\\sOM|JCM\\s+\\d+\\/\\d+"))
         
         
check <- cc %>% select(vyrazeni, datvyr64, duvvyr65)
rm(check)
  
# az bude potvrzeno, pridat k dd.mm. i rok (z pole 'rok')

# puvod - DOPRACOVAT

dd <- cc %>% 
  mutate(puvmaj28 = ifelse(!is.na(puvod), puvod, ""),
         predchmaj28 = ifelse(!is.na(puvod), puvod, ""),
         zpnab23 = case_when(str_detect(zpNabyti, "dar|dary|Dar") ~ "D",
                             str_detect(zpNabyti, "Foto") ~ "F",
                             str_detect(zpNabyti, "kopie") ~ "Kp",
                             str_detect(zpNabyti, "koupě|nákup|Nákup") ~ "K",
                             str_detect(zpNabyti, "nález") ~ "N",
                             str_detect(zpNabyti, "odevzdaný nález") ~ "On",
                             str_detect(zpNabyti, "preparace") ~ "Pr",
                             str_detect(zpNabyti, "převod|Převod") ~ "P",
                             str_detect(zpNabyti, "sběr|Sběr") ~ "S",
                             str_detect(zpNabyti, "staré fondy") ~ "SF",
                             str_detect(zpNabyti, "výzkum|Průzkum") ~ "V",
                             str_detect(zpNabyti, "vlastní činnost") ~ "VC",
                             TRUE ~ NA))

# poznamky

ee <- dd %>%
  mutate(pozn20 = paste(ifelse(!is.na(poznamka), paste("poznamka:", poznamka), ""),
                           ifelse(!is.na(poznamkaCZ), paste("poznamkaCZ:", poznamkaCZ), ""),
                                  sep = "\n"),
         nabpozn29 = paste(ifelse(!is.na(cenaKR), paste("cenaKR:", cenaKR), ""),
                           ifelse(!is.na(cenaHA), paste("cenaHA:", cenaHA), ""),
                                  sep = "\n"),
         text1_88 = ifelse(!is.na(umisteni), umisteni, ""),
         text2_89 = ifelse(!is.na(umisteniCZ), umisteniCZ, ""))

```


# not actual


```{r}

# coltypes

df$datum <- ifelse(str_detect(df$datum, "\\d+\\/\\d+\\s....$"), gsub("\\/|\\s", ".", df$datum) , df$datum) 
df$datum <- ifelse(str_detect(df$datum, "\\d+\\/\\d+"), gsub("\\/", ".", df$datum) , df$datum) 
df$datum <- ifelse(str_detect(df$datum, "\\sbis\\s"), df$datum, gsub("\\s", "", df$datum)) 
df$datum <- ifelse(str_detect(df$datum, "^\\d+\\.\\d+$"), paste0(df$datum, "."), df$datum) 

library(anytime) 
df$datum <- anydate(df$datum) # nic moc

# format(as.Date(df$datum, format="%d/%m/%Y"), "%d/%m/%y")

```

# 1st round
## EDA

```{r}

Lxls <- list.files(path_data, pattern = "*.xlsx")  # Identify file names

Lxls <- "M:/03 klienti/kraj jihocesky/jihoceske muzeum v ceskych budejovicich - JMCB/03 migrace/jmcb migrace 2023/zdrojdat/1916.xlsx"

eda <- data.frame()

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

for(i in Lxls) {
  a <- read_excel(paste0(path_data, i),
              sheet = 1, col_names=FALSE,
              range = cell_cols("A:P")) %>% 
       slice(2)
  a$zdroj <- paste(i) # add source txt file name
  # print(count(a))
  eda <- rbind(eda, a)
  print(i)
  # rm(a)
}

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

a <- read_excel("M:/03 klienti/kraj jihocesky/jihoceske muzeum v ceskych budejovicich - JMCB/03 migrace/jmcb migrace 2023/zdrojdat/1916.xlsx",
              sheet = 1, col_names=FALSE)
       #        range = cell_cols("A:P")) %>% 
       # slice(2)

```

## LOAD CES TXT LOOP

```{r LOAD CES TXT LOOP , warning = F}

df_filled <- data.frame()

colnam <- c("prirc","rok_prir","dat_nabyt", "sign","invc", 
            "predmet",  "char_pop", "pocet_ks", "zp_nabyt", "doklad",
            "puvod_ptu","odp","rok_reviz","podsb", "jinec", "pozn_okr") # n = 16


# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

for(i in Lxls) { # Lxls from EDA
  a <- readxl::read_xlsx(paste0(path_data, i),
              sheet = 1,
              skip = 1,
              col_types = c("text")) # nefuguje -> prevadi na datum vsechna pole
              # col_types = c("text", "text", "date", "text","text",
              #               "text", "text", "text", "text", "text", 
              #               "text", "text", "text", "text", "text"))
  # names(a) <- colnam
  a$zdroj <- paste(i) # add source txt file name
  # print(count(a))
  # df_filled <- rbind(df_filled, a)
 
  df_filled <- bind_rows(df_filled, a)
  print(i)
  # rm(a)
}

df_filled$`Datum nabytí` <- as.Date.character(df_filled$`Datum nabytí`) 

# install.packages("anytime")   # Install anytime package
# library("anytime") 
# df_filled$`Datum nabytí` <- anydate(df_filled$`Datum nabytí`) # nope


# ? kdyz vyuziju skip = 1, nacita se datum ve spravnem formatu, ale nejsem schopna nacist sloupce A:P
# ? kdyz vyuziju cell_colls, nefunguje skip a datum se nacita blbe

install.packages("XLConnect")
require(XLConnect)

for(i in Lxls) {
  a <- readxl::read_excel(paste0(path_data, i),
              sheet = 1,
              skip = 1) 
              # col_types = c("text"))
  # names(a) <- colnam
  a$zdroj <- paste(i) # add source txt file name
  # print(count(a))
  df_filled <- bind_rows(df_filled, a)
  print(i)
  # rm(a)
}

a <- readxl::read_excel(paste0(path_data, "1987 (Z).xlsx"),
              sheet = 1,
              skip = 1,
              col_types = c("text", "text", "date", "text","text",
                            "text", "text", "text", "text", "text", 
                            "text", "text", "text", "text", "text")) 

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# CHECK AND CLEAR ENVIRONMENT

print(count(df_filled))
rm(i)
rm(colnam)
rm(Lxls)


# SAVE COMBINED XLS


f2s <- paste0(path_kk, proj, "_allXLSX.csv")

if(file.exists(f2s)){
  print("You've been here before.")
  rm(f2s)
} else {
  write.table(df_filled, file = f2s, 
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="cp1250")
  rm(f2s)
  print("File saved!")
  }

# rm(df_filled)
# 
```

..
()

