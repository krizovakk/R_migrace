---
title: "Kontrola CES × MUSEION"
subtitle: "zjištěný stav k"
date: "`r Sys.Date()`"
author: "Katerina Krizova"
output:
  pdf_document
    toc: true
    toc_depth: 2
    number_sections: false
    fig_caption: true
  fontsize: 11pt
  geometry: margin=1in

---

\newpage 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=FALSE, fig.dim = c(8, 4))

# PACKAGES

# install.packages("tidyverse", dependencies = T)
# install.packages("readxl")
# install.packages("stringr")
# install.packages("stringi")
# install.packages("mdbr")
# install.packages("RODBC")
# install.packages("odbc")
# install.packages("xlsx")
require(tidyverse)
require(readxl)
require(xlsx) # write excel in sheets
require(stringr) # ::str_split_fixed
require(stringi) # ::stri_detect_fixed - detect empty string
require(mdbr) # ::read_mdb
require(RODBC) # ::read_mdb
require(odbc) # ::read_mdb

```

\newpage 

# PATHS AND PROJ INFO

```{r}

path_ces <- "C:/Users/krizova/Documents/R/CES/"
# path_proj <- "M:/03 klienti/kraj ustecky/galerie moderniho umeni v roudnici nad labem - GMUR/gmur_ces/"
path_proj <- "M:/03 klienti/kraj ustecky/oblastni muzeum v chomutove, p. o. - OMCV/omcv_ces/"

# proj <- "GMUR"
proj <- "OMCV"

if(proj == "GMUR"){
  path_proj <- "M:/03 klienti/kraj ustecky/galerie moderniho umeni v roudnici nad labem - GMUR/gmur_ces/"
} else if(proj == "OMCV"){
  path_proj <- "M:/03 klienti/kraj ustecky/oblastni muzeum v chomutove, p. o. - OMCV/omcv_ces/"
} else{
  print("No project found!")
}

```

# LOAD CES TXT LOOP

1.sloupec = Změna {N = nove, platne; V = vyrazeni; R = ruseni}
2.sloupec = Duvod (pro N vypusteno)
            V {N = neupotrebitelnost; P = prebytecnost; R = rozepsani; O = omyl}
            R {C = chyba; Z = zmena cislovani}
3. sloupec = typ cisla {P = prirustkove; I = inventarni}
            
```{r LOAD CES TXT ONE BY ONE, warning = F, eval = F}

# TEST

gra <- read.table(paste0(path_ces, proj, "/Další_-_Grafiky.txt"),
                   header = F, sep = ";", fill = T, check.names = F, fileEncoding="cp1250", skip = 4)
kre <- read.table(paste0(path_ces, proj, "/Další_-_Kresby.txt"),
                   header = F, sep = ";", fill = T, check.names = F, fileEncoding="cp1250", skip = 4)
obr <- read.table(paste0(path_ces, proj, "/Další_-_Obrazy.txt"),
                   header = F, sep = ";", fill = T, check.names = F, fileEncoding="cp1250", skip = 4)
soc <- read.table(paste0(path_ces, proj, "/Další_-_Sochy.txt"),
                   header = F, sep = ";", fill = T, check.names = F, fileEncoding="cp1250", skip = 4)
uum <- read.table(paste0(path_ces, proj, "/Další_-_Užité_umění.txt"),
                   header = F, sep = ";", fill = T, check.names = F, fileEncoding="cp1250", skip = 4)
```


```{r LOAD CES TXT LOOP , warning = F}

# FUNKCNI SMYCKA PRO NACITANI CES EXPORTNICH TXT 

# Ltxt <- list.files(paste0(path_ces, proj), pattern = "*.txt")  # Identify file names
Ltxt <- list.files(paste0(path_proj, "CES"), pattern = "*.txt")  # Identify file names
df_filled <- data.frame()
colnam <- c("zmena","duvod","typ_cisla","cislo",
                "s5","s6", "s7", "s8",
                "s9","s10","s11","s12")
    
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

for(i in Ltxt) {
  a <- read.table(paste0(path_proj, "CES/", i),
                  skip = 4, header = F, sep = ";", fill = T, 
                  check.names = F, fileEncoding="cp1250")
  names(a) <- colnam
  rows_to_change <- a$zmena == "N"
  a[rows_to_change,3:12] <- a[rows_to_change,2:12] # shitf columns with N
  a[rows_to_change,2] <- NA
  a$zdroj <- paste(i) # add source txt file name
  a <- a %>% filter(str_detect(zmena, ("^N$|^V$|^R$")))  # filter only relevant rows !!!
  # print(unique(a$zdroj))
  print(count(a))
  df_filled <- rbind(df_filled,a)
}

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


# CHECK AND CLEAR ENVIRONMENT

print(count(df_filled))
rm(a)
rm(i)
rm(colnam)
rm(Ltxt)
rm(rows_to_change)

# SAVE COMBINED TXT

# exi <- paste0(path_ces, proj, "/", proj, "_allTXT.csv")
# 
# if(file.exists(exi)){
#   print("File already exists !!!")
# } else {
#   f2s = exi
#   rm(exi)
#   }

f2s <- paste0(path_ces, proj, "/", proj, "_allTXT.csv")

if(file.exists(f2s)){
  print("TXT already saved")
  rm(f2s)
} else {
  write.table(df_filled, file = f2s, 
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="cp1250")
  rm(f2s)
  }

```

## Check CES txt

```{r CES PROCESSING}

ces <- df_filled %>% discard(~all(is.na(.) | . == "")) # drop empy columns
ces[ces == ""] <- NA

sort(unique(ces$zmena))
sort(unique(ces$duvod))
sort(unique(ces$typ_cisla))

# dupl <- ces %>% group_by(cislo) %>% 
#   filter(n() != 1)

ic <- ces %>% filter(typ_cisla == "I") 
pr <- ces %>% filter(typ_cisla == "P") 

count(ic)+count(pr) == count(ces) # TRUE or FALSE

```

# GMUR

## CES INVC

### Modify ces_ic

```{r}

sort(unique(ic$zdroj))

ces_ic <- ic %>% 
  # separate(cislo, into=c("rada", "num") , sep=" ", extra = "merge", remove = F)
  mutate(Mrada = str_extract(cislo, "[:alpha:]"),
         Mcislo = str_extract(cislo, "[:digit:]+"),
         Mcislo_0 = str_pad(Mcislo, 5, pad = "0")) 

sort(unique(ces_ic$Mrada))

  unite(MINVC, c(Mrada, Mcislo_0), sep = "", na.rm = T, remove = F) 
  select(zdroj, typ_cisla, cislo, zmena, duvod, MINVC)


# CHECK !!! IMPORTANT !!!
 
sum(is.na(ces_ic$zmena)) 
sum(is.na(ces_ic$duvod)) # pocet NA by mel sedet s poctem N
sum(is.na(ces_ic$duvod)) == sum(ces_ic$zmena == "N")
sum(is.na(ces_ic$typ_cisla)) 
sum(is.na(ces_ic$cislo)) 
sum(is.na(ces_ic$MINVC)) 

SAVE0 <- ces_ic
```

### Load and check MUS

```{r}

mus_ic <- read_excel(paste0(path_gmur, "MUSEION/gmur_exportCES_KAT.xlsx"), 
                  sheet = 1, col_types="text") %>% 
  filter(kod != "A") %>% # !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! JEN PRO GMUR !!!!!!!!!!!
  mutate(id = floor(as.numeric(id)),
         sp_porcislo = trunc(as.numeric(sp_porcislo)))
```

### Pair CES+MUS

```{r}

rel0 <- full_join(ces_ic, mus_ic, by = c("MINVC" = "sp_cislo"), keep = T) %>% 
  select(-sp_porcislo, -sp_porcislosub, -sp_porcislodo, -sp_porcislosub_1, -kod) %>% 
  rename(CEScislo = cislo.x, cislo_podsb = cislo.y)
```

### Sparovano 

```{r}

pair <- rel0 %>% filter(!is.na(sp_cislo)&!is.na(MINVC)) %>% mutate(status = "sparovano") 

```

### Duplicity

```{r}

dupl <- pair %>% group_by(MINVC) %>% filter(n() != 1) %>% mutate(popis_chyby = "duplicitni cislo CES")
# -> check what nature are the duplicates
# -> if relevant, keep them in 'pair'
# -> if not, delete them from 'pair', store in 'duplicates' sheet

# GMUR: duplicates are relevant -> KEEP

# SAVE 

SAVE1 <- pair
SAVE2 <- dupl
```

### Nesparovano MUS-ne

```{r}

pair_not_MUS <- rel0 %>% filter(is.na(sp_cislo)) %>% mutate(status = "nenalezeno v MUSEIONU") 
SAVE3 <- pair_not_MUS
```

### Nesparovano CES-ne

```{r}

pair_not_CES <- rel0 %>% filter(is.na(MINVC)) %>% mutate(status = "nenalezeno ve vypisu z CES") 
SAVE4 <- pair_not_CES

# CHECK

count(pair)+count(pair_not_MUS)+count(pair_not_CES) == count(rel0) # TRUE or FALSE
```

### Chyby

### Export XLS

```{r}

SAVE1[is.na(SAVE1)] <- ""
SAVE2[is.na(SAVE2)] <- ""
SAVE3[is.na(SAVE3)] <- ""
SAVE4[is.na(SAVE4)] <- ""
SAVE0[is.na(SAVE0)] <- ""

exi <- paste0(path_ces, proj, "/", proj, "_KAT.xlsx")

if(file.exists(exi)){
  print("File already exists !!!")
} else {
  f2s = exi
  write.xlsx(as.data.frame(SAVE1), file= f2s, sheetName="sparovano", row.names=FALSE)
  write.xlsx(as.data.frame(SAVE2), file= f2s, sheetName="duplicity", append=TRUE, row.names=FALSE)
  write.xlsx(as.data.frame(SAVE3), file= f2s, sheetName="nesparovanoMUS", append=TRUE, row.names=FALSE)
  write.xlsx(as.data.frame(SAVE4), file= f2s, sheetName="nesparovanoCES", append=TRUE, row.names=FALSE)
  write.xlsx(as.data.frame(SAVE0), file= f2s, sheetName="puv. vypis CES", append=TRUE, row.names=FALSE)
  rm(exi)
  rm(f2s)
  }

```

### Report CES invc

```{r}

# table1 
sort(unique(ces$zdroj))
sort(unique(mus_ic$nazev))

# table2
pair$zdroj <- as.factor(pair$zdroj)
summary(pair) 

# table3
# table 4


```


## CES PRIRC

```{r eval = F}

pr <- ces_pr %>% 
  mutate(Mrok = sub(".*/", "", cislo),
         Mcislo = sub("/.*", "", cislo),
         Mcislo_0 = str_pad(Mcislo, 3, pad = "0"))  %>% 
  unite(MPRIRC, c(Mcislo_0, Mrok), sep = "/", na.rm = T, remove = F) %>% 
  select(zdroj, typ_cisla, cislo, zmena, duvod, MPRIRC)

# CHECK !!! IMPORTANT !!!

sum(is.na(ces_pr$zmena)) 
sum(is.na(ces_pr$duvod)) # pocet NA by mel sedet s poctem N
sum(is.na(ces_pr$duvod)) == sum(ces_pr$zmena == "N")
sum(is.na(ces_pr$typ_cisla)) 
sum(is.na(ces_pr$cislo)) 
sum(is.na(ces_pr$MINVC)) 

dupli <- ces_pr %>% group_by(MPRIRC) %>% filter(n() != 1) %>% 
  mutate(popis_chyby = "duplicitni cislo CES")  
  
clear <- ces_pr %>% group_by(MPRIRC) %>% filter(n() == 1)

# chyby kontrolovat rucne a rucne nastavit podminky pro nestandardni formaty
chyby <- ces_pr %>% filter(str_detect(cislo, ".*/.*")) %>% 
  mutate(popis_chyby = "neni cislo CES ?") 

# LOAD MUSEION

mus_pr <- read_excel(paste0(path_gmur, "MUSEION/gmur_exportCES_PK.xlsx"), 
                  sheet = 1, col_types="text") %>% 
  mutate(id = floor(as.numeric(id)),
         id =  as.character(id),
         poradovecislo = trunc(as.numeric(poradovecislo)),
         poradovecislo = as.character(poradovecislo))

# P A I R

rel <- left_join(clear, mus_pr, by = c("MPRIRC" = "cislo"), keep = T) %>% 
  select(-poradovecislo, -poradovecislosub, -cislo_1, -kod)

pair <- rel %>% filter(!is.na(cislo.y)) %>% mutate(status = "sparovano") 
pair_not <- rel %>% filter(is.na(cislo.y)) %>% 
  mutate(popis_chyby = "nenalezeno v MUSEIONU")

# EXPORT XLSX

SAVE1 <- pair
SAVE2 <- pair_not
# SAVE3 <- dupli
# SAVE4 <- chyby
SAVE0 <- ces_pr

SAVE1[is.na(SAVE1)] <- ""
SAVE2[is.na(SAVE2)] <- ""
# SAVE3[is.na(SAVE3)] <- ""
# SAVE4[is.na(SAVE4)] <- ""
SAVE0[is.na(SAVE0)] <- ""

f2s <- paste0(path_ces, proj, "/", proj, "_PK.xlsx")

write.xlsx(as.data.frame(SAVE1), file= f2s, sheetName="sparovano", row.names=FALSE)
write.xlsx(as.data.frame(SAVE2), file= f2s, sheetName="nesparovano", append=TRUE, row.names=FALSE)
# write.xlsx(as.data.frame(SAVE3), file= f2s, sheetName="dupicity", append=TRUE, row.names=FALSE)
# write.xlsx(as.data.frame(SAVE4), file= f2s, sheetName="chyby", append=TRUE, row.names=FALSE)
write.xlsx(as.data.frame(SAVE0), file= f2s, sheetName="puv. vypis CES", append=TRUE, row.names=FALSE)
```

### Modify ces_ic

```{r}

ces_pr <- pr %>% 
  mutate(Mrok = sub(".*/", "", cislo),
         Mcislo = sub("/.*", "", cislo),
         Mcislo_0 = str_pad(Mcislo, 3, pad = "0"))  %>% 
  unite(MPRIRC, c(Mcislo_0, Mrok), sep = "/", na.rm = T, remove = F) %>% 
  select(zdroj, typ_cisla, cislo, zmena, duvod, MPRIRC)

# CHECK !!! IMPORTANT !!!

sum(is.na(ces_pr$zmena)) 
sum(is.na(ces_pr$duvod)) # pocet NA by mel sedet s poctem N
sum(is.na(ces_pr$duvod)) == sum(ces_pr$zmena == "N")
sum(is.na(ces_pr$typ_cisla)) 
sum(is.na(ces_pr$cislo)) 
sum(is.na(ces_pr$MINVC)) 

SAVE0 <- ces_pr
```

### Load and check MUS

```{r}

mus_pr <- read_excel(paste0(path_gmur, "MUSEION/gmur_exportCES_PK.xlsx"), 
                  sheet = 1, col_types="text") %>% 
  mutate(id = floor(as.numeric(id)),
         id =  as.character(id),
         poradovecislo = trunc(as.numeric(poradovecislo)),
         poradovecislo = as.character(poradovecislo))

```

### Pair CES+MUS

```{r}

rel0 <- full_join(ces_pr, mus_pr, by = c("MPRIRC" = "cislo"), keep = T) %>% 
 select(-poradovecislo, -poradovecislosub, -kod) %>% 
  rename(CEScislo = cislo.x, 
         MUScislo = cislo.y, 
         cislo_podsb = cislo_1)
```

### Sparovano 

```{r}

pair <- rel0 %>% filter(!is.na(MUS_cislo)&!is.na(MPRIRC)) %>% mutate(status = "sparovano") 

```

### Duplicity

```{r}

dupl <- pair %>% group_by(MPRIRC) %>% filter(n() != 1) %>% mutate(popis_chyby = "duplicitni cislo CES")
# -> check what nature are the duplicates
# -> if relevant, keep them in 'pair'
# -> if not, delete them from 'pair', store in 'duplicates' sheet

# GMUR: duplicates are relevant -> KEEP

# SAVE 

SAVE1 <- pair
SAVE2 <- dupl
```

### Nesparovano MUS-ne

```{r}

pair_not_MUS <- rel0 %>% filter(is.na(MUS_cislo)) %>% mutate(status = "nenalezeno v MUSEIONU") 
SAVE3 <- pair_not_MUS
```

### Nesparovano CES-ne

```{r}

pair_not_CES <- rel0 %>% filter(is.na(MPRIRC)) %>% mutate(status = "nenalezeno ve vypisu z CES") 
SAVE4 <- pair_not_CES

# CHECK

count(pair)+count(pair_not_MUS)+count(pair_not_CES) == count(rel0) # TRUE or FALSE
```

### Chyby

### Export XLS

```{r}

SAVE1[is.na(SAVE1)] <- ""
SAVE2[is.na(SAVE2)] <- ""
SAVE3[is.na(SAVE3)] <- ""
SAVE4[is.na(SAVE4)] <- ""
SAVE0[is.na(SAVE0)] <- ""

exi <- paste0(path_ces, proj, "/", proj, "_PK.xlsx")

if(file.exists(exi)){
  print("File already exists !!!")
} else {
  f2s = exi
  write.xlsx(as.data.frame(SAVE1), file= f2s, sheetName="sparovano", row.names=FALSE)
  write.xlsx(as.data.frame(SAVE2), file= f2s, sheetName="duplicity", append=TRUE, row.names=FALSE)
  write.xlsx(as.data.frame(SAVE3), file= f2s, sheetName="nesparovanoMUS", append=TRUE, row.names=FALSE)
  write.xlsx(as.data.frame(SAVE4), file= f2s, sheetName="nesparovanoCES", append=TRUE, row.names=FALSE)
  write.xlsx(as.data.frame(SAVE0), file= f2s, sheetName="puv. vypis CES", append=TRUE, row.names=FALSE)
  rm(exi)
  rm(f2s)
  }

```

### Report CES prirc

```{r}

# table1 
sort(unique(ces$zdroj))
sort(unique(mus_pr$nazev))
ces_pr$zdroj <- as.factor(ces_pr$zdroj)
summary(ces_pr) 

# table2
pair$zdroj <- as.factor(pair$zdroj)
summary(pair) 

# table3
# table 4
```

# OMCV

## CES INVC

### Modify ces_ic

```{r}

petky <- c("B", "CV-N", "CV-S", "G", "K-N", "K-S", "Li", "M", "pB", "pCV-N", "pG", 
           "pK-N", "pLi", "pM", "pMO", "pT", "T") 
ctyrky <- c("B-sken", "C", "CK", "Dt", "Eg", "Et", "F", "Fa", "H", "IT", "La", "Le", 
            "Li-sken", "Mi","M-sken", "MT", "MTč", "N", "NDa", "NDo", "NDp", "NDvz", 
            "Ng", "Ng-f", "Nu", "O", "Ok", "P", "Pc", "Pc-K", "Pl", "Plk", "pom", 
            "PS", "PS-kn", "PS-ko", "PS-kr", "PS-pr", "PS-v", "R", "S", "S-K", "ST", 
            "TR", "T-sken", "Tx", "ZM")

trojky <- "Rš"

# CCV, L -> nejsou vubec

ces_ic <- ic %>%
  mutate(Mrada_patt = case_when(
    str_detect(cislo, "^[:alpha:]{2}\\s\\d+") ~ str_extract(cislo, "^[:alpha:]{2}"), # Ng 5
    str_detect(cislo, "^[:alpha:]{2}\\s[:alpha:]+\\s\\d+") ~ str_extract(cislo, "^[:alpha:]{2}\\s[:alpha:]+"), # "Pl CV" "Pl K" 
    str_detect(cislo, "\\w+-\\w+\\s.*") ~ str_extract(cislo, "\\w+-\\w+"), # "K-S", "CV-N"
    str_detect(cislo, "^[:upper:]\\s\\d+") ~ str_extract(cislo, "^[:upper:]"), # B 10
    str_detect(cislo, "^[:upper:]\\s[:upper:]+.*") ~ str_extract(cislo, "^[:upper:]\\s[:upper:]+"), # C CV
    str_detect(cislo, "^[:upper:]{2}\\s\\w\\s\\d+") ~ str_extract(cislo, "^[:upper:]{2}\\s\\w"), # ND o 110
    str_detect(cislo, "^[:upper:]\\d+") ~ str_extract(cislo,"^[:upper:]"), # O2703
    TRUE ~ "chybny format invc"),
    Mrada_edit = case_when(str_detect(cislo, "^Li.*") ~ "Li",
                           str_detect(cislo, "^PcK.*") ~ "Pc-K",
                           str_detect(cislo, "^Pc K.*") ~ "Pc-K",
                           str_detect(cislo, "^s Cv\\s\\d+") ~ "S CV",
                           str_detect(cislo, "^s\\s\\d+") ~ "S",
                           str_detect(cislo, "^Et\\d+") ~ "Et",
                           str_detect(cislo, "^MTč\\d+") ~ "MTč",
                           str_detect(cislo, "CV - N") ~ "CV-N",
                           str_detect(Mrada_patt, "PS") ~ str_replace(Mrada_patt, "PS", "Ps"),
                           str_detect(Mrada_patt, "CK") ~ "Ck",
                           str_detect(Mrada_patt, "LE") ~ "Le",
                           str_detect(Mrada_patt, "Mt") ~ "MT",
                           str_detect(Mrada_patt, "Pl K") ~ "Plk",
                           str_detect(Mrada_patt, "Rš") ~ "Rs",
                           str_detect(Mrada_patt, "sK") ~ "S-K",
                           TRUE ~ Mrada_patt),
    Mrada = gsub(" ", "", Mrada_edit),
    Mcislo = case_when(
      str_detect(cislo, "\\d+\\/.+") ~ str_extract(cislo, "\\d+\\/.+"), # Ng 5)
      str_detect(cislo, "\\d+") ~ str_extract(cislo, "\\d+"), # Ng 5)
      TRUE ~ "chybny format invc"),
    Mcislo_0 = case_when(Mrada %in% trojky ~ str_pad(Mcislo, 3, pad = "0"),
                         Mrada %in% ctyrky ~ str_pad(Mcislo, 4, pad = "0"),
                         Mrada %in% petky ~ str_pad(Mcislo, 5, pad = "0"),
                         TRUE ~ Mcislo),
    Msubc = ifelse(str_detect(Mcislo_0, "\\/.+"), gsub(".+\\/", "", Mcislo_0), NA),
    Mcislo_0 = ifelse(str_detect(Mcislo_0, "\\/.+"), gsub("\\/.+", "", Mcislo_0), Mcislo_0),
    MINVC = ifelse(is.na(Msubc), paste0(Mrada, Mcislo_0), paste0(Mrada, Mcislo_0, "/", Msubc)))


check <- ces_ic %>% select(Mrada_patt, Mrada_edit, Mrada) %>% distinct()

print(sample_n(ces_ic, 10))

# CHECK !!! IMPORTANT !!!
 
sum(is.na(ces_ic$zmena)) 
sum(is.na(ces_ic$duvod)) # pocet NA by mel sedet s poctem N -> chceme TRUE
sum(is.na(ces_ic$duvod)) == sum(ces_ic$zmena == "N") # chceme TRUE
sum(is.na(ces_ic$typ_cisla)) 
sum(is.na(ces_ic$cislo)) 
sum(is.na(ces_ic$MINVC)) 

SAVE0 <- ces_ic
```

### Load and check MUS

```{r, warning = F}

mus_ic <- read_excel(paste0(path_proj, "MUSEION/omcv_exportKAT.xlsx"), 
                  sheet = 1)  
```

### Pair CES+MUS

```{r}

rel0 <- full_join(ces_ic, mus_ic, by = c("MINVC" = "sp_cislo"), keep = T) %>% 
  select(-sp_porcislo, -sp_porcislosub, -sp_porcislodo,-sp_porcislosubdo) 
  
sample_n(rel0, 10)
```

### Sparovano 

```{r}

pair <- rel0 %>% filter(!is.na(sp_cislo)&!is.na(MINVC)) %>% mutate(status = "sparovano") 

```

### Duplicity

```{r}

dupl <- pair %>% group_by(MINVC) %>% filter(n() != 1) %>% mutate(popis_chyby = "duplicitni cislo CES")
# -> check what nature are the duplicates
# -> if relevant, keep them in 'pair'
# -> if not, delete them from 'pair', store in 'duplicates' sheet

# GMUR: duplicates are relevant -> KEEP

# SAVE 

SAVE1 <- pair
SAVE2 <- dupl
```

### Nesparovano MUS-ne

```{r}

pair_not_MUS <- rel0 %>% filter(is.na(sp_cislo)) %>% mutate(status = "nenalezeno v MUSEIONU") 
SAVE3 <- pair_not_MUS
```

### Nesparovano CES-ne

```{r}

pair_not_CES <- rel0 %>% filter(is.na(MINVC)) %>% mutate(status = "nenalezeno ve vypisu z CES") 
SAVE4 <- pair_not_CES

# CHECK

count(pair)+count(pair_not_MUS)+count(pair_not_CES) == count(rel0) # TRUE or FALSE
```

### Chyby

### Export XLS

```{r}

SAVE1[is.na(SAVE1)] <- ""
SAVE2[is.na(SAVE2)] <- ""
SAVE3[is.na(SAVE3)] <- ""
SAVE4[is.na(SAVE4)] <- ""
SAVE0[is.na(SAVE0)] <- ""

exi <- paste0(path_ces, proj, "/", proj, "_KAT.xlsx")

if(file.exists(exi)){
  print("File already exists !!!")
} else {
  f2s = exi
  write.xlsx(as.data.frame(SAVE1), file= f2s, sheetName="sparovano", row.names=FALSE)
  write.xlsx(as.data.frame(SAVE2), file= f2s, sheetName="duplicity", append=TRUE, row.names=FALSE)
  write.xlsx(as.data.frame(SAVE3), file= f2s, sheetName="nesparovanoMUS", append=TRUE, row.names=FALSE)
  write.xlsx(as.data.frame(SAVE4), file= f2s, sheetName="nesparovanoCES", append=TRUE, row.names=FALSE)
  write.xlsx(as.data.frame(SAVE0), file= f2s, sheetName="puv. vypis CES", append=TRUE, row.names=FALSE)
  rm(exi)
  rm(f2s)
  }

```

### Report CES invc

```{r}

# table1 
sort(unique(ces$zdroj))
sort(unique(mus_ic$nazev))

# table2
pair$zdroj <- as.factor(pair$zdroj)
summary(pair) 

# table3
# table 4


```


