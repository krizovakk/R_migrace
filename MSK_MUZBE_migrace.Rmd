---
title: "Moravskoslezsky kraj - Muzeum Beskyd"
subtitle: "Migrace dat"
author: "Katerina Krizova"
date: "`r Sys.Date()`"
output:
  pdf_document
    toc: true
    toc_depth: 2
    number_sections: false
    fig_caption: true
  fontsize: 11pt
  geometry: margin=1in

---

\newpage 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=FALSE, fig.dim = c(8, 4))

# PACKAGES

# install.packages("tidyverse", dependencies = T)
# install.packages("readxl")
# install.packages("stringr")
# install.packages("stringi")
# install.packages("mdbr")
# install.packages("RODBC")
# install.packages("odbc")
# install.packages("xlsx")
require(tidyverse)
require(readxl)
require(stringr) # ::str_split_fixed
require(stringi) # ::stri_detect_fixed - detect empty string
require(mdbr) # ::read_mdb
require(RODBC) # ::read_mdb
require(odbc) # ::read_mdb
require(xlsx) # write excel in sheets
```

\newpage 

# PROJEKT A CESTY

```{r PROJECT SPECIFICATIONS AND PATHS}

projekt <- "MUZBE"

path <-  "C:/Users/krizova/Documents/R/"

path_data <-  paste0(path, "data/")
path_csv <-  paste0(path, "mus_csv/", projekt, "/")

path_muzbe <-  "M:/03 klienti/kraj moravskoslezsky/muzeum beskyd - MUZBE/" # databaze

path_kd <- paste0(path_csv, "KD/") # kontextove dokumenty

```

Akvarely.bf
Botanika aktuální.bf
Quercus Holuša.bf
mechorosty_Vrána.bf

spm = systematicka evidence podsbirky Pm (mechorosty)  
cpm = ciselnik podsbirky Pm (mechorosty)  


# B O T A N I K A

```{r BOTANIKA}

# L O A D

# dbname <- paste0(path_muzbe, "02 muzBE konverze/BIO/muzbeBOT_DK.accdb") 
dbname <- paste0(path_muzbe, "02 muzBE konverze/zdrojdat/BIO/MB_PVO_Botanika/botanika - aktuální.mdb") 
con <- RODBC::odbcConnectAccess2007(dbname)      
bot0 <- RODBC::sqlFetch(con, "data")   

bot1 <- bot0 %>% 
  select(-contains("_sort"), -nvg_id)


# M U S E I O N   E V I D E N C E

bot <- bot1 %>% 
  mutate(MSBIRKA = "MUZBE",
         MPODSB = "Pb",
         MPODSBnaz = "botanika",
         MFOND = "bot",
         MFONDnaz = "botanika",
         MSKUP = "herbT",
         MSKUPnaz = "herbář Tracheophyta",
         X = NA)

rm(bot0)
rm(bot1)

# biolib slovnik pro botaniku

biolib <- read_excel("M:/03 klienti/kraj moravskoslezsky/muzeum beskyd - MUZBE/02 muzBE konverze/muzbe BIO/importDK/slovniky/muzbe_import_Plantae_Taxon.xlsx") 

```

## BOT slovniky

### bot fondy

**IMPORTNÍ ROZHRANNÍ**: CSV Fond
**MUSEION**: import_fond.csv

```{r FONDY}

# M O D I F Y

# C R E A T E    C S V

mus_tab <- bot %>% 
  select(
    '1sbirkaCisloEvidInt' = MSBIRKA,    # !! povinne !!
    '2podsbirkaCislo'= MPODSB,          # !! povinne !!
    '3fondKod' = MFOND,                 # !! povinne !!
    '4nazev'= MFONDnaz,                 # !! povinne !!
    '5poznamka' = X, '6popisPubl'= X,
    '7poradi' = X, '8oaiId'= X,
    '9oaiDatumHarvestingu'= X, '10oaiDatumModifikace' = X) %>% 
  distinct()

oper_fondy <- mus_tab
imp <- "fond"
```

### bot skupiny

**IMPORTNÍ ROZHRANNÍ**: CSV Skupiny
**MUSEION**: import_skupiny.csv

```{r SKUPINY}

# M O D I F Y

# C R E A T E    C S V

mus_tab <- bot %>% 
  select(
    '1sbirkaCisloEvidInt' = MSBIRKA,     # !! povinne !!
    '2podsbirkaCislo'= MPODSB,           # !! povinne !!
    '3fondKod' = MFOND,                  # !! povinne !!
    '4skupinaKod'= MSKUP,                # !! povinne !! max 20 znaků
    '5nazev' = MSKUPnaz,                 # !! povinne !!
    '6poznamka'= X,
    '7popisPubli' = X, '8poradi'= X,
    '9oaiId'= X, '10oaiDatumHarvestingu'= X, 
    '11oaiDatumModifikace' = X) %>% 
  distinct()

oper_skupiny <- mus_tab
imp <- "skupiny"

```

### bot podskupiny

**IMPORTNÍ ROZHRANNÍ**: CSV Podskupiny
**MUSEION**: import_podskupiny.csv

```{r PODSKUPINY}

# M O D I F Y

modify_tab <- bot %>% 
  mutate(MPODSKUP = substr(sub("\\s", "", pskup), 1,20), # smazat mezeru, orezat na 20 znaku
         # MPODSKUP = substr(pskup, 1,20), 
         Mpskp_len = nchar(pskup), 
         MPODSKUPNAZ = pskup, 
         X = "")

# C R E A T E    C S V

mus_tab <- modify_tab %>% 
  select('1sbirkaCisloEvidInt' = MSBIRKA,      # !! povinne !!
    '2podsbirkaCislo'= MPODSB,                 # !! povinne !!
    '3fondKod' = MFOND,                        # !! povinne !!
    '4skupinaKod'= MSKUP,                      # !! povinne !!
    '5podskupina1Kod' = MPODSKUP,              # !! povinne !! max 20 znaku, zkracovat
    '6nazev'= MPODSKUPNAZ,
    '7poznamka'= X,
    '8popisPubli' = X, '9poradi'= X,
    '10oaiId'= X, '11oaiDatumHarvestingu'= X, 
    '12oaiDatumModifikace' = X) %>% 
  distinct()

oper_podskupiny <- mus_tab
imp <- "podskupiny"

```

### bot adresar

*IMPORTNÍ ROZHRANÍ*: CSV Adresář osob  
**MUSEION**: import_adresar.csv

pole:  
    + create_uid
    + lastwrite_uid
    + sberatel  (vice zaznamu)  
    + urcil  (vice zaznamu)  
    
    
```{r BOT MODIF ADRESAR}

# M O D I F Y

# install.packages("randomNames")
require(randomNames)

# ********* create_uid ********* 

bot_create <- bot %>% 
  select(create_uid) %>% 
  separate(create_uid, into=c("M1", "M2") , sep="\\s|\\.", remove = F, extra = "merge") %>% 
  mutate(M1 = str_to_title(M1), # velke prvni pismeno
         M2 = str_to_title(M2),
         MKODOS = ifelse(str_detect(M2, "\\w\\.$"), paste(M1, M2), paste(M2, M1)),
         MKODOS = ifelse(is.na(M2), paste(M1), MKODOS)) %>% 
  select(-M1, -M2)


#  ********* lastwrite_uid ********* 

bot_lwrt <- bot %>% 
  select(lastwrite_uid) %>% 
  separate(lastwrite_uid, into=c("M1", "M2") , sep="\\s|\\.", remove = F, extra = "merge") %>% 
  mutate(M1 = str_to_title(M1), # velke prvni pismeno
         M2 = str_to_title(M2),
         MLASTWR = ifelse(str_detect(M2, "\\w\\.$"), paste(M2, M1), paste(M1, M2))) %>% 
  mutate(KODOS = ifelse(is.na(MLASTWR), lastwrite_uid, MLASTWR)) %>%
  select(-M1, -M2, -MLASTWR) 


#  ********* urcil ********* 

bot_urc <- bot %>% 
  select(urcil) %>% 
  mutate(urcil = ifelse(urcil == "E. Burša,, rev. J. Chrtek Jun.", "E. Burša, rev. J. Chrtek Jun.", urcil),
         urcil = ifelse(urcil == "D. Hlisnikovskýet al.", "D. Hlisnikovský et al.", urcil),
         urcil = ifelse(urcil == "Z .Kilián", "Z. Kilián", urcil),
         urcil = ifelse(str_detect(urcil, "O . Rotreklová"), "O. Rotreklová", urcil),
         urcil = ifelse(str_detect(urcil, "E.  Burša"), "E. Burša", urcil),
         Mforma = ifelse(str_detect(urcil, "rev\\.|rev\\s"), "revize", 
                                    ifelse(str_detect(urcil, " et | & "), "kolektiv", "")),
         MID = seq_along(urcil)) %>% 
  relocate(Mforma, .before = "urcil") %>% 
       
  separate(urcil, into=c("M", "MR") , 
           sep="rev\\s|,\\srev\\s|,\\srev\\.|,\\s\\srev\\.|,\\s\\srev\\s|;\\srev\\.|\\srev\\.|rev\\.", # oddeleni revizi do samost. sloupce
           remove = F, extra = "merge") %>% 
  mutate(MR = gsub("rev.", "", MR), # nahradit rev prazdnym retezcem
         MR = str_trim(MR), # oriznout whitespace
         M = gsub("rev.|det.", "", M),  # nahradit rev a det prazdnym retezcem
        
         MREVDAT_urc = case_when(str_detect(M, "\\d+") ~  str_extract(M, "\\d+\\.\\d+\\.\\d+"), TRUE ~ ""), # pokud ma sloupec cislice
         M = case_when(str_detect(M, "\\d+") ~  str_remove(M, ",\\s\\d+\\.\\d+\\.\\d+"), TRUE ~ M), # vymazat datum

         # METAL = case_when(str_detect(M, " et | & ") ~  str_extract(M, ".+"), TRUE ~ ""), # oddeleni et al do samost. sloupce
         # M = case_when(str_detect(M, " et | & ") ~  str_remove(M, ".+"), TRUE ~ M),
         
         MPOZN = case_when(str_detect(M, "\\(.+\\)|det\\.|2010 - potvrdil |adnot.") ~  
                                str_extract(M, "\\(.+\\)|det\\.|2010 - potvrdil |adnot."), TRUE ~ ""),
         M = case_when(str_detect(M, "\\(.+\\)|det\\.|2010 - potvrdil |adnot.") ~  
                              str_remove(M, "\\(.+\\)|det\\.|2010 - potvrdil |adnot."), TRUE ~ M),
      
         M = str_trim(M), # TRIM !!!
         
         MRforma = ifelse(str_detect(MR, " et | & "), "kolektiv", "revize")) %>%   
  relocate(MRforma, .before = "MR") %>%

  separate(M, into=c("M1", "M2", "M3") , sep=",| et | a(?! J.)| &", remove = F, extra = "merge") %>%  
  # separate(MR, into=c("MR1", "MR2", "MR3") , sep=",| et | a(?! J.)| &", remove = F, extra = "merge") %>% 
  
  pivot_longer(
    cols = c(
      M1, M2, M3,
    ),
    names_to = "source", # poradi techniky
    values_to = "Mnames",
    values_drop_na = TRUE) %>%  
  mutate(
    Mnames = str_trim(Mnames),
    MPJM = case_when(str_detect(Mnames, "^\\w\\.\\s\\w\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w+$"), # L. a J. Reitmyerovi
                     str_detect(Mnames, "^\\w+$") ~ str_extract(Mnames, "^\\w+$"), # Vrubel
                     str_detect(Mnames, "^\\w\\.\\w+$") ~ str_extract(Mnames, "\\b\\w+$"), # A.Hájková
                     str_detect(Mnames, "^\\w+\\.$") ~ str_extract(Mnames, "^\\w+\\.$"), # D., al.
                     str_detect(Mnames, "^\\w\\.\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # R. J. Vašut
                     str_detect(Mnames, "^\\w\\.\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # R.J. Vašut
                     str_detect(Mnames, "^\\w+\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # Miroslava Bilkova
                     str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+\\.$") ~ str_extract(Mnames, "\\w+\\s\\w+\\.$"), # J. Chrtek jun.
                     str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+$") ~ str_extract(Mnames, "\\w+\\s\\w+$"), # J. Chrtek jun
                     str_detect(Mnames, "\\)$") ~ str_extract(Mnames, "\\w+\\s\\(\\w+\\)"), # O. Rotreklová (BRNU)
                     str_detect(Mnames, "^[:upper:]{3}$") ~ str_extract(Mnames, "^[:upper:]{3}$"), # PVO
                     str_detect(Mnames, "Ekrt L.|Hrabovský S.|Štech M.|Chytil P.|Danihelka J.") ~ word(Mnames, 1), # "Ekrt L."
                     TRUE ~ word(Mnames, 2)),
    MJM = case_when(str_detect(Mnames, "^\\w+\\.\\s+\\w+$") ~ str_extract(Mnames, "^\\w+\\."),  	# V. Dvořák
                    str_detect(Mnames, "^\\w+\\.\\w+$") ~ str_extract(Mnames, "^\\w+\\."),  # 	J.Danihelka
                    str_detect(Mnames, "^\\w\\.\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\s\\w\\."),  # R. J. Vašut
                    str_detect(Mnames, "^\\w\\.\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\w\\."),  # R.J. Vašut 
                    str_detect(Mnames, "^\\w+\\s\\w+$") ~ str_extract(Mnames, "^\\w+"),  # Miroslava Bilkova
                    str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+\\.$") ~ str_extract(Mnames, "^\\w+\\."), # J. Chrtek jun.
                    str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+$") ~ str_extract(Mnames, "^\\w+"), # J. Chrtek jun
                    str_detect(Mnames, "\\)$") ~ str_extract(Mnames, "^\\w+\\."), # O. Rotreklová (BRNU)
                    str_detect(Mnames, "^\\w\\.\\sa\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\sa\\s\\w\\."), # L. a J. Reitmyerovi
                    str_detect(Mnames, "Ekrt L.|Hrabovský S.|Štech M.|Chytil P.|Danihelka J.") ~ word(Mnames, 2), # "Ekrt L."
                    # str_detect(Mnames, "^\\w+\\.$") ~ str_extract(Mnames, ""), # al.
                    TRUE ~ ""),
    MTIT = case_when(str_detect(MJM, "doc.|Ing.") ~ str_extract(Mnames, "doc.|Ing."), TRUE ~ ""),
    MJM = case_when(str_detect(MJM, "doc.|Ing.") ~  str_remove(MJM, "doc.|Ing."), TRUE ~ MJM)) %>% 
  replace(is.na(.), "") %>% 
    mutate(MKODOS = paste(MPJM, MJM)) %>% 
  select(-Mforma, -M, -MRforma, -MID, -source, -Mnames, -MPJM, -MJM) # selekce pro biokartu

# back to wide

bw <- bot_urc %>% 
  group_by(MID) %>% 
  pivot_wider(names_from = source, values_from = c(MPJM, MJM, MTIT, MKODOS)) %>% 
  select(-Mnames) 
bw[bw == ""] <- NA

bw <- bw %>%  
  fill(MPJM_M1, .direction = "down") %>% 
  fill(MPJM_M2, .direction = "down") %>% 
  fill(MPJM_M2, .direction = "up") %>% 
  fill(MPJM_M3, .direction = "up") %>% 
  fill(MJM_M1, .direction = "down") %>% 
  fill(MJM_M2, .direction = "down") %>% 
  fill(MJM_M2, .direction = "up") %>% 
  fill(MJM_M3, .direction = "up") %>% 
  fill(MTIT_M1, .direction = "down") %>% 
  fill(MTIT_M2, .direction = "down") %>% 
  fill(MTIT_M2, .direction = "up") %>% 
  fill(MTIT_M3, .direction = "up") %>% 
  fill(MKODOS_M1, .direction = "down") %>% 
  fill(MKODOS_M2, .direction = "down") %>% 
  fill(MKODOS_M2, .direction = "up") %>% 
  fill(MKODOS_M3, .direction = "up") %>% 
  distinct() %>% 
  ungroup()
bw[bw == " "] <- NA

bot_urc <- bw %>% 
  # mutate(MKODOS = case_when(Mforma == "kolektiv" ~ paste(MKODOS_M1, MKODOS_M2, MKODOS_M3, sep = " et ", na.rm = T),
  #                          TRUE ~ paste(MKODOS_M1, MKODOS_M2, MKODOS_M3, sep = ", ", na.rm = T))) %>% 
  unite(MKODOS, c("MKODOS_M1", "MKODOS_M2", "MKODOS_M3"), sep = ", ", na.rm = T, remove = FALSE) %>% 
  relocate(MKODOS, .after = "urcil") %>% 
  mutate(MKODOS =  case_when(Mforma == "kolektiv" ~ gsub(", ", " et ", MKODOS),
                             TRUE ~ MKODOS)) %>% 
  select(urcil, MKODOS, MR, MREVDAT, MPOZN, MTIT_M1, MPJM_M1, MJM_M1)
  
    
#  ********* sberatel ********* 
 
bot_sbe <- bot %>% 
  select(sberatel) %>%
  mutate(
         sberatel = ifelse(sberatel == "D. Hlisnikovskýet al.", "D. Hlisnikovský et al.", sberatel),
         sberatel = ifelse(sberatel == "E.  Burša", "E. Burša", sberatel),
         Mforma = ifelse(str_detect(sberatel, "rev\\.|rev\\s"), "revize", 
                                    ifelse(str_detect(sberatel, " et | & "), "kolektiv", "")),
         MID = seq_along(sberatel)) %>% 
  relocate(Mforma, .before = "sberatel") %>% 
  separate(sberatel, into=c("M", "MR") , 
           sep="rev\\s|,\\srev\\s|,\\srev\\.|,\\s\\srev\\.|,\\s\\srev\\s|;\\srev\\.|\\srev\\.|rev\\.", # oddeleni revizi do samost. sloupce
           remove = F, extra = "merge") %>% 

  mutate(MR = str_trim(MR), # oriznout whitespace
         M = str_trim(M), # TRIM !!!
         
         MRforma = ifelse(str_detect(MR, " et | & "), "kolektiv", "revize")) %>%   
  relocate(MRforma, .before = "MR") %>%

  separate(M, into=c("M1", "M2", "M3") , sep=",| et | a(?! J.)| &", remove = F, extra = "merge")  %>% 
  # separate(MR, into=c("MR1", "MR2", "MR3") , sep=",| et | a(?! J.)| &", remove = F, extra = "merge") %>% 
  
  pivot_longer(
    cols = c(
      M1, M2, M3,
    ),
    names_to = "source", # poradi techniky
    values_to = "Mnames",
    values_drop_na = TRUE) %>%  
  mutate(
    Mnames = str_trim(Mnames),
    MPJM = case_when(
                     str_detect(Mnames, "^\\w+$") ~ str_extract(Mnames, "^\\w+$"), # Vrubel
                     str_detect(Mnames, "^\\w\\.\\w+$") ~ str_extract(Mnames, "\\b\\w+$"), # A.Hájková
                     str_detect(Mnames, "^\\w+\\.$") ~ str_extract(Mnames, "^\\w+\\.$"), # D., al.
                     # str_detect(Mnames, "^\\w\\.\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # R. J. Vašut
                     # str_detect(Mnames, "^\\w\\.\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # R.J. Vašut
                     str_detect(Mnames, "^\\w+\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # Miroslava Bilkova
                     # str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+\\.$") ~ str_extract(Mnames, "\\w+\\s\\w+\\.$"), # J. Chrtek jun.
                     # str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+$") ~ str_extract(Mnames, "\\w+\\s\\w+$"), # J. Chrtek jun
                     # str_detect(Mnames, "\\)$") ~ str_extract(Mnames, "\\w+\\s\\(\\w+\\)"), # O. Rotreklová (BRNU)
                     # str_detect(Mnames, "^[:upper:]{3}$") ~ str_extract(Mnames, "^[:upper:]{3}$"), # PVO
                     # str_detect(Mnames, "Ekrt L.|Hrabovský S.|Štech M.|Chytil P.|Danihelka J.") ~ word(Mnames, 1), # "Ekrt L."
                     TRUE ~ word(Mnames, 2)),
    MJM = case_when(str_detect(Mnames, "^\\w+\\.\\s+\\w+$") ~ str_extract(Mnames, "^\\w+\\."),  	# V. Dvořák
                    str_detect(Mnames, "^\\w+\\.\\w+$") ~ str_extract(Mnames, "^\\w+\\."),  # 	J.Danihelka
                    # str_detect(Mnames, "^\\w\\.\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\s\\w\\."),  # R. J. Vašut
                    # str_detect(Mnames, "^\\w\\.\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\w\\."),  # R.J. Vašut 
                    str_detect(Mnames, "^\\w+\\s\\w+$") ~ str_extract(Mnames, "^\\w+"),  # Miroslava Bilkova
                    # str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+\\.$") ~ str_extract(Mnames, "^\\w+\\."), # J. Chrtek jun.
                    # str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+$") ~ str_extract(Mnames, "^\\w+"), # J. Chrtek jun
                    # str_detect(Mnames, "\\)$") ~ str_extract(Mnames, "^\\w+\\."), # O. Rotreklová (BRNU)
                    # str_detect(Mnames, "^\\w\\.\\sa\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\sa\\s\\w\\."), # L. a J. Reitmyerovi
                    # str_detect(Mnames, "Ekrt L.|Hrabovský S.|Štech M.|Chytil P.|Danihelka J.") ~ word(Mnames, 2), # "Ekrt L."
                    # str_detect(Mnames, "^\\w+\\.$") ~ str_extract(Mnames, ""), # al.
                    TRUE ~ "")) %>% 
    # MTIT = case_when(str_detect(MJM, "doc.|Ing.") ~ str_extract(Mnames, "doc.|Ing."), TRUE ~ ""),
    # MJM = case_when(str_detect(MJM, "doc.|Ing.") ~  str_remove(MJM, "doc.|Ing."), TRUE ~ MJM)) %>% 
  replace(is.na(.), "") %>% 
    mutate(MKODOS = paste(MPJM, MJM)) 

# back to wide

bw <- bot_sbe %>% 
  group_by(MID) %>% 
  pivot_wider(names_from = source, values_from = c(MPJM, MJM, MKODOS)) %>% 
  select(-Mnames) 
bw[bw == ""] <- NA

bw <- bw %>%  
  fill(MPJM_M1, .direction = "down") %>% 
  fill(MPJM_M2, .direction = "down") %>% 
  fill(MPJM_M2, .direction = "up") %>% 
  fill(MPJM_M3, .direction = "up") %>% 
  fill(MJM_M1, .direction = "down") %>% 
  fill(MJM_M2, .direction = "down") %>% 
  fill(MJM_M2, .direction = "up") %>% 
  fill(MJM_M3, .direction = "up") %>% 
  fill(MKODOS_M1, .direction = "down") %>% 
  fill(MKODOS_M2, .direction = "down") %>% 
  fill(MKODOS_M2, .direction = "up") %>% 
  fill(MKODOS_M3, .direction = "up") %>% 
  distinct() %>% 
  ungroup()
bw[bw == " "] <- NA

bot_sbe <- bw %>% 
  # mutate(MKODOS = case_when(Mforma == "kolektiv" ~ paste(MKODOS_M1, MKODOS_M2, MKODOS_M3, sep = " et ", na.rm = T),
  #                          TRUE ~ paste(MKODOS_M1, MKODOS_M2, MKODOS_M3, sep = ", ", na.rm = T))) %>% 
  unite(MKODOS, c("MKODOS_M1", "MKODOS_M2", "MKODOS_M3"), sep = ", ", na.rm = T, remove = FALSE) %>% 
  relocate(MKODOS, .after = "sberatel") %>% 
  mutate(MKODOS =  case_when(Mforma == "kolektiv" ~ gsub(", ", " et ", MKODOS),
                             TRUE ~ MKODOS)) %>% 
  select(sberatel, MKODOS, MR, MPJM_M1, MJM_M1)
  

# S L O V N I K

# slo_cre <- bot_create %>% 
#   select(puv = create_uid, MKODOS) %>% 
#   mutate(MR = NA, MTIT = NA)
# 
# slo_lwr <- bot_lwrt %>% 
#   select(puv = lastwrite_uid, MKODOS = KODOS) %>% # opravit nahore KODOS na MKODOS
#   mutate(MR = NA, MTIT = NA)

slo_urc <- bot_urc %>% 
  select(puv = urcil, MKODOS, MR, MTIT = MTIT_M1, MDAT = MREVDAT, MPOZN)

slo_sbe <- bot_sbe %>% 
  select(puv = sberatel, MKODOS, MR) %>% 
  mutate(MTIT = NA,
         MDAT = NA, 
         MPOZN = NA)

botanika_slovnik <- rbind(slo_sbe, slo_urc) %>% # slo_cre, slo_lwr, 
  mutate(MKODOS = str_trim(MKODOS)) %>% 
  select(MKODOS, MTIT) %>% 
  distinct()

oper_botanika_adresar <- rbind(slo_sbe, slo_urc) %>% # slo_cre, slo_lwr, 
  mutate(MKODOS = str_trim(MKODOS),
         subjektKod = ifelse(nchar(MKODOS)>30, str_remove_all(MKODOS, "\\set\\s|\\w\\.|,\\s|al\\.$"), MKODOS),
         subjektKod = ifelse(nchar(subjektKod)>30, str_remove_all(subjektKod, "\\s"), subjektKod),
         subjektKod = str_trim(subjektKod),
         len = nchar(subjektKod)) %>% 
  # select(MKODOS, MTIT) %>% 
  distinct()

rm(bot_create)
rm(bot_lwrt)
rm(bot_sbe)
rm(bot_urc)
rm(bw)
rm(slo_sbe)
rm(slo_urc)

```

```{r BOT CSV ADRESAR}

# E X T R A C T   F R O M   B I O K A R T A

u <- urcil$MKODOS_urc
s <- urcil$MKODOS_sbe
a <- as.data.frame(c(u,s)) 
colnames(a)[1] <- "kodos"
adr <-a %>% 
  distinct() %>% 
  mutate(MPRIJM = ifelse(str_detect(kodos, "et al|,"), paste(kodos), word(kodos, 1)),
         MJM = ifelse(str_detect(kodos, "et al|,"), NA, gsub("^.*\\s", "", kodos)),
         MTIT = case_when(MPRIJM == "Velička" ~ "Ing.",
                          MPRIJM == "Vorel" ~ "doc.",
                          TRUE ~ NA), 
         MKODOS = kodos) %>% 
   mutate(across(where(is.character), str_trim))


# M O D I F Y

modify_tab <- adr %>% 
  mutate(X = "",
         '1typSubjektuKod' = "OO",
         subjektKod = ifelse(nchar(MKODOS)>30, str_remove_all(MKODOS, "\\set\\s|\\w\\.|,\\s|al\\.$"), MKODOS),
         subjektKod = ifelse(nchar(subjektKod)>30, str_remove_all(subjektKod, "\\s"), subjektKod),
         subjektKod = str_trim(subjektKod),
         len = nchar(subjektKod),
         '4osobaJmenoPrvni' = if_else(str_detect(MKODOS, "^\\w+\\s\\w\\.$"), str_extract(MKODOS, "\\w\\.$"), ""),
         '6osobaPrijmeni' = if_else(str_detect(MKODOS, "^\\w+\\s\\w\\.$"), str_extract(MKODOS, "^\\w+"), MKODOS), 
         '10osobaPohlavi' = "neznámé",  # povinne: "muž", "žena", "neznámé"
         '18subjektStatKod' = "CZ",
         '42subjektSbirka' = "MUZBE",
         '43subjektPodsbirka' = "Pb")  
modify_tab[modify_tab == ""] <- NA  


# C R E A T E    C S V

mus_tab <- modify_tab %>% 
  select('1typSubjektuKod' = '1typSubjektuKod', # !! povinne !!
         '2subjektKod' = subjektKod,         # !! povinne !!
         '3subjektAlterKod' = X, '4osobaJmenoPrvni'= '4osobaJmenoPrvni', 
         '5osobaJmenoDruhe' = X, 
         '6osobaPrijmeni' = '6osobaPrijmeni',         # !! povinne !!
         '7osobaTitulPredJmenem' = MTIT, '8osobaTitulZaJmenem' = X, 
         '9osobaRodnePrijmeni' = X, 
         '10osobaPohlavi' = '10osobaPohlavi',   # !! povinne !! "muž", "žena", "neznámé"
         
         '11osobaDatumNarozeni' = X, '12osobaMistoNarozeni' = X,
         '13okresNarozeniNazev' = X, '14obecNarozeniNazev' = X,
         '15statNarozeniKod' = X, '16osobaDatumUmrti' = X,
         '17osobaMistoUmrti' = X, 
         
         '18subjektStatKod' = '18subjektStatKod',
         '19kontaktEmail' = X, '20kontaktMobil' = X,
         '21kontaktMobil2' = X, '22kontaktTelefon' = X,
         '23kontaktInternet' = X, '24kontaktInternetoveVolani' = X,
         '25adresaText' = X, '26kontaktniAdresaText' = X,
         '27fyzickaOsobaRodneCislo' = X, '28subjektPoznamka' = X, 
         
         '29AdresaTextoveOkres' = X, '30AdresaTextoveObec' = X,
         '31AdresaTextoveCastObce' = X, '32AdresaTextoveMestskaCast' = X,
         '33AdresaTextoveUlice' = X, '34AdresaTextoveCisloOrientacni' = X,
         '35AdresaTextoveCislo' = X, '36AdresaTextovePSC' = X,
         
         '37zamestnanecCislo' = X, '38oddeleniKod' = X,
         '39osobnostMedailon' = X, '40osobnostPseudonym' = X,
         '41okruhSubjektuNazev' = X, '42subjektSbirka' = '42subjektSbirka',           
         '43subjektPodsbirka' = '43subjektPodsbirka', 
         '44osobaStudia' = X,
         '45osobaSpolky' = X, '46osobaOsobnost' = X,
         '47subjektDatumOd' = X, '48subjektDatumDo' = X,
         '49kontaktEmail2' = X, 
         '50text1' = X, '51text2' = X, '52text3' = X, 
         '53role1' = X, '54role2' = X, 
         '55role3' = X, '56role4' = X, '57$role5' = X
         # , rel_ZkrJm = puv
         )

# oper_BOTadresar <- mus_tab %>% 
#   select(rel_ZkrJm, '1typSubjektuKod', '2subjektKod', '4osobaJmenoPrvni', '6osobaPrijmeni')

imp <- "BOTadresar"

# pokracuj k ulozeni do sekce: # ! ! !   E X P O R T Y  C S V   ! ! !

```

### bot lokality

*IMPORTNÍ ROZHRANÍ*: CSV Lokalita  
**MUSEION**: import_lokalita.csv

* nvyska:
    + 498 m n.m.  
    + 640 - 730 m n.m.  
    + nad 250 m  
    + kolem 250 mnm  
    + cca 250 mnm  
    + ca 250 mnm

```{r BOT MODIF LOKALITY, warning=FALSE}

ku <- read_excel("C:/Users/krizova/Documents/R/gen_tabdata/katastryCR_cuzk_2023.xlsx")
fy0 <- read_excel("C:/Users/krizova/Documents/R/gen_tabdata/fytochorionyCR_csop_2023.xlsx") 
  
fy <- fy0 %>% 
  mutate(naz = str_trim(naz),
         fy_id = paste(idf, naz))

# M O D I F Y

bot_init <- bot %>% 
  select(oblast, katastr, lokalita_geo, mapa, ctverec, nvyska) 

bot_lok <- bot %>% 
  select(oblast, katastr, lokalita_geo, mapa, ctverec, nvyska) %>% 
  
  # coordinates
  
  mutate(Mmapa = case_when(str_detect(mapa, "WGS 84:\\s|WGS:\\s|WGS\\s|GPS\\s\\(WGS\\):\\s|\\(WGS\\)") ~ 
                             gsub("WGS 84:\\s|WGS:\\s|WGS\\s|GPS\\s\\(WGS\\):\\s|\\(WGS\\)", "", mapa),
                            TRUE ~ mapa),
         Mmap_presn = ifelse(str_detect(Mmapa, "^ca|\\sm"), str_extract(Mmapa, "^ca|.......$"), NA),
         Mmapa = ifelse(str_detect(Mmapa, "^ca|\\sm$"), str_remove(Mmapa, "^ca|.......$"), Mmapa),
         Mmap_scale = ifelse(str_detect(Mmapa, "^1"), str_extract(Mmapa, ".+"), NA),
         Mmapa = ifelse(str_detect(Mmapa, "^1"), str_remove(Mmapa, ".+"), Mmapa),
         Mmap_pozn = ifelse(str_detect(Mmapa, "Ostravská|louky|dosti|6375b|\\d+\\-\\d+\\-\\d+"), str_extract(Mmapa, ".+"), NA),
         Mmap_pozn = ifelse(str_detect(Mmapa, "\\sopr|\\soprav"), str_extract(Mmapa, "opr|oprav"), Mmap_pozn),
         Mmapa = ifelse(str_detect(Mmapa, "Ostravská|louky|dosti|6375b|\\d+\\-\\d+\\-\\d+"), str_remove(Mmapa, ".+"), Mmapa)) %>% 
  separate(Mmapa, into=c("MN", "ME"), sep="N|\\/", extra = "merge", remove = F) %>% 
  mutate(ME = gsub(",\\s|\\.\\s|;\\s|E|opr|oprav", "", ME),
         MN = gsub("\\.", ",", MN),
         ME = gsub("\\.", ",", ME),
         MN = str_trim(MN),
         MN = gsub("°,|; ", "°", MN),
         MN = gsub("\"", "'°''", MN),
         MN = gsub("' |´", "'", MN),  
         ME = str_trim(ME),
         ME = gsub("´", "'", ME)) %>% 
  mutate(MNst = str_extract(MN, "[^°]+"),        # N N N N N N N N N 
         MNmin = gsub("^.*°", "", MN),
         MNmin = gsub("'.*$", "", MNmin),
         MNvte = str_remove(MN, "[^']+"),
         MNvte = gsub("'|''|°", "", MNvte),
         MEst = str_extract(ME, "[^°]+"),        # E E E E E E E E E 
         MEmin = gsub("^.*°", "", ME),
         MEmin = gsub("'.*$", "", MEmin),
         MEvte = str_remove(ME, "[^']+"),
         MEvte = gsub("'|''|°", "", MEvte)
         )
  
  # elevation
  
  mutate(Mele_pznk = ifelse(str_detect(nvyska, "nad|kolem|cca|ca"), word(nvyska, 1), ""), 
         MMNM = ifelse(str_detect(nvyska, "-"), gsub("[^[:digit:], -]", "", nvyska), # 640 - 730 m n.m. -> odstranit mnm
                       parse_number(nvyska)),
         # MMNM = ifelse(str_detect(MMNM, "\\W\\s\\W"), gsub("\\W\\s\\W", "\\s\\-\\s", MMNM), MMNM)) %>% 
         MMNM = ifelse(str_detect(MMNM, "-\\s-"), gsub("-\\s-", " - ", MMNM), MMNM)) %>% 

  # ctverec

  mutate(MCTVEREC = ctverec) 
  
  # oblast
  
  # mutate(oblast = str_trim(oblast),
  #        MZEME = case_when(str_detect(oblast, "^Polsko") ~ "Polsko",
  #                          str_detect(oblast, "^Slovensko") ~ "Slovensko", 
  #                          str_detect(oblast, "^Andorra") ~ "Andorra", 
  #                          str_detect(oblast, "^Francie") ~ "Francie", 
  #                          str_detect(oblast, "^Rumunsko") ~ "Rumunsko", 
  #                          TRUE ~ "Česko"),
  #        MFYTOCH = ifelse(oblast %in% fy$fy_id|oblast %in% fy$naz, oblast, NA),
  #        # MFYTOCH = ifelse(str_detect(oblast, "^\\d+"), oblast, NA), # co s temi, kde se shoduje nazev, ale nemaji cislo?
  #        # Mfytoch_wonum = ifelse(oblast %in% fy$naz, oblast, "neidentifikovatelna oblast"),
  #        Mkat_anone = ifelse(katastr %in% ku$ku_name, "katastr", "nekatastr"), 
  #        MKATASTR = ifelse(katastr %in% ku$ku_name, katastr, NA)) %>% 
  # relocate(MFYTOCH, .after = "oblast") %>% 
  # # relocate(Mfytoch_wonum, .after = "oblast") %>% 
  # relocate(Mkat_anone, .after = "katastr") %>% 
  # relocate(MKATASTR, .after = "katastr") %>% 
  # mutate_all(~na_if(., '')) %>% 
  # mutate(MLOKALITA = ifelse(is.na(katastr), lokalita_geo, katastr),
  #        MLOKALITA = ifelse(is.na(MLOKALITA), oblast, MLOKALITA)) %>% 
  # relocate(MLOKALITA, .after = "katastr") %>% 
  # mutate(across(everything(), ~gsub("\\s{2}", " ", .)))

# bot_lok[bot_lok == ""] <- NA
# bot_lok[is.na(bot_lok)] <- ""

# ----------------------------------------------------------------------------------------

# po konzultaci s Danou jen vybrana pole, zbytek pujde primo na kartu:
    # oblast = oblast; kde je oblast fytochorion -> presunout do fytochorionu
    # lokalita = katastr; kde neni katastr, dat lokalita_geo

bot_lok <- bot_init %>% 
  mutate(across(everything(), ~gsub("\\s{2}", " ", .))) %>% 
  
  #oblast
  mutate(oblast = str_trim(oblast),
         MZEME = case_when(str_detect(oblast, "^Polsko") ~ "Polsko",
                           str_detect(oblast, "^Slovensko") ~ "Slovensko", 
                           str_detect(oblast, "^Andorra") ~ "Andorra", 
                           str_detect(oblast, "^Francie") ~ "Francie", 
                           str_detect(oblast, "^Rumunsko") ~ "Rumunsko", 
                           TRUE ~ "Česko"),
         MSTKOD = case_when(str_detect(oblast, "^Polsko") ~ "PL",
                           str_detect(oblast, "^Slovensko") ~ "SK", 
                           str_detect(oblast, "^Andorra") ~ "AD", 
                           str_detect(oblast, "^Francie") ~ "FR", 
                           str_detect(oblast, "^Rumunsko") ~ "RO", 
                           TRUE ~ "CZ"),
         MFYTOCH = ifelse(oblast %in% fy$fy_id|oblast %in% fy$naz, oblast, NA),
         Mkat_anone = ifelse(katastr %in% ku$ku_name, "katastr", "nekatastr"), 
         MKATASTR = ifelse(katastr %in% ku$ku_name, katastr, NA), 
         MOBLAST = ifelse(is.na(MFYTOCH), oblast, NA)) %>% 
  relocate(MFYTOCH, .after = "oblast") %>%
  relocate(Mkat_anone, .after = "katastr") %>% 
  relocate(MKATASTR, .after = "katastr") %>% 
  mutate_all(~na_if(., '')) %>% 
  mutate(MLOKALITA = ifelse(is.na(katastr), lokalita_geo, katastr),
         MLOKALITA = ifelse(is.na(MLOKALITA), oblast, MLOKALITA)) %>% 
  relocate(MLOKALITA, .after = "katastr")
  
  # fytochoriony

  select(MLOKALITA, MFYTOCH, MKATASTR, MZEME, MSTKOD, MOBLAST) %>% 
  pivot_longer(cols = c(MFYTOCH),
               names_to = "Mfytoch_por",
               values_to = "Mfytoch_naz") %>% 
  distinct() %>% 
  group_by(MLOKALITA) %>% 
  mutate(Mfytoch_por = seq_along(Mfytoch_naz)) %>% 
  spread(key = "Mfytoch_por",
         value = "Mfytoch_naz")



```

1$lokalitaNazev - P O V I N N E, *katastr*, kdyz katastr neni, tak *lokalita_geo*, jinak *oblast*
2$okresNazev - nic
3$statKod - vytvorit
4$oblastNazev - *oblast*
5$lokalitaZeme - vytvorit z pole *oblast*
6$lokalitaCtverec - *ctverec*
7$lokalitaMapa -                                                 
8$lokalitaZemepisnaSirka - 
9$lokalitaZemepisnaDelka - 
10$lokalitaNadmorskaVyska - 
11$lokalitaPoznamka - *lokalita_geo*
12$lokalitaSbirka - vytvorit
13$lokalitaPodsbirka - vytvorit
14$fytochorion1 - z pole *oblast*
15$lokalitaPublicNadNazev -                                      
16$lokalitaPublicNazev -                                        
17$fytochorion2 - nic
18$fytochorion3 - nic
19$fytochorion4 - nic


```{r BOT CSV LOKALITY}

fy <- read_excel("C:/Users/krizova/Documents/R/gen_tabdata/Fytochorion_export_MUSEION_190423.xlsx") %>% 
  mutate(Mkodnaz = paste(Kód, Název))

# M O D I F Y

modify_tab <- bot %>% 
  select(oblast, katastr, lokalita_geo) %>%  
  mutate(across(everything(), ~gsub("\\s{2}", " ", .)),
         oblast = str_trim(oblast)) %>% 
  
  # fytochorion
  
  mutate(Mkod = ifelse(str_detect(oblast, "^\\d+"), sub("\\s.*", "", oblast), NA),
         MNAZ = ifelse(str_detect(oblast, "^\\d+"), sub("^[:alnum:]+\\s", "", oblast), NA),
         Mfyt = ifelse(oblast %in% fy$Název|oblast %in% fy$Mkodnaz, oblast, NA),
         Mfyt_naz = ifelse(str_detect(Mfyt, "^[:alpha:]+"), Mfyt, NA)) %>%  
  left_join(fy, by = c("Mfyt_naz" = "Název"), keep = T) %>% 
  mutate(MFYTOCH = ifelse(str_detect(Mfyt, "^\\d+"), sub("\\s.*", "", Mfyt), Kód)) %>% 
  
  # oblast
  mutate(MZEME = case_when(str_detect(oblast, "^Polsko") ~ "Polsko",
                           str_detect(oblast, "^Slovensko") ~ "Slovensko", 
                           str_detect(oblast, "^Andorra") ~ "Andorra", 
                           str_detect(oblast, "^Francie") ~ "Francie", 
                           str_detect(oblast, "^Rumunsko") ~ "Rumunsko", 
                           TRUE ~ "Česko"),
         MSTKOD = case_when(str_detect(oblast, "^Polsko") ~ "PL",
                           str_detect(oblast, "^Slovensko") ~ "SK", 
                           str_detect(oblast, "^Andorra") ~ "AD", 
                           str_detect(oblast, "^Francie") ~ "FR", 
                           str_detect(oblast, "^Rumunsko") ~ "RO", 
                           TRUE ~ "CZ"),
         
         # Mkat_anone = ifelse(katastr %in% ku$ku_name, "katastr", "nekatastr"), 
         # MKATASTR = ifelse(katastr %in% ku$ku_name, katastr, NA), 
         MOBLAST = ifelse(is.na(MFYTOCH), oblast, "")) %>% 
  mutate_all(~na_if(., '')) %>% 
  mutate(MLOKALITA = ifelse(is.na(katastr), lokalita_geo, katastr),
         MLOKALITA = ifelse(is.na(MLOKALITA), oblast, MLOKALITA),
         MLOKALITA = str_trim(MLOKALITA)) %>% 
  
  select(MLOKALITA, MFYTOCH, MZEME, MSTKOD, MOBLAST) %>% 
  pivot_longer(cols = c(MFYTOCH),
               names_to = "Mfytoch_por",
               values_to = "Mfytoch_naz") %>% 
  distinct() %>% 
  group_by(MLOKALITA) %>% 
  mutate(Mfytoch_por = seq_along(Mfytoch_naz)) %>% 
  spread(key = "Mfytoch_por",
         value = "Mfytoch_naz") %>% 
  mutate(X = "",
         '12lokalitaSbirka' = "MUZBE",
         '13lokalitaPodsbirka' = "Pb") %>% 
  ungroup()
  
 
modify_tab[modify_tab == ""] <- NA  

# C R E A T E    C S V

mus_tab <- modify_tab %>% 
  select(
    '1lokalitaNazev' = MLOKALITA,  # !! povinne !!
    '2okresNazev'= X,
    '3statKod' = MSTKOD, 
    '4oblastNazev'= MOBLAST,
    '5lokalitaZeme' = MZEME, 
    '6lokalitaCtverec'= X,
    '7lokalitaMapa' = X, 
    '8lokalitaZemepisnaSirka'= X,
    '9lokalitaZemepisnaDelka'= X, 
    '10lokalitaNadmorskaVyska'= X,
    '11lokalitaPoznamka'= X, 
    '12lokalitaSbirka'= '12lokalitaSbirka',
    '13lokalitaPodsbirka'= '13lokalitaPodsbirka',
    '14fytochorion1'= '1',
    '15lokalitaPublicNadNazev'= X, '16lokalitaPublicNazev'= X,
    '17fytochorion2'= '2', '18fytochorion3'= '3',
    '19fytochorion4'='4') %>% 
  drop_na('1lokalitaNazev') %>% 
  distinct()

oper_lokalita <- mus_tab
imp <- "lokalita"


# rm(fy)
# rm(fy0)
# rm(ku)

# O B L A S T I slovnik

oper_oblasti <- modify_tab %>% 
  select(MOBLAST) %>% 
  distinct()

# write.table(oper_oblasti, file = paste0(path_csv, "MUZBE_import_oblasti.csv"), 
#             quote = T, row.names = F, 
#             sep = ";", dec = ",",              # desetinny oddelovac musi byt carka
#             na = "", fileEncoding="cp1250")

```

## BOT bio karta

invc = inventarni cislo  
sinvc = stare inv. cislo  
jcis = jine cislo   
prirc = prisrustkove cislo   

*MINVC*

maska:  \{S\}\{#####\}\/\{a\}  

invc = puvodni -> rozdelit na radu a cislo (Mrada a Minvc)
MPORC = pridani vedoucich nul k Minvc
MINVC = finalni cislo <- kombinace Mrada a MPORCS dle masky inv.cisla

"Umíme nahrát zkratku podsbírky před přírůstkovým čísle, ale nové přírůstky budou bez písmen na začátku." *(impl.dokument)*  

*PRIRC*

maska:  \{S\}\{####\}\/\{YYYY\}   

### bot pracovni tabulka

```{r PREMODIF BIO}

prac_bot <- bot %>% 
  
  # MINVC 
  
   mutate(MRADA = "B", 
         MPORCIS = str_extract(invc, "[:digit:]+"),
         MPORCIS = str_pad(MPORCIS, 5, pad = "0"),
         MSUBCIS = str_extract(invc, "[:alpha:]$")) %>% 
  unite(MPORSUB, c("MPORCIS", "MSUBCIS"), sep = "/", na.rm = T, remove = FALSE) %>% 
  mutate(MINVC = paste0(MRADA, MPORSUB)) %>% 
  relocate(MINVC, .after = invc) %>% 
  relocate(MSUBCIS, .after = invc) %>% 
  
  # TAXON
  
  select(MINVC, celed, druh, syn, var, publikace) %>% 
  mutate(
    
    # celed
    MceledLAT = word(celed, 1),
         MceledCZ = gsub("\\(|\\)", "", word(celed, 2)),
    # nomen
    Mrod = word(druh, 1),
    Mdruh = ifelse(str_detect(druh, "^\\w+\\sx\\s"), word(druh, 3), word(druh, 2)),
    Mrodru = ifelse(str_detect(druh, "^\\w+\\sx\\s"), paste(Mrod, "x", Mdruh), paste(Mrod, Mdruh)),
    Mautor = ifelse(str_detect(druh, "^\\w+\\sx\\s"), 
                    str_remove(druh, "^\\w+\\sx\\s\\w+\\s"),
                               str_remove(druh, "^\\w+\\s\\w+\\s")),
    MAUT = ifelse(str_detect(Mautor, "^subsp.|^ssp.|^ssp"), str_remove(Mautor, "^\\w+\\.\\s\\w+"), Mautor),
    MAUT = ifelse(str_detect(MAUT, "subsp.|ssp.|^ssp"), str_remove(MAUT, "subsp.\\s\\w+|ssp.\\s\\w+|ssp\\s\\w+"), MAUT),
    # MAUT = sub("\\s+", "\\s", MAUT),
    MSSP = str_extract(druh, "subsp.\\s.*|ssp.\\s.*|var.\\s.*"),
    MSSP = sub("\\(.*", "", MSSP),
    MSSP = case_when(str_detect(MSSP, "Meyerii") ~ "var. meyerii", TRUE ~ MSSP),
    MSSP2 = sub("[A-Z].*", "", MSSP),
    MSSP2 = sub("\\s&", "", MSSP2)) %>% 
  mutate(across(where(is.character), str_trim)) %>% 
  unite(MNOMEN, c(Mrodru, MSSP2), sep = " ", na.rm = T, remove = FALSE) %>% # , MAUT
  # select(-Mautor, -Mrodru, -MSSP, -MSSP2) %>% 
  mutate(MNOMEN = sub("ssp", "subsp", MNOMEN))

ssp <- prac_bot %>% filter(str_detect(druh, ".*subsp.*subsp.*"))

 
biolib <- read_excel("M:/03 klienti/kraj moravskoslezsky/muzeum beskyd - MUZBE/02 muzBE konverze/muzbe BIO/importDK/slovniky/muzbe_import_Plantae_Taxon.xlsx") 

porovnani <- left_join(prac_bot, biolib, by = c("MNOMEN" = "5nomen"), keep = T) %>% 
  relocate('5nomen', .after = MNOMEN) %>% 
  rename(BLnomen = '5nomen')

poddruh <- porovnani %>% 
  filter(str_detect(MNOMEN, "subsp.")) %>% 
  filter(!is.na(BLnomen)) %>% 
  select(MINVC, MNOMEN, druh)

write.table(poddruh, file = "M:/03 klienti/kraj moravskoslezsky/muzeum beskyd - MUZBE/02 muzBE konverze/BIO/MUZBE_botanika_oprava_taxonu.csv",
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="cp1250")


poddruh_ne <- porovnani %>% 
  filter(str_detect(MNOMEN, "subsp.")) %>% 
  filter(is.na(BLnomen))
# nesp <- porovnani %>% 
#   filter(is.na(stromKat)) %>%)
#   distinct())

# NOVA BOT TAB PRO POROVN TAXONU

nova <- porovnani %>% 
  select(MINVC, druh, MNOMEN, BLnomen)

stara <- read_excel(paste0(path_csv, "SbirkovyPredmetPodsbirka_export.xlsx")) %>% 
  rename(mus_MINVC = `Inventární číslo`,
         mus_TAXNOMEN = `(n) Název/jméno`,
         mus_AUT = `(n) Autoři/sběratelé`)

# kontrola <- merge(stara, nova)
kontrola <- inner_join(stara, nova, by = c("mus_MINVC" = "MINVC"), keep = T)

nesedi <- kontrola %>% 
  filter(mus_TAXNOMEN != MNOMEN) %>% 
  filter(str_detect(MNOMEN, "subsp.", negate = T))

```


### bot modif biokarta

```{r MODIF BIO}

base <- bot %>% 
  
  mutate(dostal_dc = as.character(dostal_dc),
         dostal_rc = as.character(dostal_rc)) %>% 
  
  # inventarni cislo
  mutate(MRADA = "B", 
         MPORCIS = str_extract(invc, "[:digit:]+"),
         MPORCIS = str_pad(MPORCIS, 5, pad = "0"),
         MSUBCIS = str_extract(invc, "[:alpha:]$")) %>% 
  unite(MPORSUB, c("MPORCIS", "MSUBCIS"), sep = "/", na.rm = T, remove = FALSE) %>% 
  mutate(MINVC = paste0(MRADA, MPORSUB)) %>% 
  relocate(MINVC, .after = invc) %>% 
  relocate(MSUBCIS, .after = invc) %>% 
  
  # prirustkove cislo - maska:  \{S\}\{####\}\/\{YYYY\}  
  separate(prirc, into=c("Mprir", "Mrok") , sep="/", extra = "merge", remove = FALSE) %>% 
  mutate(Mpodsb = "Pb",
         Mprir0 = str_pad(Mprir, 4, pad = "0")) %>% 
  relocate(Mpodsb, .before = "Mprir") %>% 
  mutate(MPRIRC = paste0(Mpodsb, Mprir0, "/", Mrok)) %>% 
  relocate(MPRIRC, .after = prirc) %>% 
  select(-Mpodsb, -Mprir, -Mrok)
  
  # sber a revize -> nakonec nebyl potreba
  
# sber <- base %>%  
#   mutate(
#          Msberatel = ifelse(sberatel == "D. Hlisnikovskýet al.", "D. Hlisnikovský et al.", sberatel),
#          Msberatel = ifelse(sberatel == "E.  Burša", "E. Burša", Msberatel),
#          Mforma = ifelse(str_detect(Msberatel, "rev\\.|rev\\s"), "revize", 
#                                     ifelse(str_detect(Msberatel, " et | & "), "kolektiv", "")),
#          MID = seq_along(sberatel)) %>% 
#   relocate(Msberatel, .after = "sberatel") %>% 
#   relocate(Mforma, .before = "sberatel") %>% 
#   separate(Msberatel, into=c("M", "MR_sbe") , 
#            sep="rev\\s|,\\srev\\s|,\\srev\\.|,\\s\\srev\\.|,\\s\\srev\\s|;\\srev\\.|\\srev\\.|rev\\.", # oddeleni revizi do samost. sloupce
#            remove = F, extra = "merge") %>% 
# 
#   mutate(MR_sbe = str_trim(MR_sbe), # oriznout whitespace
#          M = str_trim(M), # TRIM !!!
#          
#          MRforma = ifelse(str_detect(MR_sbe, " et | & "), "kolektiv", "revize")) %>%   
#   relocate(MRforma, .before = "MR_sbe") %>%
# 
#   separate(M, into=c("M1", "M2", "M3") , sep=",| et | a(?! J.)| &", remove = F, extra = "merge") %>% 
#   pivot_longer(
#     cols = c(
#       M1, M2, M3,
#     ),
#     names_to = "source", # poradi techniky
#     values_to = "Mnames",
#     values_drop_na = TRUE) %>%  
#   mutate(
#     Mnames = str_trim(Mnames),
#     MPJM = case_when(
#                      str_detect(Mnames, "^\\w+$") ~ str_extract(Mnames, "^\\w+$"), # Vrubel
#                      str_detect(Mnames, "^\\w\\.\\w+$") ~ str_extract(Mnames, "\\b\\w+$"), # A.Hájková
#                      str_detect(Mnames, "^\\w+\\.$") ~ str_extract(Mnames, "^\\w+\\.$"), # D., al.
#                      # str_detect(Mnames, "^\\w\\.\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # R. J. Vašut
#                      # str_detect(Mnames, "^\\w\\.\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # R.J. Vašut
#                      str_detect(Mnames, "^\\w+\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # Miroslava Bilkova
#                      # str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+\\.$") ~ str_extract(Mnames, "\\w+\\s\\w+\\.$"), # J. Chrtek jun.
#                      # str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+$") ~ str_extract(Mnames, "\\w+\\s\\w+$"), # J. Chrtek jun
#                      # str_detect(Mnames, "\\)$") ~ str_extract(Mnames, "\\w+\\s\\(\\w+\\)"), # O. Rotreklová (BRNU)
#                      # str_detect(Mnames, "^[:upper:]{3}$") ~ str_extract(Mnames, "^[:upper:]{3}$"), # PVO
#                      # str_detect(Mnames, "Ekrt L.|Hrabovský S.|Štech M.|Chytil P.|Danihelka J.") ~ word(Mnames, 1), # "Ekrt L."
#                      TRUE ~ word(Mnames, 2)),
#     MJM = case_when(str_detect(Mnames, "^\\w+\\.\\s+\\w+$") ~ str_extract(Mnames, "^\\w+\\."),  	# V. Dvořák
#                     str_detect(Mnames, "^\\w+\\.\\w+$") ~ str_extract(Mnames, "^\\w+\\."),  # 	J.Danihelka
#                     # str_detect(Mnames, "^\\w\\.\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\s\\w\\."),  # R. J. Vašut
#                     # str_detect(Mnames, "^\\w\\.\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\w\\."),  # R.J. Vašut 
#                     str_detect(Mnames, "^\\w+\\s\\w+$") ~ str_extract(Mnames, "^\\w+"),  # Miroslava Bilkova
#                     # str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+\\.$") ~ str_extract(Mnames, "^\\w+\\."), # J. Chrtek jun.
#                     # str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+$") ~ str_extract(Mnames, "^\\w+"), # J. Chrtek jun
#                     # str_detect(Mnames, "\\)$") ~ str_extract(Mnames, "^\\w+\\."), # O. Rotreklová (BRNU)
#                     # str_detect(Mnames, "^\\w\\.\\sa\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\sa\\s\\w\\."), # L. a J. Reitmyerovi
#                     # str_detect(Mnames, "Ekrt L.|Hrabovský S.|Štech M.|Chytil P.|Danihelka J.") ~ word(Mnames, 2), # "Ekrt L."
#                     # str_detect(Mnames, "^\\w+\\.$") ~ str_extract(Mnames, ""), # al.
#                     TRUE ~ "")) %>% 
#     # MTIT = case_when(str_detect(MJM, "doc.|Ing.") ~ str_extract(Mnames, "doc.|Ing."), TRUE ~ ""),
#     # MJM = case_when(str_detect(MJM, "doc.|Ing.") ~  str_remove(MJM, "doc.|Ing."), TRUE ~ MJM)) %>% 
#   replace(is.na(.), "") %>% 
#     mutate(MKODOS = paste(MPJM, MJM)) %>% 
#   group_by(MID) %>% 
#   pivot_wider(names_from = source, values_from = c(MPJM, MJM, MKODOS)) %>%  # back to wide
#   select(-Mnames) %>% 
#   # mutate_all(~na_if(., '')) %>%
#   fill(MPJM_M1, .direction = "down") %>% 
#   fill(MPJM_M2, .direction = "down") %>% 
#   fill(MPJM_M2, .direction = "up") %>% 
#   fill(MPJM_M3, .direction = "up") %>% 
#   fill(MJM_M1, .direction = "down") %>% 
#   fill(MJM_M2, .direction = "down") %>% 
#   fill(MJM_M2, .direction = "up") %>% 
#   fill(MJM_M3, .direction = "up") %>% 
#   fill(MKODOS_M1, .direction = "down") %>% 
#   fill(MKODOS_M2, .direction = "down") %>% 
#   fill(MKODOS_M2, .direction = "up") %>% 
#   fill(MKODOS_M3, .direction = "up") %>% 
#   distinct() %>% 
#   ungroup() %>% 
#   unite(MKODOS_sbe, c("MKODOS_M1", "MKODOS_M2", "MKODOS_M3"), sep = ", ", na.rm = T, remove = FALSE) %>% 
#   relocate(MKODOS_sbe, .after = "Msberatel") %>% 
#   mutate(MKODOS_sbe = case_when(Mforma == "kolektiv" ~ sub(",([^,]*)$", " et\\1", MKODOS_sbe),
#                              TRUE ~ MKODOS_sbe)) %>% 
#   # select(-(last_col(offset = 10):last_col())) %>%                                    # pozor pri zmene poradi sekci !!!!
#   select(-Mforma, -Msberatel, -M, -MRforma, -contains(c("M1", "M2", "M3")))
#   
  # urcil a revize
  
# urcil <- sber %>% 
urcil <- base %>% 

  mutate(urcil = ifelse(urcil == "E. Burša,, rev. J. Chrtek Jun.", "E. Burša, rev. J. Chrtek Jun.", urcil),
         urcil = ifelse(urcil == "D. Hlisnikovskýet al.", "D. Hlisnikovský et al.", urcil),
         urcil = ifelse(urcil == "Z .Kilián", "Z. Kilián", urcil),
         urcil = ifelse(str_detect(urcil, "O . Rotreklová"), "O. Rotreklová", urcil),
         urcil = ifelse(str_detect(urcil, "E.  Burša"), "E. Burša", urcil),
         Mforma = ifelse(str_detect(urcil, "rev\\.|rev\\s"), "revize",
                                    ifelse(str_detect(urcil, " et | & "), "kolektiv", "")),
         MID = seq_along(urcil)) %>%
  relocate(Mforma, .before = "urcil") %>%
  separate(urcil, into=c("M", "MR") ,
           sep="rev\\s|,\\srev\\s|,\\srev\\.|,\\s\\srev\\.|,\\s\\srev\\s|;\\srev\\.|\\srev\\.|rev\\.", # oddeleni revizi do samost. sloupce
           remove = F, extra = "merge") %>%
  mutate(MR_urc = gsub("rev.", "", MR), # nahradit rev prazdnym retezcem
         MR_urc = str_trim(MR_urc), # oriznout whitespace
         M = gsub("rev.|det.", "", M),  # nahradit rev a det prazdnym retezcem
         MREVDAT_urc = case_when(str_detect(M, "\\d+") ~  str_extract(M, "\\d+\\.\\d+\\.\\d+"), TRUE ~ ""), # pokud ma sloupec cislice
         M = case_when(str_detect(M, "\\d+") ~  str_remove(M, ",\\s\\d+\\.\\d+\\.\\d+"), TRUE ~ M), # vymazat datum
         MPOZN_urc = case_when(str_detect(M, "\\(.+\\)|det\\.|2010 - potvrdil |adnot.") ~
                                str_extract(M, "\\(.+\\)|det\\.|2010 - potvrdil |adnot."), TRUE ~ ""),
         M = case_when(str_detect(M, "\\(.+\\)|det\\.|2010 - potvrdil |adnot.") ~
                              str_remove(M, "\\(.+\\)|det\\.|2010 - potvrdil |adnot."), TRUE ~ M),
         M = str_trim(M),
         MRforma = ifelse(str_detect(MR_urc, " et | & "), "kolektiv", "revize")) %>%
  relocate(MRforma, .before = "MR_urc") %>%
  separate(M, into=c("M1", "M2", "M3") , sep=",| et | a(?! J.)| &", remove = F, extra = "merge") %>% 
  pivot_longer(
    cols = c(
      M1, M2, M3,
    ),
    names_to = "source", # poradi techniky
    values_to = "Mnames",
    values_drop_na = TRUE) %>%
  mutate(
    Mnames = str_trim(Mnames),
    MPJM = case_when(str_detect(Mnames, "^\\w\\.\\s\\w\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w+$"), # L. a J. Reitmyerovi
                     str_detect(Mnames, "^\\w+$") ~ str_extract(Mnames, "^\\w+$"), # Vrubel
                     str_detect(Mnames, "^\\w\\.\\w+$") ~ str_extract(Mnames, "\\b\\w+$"), # A.Hájková
                     str_detect(Mnames, "^\\w+\\.$") ~ str_extract(Mnames, "^\\w+\\.$"), # D., al.
                     str_detect(Mnames, "^\\w\\.\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # R. J. Vašut
                     str_detect(Mnames, "^\\w\\.\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # R.J. Vašut
                     str_detect(Mnames, "^\\w+\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # Miroslava Bilkova
                     str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+\\.$") ~ str_extract(Mnames, "\\w+\\s\\w+\\.$"), # J. Chrtek jun.
                     str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+$") ~ str_extract(Mnames, "\\w+\\s\\w+$"), # J. Chrtek jun
                     str_detect(Mnames, "\\)$") ~ str_extract(Mnames, "\\w+\\s\\(\\w+\\)"), # O. Rotreklová (BRNU)
                     str_detect(Mnames, "^[:upper:]{3}$") ~ str_extract(Mnames, "^[:upper:]{3}$"), # PVO
                     str_detect(Mnames, "Ekrt L.|Hrabovský S.|Štech M.|Chytil P.|Danihelka J.") ~ word(Mnames, 1), # "Ekrt L."
                     TRUE ~ word(Mnames, 2)),
    MJM = case_when(str_detect(Mnames, "^\\w+\\.\\s+\\w+$") ~ str_extract(Mnames, "^\\w+\\."),  	# V. Dvořák
                    str_detect(Mnames, "^\\w+\\.\\w+$") ~ str_extract(Mnames, "^\\w+\\."),  # 	J.Danihelka
                    str_detect(Mnames, "^\\w\\.\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\s\\w\\."),  # R. J. Vašut
                    str_detect(Mnames, "^\\w\\.\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\w\\."),  # R.J. Vašut
                    str_detect(Mnames, "^\\w+\\s\\w+$") ~ str_extract(Mnames, "^\\w+"),  # Miroslava Bilkova
                    str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+\\.$") ~ str_extract(Mnames, "^\\w+\\."), # J. Chrtek jun.
                    str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+$") ~ str_extract(Mnames, "^\\w+"), # J. Chrtek jun
                    str_detect(Mnames, "\\)$") ~ str_extract(Mnames, "^\\w+\\."), # O. Rotreklová (BRNU)
                    str_detect(Mnames, "^\\w\\.\\sa\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\sa\\s\\w\\."), # L. a J. Reitmyerovi
                    str_detect(Mnames, "Ekrt L.|Hrabovský S.|Štech M.|Chytil P.|Danihelka J.") ~ word(Mnames, 2), # "Ekrt L."
                    # str_detect(Mnames, "^\\w+\\.$") ~ str_extract(Mnames, ""), # al.
                    TRUE ~ ""),
    MTIT_urc = case_when(str_detect(MJM, "doc.|Ing.") ~ str_extract(Mnames, "doc.|Ing."), TRUE ~ ""),
    MJM = case_when(str_detect(MJM, "doc.|Ing.") ~  str_remove(MJM, "doc.|Ing."), TRUE ~ MJM)) %>%
  # replace(is.na(.), "") %>%
    mutate(MKODOS = paste(MPJM, MJM)) %>%
  group_by(MID) %>%
  pivot_wider(names_from = source, values_from = c(MPJM, MJM, MTIT_urc, MKODOS)) %>% 
  select(-Mnames) %>% 
  fill(MPJM_M1, .direction = "down") %>% 
  fill(MPJM_M2, .direction = "down") %>% 
  fill(MPJM_M2, .direction = "up") %>% 
  fill(MPJM_M3, .direction = "up") %>% 
  fill(MJM_M1, .direction = "down") %>% 
  fill(MJM_M2, .direction = "down") %>% 
  fill(MJM_M2, .direction = "up") %>% 
  fill(MJM_M3, .direction = "up") %>% 
  fill(MTIT_urc_M1, .direction = "down") %>% 
  fill(MTIT_urc_M2, .direction = "down") %>% 
  fill(MTIT_urc_M2, .direction = "up") %>% 
  fill(MTIT_urc_M3, .direction = "up") %>% 
  fill(MKODOS_M1, .direction = "down") %>% 
  fill(MKODOS_M2, .direction = "down") %>% 
  fill(MKODOS_M2, .direction = "up") %>% 
  fill(MKODOS_M3, .direction = "up") %>% 
  distinct() %>% 
  ungroup() %>% 
  unite(MKODOS_urc, c("MKODOS_M1", "MKODOS_M2", "MKODOS_M3"), sep = ", ", na.rm = T, remove = FALSE) %>% 
  relocate(MKODOS_urc, .after = "urcil") %>% 
  mutate(MKODOS_urc =  case_when(Mforma == "kolektiv" ~ sub(",([^,]*)$", " et\\1", MKODOS_urc),
                             TRUE ~ MKODOS_urc)) %>% 
  relocate(MKODOS_urc, .after = urcil) %>%
  relocate(MR_urc, .after = MKODOS_urc) %>%
  relocate(MREVDAT_urc, .after = MR_urc) %>%
  relocate(MPOZN_urc, .after = MREVDAT_urc) %>% 
  mutate(MKODOS_urc = ifelse(MPOZN_urc %in% c("adnot.", "2010 - potvrdil "), "", MKODOS_urc)) %>% 
  select(-contains(c("M1", "M2", "M3")))
  
  # souradnice

geo <- urcil %>% 
  mutate(Msour = case_when(str_detect(mapa, "WGS 84:\\s|WGS:\\s|WGS\\s|GPS\\s\\(WGS\\):\\s|\\(WGS\\)") ~ 
                             gsub("WGS 84:\\s|WGS:\\s|WGS\\s|GPS\\s\\(WGS\\):\\s|\\(WGS\\)", "", mapa),
                            TRUE ~ mapa),
         Mmap_presn = ifelse(str_detect(Msour, "^ca|\\sm"), str_extract(Msour, "^ca|.......$"), NA),
         Msour = ifelse(str_detect(Msour, "^ca|\\sm$"), str_remove(Msour, "^ca|.......$"), Msour),
         Mmap_scale = ifelse(str_detect(Msour, "^1"), str_extract(Msour, ".+"), NA),
         Msour = ifelse(str_detect(Msour, "^1"), str_remove(Msour, ".+"), Msour),
         Mmap_pozn = ifelse(str_detect(Msour, "Ostravská|louky|dosti|6375b|\\d+\\-\\d+\\-\\d+"), str_extract(Msour, ".+"), NA),
         Mmap_pozn = ifelse(str_detect(Msour, "\\sopr|\\soprav"), str_extract(Msour, "opr|oprav"), Mmap_pozn),
         Msour = ifelse(str_detect(Msour, "Ostravská|louky|dosti|6375b|\\d+\\-\\d+\\-\\d+"), str_remove(Msour, ".+"), Msour)) %>% 
  unite(MMAPA, c("Mmap_presn", "Mmap_scale", "Mmap_pozn"), sep = " ", na.rm = T, remove = FALSE) %>% 
  separate(Msour, into=c("MN", "ME"), sep="N|\\/", extra = "merge", remove = F) %>% 
  mutate(ME = gsub(",\\s|\\.\\s|;\\s|E|opr|oprav", "", ME),
         MN = gsub("\\.", ",", MN),
         ME = gsub("\\.", ",", ME),
         MN = str_trim(MN),
         MN = gsub("°,|; ", "°", MN),
         MN = gsub("\"", "'°''", MN),
         MN = gsub("' |´", "'", MN),  
         ME = str_trim(ME),
         ME = gsub("´", "'", ME)) %>% 
  mutate(
         MNst = str_extract(MN, "[^°]+"),        # N N N N N N N N N 
         MNmin = gsub("^.*°", "", MN),
         MNmin = gsub("'.*$", "", MNmin),
         MNvte = str_remove(MN, "[^']+"),
         MNvte = gsub("'|''|°", "", MNvte),
         MEst = str_extract(ME, "[^°]+"),        # E E E E E E E E E 
         MEmin = gsub("^.*°", "", ME),
         MEmin = gsub("'.*$", "", MEmin),
         MEvte = str_remove(ME, "[^']+"),
         MEvte = gsub("'|''|°", "", MEvte),
         
         MSIRKA = ifelse(str_detect(MNst, "[:digit:]+"), "N", NA),
         MDELKA = ifelse(str_detect(MEst, "[:digit:]+"), "E", NA),
         
         MN_temp = MNst,
         ME_temp = MEst,
         MNst = ifelse(MN_temp == "432342,4", "43", MNst),  # uprava dvou spec pripadu
         MNmin = ifelse(MN_temp == "432342,4", "23", MNmin),
         MNvte = ifelse(MN_temp == "432342,4", "42,4", MNvte),
         MEst = ifelse(ME_temp == "181202,8", "18", MEst),
         MEmin = ifelse(ME_temp == "181202,8", "12", MEmin),
         MEvte = ifelse(ME_temp == "181202,8", "02,8", MEvte)) %>% 
  select(-MN_temp, -ME_temp) %>% 
  relocate(Msour, .after = mapa) %>% 
  relocate(Mmap_presn, .after = Msour) %>% 
  relocate(Mmap_scale, .after = Msour) %>% 
  relocate(Mmap_pozn, .after = Msour) %>% 
  relocate(MEvte, .after = Mmap_presn) %>% 
  relocate(MEmin, .after = Mmap_presn) %>% 
  relocate(MEst, .after = Mmap_presn) %>% 
  relocate(MNvte, .after = Mmap_presn) %>% 
  relocate(MNmin, .after = Mmap_presn) %>% 
  relocate(MNst, .after = Mmap_presn) %>% 
  
  # elevation
  
  mutate(Mele_pznk = ifelse(str_detect(nvyska, "nad|kolem|cca|ca"), word(nvyska, 1), ""), 
         Mnv = ifelse(str_detect(nvyska, "-"), gsub("[^[:digit:], -]", "", nvyska), # 640 - 730 m n.m. -> odstranit mnm
                       parse_number(nvyska)),
         # MMNM = ifelse(str_detect(MMNM, "\\W\\s\\W"), gsub("\\W\\s\\W", "\\s\\-\\s", MMNM), MMNM)) %>% 
         Mnv = ifelse(str_detect(Mnv, "-\\s-"), gsub("-\\s-", " - ", Mnv), Mnv),
         Mnv = gsub("\\s", "", Mnv)) %>% 
  unite(MMNM, c("Mele_pznk", "Mnv"), sep = " ", na.rm = T, remove = FALSE) %>% 
  relocate(MMNM, .after = nvyska) %>% 
  relocate(Mele_pznk, .after = MMNM) %>% 
  mutate(MMNM = str_trim(MMNM)) %>% 
  
  # lokalita
  
  mutate(MLOKALITA = ifelse(is.na(katastr), lokalita_geo, katastr),
         MLOKALITA = ifelse(MLOKALITA == "", lokalita_geo, MLOKALITA), 
         MLOKALITA = ifelse(is.na(MLOKALITA), oblast, MLOKALITA)) %>% 
  relocate(MLOKALITA, .after = "katastr") %>% 
  mutate(across(everything(), ~ gsub("\\s{2}", " ", .)))

  # taxon

taxon <- geo %>% 

  # select(celed, druh, syn, var) %>%
  mutate(
    # celed
    MceledLAT = word(celed, 1),
         MceledCZ = gsub("\\(|\\)", "", word(celed, 2)),
    # nomen
    Mrod = word(druh, 1),
    Mdruh = ifelse(str_detect(druh, "^\\w+\\sx\\s"), word(druh, 3), word(druh, 2)),
    MNOMEN = paste(Mrod, Mdruh),
    Mautor = ifelse(str_detect(druh, "^\\w+\\sx\\s"), 
                    str_remove(druh, "^\\w+\\sx\\s\\w+\\s"),
                               str_remove(druh, "^\\w+\\s\\w+\\s"))) %>% 
  left_join(biolib %>% dplyr::select('4nazevKategorie', '5nomen', '8nadrizenyTaxon'),
            by = c("MNOMEN" = "5nomen"), keep = T) %>% 
  relocate(MNOMEN, .after = druh) %>% 
  relocate('8nadrizenyTaxon', .after = var) %>% 
  relocate('5nomen', .after = var) %>% 
  rename(BLnomen = '5nomen',
         BLnazkat = '4nazevKategorie') %>% 
  mutate(MTAXON = ifelse(is.na(BLnomen), MNOMEN, BLnomen),
         MTAXKATEG = ifelse(is.na(BLnazkat), "druh", BLnazkat)) %>% 
  relocate(MTAXON, .after = MNOMEN) %>% 
  relocate(MTAXKATEG, .after = MTAXON) 

# nesp <- porovnani %>% 
#   filter(is.na(stromKat)) %>% # 1509
#   distinct() # 499
  
  # odborne urceni pozn

taxon[taxon == ""] <- NA
ou <- taxon %>%
  # mutate(pozn = gsub("\\s+", "", pozn)) %>% 
  # mutate(reviz = gsub("^\\s+$", "", reviz)) %>% 
  # mutate(MPOZN_OU = case_when(!is.na(MPOZN_urc) ~ paste0(MPOZN_urc, "\n" , reviz),
  #                             !is.na(reviz) ~ paste0(reviz),
  #                             TRUE ~ "")) %>% 
  unite(MPOZN_OU, c("MPOZN_urc", "reviz", "pozn"), sep = "\n", na.rm = T, remove = FALSE) %>% 
  relocate(MPOZN_OU, .after = urcil_d) %>% 
  relocate(reviz, .after = urcil_d) 

  # set samostatnych poli

modify_tab <- ou %>% 
  mutate(X = NA,
         '1typPredmetuKod' = "BO", 
         '2sbirkaCisloEvidInt' = projekt,
         '3podsbirkaCislo' = "Pb", 
         '16fondKod' = "bot",
         '17skupinaKod' = "herbT",
         MPOCETKS = ifelse(pocet_kusu == "", "1", pocet_kusu),
         MPOCETKS = ifelse(pocet_kusu == "návrh na SPR", "1", MPOCETKS),
         MPOCETKS = ifelse(pocet_kusu == ";", "1", MPOCETKS),
         MPOCETKS = ifelse(is.na(MPOCETKS), "1", MPOCETKS),
         MNABYTI = case_when(nabyti == "dar" ~ "D",
                             nabyti %in% c("nákup", "Nákup", "nákup ", "nkup") ~ "K",
                             nabyti %in% c("sběr", "sběr ", "svěr") ~ "V"),
         MPODSKUP = substr(sub("\\s", "", pskup), 1,20),  # smazat mezeru, orezat na 20 znaku)
         MSTAV = case_when(str_detect(stav, "Inventarizace|Inventarizace\\s|Invenatrizace\\s|Inevntarizace\\s|Invetarizace\\s|Inventrizace\\s") 
                           ~ gsub("Inventarizace|Inventarizace\\s|Invenatrizace\\s|Inevntarizace\\s|Invetarizace\\s|Inventrizace\\s", "", stav),
                           str_detect(stav, "Inv.\\s") ~ gsub("Inv.\\s", "", stav),
                           str_detect(stav, "I|I\\s") ~ gsub("I|I\\s", "", stav),
                           TRUE ~ stav)) %>% 
  relocate(MSTAV, .after = stav)
           
# rm(base)
# rm(sber)
# rm(urcil)
# rm(geo)
# rm(taxon)
# rm(ou)

```

### bot CSV biokarta

*IMPORTNÍ ROZHRANÍ*: CSV_KatalogBIO  
*MUSEION*: import_bio.csv  
  
Prirodovedna karta.    

```{r CSV BIO}

# ------------------------------------- P O K R A C U J   Z D E !!! 
# ------------------------------------- D O P L N I T !!!

mus_tab <- modify_tab %>% 
  select(
    '1typPredmetuKod' = '1typPredmetuKod',        # !! povinne !! (BI, BO, ZO, EN, GE nebo PL)
    '2sbirkaCisloEvidInt'= '2sbirkaCisloEvidInt', # !! povinne !! ze slovniku
    '3podsbirkaCislo' = '3podsbirkaCislo',        # !! povinne !! ze slovniku
    '4ciselnaRadaKod'= MRADA,                     # !! povinne !! ze slovniku
    
    '5SPCislo' = MINVC,                           # !! povinne !!
    '6SPcisloCES'= X, 
    '7SPPoradoveCislo' = MPORCIS,
    '8SPCisloDo'= X, 
    '9SPPoradoveCisloDo'= X, 
    '10SPPoradoveCisloSub' = MSUBCIS,
    '11SPPoradoveCisloSubDo' = X, 
# evidence    
    '12SPDatumZapisu' = create_date, 
    '13jinaEvidence1Cislo' = X, # samost import
    '14jinaEvidence2Cislo' = X,
    '15jinaEvidence3Cislo' = X,
    '16fondKod' = '16fondKod', 
    '17skupinaKod' = '17skupinaKod',
    '18materialovaSkupinaKod' = X, 
    '19oznaceniNazev' = X, # u botaniky nevyplnovat
    '20taxon' = MTAXON, # 
    '21snadTaxon' = X, 
    '22SPPocetKusu' = MPOCETKS,
    '23urcilOsobaKod' = MKODOS_urc,
    '24dataceUrceniHodnota' = X,
    '25odborneUrceniPoznamka' = MPOZN_OU, 
    '26odborneUrceniPopis' = popis, 
# lokalita, geo    
    '27lokalita' = MLOKALITA,      
    '28sirkaNS' = MSIRKA, 
    '29sirkaStupne' = MNst, 
    '30sirkaMinuty' = MNmin, 
    '31sirkaVteriny' = MNvte, 
    '32delkaEW' = MDELKA, 
    '33delkaStupne' = MEst, 
    '34delkaMinuty' = MEmin, 
    '35delkaVteriny' = MEvte, 
    '36vyska' = X, '37specifikaceLokality' = X, 
    '38mapa' = MMAPA, '39ctverec' = ctverec,
    '40charakteristika' = lokalita_ekol, 
    '41puvodniPopisLokality' = X,
    '42nadmorskaVyska' = MMNM, '43nalezPoznamka' = X,
    '44dataceHodnota' = X, '45datacePoznamka' = X, 
# etikety
    '46textEtiketa' = X, '47typ' = X,
    '48cf' = X, '49var' = var, 
    '50herbar' = X, '51preparat' = X, 
    '52pocetSamcu' = X, '53pocetSamic' = X, '54pocetJuv' = X, 
    '55collectio' = X,
# lokace    
    '56stalaLokaceKod' = X, '57aktualniLokaceKod' = X, # samost import
# nabyti a zalozeni zaznamu    
    '58SPPoznamka' = odpis_duvod,
    '59zpusobNabytiKod' = MNABYTI,
    '60nabytiPredmetuDatum' = nabyti_d, 
    '61nabytiPredmetuDoklad' = X, '62nabytiPoznamka' = X, 
    '63nabytiPredchoziMajitelSlovy' = X,'64prirustekCislo' = MPRIRC,
    '65ciselnaRadaPrirustkuKod' = X,   # nevy
    '66nabytiPrirustkuDatum' = X, 
    '67zakladniCharakteristika' = X, 
    '68kodPodskupiny1' = MPODSKUP, 
    '69kodPodskupiny2' = X,'70kodPodskupiny3' = X, '71predmetCizi' = X,
    '72SPPapirovaKarta' = X, '73SPKartaJeOpsana' = X,
    '74text1' = X, 
    '75text2' = negat, 
    '76text3' = zapis_ces,
    '77text4' = MSTAV,
    '78text5' = X,
    '79SPUIns' = create_uid, # neni slovnikovane, netreba upravovat
    '80SPDIns' = create_date, 
    '81SPUUpd' = X,'82SPDUpd' = X, # nemusi byt nic, stejne se prepise importem
# ?    
    '83parageneze' = X,'84chronostratigrafie' = X,
    '85litostratigrafie' = X,'86poznamkaChrono' = X,
    '87poznamkaLito' = X,'88kompletnost' = X,
    '89tvar' = X,'90barva' = X,
    '91zrnitost' = X,'92biozona' = X,
    '93fertilita' = X,'94zpusobZachovani' = X,
    '95originalniJmeno' = druh, #                  !!!   puvodni jmeno druhu
    '96zoPohlavi' = X,
    '97zoStari' = X,'98snadChrono' = X,
    '99snadLito' = X, '100klicovaSlova' = syn,
    '101nazevKU' = X, '102fytochorion' = X,  # OBOJE vyplnovat !!!
    '103lokalitaDoplneni' = lokalita_geo, '104lokalitaOriginalni' = X,
    '105stanoviste' = X, '106mikroStanoviste' = X,
    '107biotopKod' = X, '108zpusobZiskani' = X,
    '109souradniceZdroj' = X, '110souradnicePresnost' = X,
    '111cisloSberu' = X, '112rokAkvizice' = X,
    '113text6' = X, '114text7' = X,
    '115text8' = dostal_rc, '116text9' = dostal_dc,
    '117text10' = X, '118rokPrirustku' = X,
    '119kategorieTaxonuNazev' = MTAXKATEG, # povinne
    '120nadrizenyTaxonNom' = '8nadrizenyTaxon')

oper_bio <- mus_tab
imp <- "bio"

# T O P   10   F O R   I M P O R T   C H E C K

# mus_tab10 <- mus_tab %>% slice(1:10)
# imp <- "bio10"
# 
# save <- paste0(path_csv, projekt, "_import_", imp, ".csv")
# 
# if(file.exists(save)){
#   print("You've been here before!")
# } else {
#   write.table(mus_tab10, file = save, # mus_tab10
#             quote = T, row.names = F,
#             sep = ";", dec = ",",
#             na = "", fileEncoding="cp1250")
#   print("Import csv  W R I T T E N  !")
#   }
```

### bot kontrola importu

```{r IMPORT CHECK}

# mus_imp <- read_excel(paste0(path_csv, "/SbirkovyPredmetPodsbirka_export.xlsx")) %>% 
mus_imp <- read_excel(paste0(path_csv, "/SbirkovyPredmet_export.xlsx")) %>% 
  select(mus_invc = 'Inventární číslo')

check_imp <- left_join(mus_tab, mus_imp, by = c("5SPCislo" = "mus_invc"), keep = T) %>% 
  relocate(mus_invc, .after = "5SPCislo")
  # filter(is.na(mus_invc))

check_imp[check_imp == ""] <- NA

# u p r a v y

sort(unique(check_imp$'60nabytiPredmetuDatum'))

# spatny format data nabyti
check_imp$'60nabytiPredmetuDatum' <- sub("\\s|52/2005", NA, check_imp$'60nabytiPredmetuDatum')

# poradove cislo -> upraveno v puvodni modify_tab

# inv <- check_imp %>% 
#   select(cis = '5SPCislo') %>% 
#   mutate(exc = ifelse(str_detect(cis, "[:alpha:]$"), 1, 0),
#          MRADA = "B", 
#          MPORCISLO = str_extract(cis, "[:digit:]+"),
#          MSUBCISLO = str_extract(cis, "[:alpha:]$"))

# cisla <- check_imp %>% 
#   rename(sub = '10SPPoradoveCisloSub') %>% filter(!is.na(sub))


# ososba urcil NA neznama
check_imp$'23urcilOsobaKod' <- sub("NA", NA, check_imp$'23urcilOsobaKod')

# ososba urcil NA neznama
check_imp$'35delkaVteriny' <- sub("\\s|\\|\"", "", check_imp$'35delkaVteriny')
check_imp$'35delkaVteriny' <- sub("\"", "", check_imp$'35delkaVteriny')
check_imp$'35delkaVteriny' <- sub(",,", ",", check_imp$'35delkaVteriny')

# ctverec too long 20
check_imp$'39ctverec' <- sub("\\s+", "", check_imp$'39ctverec')
ctver <- check_imp %>% select(ctv = '39ctverec') %>% mutate(len = nchar(ctv)) # ok

# nadmvyska too long 100 (?)
check_imp$'42nadmorskaVyska' <- sub(",0", "", check_imp$'42nadmorskaVyska')
ctver <- check_imp %>% select(ctv = '42nadmorskaVyska') %>% mutate(len = nchar(ctv)) # ok

# str_trim nakonec
check_imp <- check_imp %>% 
  select(-mus_invc) %>% 
  mutate(across(where(is.character), str_trim))

rm(ctver)

# s a v e   i m p o r t   f i l e 2

check_save <- paste0(path_csv, projekt, "_import_", imp, "2.csv")

if(file.exists(check_save)){
  print("You've been here before!")
} else {
  write.table(check_imp, file = check_save, # mus_tab10
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  }


# s p a r o v a n i    t a x o n u   ->   i m p o r t   f i l e 3

mus_imp <- read_excel(paste0(path_csv, "/PrenosDatZaznam_export.xlsx")) 

sort(unique(mus_imp$'Údaj 20'))

tax <- mus_imp %>% 
  filter(Pořadí != 1) %>% 
  select(nomen = 'Údaj 20', orig = 'Údaj 95') %>% distinct() %>% #  'Údaj 49', 'Údaj 100'
  mutate(MSBIRKA = "MUZBE",
         MPODSB = "Pb",
         MPODSBnaz = "botanika",
         MFOND = "bot",
         MFONDnaz = "botanika",
         MSKUP = "herbT",
         MSKUPnaz = "herbář Tracheophyta",
         X = NA,
         MOBOR = 5,
         MTAXKATnaz = "druh",
         MAUTOR = ifelse(str_detect(orig, "^\\w+\\sx\\s"), 
                         str_remove(orig, "^\\w+\\sx\\s\\w+\\s"),
                               str_remove(orig, "^\\w+\\s\\w+\\s")),
         MNADRTAXkat = "rod",
         MROD = word(nomen, 1))



mus_tab <- tax %>% 
  select(
    '1sbirkaCisloEvidInt' = MSBIRKA,  
    '2podsbirkaCislo'= 'MPODSB',          
    '3kodOboru' = MOBOR, 
    '4nazevKategorie'= MTAXKATnaz,     # !! povinne !!
    '5nomen'= nomen,                   # !! povinne !!
    '6nazev'= X,                   
    '7autor'= MAUTOR,                  
    '8nadrizenyTaxon'= MROD,                   
    '9preferovanyTaxon'= X,                   
    '10Poznamka'= X,                   
    '11nazevKategorieNadrizenehoTaxonu' = MNADRTAXkat) %>% 
  distinct()

oper_taxon <- mus_tab
imp <- "taxon"

# poslednich 11

mus_imp <- read_excel(paste0(path_csv, "/SbirkovyPredmet_export.xlsx")) %>% 
  rename(mus_invc = 'Inventární číslo') 

check_imp <- left_join(mus_tab, mus_imp, by = c("5SPCislo" = "mus_invc"), keep = T) %>% 
  relocate(mus_invc, .after = "5SPCislo") %>% 
  filter(is.na(mus_invc)) %>% 
  select(-mus_invc, -(last_col(offset = 34):last_col()))

# puvodni botanika má 3 duplicitni invc

bot[duplicated(bot$invc)|duplicated(bot$invc, fromLast=TRUE),]

# plus tri duplicitni radky

dup <- mus_tab %>% 
  rename(sl5 = "5SPCislo", sl20 = "20taxon") %>% 
  filter(sl5 == "B06434" & sl20 == "Setaria viridis"|
           sl5 == "B13836" & sl20 == "Galium odoratum"|
           sl5 == "B21785" & sl20 == "Molinia coerulea") %>% 
  mutate(sl5 = paste0(sl5, "/D")) %>% 
  rename("5SPCislo" = sl5, "20taxon" = sl20)

imp3 <- rbind(check_imp, dup) %>% 
  rename(sl60 = "60nabytiPredmetuDatum") %>% 
  mutate(sl60 = ifelse(sl60 == "52/2005", NA, sl60)) %>% 
  rename("60nabytiPredmetuDatum" = sl60)


check_save <- paste0(path_csv, projekt, "_import_", imp, "3.csv")

if(file.exists(check_save)){
  print("You've been here before!")
} else {
  write.table(imp3, file = check_save, # mus_tab10
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  }


# DOPLN SBERATELE

doplsber <- read.table(paste0(path_csv, "MUZBE_modif_bio.csv"), 
                       header = TRUE, sep = ";", fill = T, 
                       dec = ",", fileEncoding="cp1250") %>% 
  select(MINVC, MKODOS_sbe)
 


```
## BOT doprovodne

### bot sberatele

*IMPORTNÍ ROZHRANÍ*: CSV Sberatele Predmetu 
*MUSEION*: import_sberPtu.csv  

```{r BOT SBERATELE}

# M O D I F Y

doplsber <- MUZBE_modif_bio %>% 
  select(MINVC, sberatel)


doplsber[doplsber == ""] <- NA

modify_tab <- doplsber %>% 
  mutate(Msberatel = ifelse(sberatel == "D. Hlisnikovskýet al.", "D. Hlisnikovský et al.", sberatel),
         Msberatel = ifelse(sberatel == "E.  Burša", "E. Burša", Msberatel),
         Mforma = ifelse(str_detect(Msberatel, "rev\\.|rev\\s"), "revize",
                                    ifelse(str_detect(Msberatel, " et | & "), "kolektiv", "")),
         MID = seq_along(sberatel)) %>%
  relocate(Msberatel, .after = "sberatel") %>%
  relocate(Mforma, .before = "sberatel") %>%
  separate(Msberatel, into=c("M", "MR_sbe") ,
           sep="rev\\s|,\\srev\\s|,\\srev\\.|,\\s\\srev\\.|,\\s\\srev\\s|;\\srev\\.|\\srev\\.|rev\\.", # oddeleni revizi do samost. sloupce
           remove = F, extra = "merge") %>%

  mutate(MR_sbe = str_trim(MR_sbe), # oriznout whitespace
         M = str_trim(M), # TRIM !!!

         MRforma = ifelse(str_detect(MR_sbe, " et | & "), "kolektiv", "revize")) %>%
  relocate(MRforma, .before = "MR_sbe") %>%

  separate(M, into=c("M1", "M2", "M3") , sep=",| et | a(?! J.)| &", remove = F, extra = "merge") %>%
  pivot_longer(
    cols = c(
      M1, M2, M3,
    ),
    names_to = "source", # poradi techniky
    values_to = "Mnames",
    values_drop_na = TRUE) %>%
  mutate(
    Mnames = str_trim(Mnames),
    MPJM = case_when(
                     str_detect(Mnames, "^\\w+$") ~ str_extract(Mnames, "^\\w+$"), # Vrubel
                     str_detect(Mnames, "^\\w\\.\\w+$") ~ str_extract(Mnames, "\\b\\w+$"), # A.Hájková
                     str_detect(Mnames, "^\\w+\\.$") ~ str_extract(Mnames, "^\\w+\\.$"), # D., al.
                     # str_detect(Mnames, "^\\w\\.\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # R. J. Vašut
                     # str_detect(Mnames, "^\\w\\.\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # R.J. Vašut
                     str_detect(Mnames, "^\\w+\\s\\w+$") ~ str_extract(Mnames, "\\w+$"),  # Miroslava Bilkova
                     # str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+\\.$") ~ str_extract(Mnames, "\\w+\\s\\w+\\.$"), # J. Chrtek jun.
                     # str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+$") ~ str_extract(Mnames, "\\w+\\s\\w+$"), # J. Chrtek jun
                     # str_detect(Mnames, "\\)$") ~ str_extract(Mnames, "\\w+\\s\\(\\w+\\)"), # O. Rotreklová (BRNU)
                     # str_detect(Mnames, "^[:upper:]{3}$") ~ str_extract(Mnames, "^[:upper:]{3}$"), # PVO
                     # str_detect(Mnames, "Ekrt L.|Hrabovský S.|Štech M.|Chytil P.|Danihelka J.") ~ word(Mnames, 1), # "Ekrt L."
                     TRUE ~ word(Mnames, 2)),
    MJM = case_when(str_detect(Mnames, "^\\w+\\.\\s+\\w+$") ~ str_extract(Mnames, "^\\w+\\."),  	# V. Dvořák
                    str_detect(Mnames, "^\\w+\\.\\w+$") ~ str_extract(Mnames, "^\\w+\\."),  # 	J.Danihelka
                    # str_detect(Mnames, "^\\w\\.\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\s\\w\\."),  # R. J. Vašut
                    # str_detect(Mnames, "^\\w\\.\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\w\\."),  # R.J. Vašut
                    str_detect(Mnames, "^\\w+\\s\\w+$") ~ str_extract(Mnames, "^\\w+"),  # Miroslava Bilkova
                    # str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+\\.$") ~ str_extract(Mnames, "^\\w+\\."), # J. Chrtek jun.
                    # str_detect(Mnames, "^\\w\\.\\s\\w+\\s\\w+$") ~ str_extract(Mnames, "^\\w+"), # J. Chrtek jun
                    # str_detect(Mnames, "\\)$") ~ str_extract(Mnames, "^\\w+\\."), # O. Rotreklová (BRNU)
                    # str_detect(Mnames, "^\\w\\.\\sa\\s\\w\\.\\s\\w+$") ~ str_extract(Mnames, "\\w\\.\\sa\\s\\w\\."), # L. a J. Reitmyerovi
                    # str_detect(Mnames, "Ekrt L.|Hrabovský S.|Štech M.|Chytil P.|Danihelka J.") ~ word(Mnames, 2), # "Ekrt L."
                    # str_detect(Mnames, "^\\w+\\.$") ~ str_extract(Mnames, ""), # al.
                    TRUE ~ "")) %>%
    # MTIT = case_when(str_detect(MJM, "doc.|Ing.") ~ str_extract(Mnames, "doc.|Ing."), TRUE ~ ""),
    # MJM = case_when(str_detect(MJM, "doc.|Ing.") ~  str_remove(MJM, "doc.|Ing."), TRUE ~ MJM)) %>%
  replace(is.na(.), "") %>%
    mutate(MKODOS = paste(MPJM, MJM)) %>%
  group_by(MID) %>%
  pivot_wider(names_from = source, values_from = c(MPJM, MJM, MKODOS)) %>%  # back to wide
  select(-Mnames) %>%
  # mutate_all(~na_if(., '')) %>%
  fill(MPJM_M1, .direction = "down") %>%
  fill(MPJM_M2, .direction = "down") %>%
  fill(MPJM_M2, .direction = "up") %>%
  fill(MPJM_M3, .direction = "up") %>%
  fill(MJM_M1, .direction = "down") %>%
  fill(MJM_M2, .direction = "down") %>%
  fill(MJM_M2, .direction = "up") %>%
  fill(MJM_M3, .direction = "up") %>%
  fill(MKODOS_M1, .direction = "down") %>%
  fill(MKODOS_M2, .direction = "down") %>%
  fill(MKODOS_M2, .direction = "up") %>%
  fill(MKODOS_M3, .direction = "up") %>%
  distinct() %>%
  ungroup() %>%
  unite(MKODOS_sbe, c("MKODOS_M1", "MKODOS_M2", "MKODOS_M3"), sep = ", ", na.rm = T, remove = FALSE) %>%
  relocate(MKODOS_sbe, .after = "Msberatel") %>%
  mutate(MKODOS_sbe = case_when(Mforma == "kolektiv" ~ sub(",([^,]*)$", " et\\1", MKODOS_sbe),
                             TRUE ~ MKODOS_sbe)) %>%
  # select(-(last_col(offset = 10):last_col())) %>%                                    # pozor pri zmene poradi sekci !!!!
  select(-Mforma, -Msberatel, -M, -MRforma, -contains(c("M1", "M2", "M3"))) %>% 
  mutate(MREV_POZN = ifelse(str_detect(MR_sbe, "J. Danihelka"), 
                            paste("Revize", MR_sbe), NA),
         MPORADI = "1", 
         MSBIRKA = "MUZBE",
         MPODSB = "Pb",
         MPODSBnaz = "botanika",
         MFOND = "bot",
         MFONDnaz = "botanika",
         MSKUP = "herbT",
         MSKUPnaz = "herbář Tracheophyta",
         X = NA) 

h <- modify_tab %>% 
  group_by(MINVC) %>% 
  filter(n() != 1)# filter(n()==1)


# C S V

mus_tab <- modify_tab %>% 
  select(
    '1SPCislo' = MINVC,                     # !! povinne !!
    '2sbirkaCisloEvidInt' = MSBIRKA,        # !! povinne !!
    '3podsbirkaCislo' = MPODSB,             # !! povinne !!
    '4poradi' = MPORADI,                    # !! povinne !!
    '5sberatelPredmetu' = MKODOS_sbe,       # !! povinne !!
    '6poznamka' = MREV_POZN)

oper_sberpred <- mus_tab
imp <- "sberPtu"

```



### bot ohrozeni

```{r DOPR OHROZENI}

# fetch tab 'prac_bot' (actualized TAXON NOMEN)

bot_ohr <- prac_bot %>% select(MINVC, MNOMEN, publikace)

# BACH
ohr <- modify_tab %>% 
  select(MINVC, publikace)
ohr[ohr == ""] <- NA
ohr[ohr == " "] <- NA

ohr_bach <- ohr %>% 
  drop_na(publikace) %>% 
  filter(str_detect(publikace, "taxon")) %>% 
  select(MINVC, MOHR = publikace)

sort(unique(ohr$publikace))

# REJSTRIK-SYSTEM !!! Tahle tabulka ma jenom mechy, zivocichy a houby !!!

dbname <- paste0("M:/03 klienti/kraj moravskoslezsky/muzeum beskyd - MUZBE/02 muzBE konverze/muzbe BIO/muzbePVO_DK.accdb") 
con <- RODBC::odbcConnectAccess2007(dbname)      
RODBC::sqlTables(con)

tab <- RODBC::sqlFetch(con, "Rejstřík_Systém") # !!! Tahle tabulka ma jenom mechy, zivocichy a houby !!!

ohr <- tab %>% 
  select(MPODSBIRKA, celed, druh_L, ochrana) %>% 
  drop_na(ochrana)

ohr_rej <- left_join(bot_ohr, ohr, by = c("MNOMEN" = "druh_L"), keep = T) %>% 
  select(MINVC, MOHR = publikace)

# AOPK

path_gd <- "C:/Users/krizova/Documents/R/gen_tabdata/"

aopk <- read_excel(paste0(path_gd, "cervene_seznamy_AOPK.xlsx")) %>% 
# aopk <- read_excel(paste0(path_data, "cervene_seznamy_AOPK.xlsx")) %>% 
  select(id_tax, ved_jm, kat_ohr_iucn)

ohr_aopk <- left_join(bot_ohr, aopk, by = c("MNOMEN" = "ved_jm"), keep = T) %>% 
  drop_na(kat_ohr_iucn) %>% 
  select(MINVC, MOHR = kat_ohr_iucn)

# COMBINE BACH+AOPK
# combine
ohr_comb <- rbind(ohr_bach, ohr_aopk)
# find duplicates
ohr_comb_dupl <- ohr_comb %>%   
  group_by(MINVC) %>% 
  filter(n() != 1)
# remove duplicated MINVC
ohr_comb <- rbind(ohr_bach, ohr_aopk) %>% 
  filter(!duplicated(MINVC)|n()==2)
```


## BOT FINALNI KONTROLA

```{r FIN KONTR}

fk_puv <- bot %>% 
  select(invc, mapa, ctverec, nvyska)

fk_mus <- modify_tab %>% 
  select(MINVC, mapa, Msour, Mmap_pozn, Mmap_scale, MNst, MNmin, MNvte, MEst, MEmin, MEvte, ctverec, MMNM, Mele_pznk) 

# pocty nadm vysek

fk_puv[fk_puv == ""] <- NA
fk_puv[fk_puv == "  "] <- NA
p <- fk_puv %>% filter(!is.na(nvyska)) #12607p <- fk_puv %>% filter(!is.na(nvyska)) #11437 (pred upravou 12607)
m <- fk_mus %>% filter(!is.na(MMNM)) #11437, mus 11437 ?

# souradnice
m <- fk_mus %>% filter(!is.na(MNst)) #1534, mus 1531 -> spatny format souradnic

p <- fk_puv %>% filter(str_detect(mapa, "WGS|°|,")) #1534
m <- fk_mus %>% filter(!is.na(MMNM)) 

# ctverec
p <- fk_puv %>% filter(str_detect(mapa, "WGS|°|,")) #1534
m <- fk_mus %>% filter(!is.na(MMNM)) 

# datace urceni

daturc <- modify_tab %>% 
  select(MINVC, urcil_d) %>% 
  drop_na(urcil_d) %>% #duplicity nejsou
  filter(str_detect(urcil_d, "rev|kusů", negate = T))
  # filter(str_detect(urcil_d, "kusů")) # pro zjisteni minvc, kde neni datace, ale kusy

# write.table(daturc, file = paste0(path_muzbe, "02 muzBE konverze/BIO/muzbe_datace_urceni.csv"), 
#             quote = T, row.names = F, 
#             sep = ";", dec = ",", 
#             na = "", fileEncoding="cp1250")

# synonyma

syn <- modify_tab %>% 
  select(MTAXON, MTAXKATEG, syn, '8nadrizenyTaxon', druh) 

syn[syn == ""] <- NA
syn[syn == " "] <- NA

syn <- syn %>% 
  filter(!is.na(syn)) %>% 
  distinct()


write.table(syn, file = paste0(path_muzbe, "02 muzBE konverze/muzbe BIO/muzbe_Pb_synonyma.csv"),
            quote = T, row.names = F,
            sep = ";", dec = ",",
            na = "", fileEncoding="cp1250")

dup <-  modify_tab %>% 
  select(MTAXON, MTAXKATEG, syn, '8nadrizenyTaxon', druh) 

dup[dup == ""] <- NA
dup[dup == " "] <- NA

dup <- dup %>% 
  filter(!is.na(syn)) %>% 
  group_by(syn) %>% 
  filter(n() != 1)

```


# A K V A R E L Y

```{r AKVARELY}

# L O A D

dbname <- paste0(path_muzbe, "02 muzBE konverze/BIO/muzbeBOT_DK.accdb") 
con <- RODBC::odbcConnectAccess2007(dbname)      

akv <- RODBC::sqlFetch(con, "lcl_akvarely")
# bot <- RODBC::sqlFetch(con, "lcl_botanika")   
# bry <- RODBC::sqlFetch(con, "lcl_mechorosty")   
# que <- RODBC::sqlFetch(con, "lcl_quercus")   

# B R O W S E 




```


### AKV: Inventarni a prirustkove cislo

invc = inventarni cislo  
sinvc = stare inv. cislo  
jcis = jine cislo   
prirc = prisrustkove cislo   

maska:  \{S\}\{#####\}\/\{A}  

```{r INVENTARNI CISLO}

# invc = puvodni -> rozdelit na radu a cislo (Mrada a Minvc)
# MPORC = pridani vedoucich nul k Minvc
# MINVC = finalni cislo <- kombinace Mrada a MPORCS dle masky inv.cisla

akv_invc <- akv %>% 
  separate(invc, into=c("Mrada", "Minvc") , sep=" ", extra = "merge", remove = FALSE) %>% 
  mutate(MPORC = str_pad(Minvc, 7, pad = "0")) %>% # 7 proto, ze pracujeme i s podlomenim, tzn 5 mist + 2 znaky = '/A'
  relocate(MPORC, .after = Minvc) %>% 
  mutate(MINVC = paste0(Mrada, MPORC)) %>% 
  relocate(MINVC, .after = MPORC)
  
```

"Umíme nahrát zkratku podsbírky před přírůstkovým čísle, ale nové přírůstky budou bez písmen na začátku." *(impl.dokument)*  

maska:  \{S\}\{####\}\/\{YYYY\}   

```{r PRIRUSTKOVE CISLO}

bot_prirc <- bot_invc %>% 
  separate(prirc, into=c("Mprir", "Mrok") , sep="/", extra = "merge", remove = FALSE) %>% 
  mutate(Mpodsb = "Pb") %>% 
  relocate(Mpodsb, .before = "Mprir")

  
```



# Q U E R C U S

```{r QUERCUS}

# L O A D

dbname <- paste0(path_muzbe, "02 muzBE konverze/muzbe BIO/muzbePVO_DK.accdb") 
con <- RODBC::odbcConnectAccess2007(dbname)      

# akv <- RODBC::sqlFetch(con, "lcl_akvarely")
# bot <- RODBC::sqlFetch(con, "lcl_botanika")   
# bry <- RODBC::sqlFetch(con, "lcl_mechorosty")   
que <- RODBC::sqlFetch(con, "lcl_Pb_quercus")

# S Y N O N Y M A

qsyn <- que %>% 
  select(MU_INVC, MU_NOMEN, syn) %>% 
  filter(!is.na(syn))

qsyn_un <- qsyn %>% select(-MU_INVC) %>% distinct()


```


### QUE: Inventarni a prirustkove cislo

invc = inventarni cislo  
sinvc = stare inv. cislo  
jcis = jine cislo   
prirc = prisrustkove cislo   

maska:  \{S\}\{#####\}\/\{Q}  

```{r INVENTARNI CISLO}

# invc = puvodni -> rozdelit na radu a cislo (Mrada a Minvc)
# MPORC = pridani vedoucich nul k Minvc
# MINVC = finalni cislo <- kombinace Mrada a MPORCS dle masky inv.cisla

que_invc <- que %>% 
  separate(invc, into=c("Mrada", "Minvc") , sep=" ", extra = "merge", remove = FALSE) %>% 
  mutate(MPORC = str_pad(Minvc, 7, pad = "0")) %>% # 7 proto, ze pracujeme i s podlomenim, tzn 5 mist + 2 znaky = '/Q'
  relocate(MPORC, .after = Minvc) %>% 
  mutate(MINVC = paste0(Mrada, MPORC)) %>% 
  relocate(MINVC, .after = MPORC)
  
```

"Umíme nahrát zkratku podsbírky před přírůstkovým čísle, ale nové přírůstky budou bez písmen na začátku." *(impl.dokument)*  

maska:  \{S\}\{####\}\/\{YYYY\}   

```{r PRIRUSTKOVE CISLO}

bot_prirc <- bot_invc %>% 
  separate(prirc, into=c("Mprir", "Mrok") , sep="/", extra = "merge", remove = FALSE) %>% 
  mutate(Mpodsb = "Pb") %>% 
  relocate(Mpodsb, .before = "Mprir")

  
```


# M E CH O R O S T Y

### MUZBE slovniky a data

Pro ucely pozadavku na pana Ondreje Zichu z BioLib.  
Potrebujeme ziskat BioLib slovnik pro skupinu Mechorostu.  

ID a stupen ohrozeni  

```{r SET DATABASE CONNECTION}

dbname <- paste0(path_muzbe, "02 muzBE konverze/zdrojdat/BIO/ciselnik_taxonu.mdb") # path to database
con <- RODBC::odbcConnectAccess2007(dbname)      # set the connection
cis <- RODBC::sqlFetch(con, "data")              # read specific table

dbname <- paste0(path_muzbe, "02 muzBE konverze/zdrojdat/BIO/mechorosty_Vrána.mdb") # path to database
con <- RODBC::odbcConnectAccess2007(dbname)      # set the connection
data <- RODBC::sqlFetch(con, "data")             # read specific table

# RODBC::sqlTables(con)                          # list tables in database

sel_cis <- cis %>% 
  select(taxon) %>% 
  distinct()                  # unikatni druhy z tabulky ciselnik

sel_data <- data %>% 
  select(taxon) %>%
  mutate(taxon = str_trim(taxon)) %>% 
  distinct()                  # unikatni druhy z tabulky data

check <- sel_cis %>% 
  full_join(sel_data, by = ("taxon" = "taxon"), keep = T) %>%             # unikatni druhy z obou tabulek
  mutate(MDRUH = coalesce(taxon.x, taxon.y)) %>%                          # vytvoreni sloupce druh
  separate(MDRUH, into=c("MROD", "rest") , sep=" ", extra = "merge") %>%  # vytvoreni sloupce rod
  select(MROD) %>%                                                        # vytazeni pouze potrebneho sloupce 
  distinct() %>%                                                          # pouze unikatni hodnoty pro rod
  arrange(MROD)                                                           # seradit abecedne
 
  
write.xlsx(check, file=paste0(path_csv, projekt, "_mechorosty_pozadavky_BioLib.xlsx"), 
           row.names = F, col.names = F)

bio_plant <- biolib %>%  # biolib = slovnik na zaklade accessu
  select(rod_Nomen) %>% 
  filter(!is.na(rod_Nomen)) %>% 
  distinct()

bio_mech <- check %>% 
  left_join(bio_plant, by = c("MROD" = "rod_Nomen"), keep = T)

nrow(bio_mech)
sum(is.na(bio_mech$rod_Nomen))

```

### BioLib mechy NOVÉ

Dostali jsme nová csv s daty pro mechorosty z BioLib. 

Je třeba:
  a) vytvořit strom,  
  b) porovnat s daty z MUZBE.  

```{r MECHOROSTY BIOLIB STROM}

com <- read.table(paste0(path_data, projekt, "/ComName.csv"), 
                   sep = ";", header = T, fileEncoding="cp1250")
tax <- read.table(paste0(path_data, projekt, "/TaxName.csv"), 
                   sep = ";", header = T, fileEncoding="cp1250")
ton <- read.table(paste0(path_data, projekt, "/Taxon.csv"), 
                   sep = ";", header = T, fileEncoding="cp1250")

# doplneni taxonomickyh kategorii na zaklade koncovek

tax_modif <- tax %>% 
  mutate(tn_name = str_trim(tn_name),
         MLEVEL = case_when(str_detect(tn_name, "\\ssubsp\\.|\\svar\\.|\\sf\\.|\\sß") ~ "poddruh",  
                            str_detect(tn_name, "^\\w+\\s\\w+$")|str_detect(tn_name, "-|\\?") ~ "druh", 
                            str_detect(tn_name, "\\ssubgen\\.|\\ssect\\.") ~ "rod",  
                            str_detect(tn_name, "^\\w+ae$") ~ "celed",  
                            str_detect(tn_name, "^\\w+ales$") ~ "rad",  
                            str_detect(tn_name, "^\\w+psida$") ~ "trida",  
                            str_detect(tn_name, "^\\w+phyta$") ~ "oddeleni", 
                            # str_detect(tn_name, "\\?") ~ "nejasne",  
                            TRUE ~ "jine"),
         MLEVEL = ifelse(MLEVEL == "jine" & !str_detect(tn_name, "\\s"), "rod", MLEVEL),
         MLEVEL = case_when(str_detect(tn_name, "Marchantiomorpha|Hepaticae|Musci") ~ "oddeleni", # specialni pripady -> rucni prepsani
                            TRUE ~ MLEVEL)) 
# %>% 
#   mutate(MTAXPOR = case_when(MLEVEL == "poddruh" ~ 7,
#                              MLEVEL == "druh" ~ 6,
#                              MLEVEL == "rod" ~ 5,
#                              MLEVEL == "celed" ~ 4,
#                              MLEVEL == "rad" ~ 3,
#                              MLEVEL == "trida" ~ 2,
#                              MLEVEL == "oddeleni" ~ 1)) 
#         
# jine <- tax_modif %>% 
#   filter(MLEVEL == "jine") 
# 
# poddruh <- tax_modif %>% 
#   filter(MLEVEL == "poddruh")
# 
# druh <- tax_modif %>% 
#   filter(MLEVEL == "druh")
# 
# rod <- tax_modif %>%
#   filter(MLEVEL == "rod")
# 
# celed <- tax_modif %>% 
#   filter(MLEVEL == "celed")
# 
# rad <- tax_modif %>% 
#   filter(MLEVEL == "rad")
# 
# trida <- tax_modif %>% 
#   filter(MLEVEL == "trida")
# 
# oddeleni <- tax_modif %>% 
#   filter(MLEVEL == "oddeleni")

# ******* SOUCTY SEDI -> KATEGORIE JSOU ROZRAZENY VSECHNY ******* 

# strom

wide <- spread(tax_modif,                                  # Applying spread function
                        key = MLEVEL,
                        value = tn_name) %>% 
  select(tn_id, tn_tx_id, tn_authority, tn_type, oddeleni, trida, rad, celed, rod, druh, poddruh) %>% 
  mutate(oddeleni_ID = ifelse(!is.na(oddeleni), tn_tx_id, NA),
         trida_ID = ifelse(!is.na(trida), tn_tx_id, NA), 
         rad_ID = ifelse(!is.na(rad), tn_tx_id, NA), 
         celed_ID = ifelse(!is.na(celed), tn_tx_id, NA), 
         rod_ID = ifelse(!is.na(rod), tn_tx_id, NA), 
         druh_ID = ifelse(!is.na(druh), tn_tx_id, NA), 
         poddruh_ID = ifelse(!is.na(poddruh), tn_tx_id, NA)) %>% 
  relocate(oddeleni_ID, .before = oddeleni) %>% 
  relocate(trida_ID, .before = trida) %>% 
  relocate(rad_ID, .before = rad) %>% 
  relocate(celed_ID, .before = celed) %>% 
  relocate(rod_ID, .before = rod) %>% 
  relocate(druh_ID, .before = druh) %>% 
  relocate(poddruh_ID, .before = poddruh) %>% 
  mutate(oddeleni_Autor = ifelse(!is.na(oddeleni), tn_authority, NA),
         trida_Autor = ifelse(!is.na(trida), tn_authority, NA), 
         rad_Autor = ifelse(!is.na(rad), tn_authority, NA), 
         celed_Autor = ifelse(!is.na(celed), tn_authority, NA), 
         rod_Autor = ifelse(!is.na(rod), tn_authority, NA), 
         druh_Autor = ifelse(!is.na(druh), tn_authority, NA), 
         poddruh_Autor = ifelse(!is.na(poddruh), tn_authority, NA)) %>% 
  relocate(oddeleni_Autor, .before = oddeleni) %>% 
  relocate(trida_Autor, .before = trida) %>% 
  relocate(rad_Autor, .before = rad) %>% 
  relocate(celed_Autor, .before = celed) %>% 
  relocate(rod_Autor, .before = rod) %>% 
  relocate(druh_Autor, .before = druh) %>% 
  relocate(poddruh_Autor, .before = poddruh) 


strom <- wide %>%
  mutate(BU_DRUH = druh,
         BU_PODDRUH = poddruh) %>% # backup column for druh and poddruh
  filter(tn_type == 0) %>%  # work only with preffered names, filter out synonyms (1)
  fill(oddeleni, .direction = "down") %>%  # group and fill the taxonomy
  fill(oddeleni_ID, .direction = "down") %>%  # group and fill BioLib ID
  fill(oddeleni_Autor, .direction = "down") %>%  # group and fill BioLib Autor
  fill(trida, .direction = "down") %>%  
  fill(trida_ID, .direction = "down") %>% 
  fill(trida_Autor, .direction = "down") %>% 
  
  group_by(oddeleni, trida) %>% 
  fill(rad, .direction = "down") %>% 
  fill(rad_ID, .direction = "down") %>% 
  fill(rad_Autor, .direction = "down") %>% 
  
  group_by(oddeleni, trida, rad) %>%
  fill(celed, .direction = "down") %>% 
  fill(celed_ID, .direction = "down") %>% 
  fill(celed_Autor, .direction = "down") %>% 
  
  group_by(oddeleni, trida, rad, celed) %>%
  fill(rod, .direction = "down") %>%  # zbytecne ?
  fill(rod_ID, .direction = "down") %>%  
  fill(rod_Autor, .direction = "down") %>%  
  # group_by(oddeleni, trida, rad, celed, rod) %>%
  # fill(druh, .direction = "down") %>% 
  # group_by(oddeleni, trida, rad, celed, rod, druh) %>%
  # fill(poddruh, .direction = "down") %>% 
  ungroup() %>% 
  mutate(rod = ifelse(is.na(druh), word(poddruh, 1), word(druh, 1))) %>% # take rod from the druh name (= more precise)
  mutate(druh = ifelse(is.na(druh), paste(word(poddruh, 1), word(poddruh, 2)), druh), # take rod from the druh name (= more precise)
         druh = gsub("NA NA", NA, druh)) %>%
  unite(sys_tree, c("oddeleni", "trida", "rad", "celed", "rod", "druh"), # "poddruh"
        sep = "/", na.rm = T, remove = FALSE) %>%   # create systematic tree
  relocate(sys_tree, .after = tn_type)
  
# druhy <- strom %>% 
#   filter(!is.na(BU_DRUH)|!is.na(BU_PODDRUH)) # POZOR ! Nesedi vzdy..

length(unique(strom$rod)) # 593


rm(com)
rm(tax)
rm(ton)

strom1 <- strom %>% 
  select(-BU_DRUH, -BU_PODDRUH)

write.table(strom1, file = "M:/02 dokumenty/03 migrace/BIO/BRYOLOGIE/BioLib_Bryologie_strom_KK.txt", 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
```

### BioLib slovnik PLANTAE+BRYOPHYTA

```{r}

# BioLib Plantae

bl_plant <- read.table(paste0(path, "bioslov/BioLib_KKsummary_plantae.csv"), sep = ";", header = T)

sel_biol <- bl_plant %>% 
  mutate(kmen = coalesce(kmen_Nomen, trida_NadNomen),
         trida = coalesce(trida_Nomen, rad_NadNomen),
         rad = coalesce(rad_Nomen, celed_NadNomen),
         celed = coalesce(celed_Nomen, rod_NadNomen),
         rod = coalesce(rod_Nomen, druh_NadNomen),
         druh = coalesce(druh_Nomen, poddruh_NadNomen),
         poddruh = poddruh_Nomen) %>% 
  unite(sys_tree_BIOL, c(
    # "kmen",  # ? does data have 'kmen' ?
    # "trida", "rad", 
    "celed", "rod", "druh_Nomen"
    # ,"poddruh"
    )
    ,sep = "/", na.rm = T, remove = FALSE) %>% 
  select(sys_tree_BIOL, druh, druh_Autor 
         # ,poddruh, poddruh_Autor # ? does data have 'poddruh' ?
         ) %>% 
  distinct()

bl_plantmech <- biolib %>%  # filtr pro mechy
  filter(kmen_Nomen %in% c("Anthocerotophyta", "Marchantiophyta", "Bryophyta"))
length(unique(bl_plantmech$rod_Nomen)) # 252
colnames(bl_plantmech)

# BioLib Bryophyta

bl_mech <- strom %>% 
  select(-BU_DRUH,-BU_PODDRUH) %>% 
  rename(oddeleni_Nomen = oddeleni, trida_Nomen = trida, rad_Nomen = rad, celed_Nomen = celed, 
         rod_Nomen = rod, druh_Nomen = druh, poddruh_Nomen = poddruh)

length(unique(bl_mech$rod_Nomen)) # 593
colnames(bl_mech)

# autori

# bl_mech <- left_join(bl_mech, bl_id_aut, by = c("oddeleni_ID" = "tn_tx_id")) %>% 
#   rename(oddeleni_Autor = tn_authority.y) %>% 
#   relocate(oddeleni_Autor, .after = oddeleni_Nomen)
# 
# bl_mech <- left_join(bl_mech, bl_id_aut, by = c("trida_ID" = "tn_tx_id")) %>% 
#   rename(trida_Autor = tn_authority) %>%
#   relocate(trida_Autor, .after = trida_Nomen)
# 
# bl_mech <- left_join(bl_mech, bl_id_aut, by = c("rad_ID" = "tn_tx_id")) %>% 
#   rename(rad_Autor = tn_authority) %>%
#   relocate(rad_Autor, .after = rad_Nomen)
#   
# bl_mech <- left_join(bl_mech, bl_id_aut, by = c("celed_ID" = "tn_tx_id")) %>% 
#   rename(celed_Autor = tn_authority) %>%
#   relocate(celed_Autor, .after = celed_Nomen)
#   
# bl_mech <- left_join(bl_mech, bl_id_aut, by = c("rod_ID" = "tn_tx_id")) %>% 
#   rename(rod_Autor = tn_authority) %>%
#   relocate(rod_Autor, .after = rod_Nomen)
#   
# bl_mech <- left_join(bl_mech, bl_id_aut, by = c("druh_ID" = "tn_tx_id")) %>% 
#   rename(druh_Autor = tn_authority) %>%
#   relocate(druh_Autor, .after = druh_Nomen)
#   
# bl_mech <- left_join(bl_mech, bl_id_aut, by = c("poddruh_ID" = "tn_tx_id")) %>% 
#   rename(poddruh_Autor = tn_authority) %>%
#   relocate(poddruh_Autor, .after = poddruh_Nomen)
  
# RBIND

colnames(bl_plantmech)
colnames(bl_mech)


pb <- bl_plantmech %>% 
  mutate(source = "BL Plantae", # filter jen pro Bryo
         oddeleni_ID = NA, 
         oddeleni_Nomen = NA,
         oddeleni_Autor = NA)

length(unique(pb$druh_Nomen)) # 936
length(unique(pb$poddruh_Nomen)) # 10

bb <- bl_mech %>% 
  mutate(source = "BL Bryo", 
         kmen_ID = NA, 
         kmen_Nomen = NA,
         kmen_Autor = NA)

length(unique(bb$druh_Nomen)) # 9092
length(unique(bb$poddruh_Nomen)) # 135

# kontrola prekryvu 

prekryv <- intersect(pb$druh_Nomen, bb$druh_Nomen) # 902
prekryv2 <- intersect(pb$poddruh_Nomen, bb$poddruh_Nomen) # 10

# CZ

czm <- com %>% 
  filter(tvn_type == 0)

mechCZ <- bl_mech

mechCZ <- left_join(mechCZ, czm %>% select(tvn_name, tvn_tx_id), by = c("oddeleni_ID" = "tvn_tx_id")) %>% 
  relocate(tvn_name, .after = oddeleni_Nomen) %>% 
  rename(oddeleni_Nazev = tvn_name)

mechCZ <- left_join(mechCZ, czm %>% select(tvn_name, tvn_tx_id), by = c("trida_ID" = "tvn_tx_id")) %>% 
  relocate(tvn_name, .after = trida_Nomen) %>% 
  rename(trida_Nazev = tvn_name)

mechCZ <- left_join(mechCZ, czm %>% select(tvn_name, tvn_tx_id), by = c("rad_ID" = "tvn_tx_id")) %>% 
  relocate(tvn_name, .after = rad_Nomen) %>% 
  rename(rad_Nazev = tvn_name)

mechCZ <- left_join(mechCZ, czm %>% select(tvn_name, tvn_tx_id), by = c("celed_ID" = "tvn_tx_id")) %>% 
  relocate(tvn_name, .after = celed_Nomen) %>% 
  rename(celed_Nazev = tvn_name)

mechCZ <- left_join(mechCZ, czm %>% select(tvn_name, tvn_tx_id), by = c("rod_ID" = "tvn_tx_id")) %>% 
  relocate(tvn_name, .after = rod_Nomen) %>% 
  rename(rod_Nazev = tvn_name)

mechCZ <- left_join(mechCZ, czm %>% select(tvn_name, tvn_tx_id), by = c("druh_ID" = "tvn_tx_id")) %>% 
  relocate(tvn_name, .after = druh_Nomen) %>% 
  rename(druh_Nazev = tvn_name)

mechCZ <- left_join(mechCZ, czm %>% select(tvn_name, tvn_tx_id), by = c("poddruh_ID" = "tvn_tx_id")) %>% 
  relocate(tvn_name, .after = poddruh_Nomen) %>% 
  rename(poddruh_Nazev = tvn_name)

```


### mechy porovnani

- nove promenne pro praci na porovnani  
- zjistit, zda jsou data z databaze v ciselniku dodanem klientem  
- zjistit, zda jsou data v BioLib slovniku pro Plantae (-> overeny BioLib strom -> PREFEROVANE)
- zjistit, zda jsou data v BioLib slovniku pro Bryophyta (-> slovnik semtam nesedi -> POUZE PRO NUTNE PRIPADY)  
--> vytvorit tabulku: data - ciselnik - biolib Plantae - biolib Bryophyta

```{r MECHOROSTY BIOLIB POROVNANI}

mechy_data <- sel_data # n = 491
mechy_cis <- sel_cis   # n = 902
biolib_pl <- sel_biol  # n = 6528
biolib_bry <- druhy    # n = 9226


# 1) jsou vsechna data ve slovniku (ciselniku)?

# data 491
# ciselnik 902

colnames(mechy_data) <- paste0("data")
colnames(mechy_cis) <- paste0("cis")

mechy_data <- mechy_data %>% 
  mutate(clean_sp = paste(word(data, 1), word(data, 2)), # osekat na druhy (bez poddruhu, autoru)
         clean_sp = ifelse(str_detect(clean_sp, "^\\w+\\sNA$"), word(clean_sp, 1), clean_sp)) # v nekterych pripadech bylo zapsano 'Sphagnum NA' -> odstraneni NA

st1 <- left_join(mechy_data, mechy_cis, by = c("data" = "cis"), keep = T) %>%
  select("DB_data" = data,
         "DB_ciseln" = cis,
         "DB_clean" = clean_sp)

chybi_v_cis <- st1 %>% 
  filter(is.na(DB_ciseln))


# 2) data vs. puvodni biolib plantae?

# data 491
# biolib plantae 6528

st2 <- left_join(st1, biolib_pl, by = c("DB_clean" = "druh"), keep = T) %>% 
  select(DB_data, DB_ciseln, DB_clean,
         "BLPL_tree" = sys_tree_BIOL,
         "BLPL_druh" = druh,
         "BLPL_autor" = druh_Autor)

chybi_v_biolpl <- st2 %>% 
  filter(is.na(BLPL_druh))

# 3) data vs. novy biolib mechy?

# data 491
# biolib plantae 9226

st3 <- left_join(st2, biolib_bry, by = c("DB_clean" = "druh"), keep = T) %>% 
  distinct() %>% 
  select(DB_data, DB_ciseln, DB_clean, BLPL_tree, BLPL_druh, BLPL_autor,
         "BLBR_tree" = sys_tree,
         "BLBR_druh" = druh,
         "BLBR_autor" = tn_authority)

chybi_v_biolbr <- st3 %>% 
  filter(is.na(BLBR_druh))

chybi_uplne <- st3 %>% 
  filter(is.na(BLBR_tree)&is.na(BLPL_tree))

# synonyma ?

synon <- wide %>%
  mutate(BU_DRUH = druh,
         BU_PODDRUH = poddruh,
         rn = row_number()) %>% # backup column for druh and poddruh
  filter(tn_type == 1) 

rn <- synon$rn # synonyma
rn1 <- synon$rn+1 # radek za synonymem -> k nemu se synonymum vaze
rnfin <- c(rn, rn1) # identifikace radku, se synonymy ?

# tohle neni dobre -> pracuj s tn_tx_id !!!!!!! group apod

syn <- wide %>% 
  slice(rnfin) # filtruj radky dle row number identifikovane vyse

```



### MECH: Adresar
  
Pripady:  
1) Krizova   
2) Krizova K.  
3) Krizova K. et | & | ed | , Novak V.  
4) Krizova & Novak  
5) anonymni darce  
6) Chytil Petr, Mgr.  
7) JUDr. Cejchoň  
8) MěÚ Frýdlant. n. O., odbor ŽP  
9) Poloczek B. (Poloček B.)  
10) pracovníci zemědělského družstva  
11) T.Kukulka  
12) Pustka St.  
13) Lukáš J. sen  

```{r MODIF ADRESAR}

dbname <- paste0(path_muzbe, "02 muzBE konverze/zdrojdat/BIO/Databaze_PVO.accdb") # path to database
con <- RODBC::odbcConnectAccess2007(dbname, pwd = "Fazole")      # set the connection
adr <- RODBC::sqlFetch(con, "Rejstřík_Adresar")              # read specific table

# modify

# 1-2
simple <- adr %>% 
  filter(str_detect(symbol, "\\s\\w\\.$")|str_detect(symbol, "^\\w+$")) %>%
  filter(!str_detect(symbol, "\\s(et|&|ed|rev)")) %>% 
  filter(!str_detect(symbol, ",")) %>% 
  mutate(MA = "simple") %>% 
  mutate(MPRIJM = word(symbol, 1),
         MJM = ifelse(!is.na(jmeno), jmeno, word(symbol, 2)),
         MTIT = "", 
         MPOZN = "")
  
# 3-4
combi <- adr %>% 
  filter(str_detect(symbol, "\\s(et|&|ed|rev)|,")) %>% 
  filter(!str_detect(symbol, "Mgr.|Frýdlant")) %>%  # n = 36
  mutate(MA = "combi") %>% 
  mutate(MCOMBI = strsplit(as.character(symbol), ",")) %>%
  unnest(MCOMBI) %>%
  mutate(MCOMBI = gsub("rev.", "", MCOMBI),
         MCOMBI = str_trim(MCOMBI),
         MPRIJM = case_when(str_detect(MCOMBI, "^\\w+\\s\\w\\.$") ~ word(MCOMBI, 1),
                            TRUE ~ MCOMBI),
         MJM = case_when(str_detect(MCOMBI, "^\\w+\\s\\w\\.$") ~ word(MCOMBI, 2),
                            TRUE ~ ""),
         MTIT = "", 
         MPOZN = "") %>%
  select(-MCOMBI)


# 5-13
extra <- adr %>% 
  filter(str_detect(symbol, "anonym|Mgr|JUDr.|Frýdlant|Poloczek|pracovníci|T.Kukulka|St.$|\\ssen$")) %>% 
  mutate(MA = "extra") %>% 
  mutate(MPRIJM = case_when(str_detect(symbol, "anonym") ~ "anonymní dárce",
                            str_detect(symbol, "Mgr") ~ "Chytil",
                            str_detect(symbol, "JUDr.") ~ "Cejchoň",
                            str_detect(symbol, "Frýdlant") ~ "MěÚ Frýdlant. n. O., odbor ŽP",
                            str_detect(symbol, "Poloczek") ~ "Poloczek",
                            str_detect(symbol, "pracovníci") ~ "pracovníci zemědělského družstva",
                            str_detect(symbol, "T.Kukulka") ~ "Kukulka",
                            str_detect(symbol, "St.$") ~ "Pustka",
                            str_detect(symbol, "\\ssen$") ~ "Lukáš"),
         MJM = case_when(str_detect(symbol, "Mgr") ~ "Petr",
                         str_detect(symbol, "Poloczek") ~ "B.",
                         str_detect(symbol, "Kukulka") ~ "T."),
         MTIT = case_when(str_detect(symbol, "Mgr") ~ "Mgr.",
                          str_detect(symbol, "JUDr.") ~ "JUDr.", TRUE ~ ""), 
         MPOZN = case_when(str_detect(symbol, "Poloczek") ~ "Poloček B.",
                           str_detect(symbol, "St.$") ~ "St.",
                           str_detect(symbol, "\\ssen$") ~ "sen", TRUE ~ "")) 

# back together
df1 <- rbind(simple, combi)
df <- rbind(df1, extra)

check <- left_join(adr, df, by = "symbol", all.x = T, keep = T) %>% 
  select(symbol.x, symbol.y) 

sum(is.na(check))


```

```{r IMPORT CSV ADRESAR}

# M O D I F Y

modify_tab <- df %>% 
  mutate(X = "",
         '1typSubjektuKod' = "OO",
         '10osobaPohlavi' = "neznámé",  # povinne: "muž", "žena", "neznámé"
         '18subjektStatKod' = "CZ") %>% 
  unite('2subjektKod', c(MPRIJM, MJM), na.rm = T, remove = FALSE, sep = " ")

modif_save <- paste0(path_csv, projekt, "_modif_adresar.csv")

if(file.exists(modif_save)){
  print("You've been here before!")
} else {
  write.table(modify_tab, file = modif_save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Operational file  S A V E D  !")
  }

# C R E A T E    C S V

mus_tab <- modify_tab %>% 
  select('1typSubjektuKod' = '1typSubjektuKod', # !! povinne !!
         '2subjektKod' = '2subjektKod',         # !! povinne !!
         '3subjektAlterKod' = X, '4osobaJmenoPrvni'= MJM, 
         '5osobaJmenoDruhe' = X, 
         '6osobaPrijmeni' = MPRIJM,         # !! povinne !!
         '7osobaTitulPredJmenem' = MTIT, '8osobaTitulZaJmenem' = X, 
         '9osobaRodnePrijmeni' = X, 
         '10osobaPohlavi' = '10osobaPohlavi',   # !! povinne !! "muž", "žena", "neznámé"
         
         '11osobaDatumNarozeni' = X, '12osobaMistoNarozeni' =X,
         '13okresNarozeniNazev' = X, '14obecNarozeniNazev' = X,
         '15statNarozeniKod' = X, '16osobaDatumUmrti' = X,
         '17osobaMistoUmrti' = X, 
         
         '18subjektStatKod' = '18subjektStatKod',
         '19kontaktEmail' = X, '20kontaktMobil' = X,
         '21kontaktMobil2' = X, '22kontaktTelefon' = X,
         '23kontaktInternet' = X, '24kontaktInternetoveVolani' = X,
         '25adresaText' = X, '26kontaktniAdresaText' = X,
         '27fyzickaOsobaRodneCislo' = X, '28subjektPoznamka' = poznamka, # kam MPOZN ???
         
         '29AdresaTextoveOkres' = X, '30AdresaTextoveObec' = mesto,
         '31AdresaTextoveCastObce' = X, '32AdresaTextoveMestskaCast' = X,
         '33AdresaTextoveUlice' = ulice, '34AdresaTextoveCisloOrientacni' = cp,
         '35AdresaTextoveCislo' = X, '36AdresaTextovePSC' = psc,
         
         '37zamestnanecCislo' = X, '38oddeleniKod' = X,
         '39osobnostMedailon' = X, '40osobnostPseudonym' = X,
         '41okruhSubjektuNazev' = X, '42subjektSbirka' =  X,           
         '43subjektPodsbirka' =  X, '44osobaStudia' = X,
         '45osobaSpolky' = X, '46osobaOsobnost' = X,
         '47subjektDatumOd' = X, '48subjektDatumDo' = X,
         '49kontaktEmail2' = X, 
         '50text1' = X, '51text2' = X, '52text3' = X, 
         '53role1' = X, '54role2' = X, 
         '55role3' = X, '56role4' = X, '57$role5' = X,
         rel_ZkrJm = symbol)

oper_MECHadresar <- mus_tab %>% 
  select(rel_ZkrJm, '1typSubjektuKod', '2subjektKod', '4osobaJmenoPrvni', '6osobaPrijmeni')
imp <-"MECHadresar"

```


# ~ O B R A Z K Y ~

**DEMUS**: (slozka s obrazky)
**MUSEION**: import_obrazky.csv (muze byt vice slozek)

**IMPORTNÍ ROZHRANNÍ**: CSV Import souborových příloh 

- udelat vypis souboru v cmd  
- seznam cest k souborum  
- naparovat s MINVC

V MUSEIONU: Další agendy -> Multimédia/přílohy -> Import souborových příloh


*MUZBE ACCDB:*

Diapozitivy - HOT   
Foto - HOT   
Lesnicka sbirka - HOT    
MB_PVO  (?)   
Negativy  - IP
Obecne sbirky 1  (?) - NEMIG  
Obecne sbirky 2  (?)  - NEMIG  
Obecne sbirkyy - 4 slozky - IP @EVA
Prirustkova kniha  (?) 
Rukopisy (?)   

```{r OBRAZKY PRIPOJENI DATABAZE}

# L O A D

# dbname <- paste0(path_muzbe, "02 muzBE konverze/BIO/muzbeBOT_DK.accdb") 
dbname <- paste0(path_muzbe, "02 muzBE konverze/SVO/MUZBE-SVO.accdb") 
con <- RODBC::odbcConnectAccess2007(dbname)      

RODBC::sqlTables(con)

# v <- "diap"
# v <- "foto"
# v <- "les"

# sez <- RODBC::sqlFetch(con, "diapozitivy")
# sez <- RODBC::sqlFetch(con, "foto")
# sez <- RODBC::sqlFetch(con, "lesnicka")
sez <- RODBC::sqlFetch(con, "negativy")
# sez <- RODBC::sqlFetch(con, "obecne")   
# sez <- RODBC::sqlFetch(con, "obecne1")   
# sez <- RODBC::sqlFetch(con, "PrirustkySVO")   
# sez <- RODBC::sqlFetch(con, "rukopisy")   

```

## Diapozitivy HOTOVE

```{r OBR DIAP}


# DATABASE CONNECTION

v <- "diap"
sez <- RODBC::sqlFetch(con, "diapozitivy")

# LIST OF KD

vypis <- as.data.frame(list.files("D:/MUZBE/Diapozitivy/Image", full.names = T)) #  s w i t c h !!!
colnames(vypis)[1] <- "path"

vypis <- vypis %>% 
  separate(path, into = c("disc", "project", "subject", "image", "file", "ext"), 
           sep = "\\/|\\.", extra = "merge", remove = FALSE) %>% 
  mutate(MFN = paste0(file, ".", ext)) %>% 
  mutate(MFC = sub("\\s", "", file)) %>%  # foto
  # separate(file, into = c("file", "multi"), sep = "\\s|-", extra = "merge", remove = FALSE) %>% # diap
  separate(MFC, into = c("MFC", "multi"), sep = "\\s|-", extra = "merge", remove = FALSE) %>% # foto
  select(MFN, MFC, file, multi, ext)


# SEZNAM INVC

# sez_ch <- sez %>% 
#   select(invc, MINVC, MINVChorni, MINVCPozn, MPORCISLO, MPORCISLOhorni, MSUBCISLO, MSUBCISLOhorni)

sez <- sez %>% 
  select(invc, MINVC) %>% 
  # separate(invc, into = c("rada", "cislo", "subcislo"),
  #          sep = "\\s|\\/", extra = "merge", remove = FALSE) %>%
  # replace(is.na(.), "") %>% 
  mutate(
         cislo = str_extract(MINVC, ".....$"),# diap
         rada = str_extract(MINVC, "^."), # diap
         cislo = as.numeric(cislo),# diap
         Mcislo = ifelse(cislo < 1000, str_pad(cislo, 3, pad = "0"), str_pad(cislo, 4, pad = "0")), # diap
         MFC = paste0(rada, Mcislo))

  
# R E L A T E 

# relace <- left_join(vypis, sez, by = c("file" = "MFC"), keep = T) # diap
relace <- left_join(vypis, sez, by = c("MFC" = "MFC"), keep = T) # foto

# N E S P A R O V A N E

nesparovane <- relace %>% 
  filter(is.na(MINVC)) %>% 
  select(MFN) 
write.table(nesparovane, file = paste0(path_kd, projekt, "_vypis_nesparovane_", v, ".csv"), 
            sep = ";", quote = T, row.names = F, col.names = F, 
            na = "", fileEncoding="cp1250")

# vypis n = 14976
# mus_tab n = 14730
# nesparovane n = 243

print(count(vypis)-count(mus_tab)) # = n(nesparovane) ?


modify_tab <- relace %>%
  select(MFN, MINVC) %>% 
  group_by(MINVC) %>% 
  mutate(MPORADI = seq_along(MINVC)) %>% 
  ungroup() %>%
  mutate(X = "",
         '1uloha' = "PREDMET_PRIVATE",
         '6url' = MFN,
         '7nahled' = ifelse(MPORADI == 1, "1", "0"),       # priznak {0;1}                       
         # '7nahled' = case_when('3poradi' == 1 ~ "1", 
         #                       TRUE ~ "0"),       # priznak {0;1}                       
         '8vodoznak' = 0,      # priznak {0;1}                  
         '9tisk1' = 0,          # priznak {0;1}                     
         '10tisk2' = 0)  %>%        # priznak {0;1}     ) %>% 
  filter(!is.na(MINVC)) # odfiltrovat nesparovane   # H 11 U : 452a ; 452b

modif_save <- paste0(path_kd, projekt, "_modif_obrazky_", v, ".csv")  

if(file.exists(modif_save)){
  print("You've been here before!")
} else {
  write.table(modify_tab, file = modif_save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Operational file  S A V E D  !")
  }

# C R E A T E    C S V

mus_tab <- modify_tab %>%  
  select(
    '1uloha' = '1uloha',   # !! povinne !!                            
    '2cislo' = MINVC,   # !! povinne !!     
    '3poradi' = MPORADI,   # !! povinne !!          
    '4nazev' = X,                                   
    '5typDokumentuNazev' = X,          
    '6url' = '6url',    # !! povinne !!
    '7nahled' = '7nahled',       # priznak {0;1}                       
    '8vodoznak' = '8vodoznak',      # priznak {0;1}                  
    '9tisk1' = '9tisk1',          # priznak {0;1}                     
    '10tisk2' = '10tisk2',         # priznak {0;1}                   
    '11poznamka' = X, 
    '12neDigitalni' = X, 
    '13umisteni' = X, 
    '14publikace' = X, 
    '15literaturaNazev' = X, 
    '16literaturaSlovy' = X, 
    '17APlicenceCC' = X, 
    '18APvariantaCCOznaceni' = X, 
    '19APautorSubjektKod' = X, 
    '20APdrzitelSubjektKod' = X, 
    '21APtypLicence' = X, 
    '22APcasovaLicence' = X, 
    '23APuzemniLicence' = X, 
    '24APmnozstevniLicence' = X, 
    '25APdatumVyprseni' = X, 
    '26APpoznamka' = X
    )                    

oper_obrazky_diap <- mus_tab  #  s w i t c h !!!

# S A V E   I M P O R T   C S V

save <- paste0(path_kd, projekt, "_import_obrazky_", v, ".csv")  

if(file.exists(save)){
  print("You've been here before!")
} else {
  write.table(mus_tab, file = save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  }

  
# I M P O R T   C H E C K 

mus_imp <- read_excel(paste0(path_kd, "diap/KontextovyDokument_export fin.xlsx")) %>%  #  s w i t c h !!!
  select(Číslo, URL) %>% 
  mutate(MFN = sub("_original", "", URL))

csv_imp <- read.csv(paste0(path_kd, "diap/MUZBE_import_obrazky_diap.csv"), sep = ";") 
  # select(X2cislo, X6url)

imp_check <- left_join(csv_imp, mus_imp, by = c("X6url" = "MFN"), keep = T) %>% 
  filter(is.na(Číslo))

# aftermath

vypis_list <- select(vypis, MFN) 
mus_list <- select(mus_imp, MFN)

fin_imp <- left_join(vypis_list, mus_list, keep = T) %>% 
  filter(is.na(MFN.y))

```

## Foto HOTOVE 

```{r OBR FOTO}


# DATABASE CONNECTION

v <- "foto"
sez <- RODBC::sqlFetch(con, "foto")

# LIST OF KD

vypis <- as.data.frame(list.files("D:/MUZBE/Foto/Image", full.names = T)) 
colnames(vypis)[1] <- "path"

vypis <- vypis %>% 
  separate(path, into = c("disc", "project", "subject", "image", "file", "ext"), 
           sep = "\\/|\\.", extra = "merge", remove = FALSE) %>% 
  mutate(MFN = paste0(file, ".", ext),
         Mrada = "F",
         Mcislo = sub("F ", "", file), 
         Mcislo = sub("^0+", "", Mcislo)) %>% 
  mutate(MFC = paste0(Mrada, Mcislo)) %>%  # foto
  separate(MFC, into = c("MFC", "multi"), sep = "\\s|-", extra = "merge", remove = FALSE) %>%
  mutate(MFC = ifelse(str_detect(MFC, "[:alpha:]$"), sub("[:alpha:]$", "", MFC), MFC)) %>% 
  select(MFN, MFC, file, multi, ext)


# SEZNAM INVC

sez <- sez %>% 
  select(invc, MINVC) %>% 
  
  mutate(cislo = substr(MINVC, 2, 6), 
         rada = str_extract(MINVC, "^."),
         Mcislo = sub("^0+", "", cislo), 
         MFC = paste0(rada, Mcislo))

  
# R E L A T E 

relace <- left_join(vypis, sez, by = c("MFC" = "MFC"), keep = T) 

# N E S P A R O V A N E

nesparovane <- relace %>% 
  filter(is.na(MINVC)) %>% 
  select(MFN)  

write.table(nesparovane, file = paste0(path_kd, projekt, "_vypis_nesparovane_", v, ".csv"), 
            sep = ";", quote = T, row.names = F, col.names = F, 
            na = "", fileEncoding="cp1250")

# vypis n = 14976
# mus_tab n = 14730
# nesparovane n = 243

print(count(vypis)-count(mus_tab)) # = n(nesparovane) ? 


# M O D I F Y

# v pripade dvokoloveho prirazovani: 

modify_tab <- relace %>%
  select(MFN, MINVC) %>% 
  group_by(MINVC) %>% 
  mutate(MPORADI = seq_along(MINVC)) %>% 
  ungroup() %>%
  mutate(X = "",
         '1uloha' = "PREDMET_PRIVATE",
         '6url' = MFN,
         '7nahled' = ifelse(MPORADI == 1, "1", "0"),       # priznak {0;1}                       
         # '7nahled' = case_when('3poradi' == 1 ~ "1", 
         #                       TRUE ~ "0"),       # priznak {0;1}                       
         '8vodoznak' = 0,      # priznak {0;1}                  
         '9tisk1' = 0,          # priznak {0;1}                     
         '10tisk2' = 0)  %>%        # priznak {0;1}     ) %>% 
  filter(!is.na(MINVC)) # odfiltrovat nesparovane   # H 11 U : 452a ; 452b

modif_save <- paste0(path_kd, projekt, "_modif_obrazky_", v, ".csv")  

if(file.exists(modif_save)){
  print("You've been here before!")
} else {
  write.table(modify_tab, file = modif_save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Operational file  S A V E D  !")
  }

# C R E A T E    C S V

mus_tab <- modify_tab %>%  
  select(
    '1uloha' = '1uloha',   # !! povinne !!                            
    '2cislo' = MINVC,   # !! povinne !!     
    '3poradi' = MPORADI,   # !! povinne !!          
    '4nazev' = X,                                   
    '5typDokumentuNazev' = X,          
    '6url' = '6url',    # !! povinne !!
    '7nahled' = '7nahled',       # priznak {0;1}                       
    '8vodoznak' = '8vodoznak',      # priznak {0;1}                  
    '9tisk1' = '9tisk1',          # priznak {0;1}                     
    '10tisk2' = '10tisk2',         # priznak {0;1}                   
    '11poznamka' = X, 
    '12neDigitalni' = X, 
    '13umisteni' = X, 
    '14publikace' = X, 
    '15literaturaNazev' = X, 
    '16literaturaSlovy' = X, 
    '17APlicenceCC' = X, 
    '18APvariantaCCOznaceni' = X, 
    '19APautorSubjektKod' = X, 
    '20APdrzitelSubjektKod' = X, 
    '21APtypLicence' = X, 
    '22APcasovaLicence' = X, 
    '23APuzemniLicence' = X, 
    '24APmnozstevniLicence' = X, 
    '25APdatumVyprseni' = X, 
    '26APpoznamka' = X
    )                    

oper_obrazky_foto <- mus_tab  

# S A V E   I M P O R T   C S V

save <- paste0(path_kd, projekt, "_import_obrazky_", v, ".csv")  

if(file.exists(save)){
  print("You've been here before!")
} else {
  write.table(mus_tab, file = save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
}


# I M P O R T   C H E C K 

mus_imp <- read_excel(paste0(path_kd, "foto/KontextovyDokument_export (2).xlsx")) %>%  #  s w i t c h !!!
  select(Číslo, URL) %>% 
  mutate(MFN = sub("_original", "", URL))

csv_imp <- read.csv(paste0(path_kd, "foto/MUZBE_import_obrazky_foto.csv"), sep = ";") %>% 
  mutate(Murl = sub("JPG", "jpg", X6url))
  # select(X2cislo, X6url)

imp_check <- left_join(csv_imp, mus_imp, by = c("Murl" = "MFN"), keep = T) %>% 
  filter(is.na(Číslo))

# aftermath

mus_list <- select(mus_imp, MFN)
vypis_list <- select(vypis, MFN) 


fin_imp <- left_join(vypis_list, mus_list, keep = T) %>% 
  filter(is.na(MFN.y))


```
## Lesnicka HOTOVE


```{r OBR LES}


# LIST OF FILES

vypis <- as.data.frame(list.files("D:/MUZBE/Lesnická sbírka/Image", full.names = T)) 
colnames(vypis)[1] <- "path"

vypis <- vypis %>% 
  separate(path, into = c("disc", "project", "subject", "image", "file", "ext"), 
           sep = "\\/|\\.", extra = "merge", remove = FALSE) %>% 
  mutate(MFN = paste0(file, ".", ext)) %>% 
  # mutate(MFC = sub("\\s", "", file)) %>% 
  separate(file, into = c("MFC", "multi"), sep = "-", extra = "merge", remove = FALSE) %>% 
  select(MFN, MFC, file, multi, ext)


# SEZNAM

# sez_ch <- sez %>% 
#   select(invc, MINVC, MINVChorni, MINVCPozn, MPORCISLO, MPORCISLOhorni, MSUBCISLO, MSUBCISLOhorni)

sez <- sez %>% 
  select(invc, MINVC) %>% 
  
  separate(MINVC, into = c("cislo", "multi"), sep = "\\/", extra = "merge", remove = FALSE) %>% 
  mutate(
         rada = str_extract(cislo, "^."),
         cislo = str_extract(cislo, ".....$"),
         Mcislo = sub("^0+", "", cislo),
         MFC = ifelse(!is.na(multi), paste0(rada, " ", Mcislo, "/", multi), paste(rada, Mcislo)))

  
# R E L A T E 

relace <- left_join(vypis, sez, by = c("MFC" = "MFC"), keep = T) # foto

# N E S P A R O V A N E

nesparovane <- relace %>% 
  filter(is.na(MINVC)) %>% 
  select(MFN)  
  # write.table(file = paste0(path_kd, projekt, "_vypis_nesparovane_", v, ".csv"), 
  #           sep = ";", quote = T, row.names = F, col.names = F, 
  #           na = "", fileEncoding="cp1250")

# vypis n = 14976
# mus_tab n = 14730
# nesparovane n = 243

print(count(vypis)-count(mus_tab)) # = n(nesparovane) ? 


# M O D I F Y

modify_tab <- relace %>%
  select(MFN, MINVC) %>% 
  group_by(MINVC) %>% 
  mutate(MPORADI = seq_along(MINVC)) %>% 
  ungroup() %>%
  mutate(X = "",
         '1uloha' = "PREDMET_PRIVATE",
         '6url' = MFN,
         '7nahled' = ifelse(MPORADI == 1, "1", "0"),       # priznak {0;1}                       
         # '7nahled' = case_when('3poradi' == 1 ~ "1", 
         #                       TRUE ~ "0"),       # priznak {0;1}                       
         '8vodoznak' = 0,      # priznak {0;1}                  
         '9tisk1' = 0,          # priznak {0;1}                     
         '10tisk2' = 0)  %>%        # priznak {0;1}     ) %>% 
  filter(!is.na(MINVC)) # odfiltrovat nesparovane   # H 11 U : 452a ; 452b

modif_save <- paste0(path_kd, projekt, "_modif_obrazky_", v, ".csv")  

if(file.exists(modif_save)){
  print("You've been here before!")
} else {
  write.table(modify_tab, file = modif_save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Operational file  S A V E D  !")
  }

# C R E A T E    C S V

mus_tab <- modify_tab %>%  
  select(
    '1uloha' = '1uloha',   # !! povinne !!                            
    '2cislo' = MINVC,   # !! povinne !!     
    '3poradi' = MPORADI,   # !! povinne !!          
    '4nazev' = X,                                   
    '5typDokumentuNazev' = X,          
    '6url' = '6url',    # !! povinne !!
    '7nahled' = '7nahled',       # priznak {0;1}                       
    '8vodoznak' = '8vodoznak',      # priznak {0;1}                  
    '9tisk1' = '9tisk1',          # priznak {0;1}                     
    '10tisk2' = '10tisk2',         # priznak {0;1}                   
    '11poznamka' = X, 
    '12neDigitalni' = X, 
    '13umisteni' = X, 
    '14publikace' = X, 
    '15literaturaNazev' = X, 
    '16literaturaSlovy' = X, 
    '17APlicenceCC' = X, 
    '18APvariantaCCOznaceni' = X, 
    '19APautorSubjektKod' = X, 
    '20APdrzitelSubjektKod' = X, 
    '21APtypLicence' = X, 
    '22APcasovaLicence' = X, 
    '23APuzemniLicence' = X, 
    '24APmnozstevniLicence' = X, 
    '25APdatumVyprseni' = X, 
    '26APpoznamka' = X
    )                    

oper_obrazky_foto <- mus_tab  #  s w i t c h !!!

# S A V E   I M P O R T   C S V

save <- paste0(path_kd, projekt, "_import_obrazky_", v, ".csv")  

if(file.exists(save)){
  print("You've been here before!")
} else {
  write.table(mus_tab, file = save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  }

```

## Negativy HOTOVE

```{r OBR NEG}

# DATABASE CONNECTION

v <- "neg"
sez <- RODBC::sqlFetch(con, "negativy")

# LIST OF KD

vypis <- as.data.frame(list.files("D:/MUZBE/Negativy_IP/Image", full.names = T, pattern = "\\.jpg$")) 
colnames(vypis)[1] <- "path"

vypis <- vypis %>% 
  separate(path, into = c("disc", "project", "subject", "image", "file", "ext"), 
           sep = "\\/|\\.", extra = "merge", remove = FALSE) %>% 
  mutate(MFN = paste0(file, ".", ext),
         Mrada = substr(file, 1, 1),
         Mcislo = sub("N-a", "N", file),
         Mcislo = sub("N", "", Mcislo), 
         Mcislo = sub("^0+", "", Mcislo),
         MFC = paste0(Mrada, Mcislo)) %>% 
  separate(MFC, into = c("MFC", "multi"), sep = "\\s|-", extra = "merge", remove = FALSE) %>% 
  mutate(multi = ifelse(str_detect(multi, "A|-A|B|-B|C|-C"), sub("A|-A|B|-B|C|-C", "", multi), multi),
         multi = gsub("^0+", "", multi), # 020 (2) -> 20 (2)
         MFC = ifelse(str_detect(MFC, "[:alpha:]$"), sub("[:alpha:]$", "", MFC), MFC),
         MFC = ifelse(MFC == "N37542", paste0(MFC, "/", multi), MFC), # N37542-20 (2)
         MFC = sub("\\s\\(2\\)", "", MFC), # N37542-20 (2) -> N37542-20
         MFC = ifelse(str_detect(MFC, "a|b|c|A|B|C$"), sub("a|b|c|A|B|C$", "", MFC), MFC)) %>% # N37542-051A -> N37542-051
  select(MFN, MFC, file, multi, ext)
         
         
  
# SEZNAM INVC

sez <- sez %>% 
  select(invc, MINVC, MINVChorni) %>% 
  
  mutate(cislo = substr(MINVC, 2, 6),
         rada = "N",
         Mcislo = sub("^0+", "", cislo), 
         MFC = paste0(rada, Mcislo),
         MFC = ifelse(MFC == "N37542", MINVC, MFC), 
         MFC = ifelse(str_detect(MFC, "AB|A-C|A-D"), gsub("AB|A-C|A-D", "", MFC), MFC))
   
  
# R E L A T E 

relace <- left_join(vypis, sez, by = c("MFC" = "MFC"), keep = T) 

# N E S P A R O V A N E

nesparovane <- relace %>% 
  filter(is.na(MINVC)) 

# write.table(nesparovane, file = paste0(path_kd, projekt, "_vypis_nesparovane_", v, ".csv"), 
#             sep = ";", quote = T, row.names = F, col.names = F, 
#             na = "", fileEncoding="cp1250")


# M O D I F Y

modify_tab <- relace %>%
  select(MFN, MINVC) %>% 
  group_by(MINVC) %>% 
  mutate(MPORADI = seq_along(MINVC)) %>% 
  ungroup() %>%
  mutate(X = "",
         '1uloha' = "PREDMET_PRIVATE",
         '6url' = MFN,
         '7nahled' = ifelse(MPORADI == 1, "1", "0"),       # priznak {0;1}                       
         # '7nahled' = case_when('3poradi' == 1 ~ "1", 
         #                       TRUE ~ "0"),       # priznak {0;1}                       
         '8vodoznak' = 0,      # priznak {0;1}                  
         '9tisk1' = 0,          # priznak {0;1}                     
         '10tisk2' = 0)  %>%        # priznak {0;1}     ) %>% 
  filter(!is.na(MINVC)) # odfiltrovat nesparovane   # H 11 U : 452a ; 452b

modif_save <- paste0(path_kd, projekt, "_modif_obrazky_", v, ".csv")  

if(file.exists(modif_save)){
  print("You've been here before!")
} else {
  write.table(modify_tab, file = modif_save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Operational file  S A V E D  !")
  }

# C R E A T E    C S V

mus_tab <- modify_tab %>%  
  select(
    '1uloha' = '1uloha',   # !! povinne !!                            
    '2cislo' = MINVC,   # !! povinne !!     
    '3poradi' = MPORADI,   # !! povinne !!          
    '4nazev' = X,                                   
    '5typDokumentuNazev' = X,          
    '6url' = '6url',    # !! povinne !!
    '7nahled' = '7nahled',       # priznak {0;1}                       
    '8vodoznak' = '8vodoznak',      # priznak {0;1}                  
    '9tisk1' = '9tisk1',          # priznak {0;1}                     
    '10tisk2' = '10tisk2',         # priznak {0;1}                   
    '11poznamka' = X, 
    '12neDigitalni' = X, 
    '13umisteni' = X, 
    '14publikace' = X, 
    '15literaturaNazev' = X, 
    '16literaturaSlovy' = X, 
    '17APlicenceCC' = X, 
    '18APvariantaCCOznaceni' = X, 
    '19APautorSubjektKod' = X, 
    '20APdrzitelSubjektKod' = X, 
    '21APtypLicence' = X, 
    '22APcasovaLicence' = X, 
    '23APuzemniLicence' = X, 
    '24APmnozstevniLicence' = X, 
    '25APdatumVyprseni' = X, 
    '26APpoznamka' = X
    )                    

oper_obrazky_neg <- mus_tab 

# S A V E   I M P O R T   C S V

save <- paste0(path_kd, projekt, "_import_obrazky_", v, ".csv")  

if(file.exists(save)){
  print("You've been here before!")
} else {
  write.table(mus_tab, file = save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  }

# I M P O R T   C H E C K 

mus_imp <- read_excel(paste0(path_kd, "neg/KontextovyDokument_export (2).xlsx")) %>%  #  s w i t c h !!!
  select(Číslo, URL) %>% 
  mutate(MFN = sub("_original", "", URL))

csv_imp <- read.csv(paste0(path_kd, "neg/MUZBE_import_obrazky_neg.csv"), sep = ";") %>%  #  s w i t c h !!!
  mutate(Murl = sub("JPG", "jpg", X6url))
  # select(X2cislo, X6url)

imp_check <- left_join(csv_imp, mus_imp, by = c("Murl" = "MFN"), keep = T) %>% 
  filter(is.na(Číslo))

# aftermath

mus_list <- select(mus_imp, MFN)
vypis_list <- select(vypis, MFN) 


fin_imp <- left_join(vypis_list, mus_list, keep = T) %>% 
  filter(is.na(MFN.y))


```

Nektere obrazky nebyly prirazeny, protoze spadaji do intervalu daneho puvodnim invenarnim cislem.  
Nutne priradit obrazky ke spravnemu spodnimu MINVC.  

```{r OBR NEGATIVY 2KOLO INTERVALY}

# sez_int <- sez %>% 
#   filter(str_detect(invc, "N\\s\\d+-\\d{5}")) %>% 
#   mutate(Minterv = str_extract(invc, "\\d{5}-\\d+")) %>% 
#   separate(Minterv, into = c("dolni", "horni"), 
#            sep = "-", extra = "merge", remove = FALSE) %>% 
#   mutate(dolni = as.numeric(dolni),
#          horni = as.numeric(horni))

sez_int <- sez %>% 
  drop_na(MINVChorni) %>% 
  mutate(dolni = sub("N", "", MINVC),
         horni = sub("N", "", MINVChorni))

nesp_int <- nesparovane %>% 
  select(MFN, MFC.x) %>% 
  mutate(Mcislo = gsub("A|B|N", "", MFC.x),
         Mcislo = as.numeric(Mcislo)) 

# install.packages("fuzzyjoin")
require(fuzzyjoin)

fuzzy_relace <- fuzzy_left_join(nesp_int, sez_int, 
                                by = c("Mcislo" = "dolni", "Mcislo" = "horni"), 
                                match_fun = list(`>=`, `<=`))       # W O R K S !!!!
 
ruc_fuzzy_relace <- fuzzy_relace %>% 
  mutate(MINVC = case_when(Mcislo.x >= 17881 & Mcislo.x <= 17902 ~ "N17880/-902,CH890",
                           Mcislo.x >= 19859 & Mcislo.x <= 19951 ~ "N19858/-951,CH911",
                           Mcislo.x >= 30212 & Mcislo.x <= 30262 ~ "N30212/-262,CH212",
                           Mcislo.x >= 36427 & Mcislo.x <= 36435 ~ "N36427/-435,C28-9",
                           Mcislo.x >= 37747 & Mcislo.x <= 37805 ~ "N37747/A-805",
                           Mcislo.x >= 44331 & Mcislo.x <= 44342 ~ "N44331/-342,CH330",
                           TRUE ~ MINVC))

sparovane2 <- ruc_fuzzy_relace %>% drop_na(MINVC)
nesparovane2 <- ruc_fuzzy_relace %>% filter(is.na(MINVC)) # -> rucne doplnit intervaly u MINVC v nestandartním formatu

write.table(nesparovane2, file = paste0(path_kd, projekt, "_vypis_nesparovane_", v, ".csv"),
            sep = ";", quote = T, row.names = F, col.names = F,
            na = "", fileEncoding="cp1250")

modify_tab <- sparovane2 %>%
  select(MFN, MINVC) %>% 
  group_by(MINVC) %>% 
  mutate(MPORADI = seq_along(MINVC)+1) %>% # nutne zacit od 2, protoze poradi=1 uz se zapsalo v prvnim kole importu !!!
  ungroup() %>%
  mutate(X = "",
         '1uloha' = "PREDMET_PRIVATE",
         '6url' = MFN,
         '7nahled' = ifelse(MPORADI == 1, "1", "0"),       # priznak {0;1}                       
         # '7nahled' = case_when('3poradi' == 1 ~ "1", 
         #                       TRUE ~ "0"),       # priznak {0;1}                       
         '8vodoznak' = 0,      # priznak {0;1}                  
         '9tisk1' = 0,          # priznak {0;1}                     
         '10tisk2' = 0)  %>%        # priznak {0;1}     ) %>% 
  filter(!is.na(MINVC)) # odfiltrovat nesparovane   # H 11 U : 452a ; 452b

modif_save <- paste0(path_kd, projekt, "_modif_obrazky_", v, "_2.csv")  

if(file.exists(modif_save)){
  print("You've been here before!")
} else {
  write.table(modify_tab, file = modif_save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Operational file  S A V E D  !")
  }

# C R E A T E    C S V

mus_tab <- modify_tab %>%  
  select(
    '1uloha' = '1uloha',   # !! povinne !!                            
    '2cislo' = MINVC,   # !! povinne !!     
    '3poradi' = MPORADI,   # !! povinne !!          
    '4nazev' = X,                                   
    '5typDokumentuNazev' = X,          
    '6url' = '6url',    # !! povinne !!
    '7nahled' = '7nahled',       # priznak {0;1}                       
    '8vodoznak' = '8vodoznak',      # priznak {0;1}                  
    '9tisk1' = '9tisk1',          # priznak {0;1}                     
    '10tisk2' = '10tisk2',         # priznak {0;1}                   
    '11poznamka' = X, 
    '12neDigitalni' = X, 
    '13umisteni' = X, 
    '14publikace' = X, 
    '15literaturaNazev' = X, 
    '16literaturaSlovy' = X, 
    '17APlicenceCC' = X, 
    '18APvariantaCCOznaceni' = X, 
    '19APautorSubjektKod' = X, 
    '20APdrzitelSubjektKod' = X, 
    '21APtypLicence' = X, 
    '22APcasovaLicence' = X, 
    '23APuzemniLicence' = X, 
    '24APmnozstevniLicence' = X, 
    '25APdatumVyprseni' = X, 
    '26APpoznamka' = X
    )                    

oper_obrazky_neg <- mus_tab 

# S A V E   I M P O R T   C S V

save <- paste0(path_kd, projekt, "_import_obrazky_", v, "_2.csv")  

if(file.exists(save)){
  print("You've been here before!")
} else {
  write.table(mus_tab, file = save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  }
```

## Obecne sbirky ---prevz EVA

```{r OBR OB}

# DATABASE CONNECTION !! jina databaze !!

dbname <- paste0(path_muzbe, "02 muzBE konverze/SVO/MUZBE-SVO-pracovni.accdb") 
con <- RODBC::odbcConnectAccess2007(dbname)      

# RODBC::sqlTables(con)

v <- "obs"
sez <- RODBC::sqlFetch(con, "obecne")

# LIST OF KD

# vyp <- as.data.frame(list.files(c("D:/MUZBE/Obecné sbírky-4složky obrázků/Image_01",
#                                     "D:/MUZBE/Obecné sbírky-4složky obrázků/Image_02",
#                                     "D:/MUZBE/Obecné sbírky-4složky obrázků/Image_03",
#                                     "D:/MUZBE/Obecné sbírky-4složky obrázků/Image_04"), 
#                                   pattern = "jpg$|JPG$", full.names = T)) 

# vyp1 <- as.data.frame(list.files("D:/MUZBE/Obecné sbírky-4složky obrázků/Image_01", pattern = "jpg$|JPG$", full.names = T)) 
# colnames(vyp1)[1] <- "path"
# vyp2 <- as.data.frame(list.files("D:/MUZBE/Obecné sbírky-4složky obrázků/Image_02", pattern = "jpg$|JPG$", full.names = T)) 
# colnames(vyp2)[1] <- "path"
vyp3 <- as.data.frame(list.files("D:/MUZBE/Obecné sbírky-4složky obrázků/Image_03", pattern = "jpg$|JPG$", full.names = T)) 
colnames(vyp3)[1] <- "path"

# vypis <- vyp1 %>% 
vypis <- vyp3 %>% 
  mutate(MFN = sub(".*\\/.*\\/.*\\/.*\\/", "", path),
         Mrada = "FM",
         Mcislo = sub("^FM", "", MFN),
         Mcislo = sub(".jpg|.JPG", "", Mcislo),
         Mcislo = sub("S", "", Mcislo),
         Mcislo = sub("--", "-", Mcislo),
         Mcislo = sub("\\s\\(\\d+\\)", "", Mcislo),
         Mcislo = str_trim(Mcislo)) %>% 
  
  separate(Mcislo, into = c("hlavni", "sub"), sep = "-|\\s", extra = "merge", remove = FALSE) %>% 
  
  mutate(sub = ifelse(str_detect(hlavni, "\\d+[:alpha:]$"), str_extract(hlavni, ".$"), sub),
         hlavni = ifelse(str_detect(hlavni, "[:alpha:]$"), str_remove(hlavni, ".$"), hlavni),
         sub = str_remove_all(sub, "\\s+"),
         sub = str_remove(sub, "^-"),
         sub = str_trim(sub)) %>% 
         
  separate(sub, into = c("sub1", "sub2"), sep = "-|,|\\(", extra = "merge", remove = FALSE) %>% 
  mutate(sub2 = ifelse(str_detect(sub1, ".+[:alpha:]$"), str_extract(sub1, ".$"), sub2),
         sub1 = ifelse(str_detect(sub1, ".+[:alpha:]$"), str_remove(sub1, ".$"), sub1))


# SEZNAM INVC

sez <- sez %>% 
  select(invc, MINVC) %>% 
  filter(!is.na(MINVC)) %>% 
  
  separate(MINVC, into = c("hlavni", "sub"), sep = "\\/", extra = "merge", remove = FALSE) %>% 
  mutate(Mrada = paste0("FM"),
         MFC = gsub("FM| S", "", hlavni),
         MFC = gsub("^0+", "", MFC))
    
  
# R E L A T E 

# relace <- left_join(vypis, sez, by = c("hlavni" = "MFC"), keep = T) # 13887

relace <- left_join(vypis, sez, by = c("hlavni" = "MFC", "sub1" = "sub"), keep = T)  # 13694
rel_ok <- relace %>% filter(!is.na(MINVC)) %>% 
  select(MFN, MINVC) # 8226
rel_na <- relace %>% filter(is.na(MINVC)) %>% #5468
  select(-invc, -MINVC, -hlavni.y, -sub.y, -Mrada.y, -MFC) %>% 
  rename("Mrada" = Mrada.x, "hlavni" = hlavni.x, "sub" = sub.x) 
rel_naok <- left_join(rel_na, sez, by = c("hlavni" = "MFC"), keep = T)  # 5585

# check_rel <- rel_naok %>% 
check_rel <- rel_naok %>% 
  group_by(MFN) %>% 
  filter(n()>1)

del_vec <- check_rel$MFN # seznam INVC, ktera byla spatne sparovana a maji se priradit rucne

rel_naok2 <- rel_naok %>% 
  filter(!MFN %in% del_vec) %>%  # smazat neprirazena MINVC
  select(MFN, MINVC)

opr_vypis <- rbind(rel_ok, rel_naok2) 


# N E S P A R O V A N E

#viz del_vec, check_rel

# write.table(nesparovane, file = paste0(path_kd, projekt, "_vypis_nesparovane_", v, ".csv"),
#             sep = ";", quote = T, row.names = F, col.names = F,
#             na = "", fileEncoding="cp1250")
# 
# print(count(vypis)-count(mus_tab)) # = n(nesparovane) ? 

# w <- "Image_01"
w <- "Image_02"

# M O D I F Y

modify_tab <- opr_vypis %>%
  # select(MFN, MINVC) %>% 
  group_by(MINVC) %>% 
  mutate(MPORADI = seq_along(MINVC)) %>% 
  ungroup() %>%
  mutate(X = "",
         '1uloha' = "PREDMET_PRIVATE",
         '6url' = MFN,
         '7nahled' = ifelse(MPORADI == 1, "1", "0"),       # priznak {0;1}                       
         # '7nahled' = case_when('3poradi' == 1 ~ "1", 
         #                       TRUE ~ "0"),       # priznak {0;1}                       
         '8vodoznak' = 0,      # priznak {0;1}                  
         '9tisk1' = 0,          # priznak {0;1}                     
         '10tisk2' = 0)  %>%        # priznak {0;1}     ) %>% 
  filter(!is.na(MINVC)) # odfiltrovat nesparovane   # H 11 U : 452a ; 452b

modif_save <- paste0(path_kd, projekt, "_modif_obrazky_", v, w,".csv")  

if(file.exists(modif_save)){
  print("You've been here before!")
} else {
  write.table(modify_tab, file = modif_save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Operational file  S A V E D  !")
  }

# C R E A T E    C S V

mus_tab <- modify_tab %>%  
  select(
    '1uloha' = '1uloha',   # !! povinne !!                            
    '2cislo' = MINVC,   # !! povinne !!     
    '3poradi' = MPORADI,   # !! povinne !!          
    '4nazev' = X,                                   
    '5typDokumentuNazev' = X,          
    '6url' = '6url',    # !! povinne !!
    '7nahled' = '7nahled',       # priznak {0;1}                       
    '8vodoznak' = '8vodoznak',      # priznak {0;1}                  
    '9tisk1' = '9tisk1',          # priznak {0;1}                     
    '10tisk2' = '10tisk2',         # priznak {0;1}                   
    '11poznamka' = X, 
    '12neDigitalni' = X, 
    '13umisteni' = X, 
    '14publikace' = X, 
    '15literaturaNazev' = X, 
    '16literaturaSlovy' = X, 
    '17APlicenceCC' = X, 
    '18APvariantaCCOznaceni' = X, 
    '19APautorSubjektKod' = X, 
    '20APdrzitelSubjektKod' = X, 
    '21APtypLicence' = X, 
    '22APcasovaLicence' = X, 
    '23APuzemniLicence' = X, 
    '24APmnozstevniLicence' = X, 
    '25APdatumVyprseni' = X, 
    '26APpoznamka' = X
    )                    

# oper_obrazky_obs1 <- mus_tab 
oper_obrazky_obs2 <- mus_tab
# oper_obrazky_obs3 <- mus_tab 
# oper_obrazky_obs4 <- mus_tab 

# S A V E   I M P O R T   C S V

save <- paste0(path_kd, projekt, "_import_obrazky_", v, w,".csv")  

if(file.exists(save)){
  print("You've been here before!")
} else {
  write.table(mus_tab, file = save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  }

  
# I M P O R T   C H E C K 

mus_imp <- read_excel(paste0(path_kd, "neg/KontextovyDokument_export (2).xlsx")) %>%  #  s w i t c h !!!
  select(Číslo, URL) %>% 
  mutate(MFN = sub("_original", "", URL))
 
csv_imp <- read.csv(paste0(path_kd, "neg/MUZBE_import_obrazky_neg.csv"), sep = ";")  #  s w i t c h !!!
  # select(X2cislo, X6url)

imp_check <- left_join(csv_imp, mus_imp, by = c("X6url" = "MFN"), keep = T) %>% 
  filter(is.na(Číslo))

# aftermath

vypis_list <- select(vypis, MFN) 
mus_list <- select(mus_imp, MFN)

fin_imp <- left_join(vypis_list, mus_list, keep = T) %>% 
  filter(is.na(MFN.y))

```

## Rukopisy

```{r OBR RUKO}


# DATABASE CONNECTION

v <- "ruko"
sez <- RODBC::sqlFetch(con, "rukopisy")  

# LIST OF KD

vypis <- as.data.frame(list.files("D:/MUZBE/rukopisy.lbd/Image", full.names = T)) 
colnames(vypis)[1] <- "path"

vypis <- vypis %>% 
  separate(path, into = c("disc", "project", "subject", "image", "file", "ext"), 
           sep = "\\/|\\.", extra = "merge", remove = FALSE) %>% 
  mutate(MFN = paste0(file, ".", ext),
         Mrada = "F",
         Mcislo = sub("F ", "", file), 
         Mcislo = sub("^0+", "", Mcislo)) %>% 
  mutate(MFC = paste0(Mrada, Mcislo)) %>%  # foto
  separate(MFC, into = c("MFC", "multi"), sep = "\\s|-", extra = "merge", remove = FALSE) %>%
  mutate(MFC = ifelse(str_detect(MFC, "[:alpha:]$"), sub("[:alpha:]$", "", MFC), MFC)) %>% 
  select(MFN, MFC, file, multi, ext)


# SEZNAM INVC

sez <- sez %>% 
  select(invc, MINVC) %>% 
  
  mutate(cislo = substr(MINVC, 2, 6), 
         rada = str_extract(MINVC, "^."),
         Mcislo = sub("^0+", "", cislo), 
         MFC = paste0(rada, Mcislo))

  
# R E L A T E 

relace <- left_join(vypis, sez, by = c("MFC" = "MFC"), keep = T) 

# N E S P A R O V A N E

nesparovane <- relace %>% 
  filter(is.na(MINVC)) %>% 
  select(MFN)  

write.table(nesparovane, file = paste0(path_kd, projekt, "_vypis_nesparovane_", v, ".csv"), 
            sep = ";", quote = T, row.names = F, col.names = F, 
            na = "", fileEncoding="cp1250")

# vypis n = 14976
# mus_tab n = 14730
# nesparovane n = 243

print(count(vypis)-count(mus_tab)) # = n(nesparovane) ? 


# M O D I F Y

# v pripade dvokoloveho prirazovani: 

modify_tab <- relace %>%
  select(MFN, MINVC) %>% 
  group_by(MINVC) %>% 
  mutate(MPORADI = seq_along(MINVC)) %>% 
  ungroup() %>%
  mutate(X = "",
         '1uloha' = "PREDMET_PRIVATE",
         '6url' = MFN,
         '7nahled' = ifelse(MPORADI == 1, "1", "0"),       # priznak {0;1}                       
         # '7nahled' = case_when('3poradi' == 1 ~ "1", 
         #                       TRUE ~ "0"),       # priznak {0;1}                       
         '8vodoznak' = 0,      # priznak {0;1}                  
         '9tisk1' = 0,          # priznak {0;1}                     
         '10tisk2' = 0)  %>%        # priznak {0;1}     ) %>% 
  filter(!is.na(MINVC)) # odfiltrovat nesparovane   # H 11 U : 452a ; 452b

modif_save <- paste0(path_kd, projekt, "_modif_obrazky_", v, ".csv")  

if(file.exists(modif_save)){
  print("You've been here before!")
} else {
  write.table(modify_tab, file = modif_save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Operational file  S A V E D  !")
  }

# C R E A T E    C S V

mus_tab <- modify_tab %>%  
  select(
    '1uloha' = '1uloha',   # !! povinne !!                            
    '2cislo' = MINVC,   # !! povinne !!     
    '3poradi' = MPORADI,   # !! povinne !!          
    '4nazev' = X,                                   
    '5typDokumentuNazev' = X,          
    '6url' = '6url',    # !! povinne !!
    '7nahled' = '7nahled',       # priznak {0;1}                       
    '8vodoznak' = '8vodoznak',      # priznak {0;1}                  
    '9tisk1' = '9tisk1',          # priznak {0;1}                     
    '10tisk2' = '10tisk2',         # priznak {0;1}                   
    '11poznamka' = X, 
    '12neDigitalni' = X, 
    '13umisteni' = X, 
    '14publikace' = X, 
    '15literaturaNazev' = X, 
    '16literaturaSlovy' = X, 
    '17APlicenceCC' = X, 
    '18APvariantaCCOznaceni' = X, 
    '19APautorSubjektKod' = X, 
    '20APdrzitelSubjektKod' = X, 
    '21APtypLicence' = X, 
    '22APcasovaLicence' = X, 
    '23APuzemniLicence' = X, 
    '24APmnozstevniLicence' = X, 
    '25APdatumVyprseni' = X, 
    '26APpoznamka' = X
    )                    

oper_obrazky_foto <- mus_tab  

# S A V E   I M P O R T   C S V

save <- paste0(path_kd, projekt, "_import_obrazky_", v, ".csv")  

if(file.exists(save)){
  print("You've been here before!")
} else {
  write.table(mus_tab, file = save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
}


# I M P O R T   C H E C K 

mus_imp <- read_excel(paste0(path_kd, "foto/KontextovyDokument_export (2).xlsx")) %>%  #  s w i t c h !!!
  select(Číslo, URL) %>% 
  mutate(MFN = sub("_original", "", URL))

csv_imp <- read.csv(paste0(path_kd, "foto/MUZBE_import_obrazky_foto.csv"), sep = ";") %>% 
  mutate(Murl = sub("JPG", "jpg", X6url))
  # select(X2cislo, X6url)

imp_check <- left_join(csv_imp, mus_imp, by = c("Murl" = "MFN"), keep = T) %>% 
  filter(is.na(Číslo))

# aftermath

mus_list <- select(mus_imp, MFN)
vypis_list <- select(vypis, MFN) 


fin_imp <- left_join(vypis_list, mus_list, keep = T) %>% 
  filter(is.na(MFN.y))


```


## Dalsi obrazky

- n = 1001
- podsbirka 25 - Spolecenskovedni oddeleni

```{r OBR DALSI}

# LIST OF INVC

v <- "dalsi"
sez <- read_excel(paste0(path_kd, v, "/SbirkovyPredmet_25_export.xlsx")) %>% 
  rename(MINVC = 'Inventární číslo') %>% 
  separate(MINVC, into = c("Mcislo_prov", "Mrada_S"), 
           sep = "\\s", extra = "merge", remove = FALSE) %>% 
  mutate(Mcislo = sub("FM", "", Mcislo_prov),
         Msub = ifelse(str_detect(MINVC, "\\/"), sub(".*\\/", "", MINVC), NA)) %>% 
  select(MINVC, Mcislo, Msub) 

# LIST OF KD

vypis <- as.data.frame(list.files("D:/MUZBE/dalsi", full.names = T, pattern = "\\.jpg$|\\.JPG")) 
colnames(vypis)[1] <- "path"

jpg <- vypis %>% 
  separate(path, into = c("disc", "project", "subject", "file", "ext"), 
           sep = "\\/|\\.", extra = "merge", remove = FALSE)  %>% 
  separate(file, into = c("Mrada_gr", "Mcislo", "Msub"), 
           sep = "\\s|-", extra = "merge", remove = FALSE) %>% 
  mutate(MFN = paste0(file, ".", ext),
         Mrada = "FM-S", 
         Msub = gsub("0", "", Msub)) %>% 
  select(MFN, Mcislo, Msub)

sort(unique(jpg$Msub))
sort(unique(sez$Msub))

# JOIN

relace <- left_join(jpg, sez, by = c("Mcislo" = "Mcislo", "Msub" = "Msub"), keep = T) 
rel_sub <- relace %>% filter(!is.na(MINVC)) %>% 
  select(MINVC, MFN)
rel_rest <- relace %>% filter(is.na(MINVC)) 

relace2 <- left_join(rel_rest, sez, by = c("Mcislo.x" = "Mcislo"), keep = T) %>% 
  group_by(MFN) %>% filter(!n() != 1) %>% 
   select(MINVC = MINVC.y, MFN)

ch <- relace2 %>% group_by(MFN) %>% filter(n() != 1)

rel_fin <- rbind(rel_sub, relace2)

nesparovane <- rel_fin %>% filter(is.na(MINVC))

# N E S P A R O V A N E

# doplnit rucne

# "FM 52243-001.jpg OK" "FM 52243-002.jpg OK" "FM 52243-003.jpg OK" 
# "FM 53712-002.jpg OK" "FM 53737-002.jpg"

# zkontroluj FM32379 S: uz je nahrany obrazek FM 32379_original.jpg; ted nahravame 002 a dal. Neprepise se prvni? 

# CSV

# M O D I F Y

modify_tab <- rel_fin %>%
  select(MFN, MINVC) %>% 
  group_by(MINVC) %>% 
  mutate(MPORADI = seq_along(MINVC)) %>% 
  ungroup() %>%
  mutate(X = "",
         '1uloha' = "PREDMET_PRIVATE",
         '6url' = MFN,
         '7nahled' = ifelse(MPORADI == 1, "1", "0"),       # priznak {0;1}                       
         # '7nahled' = case_when('3poradi' == 1 ~ "1", 
         #                       TRUE ~ "0"),       # priznak {0;1}                       
         '8vodoznak' = 0,      # priznak {0;1}                  
         '9tisk1' = 0,          # priznak {0;1}                     
         '10tisk2' = 0) %>%         # priznak {0;1}     
  filter(!is.na(MINVC)) # odfiltrovat nesparovane

modif_save <- paste0(path_kd, projekt, "_modif_obrazky_", v, ".csv")  

if(file.exists(modif_save)){
  print("You've been here before!")
} else {
  write.table(modify_tab, file = modif_save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Operational file  S A V E D  !")
  }

# C R E A T E    C S V

mus_tab <- modify_tab %>%  
  select(
    '1uloha' = '1uloha',   # !! povinne !!                            
    '2cislo' = MINVC,   # !! povinne !!     
    '3poradi' = MPORADI,   # !! povinne !!          
    '4nazev' = X,                                   
    '5typDokumentuNazev' = X,          
    '6url' = '6url',    # !! povinne !!
    '7nahled' = '7nahled',       # priznak {0;1}                       
    '8vodoznak' = '8vodoznak',      # priznak {0;1}                  
    '9tisk1' = '9tisk1',          # priznak {0;1}                     
    '10tisk2' = '10tisk2',         # priznak {0;1}                   
    '11poznamka' = X, 
    '12neDigitalni' = X, 
    '13umisteni' = X, 
    '14publikace' = X, 
    '15literaturaNazev' = X, 
    '16literaturaSlovy' = X, 
    '17APlicenceCC' = X, 
    '18APvariantaCCOznaceni' = X, 
    '19APautorSubjektKod' = X, 
    '20APdrzitelSubjektKod' = X, 
    '21APtypLicence' = X, 
    '22APcasovaLicence' = X, 
    '23APuzemniLicence' = X, 
    '24APmnozstevniLicence' = X, 
    '25APdatumVyprseni' = X, 
    '26APpoznamka' = X
    )                    

oper_obrazky_dalsi <- mus_tab 
dalsi_reimport <- oper_obrazky_dalsi %>% 
  slice(1,2,174)

dalsi_reimport <- rbind(dalsi_reimport, dalsi_reimport[rep(1:nrow(dalsi_reimport), 1), ]) %>% 
  rename(cislo = '2cislo') %>% 
  group_by(cislo) %>% 
  mutate('3poradi' = seq_along(cislo))

# S A V E   I M P O R T   C S V

save <- paste0(path_kd, projekt, "_import_obrazky_", v, ".csv")  

if(file.exists(save)){
  print("You've been here before!")
} else {
  write.table(mus_tab, file = save, 
            sep = ";", quote = T, row.names = F, 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  }

# CHECK IMPORT DALSI


mus_imp <- read_excel(paste0(path_kd, v, "/KontextovyDokument_export (1).xlsx")) %>%  #  s w i t c h !!!
  mutate(MFN = sub("_original", "", URL))

# csv_imp <- read.csv(paste0(path_kd, "neg/MUZBE_import_obrazky_neg.csv"), sep = ";") %>%  #  s w i t c h !!!
#   mutate(Murl = sub("JPG", "jpg", X6url))
#   # select(X2cislo, X6url)

jpg_cs <- jpg %>% mutate(MFN = ifelse(str_detect(MFN, "JPG"), sub("JPG", "jpg", MFN), MFN))

imp_check <- left_join(jpg_cs, mus_imp, by = c("MFN" = "MFN"), keep = T)


na2 <- imp_check %>% filter(is.na(Číslo))


```


## ~ O B R  -  C H E C K ~ 

```{r OBR CHECK IMPORT}

# I N V   R A D A

# v <- "diap"
# v <- "foto"
# v <- "les"
v <- "neg"
# v <- "obs"

# V Y P I S   O B R A Z K U

# jpg_vypis <- as.data.frame(list.files("D:/MUZBE/Diapozitivy/Image", full.names = T)) #  s w i t c h !!!
# jpg_vypis <- as.data.frame(list.files("D:/MUZBE/Foto/Image", full.names = T)) #  s w i t c h !!!
# jpg_vypis <- as.data.frame(list.files("D:/MUZBE/Lesnická sbírka/Image", full.names = T)) #  s w i t c h !!!
jpg_vypis <- as.data.frame(list.files("D:/MUZBE/Negativy_IP/Image", full.names = T, pattern = "\\.jpg$")) #  s w i t c h !!!
colnames(jpg_vypis)[1] <- "path"
count(jpg_vypis)

# M U S E I O N   I M P

mus_imp <- read_excel(paste0(path_kd, v, "/KontextovyDokument_export (1).xlsx")) %>% 
  select(Číslo, URL) %>% 
  mutate(MFN = sub("_original", "", URL))

# C H E C K 

if(v == "neg"){
  csv1 <- read.csv(paste0(path_kd, v, "/MUZBE_import_obrazky_", v, ".csv"), sep = ";")
  csv2 <- read.csv(paste0(path_kd, v, "/MUZBE_import_obrazky_", v, "_2.csv"), sep = ";")
  csv_imp <- rbind(csv1, csv2)
} else {
  csv_imp <- read.csv(paste0(path_kd, v, "/MUZBE_import_obrazky_", v, ".csv"), sep = ";") 
}

imp_check <- left_join(csv_imp, mus_imp, by = c("X6url" = "MFN"), keep = T) %>% 
  filter(is.na(Číslo))

# aftermath # neni to totez jako uz mam vyse? Ja myslim, ze jo ! :D

vypis_list <- select(vypis, MFN) # soupis dodanych obrazku
mus_list <- select(mus_imp, MFN) # co je fyzicky v MUSEIONU

fin_imp <- left_join(vypis_list, mus_list, keep = T) %>% 
  filter(is.na(MFN.y))


mus_imp # co je v museionu
jpg_vypis # vypis obrazku


jpg_vypis <- jpg_vypis %>% 
  separate(path, into = c("disc", "project", "subject", "image", "file", "ext"), 
           sep = "\\/|\\.", extra = "merge", remove = FALSE) %>% 
  mutate(MFN = paste0(file, ".", ext))


imp_check <- left_join(jpg_vypis, mus_imp, by = c("MFN" = "MFN"), keep = T) 
```


### negativy check

```{r NEG KD CHECK}

mus_imp <- read_excel(paste0(path_kd, v, "/KontextovyDokument_export (1).xlsx")) %>% 
  select(Číslo, URL) %>% 
  mutate(MFN = sub("_original", "", URL))

if(v == "neg"){
  csv1 <- read.csv(paste0(path_kd, v, "/MUZBE_import_obrazky_", v, ".csv"), sep = ";")
  csv2 <- read.csv(paste0(path_kd, v, "/MUZBE_import_obrazky_", v, "_2.csv"), sep = ";")
  csv_imp <- rbind(csv1, csv2)
} else {
  csv_imp <- read.csv(paste0(path_kd, v, "/MUZBE_import_obrazky_", v, ".csv"), sep = ";") 
}

# precislovat poradi !!

csv_imp <- csv_imp %>% 
  group_by(X2cislo) %>% 
  mutate(Mpor = seq_along(X6url),
         Mnahl = ifelse(row_number() == 1, 1, 0)) %>% 
  ungroup() %>% 
  relocate(Mpor, .after = X3poradi) %>% 
  relocate(Mnahl, .after = X7nahled) %>% 
  select(-X3poradi, -X7nahled)

mus_tab <- csv_imp %>% 
  filter(X2cislo == "N44222")

save <- paste0(path_csv, projekt, "_import_", v, "N44222.csv")

imp3 <- left_join(fin_imp, csv_imp, by = c("MFN.x" = "X6url"), keep = T) %>% 
  select(-MFN.x, -MFN.y)

save <- paste0(path_csv, projekt, "_import_", v, "chyb_160523.csv")
```


# ! ! !   E X P O R T Y    C S V   ! ! !


```{r EXPORT CSV}

# finalni csv

save <- paste0(path_csv, projekt, "_import_", imp, ".csv")

if(file.exists(save)){
  print("You've been here before!")
} else {
  write.table(mus_tab, file = save, # mus_tab10
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
  }

# upravena tabulka

modif_save <- paste0(path_csv, projekt, "_modif_", imp, ".csv")

if(file.exists(modif_save)){
  print("You've been here before!")
} else {
  write.table(modify_tab, file = modif_save, 
            quote = T, row.names = F, 
            sep = ";", dec = ",",              # desetinny oddelovac musi byt carka
            na = "", fileEncoding="cp1250")
  print("Operational file  S A V E D  !")
  }

# s a v e   i m p o r t   f i l e 2

check_save <- paste0(path_csv, projekt, "_import_", imp, "2.csv")

if(file.exists(check_save)){
  print("You've been here before!")
} else {
  write.table(check_imp, file = check_save, # mus_tab10
            quote = T, row.names = F, 
            sep = ";", dec = ",", 
            na = "", fileEncoding="cp1250")
  print("Import csv  W R I T T E N  !")
}

rm(save)
rm(modif_save)
rm(check_save)
```


# KONFLIKTY PRI MIGRACI DAT

## Botanika

* B 15781 - celed - "Orobanchaceae (zárazovité)Orobanchaceae (zárazovité)"  

* B 20207 - mapa - "6375b" - KK: cislo ctverce ?
  
* sort(unique(bot$nabyti))  
[1] "dar"   "nákup" "Nákup" "nkup"  "sběr"  "svěr" 

* B23277 - spatny format souradnic -> smazany, do pole 37specifikaceLokality
* B21649 - spatny format souradnic -> smazany, do pole 37specifikaceLokality
* B22019 - spatny format souradnic -> smazany, do pole 37specifikaceLokality


DUPLICITINI ZAZNAMY V PUVODNI DATABAZI
* B 6434 -> B6434/D = Setaria viridis
* B 13836 -> B13836/D = Galium odoratum
* B 21785 -> B21785/D = Molinia coerulea

# O H R O Z E N I

Tabulka taxonu z MUSEIONU.  

id = MUSEION id taxonu  
nomen = lat nazev taxonu
nazev = ces nazev taxonu
autor
cislo = kod podsbirky  
nazev_1 = nazev kategorie  
nadtaxon  
uroven  
poznamka = url z biolibu

* nomaut = vytvorene policko nomen+autor pro potreby parovani

```{r MUZBE TAXONY MUSEION}

mtax <- read_excel(paste0(path_csv, "muzbe_taxony_MUSEION.xlsx"))

pb <- mtax %>% 
  filter(cislo == "Pb") %>% 
  unite(nomaut, c("nomen", "autor"), sep = " ", na.rm = T, remove = FALSE) %>% 
  select(id, nazev_1, nomen, autor, nomaut)

```


## Botanika

```{r BOT OHROZENI}

# fetch tab 'prac_bot' (actualized TAXON NOMEN)

ohr <- prac_bot %>% 
  select(MINVC, MNOMEN, MAUT, publikace) %>% 
  mutate(MAUT = ifelse(str_detect(MAUT, "Arctostaphylos uva-ursi "), str_remove(MAUT, "Arctostaphylos uva-ursi "), MAUT)) %>% 
  mutate(MAUT = ifelse(str_detect(MAUT, "Hydrocharis morsus-ranae "), str_remove(MAUT, "Hydrocharis morsus-ranae "), MAUT)) %>% 
  mutate(MAUT = ifelse(str_detect(MAUT, "Chenopodium bonus-henricus "), str_remove(MAUT, "Chenopodium bonus-henricus "), MAUT)) %>% 
  mutate(MAUT = ifelse(str_detect(MAUT, "Neottia nidus-avis "), str_remove(MAUT, "Neottia nidus-avis "), MAUT)) %>% 
  mutate(MAUT = ifelse(str_detect(MAUT, "Rubus portae-moravicae "), str_remove(MAUT, "Rubus portae-moravicae "), MAUT)) %>% 
  unite(nomaut, c("MNOMEN", "MAUT"), sep = " ", na.rm = T, remove = FALSE) %>% 
  # drop_na(publikace) %>% 
  # filter(str_detect(publikace, "taxon")) %>% 
  select(MINVC, MNOMEN, MAUT, nomaut, MOHR = publikace) %>% 
  mutate(MOHR = ifelse(str_detect(MOHR, "taxon", negate = T), "", MOHR)) 
  

ohr[ohr == ""] <- NA
ohr[ohr == " "] <- NA


sort(unique(ohr$MOHR))

# AOPK

aopk <- read_excel(paste0(path_data, "/_gen_tab/cervene_seznamy_AOPK.xlsx")) %>% 
  select(id_tax, ved_jm, autor_pop, kat_ohr_iucn) %>% 
  unite(nomaut, c("ved_jm", "autor_pop"), sep = " ", na.rm = T, remove = FALSE) 

ohr_aopk <- left_join(ohr, aopk, by = c("MNOMEN" = "ved_jm"), keep = T) %>% 
  rename(BACH_NOMAUT = nomaut.x,
         AOPK_NOMAUT = nomaut.y,
         BACH_MOHR = MOHR,
         AOPK_MOHR = kat_ohr_iucn)

ohr_bl <- left_join(ohr_aopk, pb, by = c("MNOMEN" = "nomen"), keep = T)
# ohr_bl <- left_join(ohr_aopk, pb, by = c("BACH_NOMAUT" = "nomaut"), keep = T)

ohr_fin <- ohr_bl %>% 
  select(MINVC, MNOMEN, BACH_NOMAUT, AOPK_NOMAUT, BL_NOMAUT = nomaut, BACH_MOHR, AOPK_MOHR, MUS_ID = id) %>% 
  filter(!is.na(BACH_MOHR)|!is.na(AOPK_MOHR)) %>% 
  select(MINVC, MNOMEN, BACH_MOHR, AOPK_MOHR, MUS_ID)

write.table(ohr_fin, file = paste0(path_muzbe, "02 muzBE konverze/BIO/muzbe_Pb_ohrozeni.csv"),
            quote = T, row.names = F,
            sep = ";", dec = ",",
            na = "", fileEncoding="cp1250")



```

## Mechorosty

```{r MECH OHROZENI}

dbname <- paste0(path_muzbe, "02 muzBE konverze/zdrojdat/BIO/mechorosty_Vrána.mdb") # path to database
con <- RODBC::odbcConnectAccess2007(dbname)      # set the connection
m_data <- RODBC::sqlFetch(con, "data")             # read specific table

dbname <- paste0(path_muzbe, "02 muzBE konverze/zdrojdat/BIO/ciselnik_taxonu.mdb") # path to database
con <- RODBC::odbcConnectAccess2007(dbname)      # set the connection
m_cis <- RODBC::sqlFetch(con, "data")              # read specific table

dbname <- paste0(path_muzbe, "02 muzBE konverze/BIO/muzbePVO_DK.accdb") # path to database
con <- RODBC::odbcConnectAccess2007(dbname)      # set the connection
m_rej <- RODBC::sqlFetch(con, "Rejstřík_Systém")   # read specific table

# museion taxon

mtax <- read_excel(paste0(path_csv, "muzbe_taxony_MUSEION.xlsx"))

m_pm <- mtax %>% filter(cislo == "Pm") %>% 
  mutate(nomaut = paste(nomen, autor))

# m_pm_dupl <- m_pm %>% 
#   group_by(nomen) %>% 
#   filter(n() != 1)
# 
# m_pm <- m_pm %>% 
#   filter(!id %in% c(18588344, 20063902))

```

```{r MECH OHROZENI DATA}

# vytvorit MINVC

ohr_m_data <- m_data %>% 
  select(invc, taxon, ohrozeni) %>% 
  mutate(invc = sub("M", "", invc),
    MINVC = paste0("M", str_pad(invc, 5, pad = "0"))) %>% 
  separate(taxon, into=c("Mrod", "Mdruh", "Mautor") , sep=" ", extra = "merge", remove = F) %>% 
  unite(MNOMEN, c("Mrod", "Mdruh"), sep = " ", na.rm = T, remove = FALSE) %>%
  select(MINVC, taxon, MNOMEN, ohrozeni)

# ohr_m_data$taxon <- str_trim(ohr_m_data$taxon)

# MUSEION id

ohr_m_mus <- ohr_m_data %>%
  # left_join(m_pm, by = c("taxon" = "nomaut")) 
  left_join(m_pm, by = c("MNOMEN" = "nomen")) %>% 
  mutate(id = case_when(taxon == "Chiloscyphus profundus (Nees) J. J. Engel & R. M. Schust." ~ 18588339,
                        taxon == "Chiloscyphus coadunatus (Sw.) J. J. Engel & R. M. Schust." ~ 18588336,
                        taxon == "Chiloscyphus cuspidatus (Nees) J. J. Engel & R. M. Schust." ~ 118588337,
                        taxon == "Chiloscyphus minor (Nees) J. J. Engel & R. M. Schust." ~ 18588338,
                        taxon == "Orthotrichum" ~ 13530622,
                        taxon == "Orthotrichum " ~ 13530622,
                        taxon == "Sphagnum" ~ NA,
                        taxon == "Sphagnum cf. capillifolium (Ehrh.) Hedw." ~ 18588358,
                        TRUE ~ id))

ch <- sample_n(ohr_m_mus, 10)

```

```{r MECH OHROZENI CISELNIK}

# nema moc smysl, kategorie ohrozeni stejna, jako v datech

ohr_m_cis <- m_cis %>% 
  select(taxon, ohrozeni) %>% 
  separate(taxon, into=c("Mrod", "Mdruh", "Mautor") , sep=" ", extra = "merge", remove = F) %>% 
  mutate(MNOMEN = paste(Mrod, Mdruh)) %>%
  select(taxon, MNOMEN, ohrozeni) %>% 
  distinct()

```

```{r MECH OHROZENI AOPK}

ohr_m_aopk <- read_excel(paste0(path_data, "/_gen_tab/cervene_seznamy_AOPK.xlsx")) %>% 
  select(id_tax, ved_jm, autor_pop, kat_ohr_iucn) %>% 
  unite(nomaut, c("ved_jm", "autor_pop"), sep = " ", na.rm = T, remove = FALSE) 

```

```{r MECH OHROZENI COMB}

# vytvorit MINVC

ohr_m_1 <- left_join(ohr_m_mus, ohr_m_aopk, by = c("taxon" = "nomaut"), keep = T) 
ohr_m_2 <- left_join(ohr_m_1, ohr_m_aopk, by = c("MNOMEN" = "ved_jm"), keep = T) 


ohr_m_fin <- ohr_m_2 %>%
  select(MINVC, taxon, MNOMEN, 
         DATA_ohrozeni = ohrozeni,
         AOPK_ohrozeni1 = kat_ohr_iucn.x,
         AOPK_ohrozeni2 = kat_ohr_iucn.y,
         MUS_ID = id,
         nomaut.y) 

m_pm_dupl <- ohr_m_fin %>%
  group_by(MINVC) %>%
  filter(n() != 1)

sub1 <- subset(ohr_m_fin, MINVC != "M01521"|MUS_ID != 13539014)
sub2 <- subset(sub1, MINVC != "M01179"|MUS_ID != 13539014)
sub3 <- subset(sub2, MINVC != "M02140"|MUS_ID != 18588344)
sub4 <- subset(sub3, MINVC != "M02051"|MUS_ID != 18588403)
sub5 <- subset(sub4, MINVC != "M01268"|MUS_ID != 13539014) %>% select(-nomaut.y, -AOPK_ohrozeni1)
  
write.table(sub5, file = paste0(path_muzbe, "02 muzBE konverze/BIO/muzbe_Pm_ohrozeni.csv"),
            quote = T, row.names = F,
            sep = ";", dec = ",",
            na = "", fileEncoding="cp1250")  


```

## Entomologie

```{r OHR ENTO}

# museion taxon

mtax <- read_excel(paste0(path_csv, "muzbe_taxony_MUSEION.xlsx"))

m_pe <- mtax %>% filter(cislo == "Pe") %>% 
  # mutate(nomaut = paste(nomen, autor))
  unite(nomaut, c("nomen", "autor"), sep = " ", na.rm = T, remove = F)

m_pe_dupl <- m_pe %>%
  group_by(nomen) %>%
  filter(n() != 1)

# data

dbname <- paste0(path_muzbe, "02 muzBE konverze/BIO/muzbePVO_DK.accdb") # path to database
con <- RODBC::odbcConnectAccess2007(dbname)     
ohr_e_data <- RODBC::sqlFetch(con, "lcl_Pe_ENTO") %>% 
  select(MU_INVC, MU_NOMEN, MU_NADNOMEN)

ohr_e_mus <- ohr_e_data %>%
  left_join(m_pe, by = c("MU_NOMEN" = "nomen", "MU_NADNOMEN" = "nadtaxon"), keep = T) %>% 
  select(MU_INVC, MU_NOMEN, id)

# REJSTRIK-SYSTEM

dbname <- paste0("M:/03 klienti/kraj moravskoslezsky/muzeum beskyd - MUZBE/02 muzBE konverze/BIO/muzbePVO_DK.accdb")
con <- RODBC::odbcConnectAccess2007(dbname)
RODBC::sqlTables(con)

rej <- RODBC::sqlFetch(con, "Rejstřík_Systém") # !!! Tahle tabulka ma jenom mechy, zivocichy a houby !!!

ohr_e_rej <- left_join(ohr_e_mus, rej, by = c("MU_NOMEN" = "druh_L"), keep = T)

# AOPK

ohr_e_aopk <- read_excel(paste0(path_data, "/_gen_tab/cervene_seznamy_AOPK.xlsx")) %>% 
  select(id_tax, ved_jm, autor_pop, kat_ohr_iucn) %>% 
  unite(nomaut, c("ved_jm", "autor_pop"), sep = " ", na.rm = T, remove = FALSE) 

ohr_e_fin <- left_join(ohr_e_rej, ohr_e_aopk, by = c("MU_NOMEN" = "ved_jm"), keep = T) %>% 
  select(MINVC = MU_INVC, taxon = MU_NOMEN, id, 
         DATA_ohrozeni = ochrana, AOPK_ohrozeni = kat_ohr_iucn)

write.table(ohr_e_fin, file = paste0(path_muzbe, "02 muzBE konverze/BIO/muzbe_Pe_ohrozeni.csv"),
            quote = T, row.names = F,
            sep = ";", dec = ",",
            na = "", fileEncoding="cp1250")  

```

## Houby

Ph - mykologicka podsbirka

```{r OHR HOUBY}

# museion taxon

mtax <- read_excel(paste0(path_csv, "muzbe_taxony_MUSEION.xlsx"))

m_ph <- mtax %>% filter(cislo == "Ph") %>% 
  # mutate(nomaut = paste(nomen, autor))
  unite(nomaut, c("nomen", "autor"), sep = " ", na.rm = T, remove = F)

m_ph_dupl <- m_ph %>%
  group_by(nomen) %>%
  filter(n() != 1)

# data

dbname <- paste0(path_muzbe, "02 muzBE konverze/BIO/muzbePVO_DK.accdb") # path to database
con <- RODBC::odbcConnectAccess2007(dbname)     
ohr_f_data <- RODBC::sqlFetch(con, "lcl_Ph_MYKO") %>% 
  select(MU_INVC, MU_NOMEN, MU_NADNOMEN)

ohr_f_mus <- ohr_f_data %>%
  left_join(m_ph, by = c("MU_NOMEN" = "nomen", "MU_NADNOMEN" = "nadtaxon"), keep = T) %>% 
  # left_join(m_ph, by = c("MU_NOMEN" = "nomen"), keep = T) %>% 
  select(MU_INVC, MU_NOMEN, id)

# REJSTRIK-SYSTEM

dbname <- paste0("M:/03 klienti/kraj moravskoslezsky/muzeum beskyd - MUZBE/02 muzBE konverze/BIO/muzbePVO_DK.accdb")
con <- RODBC::odbcConnectAccess2007(dbname)
RODBC::sqlTables(con)

rej <- RODBC::sqlFetch(con, "Rejstřík_Systém") # !!! Tahle tabulka ma jenom mechy, zivocichy a houby !!!

ohr_f_rej <- left_join(ohr_f_mus, rej, by = c("MU_NOMEN" = "druh_L"), keep = T)

# AOPK

ohr_f_aopk <- read_excel(paste0(path_data, "/_gen_tab/cervene_seznamy_AOPK.xlsx")) %>% 
  select(id_tax, ved_jm, autor_pop, kat_ohr_iucn) %>% 
  unite(nomaut, c("ved_jm", "autor_pop"), sep = " ", na.rm = T, remove = FALSE) 

ohr_f_fin <- left_join(ohr_f_rej, ohr_f_aopk, by = c("MU_NOMEN" = "ved_jm"), keep = T) %>% 
  select(MINVC = MU_INVC, taxon = MU_NOMEN, id, 
         DATA_ohrozeni = ochrana, AOPK_ohrozeni = kat_ohr_iucn)

write.table(ohr_f_fin, file = paste0(path_muzbe, "02 muzBE konverze/BIO/muzbe_Ph_ohrozeni.csv"),
            quote = T, row.names = F,
            sep = ";", dec = ",",
            na = "", fileEncoding="cp1250")  

```

## Zoologie

Pz = zoologická podsbírka

```{r OHR ZOO}

# museion taxon

mtax <- read_excel(paste0(path_csv, "muzbe_taxony_MUSEION.xlsx"))

m_pz <- mtax %>% filter(cislo == "Pz") %>% 
  # mutate(nomaut = paste(nomen, autor))
  unite(nomaut, c("nomen", "autor"), sep = " ", na.rm = T, remove = F)

m_pz_dupl <- m_pz %>%
  group_by(nomen) %>%
  filter(n() != 1)

# data

dbname <- paste0(path_muzbe, "02 muzBE konverze/BIO/muzbePVO_DK.accdb") # path to database
con <- RODBC::odbcConnectAccess2007(dbname)     
ohr_z_data <- RODBC::sqlFetch(con, "lcl_Pz_ZOO") %>% 
  select(MU_INVC, MU_NOMEN, MU_NADNOMEN)

ohr_z_mus <- ohr_z_data %>%
  left_join(m_pz, by = c("MU_NOMEN" = "nomen", "MU_NADNOMEN" = "nadtaxon"), keep = T) %>% 
  # left_join(m_ph, by = c("MU_NOMEN" = "nomen"), keep = T) %>% 
  select(MU_INVC, MU_NOMEN, id)

# REJSTRIK-SYSTEM

dbname <- paste0("M:/03 klienti/kraj moravskoslezsky/muzeum beskyd - MUZBE/02 muzBE konverze/BIO/muzbePVO_DK.accdb")
con <- RODBC::odbcConnectAccess2007(dbname)
RODBC::sqlTables(con)

rej <- RODBC::sqlFetch(con, "Rejstřík_Systém") # !!! Tahle tabulka ma jenom mechy, zivocichy a houby !!!

ohr_z_rej <- left_join(ohr_z_mus, rej, by = c("MU_NOMEN" = "druh_L"), keep = T)

# AOPK

ohr_z_aopk <- read_excel(paste0(path_data, "/_gen_tab/cervene_seznamy_AOPK.xlsx")) %>% 
  select(id_tax, ved_jm, autor_pop, kat_ohr_iucn) %>% 
  unite(nomaut, c("ved_jm", "autor_pop"), sep = " ", na.rm = T, remove = FALSE) 

ohr_z_fin <- left_join(ohr_z_rej, ohr_z_aopk, by = c("MU_NOMEN" = "ved_jm"), keep = T) %>% 
  select(MINVC = MU_INVC, taxon = MU_NOMEN, id, 
         DATA_ohrozeni = ochrana, AOPK_ohrozeni = kat_ohr_iucn)

write.table(ohr_z_fin, file = paste0(path_muzbe, "02 muzBE konverze/BIO/muzbe_Pz_ohrozeni.csv"),
            quote = T, row.names = F,
            sep = ";", dec = ",",
            na = "", fileEncoding="cp1250")  

```

## OHR do jedne tabulky

```{r OHR 1 TAB}

b <- read.table(paste0(path_muzbe, "02 muzBE konverze/BIO/muzbe_Pb_ohrozeni.csv"),
                header = T, sep = ";", fileEncoding="cp1250")
m <- read.table(paste0(path_muzbe, "02 muzBE konverze/BIO/muzbe_Pm_ohrozeni.csv"),
                header = T, sep = ";", fileEncoding="cp1250")
e <- read.table(paste0(path_muzbe, "02 muzBE konverze/BIO/muzbe_Pe_ohrozeni.csv"),
                header = T, sep = ";", fileEncoding="cp1250")
h <- read.table(paste0(path_muzbe, "02 muzBE konverze/BIO/muzbe_Ph_ohrozeni.csv"),
                header = T, sep = ";", fileEncoding="cp1250")
z <- read.table(paste0(path_muzbe, "02 muzBE konverze/BIO/muzbe_Pz_ohrozeni.csv"),
                header = T, sep = ";", fileEncoding="cp1250")

b <- b %>% 
  select(MINVC, MNOMEN, MUS_ID,
         DATA_ohrozeni = BACH_MOHR, AOPK_ohrozeni = AOPK_MOHR) %>% 
  mutate(MPODSB = "Pb")
m <- m %>% 
  select(MINVC, MNOMEN, MUS_ID,
         DATA_ohrozeni, AOPK_ohrozeni = AOPK_ohrozeni2)%>% 
  mutate(MPODSB = "Pm")
e <- e %>% 
  select(MINVC, MNOMEN = taxon, MUS_ID = id,
         DATA_ohrozeni, AOPK_ohrozeni)%>% 
  mutate(MPODSB = "Pe")
h <- h %>% 
  select(MINVC, MNOMEN = taxon, MUS_ID = id,
         DATA_ohrozeni, AOPK_ohrozeni)%>% 
  mutate(MPODSB = "Ph")
z <- z %>% 
  select(MINVC, MNOMEN = taxon, MUS_ID = id,
         DATA_ohrozeni, AOPK_ohrozeni)%>% 
  mutate(MPODSB = "Pz")

b[b == ""] <- NA
m[m == ""] <- NA
m <- m %>%filter(!is.na(DATA_ohrozeni)|!is.na(AOPK_ohrozeni))  
e[e == ""] <- NA
e <- e %>%filter(!is.na(DATA_ohrozeni)|!is.na(AOPK_ohrozeni))  
h[h == ""] <- NA
h <- h %>%filter(!is.na(DATA_ohrozeni)|!is.na(AOPK_ohrozeni))  
z[z == ""] <- NA
z <- z %>%filter(!is.na(DATA_ohrozeni)|!is.na(AOPK_ohrozeni))  

ohr_all_fin <- rbind()
ohr_all_fin <- bind_rows(b,m,e,h,z)

# doplneni id rucne ? ZKONZULTUJ

ohr_all_fin <- ohr_all_fin %>% 
  mutate(MNOMEN = str_trim(MNOMEN), 
         MUS_ID = ifelse(MNOMEN == "Sphagnum"&is.na(MUS_ID), 13530693, MUS_ID),
         MUS_ID = ifelse(MNOMEN == "Calypogeia"&is.na(MUS_ID), 13530499, MUS_ID),
         MUS_ID = ifelse(MNOMEN == "Phyllotus porrigens"&is.na(MUS_ID), 18665370, MUS_ID),
         MUS_ID = ifelse(MNOMEN == "Micromphale foetidum"&is.na(MUS_ID), 18665341, MUS_ID),
         MUS_ID = ifelse(MNOMEN == "Dendropolyporus umbellatus"&is.na(MUS_ID), 18665265, MUS_ID),
         MUS_ID = ifelse(MNOMEN == "Miliaria calandra"&is.na(MUS_ID), 18657104, MUS_ID),
         MUS_ID = ifelse(MNOMEN == "Bufo viridis"&is.na(MUS_ID), 18657083, MUS_ID))


write.table(ohr_all_fin, file = paste0(path_muzbe, "02 muzBE konverze/BIO/muzbe_VSE_ohrozeni.csv"),
            quote = T, row.names = F,
            sep = ";", dec = ",",
            na = "", fileEncoding="cp1250")  
```




# S Y N O N Y M A

## Botanika 

```{r}

botsyn <- modify_tab %>% # modify_tab pro BOTANIKU !!!
  select(MTAXON, MTAXKATEG, '8nadrizenyTaxon', syn) 

botsyn[botsyn == ""] <- NA
botsyn[botsyn == " "] <- NA

botsyn <- botsyn %>% 
  filter(!is.na(syn)) %>% 
  distinct() %>% 
  rename(nomen = MTAXON,
         kateg = MTAXKATEG, 
         nadrizeny = '8nadrizenyTaxon') %>% 
  mutate(fond = "B")


# dup <-  modify_tab %>% 
#   select(MTAXON, MTAXKATEG, syn, '8nadrizenyTaxon', druh) 
# 
# dup[dup == ""] <- NA
# dup[dup == " "] <- NA
# 
# dup <- dup %>% 
#   filter(!is.na(syn)) %>% 
#   group_by(syn) %>% 
#   filter(n() != 1)
```

## Quercus

```{r}
dbname <- paste0(path_muzbe, "02 muzBE konverze/muzbe BIO/muzbePVO_DK.accdb") 
con <- RODBC::odbcConnectAccess2007(dbname)      

# akv <- RODBC::sqlFetch(con, "lcl_akvarely")
# bot <- RODBC::sqlFetch(con, "lcl_botanika")   
# bry <- RODBC::sqlFetch(con, "lcl_mechorosty")   
que <- RODBC::sqlFetch(con, "lcl_Pb_quercus")

# S Y N O N Y M A

quesyn <- que %>% 
  select(MU_NOMEN, MU_KATEGORIE, MU_NADNOMEN, syn) %>% 
  filter(!is.na(syn)) %>% 
  distinct()  %>% 
  rename(nomen = MU_NOMEN,
         kateg = MU_KATEGORIE, 
         nadrizeny = MU_NADNOMEN) %>% 
  mutate(fond = "quer")

```

## SYN do jedne tabulky

```{r}

synonyma <- rbind(botsyn, quesyn)


write.table(synonyma, file = paste0(path_muzbe, "02 muzBE konverze/muzbe BIO/muzbe_Pb_synonyma.csv"),
            quote = T, row.names = F,
            sep = ";", dec = ",",
            na = "", fileEncoding="cp1250")

```

